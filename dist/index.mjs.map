{"version":3,"file":"index.mjs","sources":["../src/colors.ts","../src/fov.ts","../src/keys.ts","../src/rng.ts","../src/font.ts","../src/shaders.ts","../src/mouse.ts","../src/terminal.ts"],"sourcesContent":["\nexport const COLOR_BLACK = 0x00000000;\nexport const COLOR_WHITE = 0xffffff00;\nexport const COLOR_LIGHT_GRAY = 0xaaaaaa00;\nexport const COLOR_DARK_GRAY = 0x55555500;\nexport const COLOR_YELLOW = 0xffff5500;\nexport const COLOR_BROWN = 0xaa550000;\nexport const COLOR_LIGHT_RED = 0xff555500;\nexport const COLOR_DARK_RED = 0xaa000000;\nexport const COLOR_LIGHT_GREEN = 0x55ff5500;\nexport const COLOR_DARK_GREEN = 0x00aa0000;\nexport const COLOR_LIGHT_CYAN = 0x55ffff00;\nexport const COLOR_DARK_CYAN = 0x00aaaa00;\nexport const COLOR_LIGHT_BLUE = 0x5555ff00;\nexport const COLOR_DARK_BLUE = 0x0000aa00;\nexport const COLOR_LIGHT_MAGENTA = 0xff55ff00;\nexport const COLOR_DARK_MAGENTA = 0xaa00aa00;\nexport const COLOR_ORANGE = 0xff880000;\n\n/**\n * Creates a big-endian 32-bit RGBA color from red, green, and blue components.\n * @param r Red (0-255).\n * @param g Green (0-255).\n * @param b Blue (0-255).\n * @return A 32-bit unsigned integer color.\n */\nexport function createColor(r: number, g: number, b: number) {\n  return (r << 24) + (g << 16) + (b << 8);\n}\n\n/**\n * Converts a color from HSV format to RGBA format.\n *\n * Based on: https://stackoverflow.com/a/17243070/2051724\n *\n * @param h Hue (0.0 - 1.0).\n * @param s Saturation (0.0 - 1.0).\n * @param v Value (0.0 - 1.0).\n * @return A 32-bit unsigned integer color.\n */\nexport function createHsvColor(h: number, s: number, v: number) {\n  let r, g, b, i, f, p, q, t;\n  i = (h * 6) | 0;\n  f = h * 6 - i;\n  p = v * (1 - s);\n  q = v * (1 - f * s);\n  t = v * (1 - (1 - f) * s);\n  switch (i % 6) {\n    case 0:\n      r = v, g = t, b = p;\n      break;\n    case 1:\n      r = q, g = v, b = p;\n      break;\n    case 2:\n      r = p, g = v, b = t;\n      break;\n    case 3:\n      r = p, g = q, b = v;\n      break;\n    case 4:\n      r = t, g = p, b = v;\n      break;\n    case 5:\n      r = v, g = p, b = q;\n      break;\n    default:\n      r = 0;\n      g = 0;\n      b = 0;\n  }\n  return createColor((r * 255) | 0, (g * 255) | 0, (b * 255) | 0);\n}\n","\n// MRPAS\n// Mingos' Restrictive Precise Angle Shadowcasting\n// https://bitbucket.org/mingos/mrpas/overview\n\nfunction createBoolMatrix(width: number, height: number) {\n  const result = new Array(height);\n  for (let y = 0; y < height; y++) {\n    result[y] = new Array(width);\n  }\n  return result;\n}\n\nexport class FovMap {\n  private width: number;\n  private height: number;\n  private blocked: boolean[][];\n  private visible: boolean[][];\n  private originX: number;\n  private originY: number;\n  private minX: number;\n  private maxX: number;\n  private minY: number;\n  private maxY: number;\n  private radius: number;\n\n  /**\n   * Creates a new FOV map.\n   * @constructor\n   * @param width\n   * @param height\n   * @param blockedFunc\n   */\n  constructor(width: number, height: number, blockedFunc?: Function) {\n    this.width = width;\n    this.height = height;\n    this.blocked = createBoolMatrix(width, height);\n    this.visible = createBoolMatrix(width, height);\n    this.originX = 0;\n    this.originY = 0;\n    this.minX = 0;\n    this.maxX = 0;\n    this.minY = 0;\n    this.maxY = 0;\n    this.radius = 0;\n\n    if (blockedFunc) {\n      for (let y = 0; y < height; y++) {\n        for (let x = 0; x < width; x++) {\n          this.blocked[y][x] = blockedFunc(x, y);\n        }\n      }\n    }\n  }\n\n  setBlocked(x: number, y: number, blocked: boolean) {\n    if (x >= 0 && x < this.width && y >= 0 && y < this.height) {\n      this.blocked[y][x] = blocked;\n    }\n  }\n\n  isVisible(x: number, y: number) {\n    if (x < 0 || x >= this.width || y < 0 || y >= this.height) {\n      return false;\n    }\n    return this.visible[y][x];\n  }\n\n  /**\n   * Compute the FOV in an octant adjacent to the Y axis\n   */\n  private computeOctantY(deltaX: number, deltaY: number) {\n    const startSlopes: number[] = [];\n    const endSlopes: number[] = [];\n    let iteration = 1;\n    let totalObstacles = 0;\n    let obstaclesInLastLine = 0;\n    let minSlope = 0;\n    let x;\n    let y;\n    let halfSlope;\n    let processedCell;\n    let visible;\n    let extended;\n    let centreSlope;\n    let startSlope;\n    let endSlope;\n    let previousEndSlope;\n\n    for (y = this.originY + deltaY; y >= this.minY && y <= this.maxY;\n      y += deltaY, obstaclesInLastLine = totalObstacles, ++iteration) {\n      halfSlope = 0.5 / iteration;\n      previousEndSlope = -1;\n      for (processedCell = Math.floor(minSlope * iteration + 0.5),\n        x = this.originX + (processedCell * deltaX);\n        processedCell <= iteration && x >= this.minX && x <= this.maxX;\n        x += deltaX, ++processedCell, previousEndSlope = endSlope) {\n        visible = true;\n        extended = false;\n        centreSlope = processedCell / iteration;\n        startSlope = previousEndSlope;\n        endSlope = centreSlope + halfSlope;\n\n        if (obstaclesInLastLine > 0) {\n          if (!(this.visible[y - deltaY][x] && !this.blocked[y - deltaY][x]) &&\n            !(this.visible[y - deltaY][x - deltaX] &&\n              !this.blocked[y - deltaY][x - deltaX])) {\n            visible = false;\n          } else {\n            for (let idx = 0; idx < obstaclesInLastLine && visible; ++idx) {\n              if (startSlope <= endSlopes[idx] &&\n                endSlope >= startSlopes[idx]) {\n                if (!this.blocked[y][x]) {\n                  if (centreSlope > startSlopes[idx] &&\n                    centreSlope < endSlopes[idx]) {\n                    visible = false;\n                    break;\n                  }\n                } else {\n                  if (startSlope >= startSlopes[idx] &&\n                    endSlope <= endSlopes[idx]) {\n                    visible = false;\n                    break;\n                  } else {\n                    startSlopes[idx] = Math.min(startSlopes[idx], startSlope);\n                    endSlopes[idx] = Math.max(endSlopes[idx], endSlope);\n                    extended = true;\n                  }\n                }\n              }\n            }\n          }\n        }\n        if (visible) {\n          this.visible[y][x] = true;\n          if (this.blocked[y][x]) {\n            if (minSlope >= startSlope) {\n              minSlope = endSlope;\n            } else if (!extended) {\n              startSlopes[totalObstacles] = startSlope;\n              endSlopes[totalObstacles++] = endSlope;\n            }\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * Compute the FOV in an octant adjacent to the X axis\n   */\n  private computeOctantX(deltaX: number, deltaY: number) {\n    const startSlopes: number[] = [];\n    const endSlopes: number[] = [];\n    let iteration = 1;\n    let totalObstacles = 0;\n    let obstaclesInLastLine = 0;\n    let minSlope = 0;\n    let x;\n    let y;\n    let halfSlope;\n    let processedCell;\n    let visible;\n    let extended;\n    let centreSlope;\n    let startSlope;\n    let endSlope;\n    let previousEndSlope;\n\n    for (x = this.originX + deltaX; x >= this.minX && x <= this.maxX;\n      x += deltaX, obstaclesInLastLine = totalObstacles, ++iteration) {\n      halfSlope = 0.5 / iteration;\n      previousEndSlope = -1;\n      for (processedCell = Math.floor(minSlope * iteration + 0.5),\n        y = this.originY + (processedCell * deltaY);\n        processedCell <= iteration && y >= this.minY && y <= this.maxY;\n        y += deltaY, ++processedCell, previousEndSlope = endSlope) {\n        visible = true;\n        extended = false;\n        centreSlope = processedCell / iteration;\n        startSlope = previousEndSlope;\n        endSlope = centreSlope + halfSlope;\n\n        if (obstaclesInLastLine > 0) {\n          if (!(this.visible[y][x - deltaX] && !this.blocked[y][x - deltaX]) &&\n            !(this.visible[y - deltaY][x - deltaX] &&\n              !this.blocked[y - deltaY][x - deltaX])) {\n            visible = false;\n          } else {\n            for (let idx = 0; idx < obstaclesInLastLine && visible; ++idx) {\n              if (startSlope <= endSlopes[idx] &&\n                endSlope >= startSlopes[idx]) {\n                if (!this.blocked[y][x]) {\n                  if (centreSlope > startSlopes[idx] &&\n                    centreSlope < endSlopes[idx]) {\n                    visible = false;\n                    break;\n                  }\n                } else {\n                  if (startSlope >= startSlopes[idx] &&\n                    endSlope <= endSlopes[idx]) {\n                    visible = false;\n                    break;\n                  } else {\n                    startSlopes[idx] = Math.min(startSlopes[idx], startSlope);\n                    endSlopes[idx] = Math.max(endSlopes[idx], endSlope);\n                    extended = true;\n                  }\n                }\n              }\n            }\n          }\n        }\n        if (visible) {\n          this.visible[y][x] = true;\n          if (this.blocked[y][x]) {\n            if (minSlope >= startSlope) {\n              minSlope = endSlope;\n            } else if (!extended) {\n              startSlopes[totalObstacles] = startSlope;\n              endSlopes[totalObstacles++] = endSlope;\n            }\n          }\n        }\n      }\n    }\n  }\n\n  computeFov(originX: number, originY: number, radius: number) {\n    for (let y = 0; y < this.height; y++) {\n      for (let x = 0; x < this.width; x++) {\n        this.visible[y][x] = false;\n      }\n    }\n\n    this.visible[originY][originX] = true;\n    this.originX = originX;\n    this.originY = originY;\n    this.radius = radius;\n    this.minX = Math.max(0, originX - radius);\n    this.minY = Math.max(0, originY - radius);\n    this.maxX = Math.min(this.width - 1, originX + radius);\n    this.maxY = Math.min(this.height - 1, originY + radius);\n\n    this.computeOctantY(1, 1);\n    this.computeOctantX(1, 1);\n    this.computeOctantY(1, -1);\n    this.computeOctantX(1, -1);\n    this.computeOctantY(-1, 1);\n    this.computeOctantX(-1, 1);\n    this.computeOctantY(-1, -1);\n    this.computeOctantX(-1, -1);\n  }\n}\n","\n/**\n * Number of keys to track.\n */\nconst KEY_COUNT = 256;\n\n/**\n * Creates a new key instance.\n */\nexport class Key {\n  down: boolean;\n  downCount: number;\n\n  constructor() {\n    this.down = false;\n    this.downCount = 0;\n  }\n}\n\nexport class Keys {\n  private keys: Key[];\n\n  /**\n   * Creates a new keyboard module.\n   *\n   * @param el DOM el to attach listeners.\n   */\n  constructor(el: Element) {\n    this.keys = new Array(KEY_COUNT);\n    for (let i = 0; i < KEY_COUNT; i++) {\n      this.keys[i] = new Key();\n    }\n\n    el.addEventListener('keydown', e => this.setKey(e as KeyboardEvent, true));\n    el.addEventListener('keyup', e => this.setKey(e as KeyboardEvent, false));\n  }\n\n\n  setKey(e: KeyboardEvent, state: boolean) {\n    e.stopPropagation();\n    e.preventDefault();\n    const keyCode = e.keyCode;\n    if (keyCode >= 0 && keyCode < KEY_COUNT) {\n      this.keys[keyCode].down = state;\n    }\n  }\n\n  updateKeys() {\n    for (let i = 0; i < KEY_COUNT; i++) {\n      if (this.keys[i].down) {\n        this.keys[i].downCount++;\n      } else {\n        this.keys[i].downCount = 0;\n      }\n    }\n  }\n\n  getKey(keyCode: number) {\n    return keyCode >= 0 && keyCode < KEY_COUNT ? this.keys[keyCode] : null;\n  }\n}\n\nexport const VK_ESCAPE = 27;\nexport const VK_SPACE = 32;\nexport const VK_LEFT = 37;\nexport const VK_UP = 38;\nexport const VK_RIGHT = 39;\nexport const VK_DOWN = 40;\nexport const VK_A = 65;\nexport const VK_D = 68;\nexport const VK_M = 77;\nexport const VK_Q = 81;\nexport const VK_S = 83;\nexport const VK_W = 87;\nexport const VK_Z = 90;\n","\n/**\n * Random number generator.\n *\n * LCG\n * https://stackoverflow.com/a/424445/2051724\n */\nexport class RNG {\n  private m: number;\n  private a: number;\n  private c: number;\n  private state: number;\n\n  /**\n   * Creates a new random number generator.\n   *\n   * @param seed The integer seed.\n   */\n  constructor(seed: number) {\n    // LCG using GCC's constants\n    this.m = 0x80000000;  // 2**31;\n    this.a = 1103515245;\n    this.c = 12345;\n    this.state = seed || 1;\n  }\n\n  private nextInt() {\n    this.state = (this.a * this.state + this.c) % this.m;\n    return this.state;\n  }\n\n  nextFloat() {\n    // returns in range [0,1]\n    return this.nextInt() / (this.m - 1);\n  }\n\n  nextRange(start: number, end: number) {\n    // returns in range [start, end): including start, excluding end\n    // can't modulu nextInt because of weak randomness in lower bits\n    const rangeSize = end - start;\n    const randomUnder1 = this.nextInt() / this.m;\n    return start + ((randomUnder1 * rangeSize) | 0);\n  }\n}\n","\n/**\n * Character width in pixels.\n */\nexport const FONT_CHAR_WIDTH = 8;\n\n/**\n * Character height in pixels.\n */\nexport const FONT_CHAR_HEIGHT = 8;\n\n/**\n * Font image as data URL.\n * IBM terminal font.\n * See img/font.png.\n */\nexport const FONT_IMAGE =\n    'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAA' +\n    'ACAAQMAAAD58POIAAAABlBMVEUAAAD///+l2Z/dAAAEtElEQVRIx2WTsYsUMRTGPxT' +\n    'OJniWgRMFsbR4oJyDBE+s/AdsrIJKtEixIKwPHOc8tbCwsdNKLCy0tlBQGBCnel55C' +\n    'K5y1dqIbKVbhBlfZkYP8UsI2d98ed+bMAtUVTxUHELn3Krb2HwCbHVtUSo4f/5AOHn' +\n    'lEvD8c1sWhf229WQ1bGy63tG2pXu/9e52oCvfgHfvy7JtMxDXgyffimKnzEfETq71R' +\n    'w6pclGpFvNLORYoihzLdrd+gjv7bNisYK3FoN2DLnx+D+esJRy3HZZnq/CZ9aA1vg6' +\n    'uQ9vacEvykbatu6pShw1rooYqOzqnNSqsceWss9Qe76ymuLD2sNpLAXS3RIe/4hgJh' +\n    'bceWSs9SE30RIEUmAzaWoraW0fDeUZMdgpvu4QEhYTW0AyjI1dSRxDkGhNQnR2Rmil' +\n    'yCoHuYE+jn4n5cCoSc47wDFmIuNqLSH9EMCNj4rI2IkQ+WYNERSFmabkkjTAW38mb1' +\n    'giJAdRB0K2o34ulCYEATokNs+cJkabQf22gpORS2zrhI/NF0xRoOIR4+XIQMsH/mEd' +\n    '8lVCH69drBdG3PxsFZR2Y60SG/c5XBal3bGt8vNxsN6gl1/BaQzdNE8GSUxZnhXne5' +\n    'pT/lFiHSNNIyzUfAoIEedUD8d4WPdglBVEee7IRKKUsFOwUTN7aBvAzPqygjXTZGws' +\n    'FHIWEfzTU+JUMFofnzImahlvex/hPHQi7OIwCu2R3JxkRPAyiruP96f2zYT+NEw70f' +\n    'cmACVLKQqbaFbUiQBlqSV4CWaadDCSI1L4M2dFkMH3LU16YOX+acyOMUUtggr86hF6' +\n    'H7e502NIAyNKswGz6qSz7C0oKEBEk1uMF5XdoMuD+goTUoaAsvTkl3Mby6gC8WSztl' +\n    'GJjkqagxeLIXie9GLYS76CLlF4IIvQeFFgXNEQXUIMdsxNdJsWECbXIijErdRDRFGG' +\n    'IpLNleVaqlDIQsOSHgX1dK0gJVPFGVW2Q1tBi6vB73+ggi7MMzx6NoDiDgyBEEdIBI' +\n    'EasIW3KYC2lvLotFt60zCwijWwvdrgCb4qqBzt+TuoYf6dG5vPIVmtsM3NVmZLL9Fo' +\n    '+Af9exwTWGjOdOkcO83lGRNbOZjHgkrZhTwp4knEM9BzMCAGGWJbfzzr/JlU3rJxES' +\n    'TkTqF+YK9esOiSDWVVJMNsfndaotAkRgB0eP3X4R0f3WwDHLn7RVrh26+tYtwI8eHn' +\n    'TWnvfnx/A6CCiNz/X258Vjw5mfrayvrJSp8Gx1GR1/GxrWg6OlJLWWEeV7FBDHS4DS' +\n    '3ZwQPUH6C8d0+k6hjGC2WwEd0fAdHrjV3e6+9WOwDARoDPiaNfpLGVDH+uMGKpIygV' +\n    '0tiOoZAR3RwCMAPiUWLzGiEUH6ztM4n1QTffRA+rwKeibnWPmHnAH89N7v0tEGUAdL' +\n    'jAzFCy1HZtbi+rIAHYARVJBXT1g7CkDqLpusdphsaoJvm9xa2sEdJ+IEmHr3gikH8D' +\n    'Whz9A1YMXAFZXVxei4gwe7YFEGWyNgJkN97Ej+PutEuabFaEAipIHcOLze0IU8EGTQ' +\n    'QJ/ZiAC1hUuO9LJW5JQKDjoFWjUtzWBylZlqUDRxzUmDMog4enaQ1Kyp/1Y7v1vfwP' +\n    'x3em+Z+50IgAAAABJRU5ErkJggg==';\n","\n/**\n * Vertex shader program.\n *\n * a = attribute vec2 aVertexPosition;\n * b = attribute vec2 aTextureCoord;\n * c = attribute vec3 aFgColor;\n * d = attribute vec3 aBgColor;\n * e = varying vec2 vTextureCoord;\n * f = varying vec4 vFgColor;\n * g = varying vec4 vBgColor;\n */\nexport const VERTEX_SHADER_SOURCE = 'attribute vec2 a;' +\n    'attribute vec2 b;' +\n    'attribute vec3 c;' +\n    'attribute vec3 d;' +\n    'varying highp vec2 e;' +\n    'varying highp vec4 f;' +\n    'varying highp vec4 g;' +\n    'void main(void){' +\n    'gl_Position=vec4(a.x,a.y,0,1);' +\n    'e=b/16.0;' +\n    'f=vec4(c.r,c.g,c.b,1);' +\n    'g=vec4(d.r,d.g,d.b,1);' +\n    '}';\n\n/**\n * Fragment shader program.\n *\n * e = varying vec2 vTextureCoord;\n * f = varying vec4 vFgColor;\n * g = varying vec4 vBgColor;\n * s = uniform sampler2D uSampler;\n */\nexport const FRAGMENT_SHADER_SOURCE = 'varying highp vec2 e;' +\n    'varying highp vec4 f;' +\n    'varying highp vec4 g;' +\n    'uniform sampler2D s;' +\n    'void main(void){' +\n    'gl_FragColor=texture2D(s,e);' +\n    'if(gl_FragColor.r<0.1) {' +\n    'gl_FragColor=g;' +\n    '} else {' +\n    'gl_FragColor=f;' +\n    '}' +\n    '}';\n","\r\nimport {FONT_CHAR_HEIGHT, FONT_CHAR_WIDTH} from './font';\r\n\r\nexport class Mouse {\r\n    x: number;\r\n    y: number;\r\n    buttons: boolean[];\r\n\r\n    constructor (el: Element) {\r\n        this.x = 0;\r\n        this.y = 0;\r\n        this.buttons = [false, false, false];\r\n\r\n        el.addEventListener('mousedown', e => this.update(e as MouseEvent));\r\n        el.addEventListener('mouseup', e => this.update(e as MouseEvent));\r\n        el.addEventListener('mousemove', e => this.update(e as MouseEvent));\r\n    }\r\n\r\n    update(e: MouseEvent) {\r\n        this.x = (e.offsetX / FONT_CHAR_WIDTH) | 0;\r\n        this.y = (e.offsetY / FONT_CHAR_HEIGHT) | 0;\r\n\r\n        if (e.type === 'mousedown') {\r\n            this.buttons[e.button] = true;\r\n        }\r\n\r\n        if (e.type === 'mouseup') {\r\n            this.buttons[e.button] = false;\r\n        }\r\n    }\r\n}","\nimport {FONT_CHAR_HEIGHT, FONT_CHAR_WIDTH, FONT_IMAGE} from './font';\nimport {FRAGMENT_SHADER_SOURCE, VERTEX_SHADER_SOURCE} from './shaders';\nimport {Keys} from './keys';\nimport {Mouse} from './mouse';\n\n/**\n * Linearly interpolates a number in the range 0-max to -1.0-1.0.\n *\n * @param i The value between 0 and max.\n * @param max The maximum value.\n * @returns The interpolated value between -1.0 and 1.0.\n */\nfunction interpolate(i: number, max: number) {\n  return -1.0 + 2.0 * (i / max);\n}\n\nexport class Terminal {\n  private canvas: HTMLCanvasElement;\n  private width: number;\n  private height: number;\n  private pixelWidth: number;\n  private pixelHeight: number;\n  private keys: Keys;\n  private mouse: Mouse;\n  private gl: WebGLRenderingContext;\n  private program: WebGLProgram;\n  private positionAttribLocation: GLint;\n  private textureAttribLocation: GLint;\n  private fgColorAttribLocation: GLint;\n  private bgColorAttribLocation: GLint;\n  private positionsArray: Float32Array;\n  private indexArray: Uint16Array;\n  private textureArray: Float32Array;\n  private foregroundUint8Array: Uint8Array;\n  private foregroundDataView: DataView;\n  private backgroundUint8Array: Uint8Array;\n  private backgroundDataView: DataView;\n  private positionBuffer: WebGLBuffer;\n  private indexBuffer: WebGLBuffer;\n  private textureBuffer: WebGLBuffer;\n  private foregroundBuffer: WebGLBuffer;\n  private backgroundBuffer: WebGLBuffer;\n  private texture: WebGLTexture;\n  update?: Function;\n\n  constructor(canvas: HTMLCanvasElement, width: number, height: number) {\n    this.canvas = canvas;\n    this.width = width;\n    this.height = height;\n    this.pixelWidth = width * FONT_CHAR_WIDTH;\n    this.pixelHeight = height * FONT_CHAR_HEIGHT;\n\n    canvas.width = this.pixelWidth;\n    canvas.height = this.pixelHeight;\n    canvas.style.width = this.pixelWidth + 'px';\n    canvas.style.height = this.pixelHeight + 'px';\n    // canvas.style.imageRendering = 'pixelated';\n    canvas.style.outline = 'none';\n    canvas.tabIndex = 0;\n\n    this.keys = new Keys(canvas);\n    this.mouse = new Mouse(canvas);\n\n    // Get the WebGL context from the canvas\n    const gl = canvas.getContext('webgl', {antialias: false});\n    if (!gl) {\n      throw new Error(\n          'Unable to initialize WebGL. Your browser may not support it.');\n    }\n\n    const program = gl.createProgram();\n    if (!program) {\n      throw new Error(\n          'Unable to initialize WebGL. Your browser may not support it.');\n    }\n\n    this.gl = gl;\n    this.program = program;\n\n    gl.attachShader(\n        program, this.buildShader(gl.VERTEX_SHADER, VERTEX_SHADER_SOURCE));\n    gl.attachShader(\n        program, this.buildShader(gl.FRAGMENT_SHADER, FRAGMENT_SHADER_SOURCE));\n    gl.linkProgram(program);\n    gl.useProgram(program);\n\n    this.positionAttribLocation = this.getAttribLocation('a');\n    this.textureAttribLocation = this.getAttribLocation('b');\n    this.fgColorAttribLocation = this.getAttribLocation('c');\n    this.bgColorAttribLocation = this.getAttribLocation('d');\n\n    const cellCount = width * height;\n    this.positionsArray = new Float32Array(cellCount * 3 * 4);\n    this.indexArray = new Uint16Array(cellCount * 6);\n    this.textureArray = new Float32Array(cellCount * 2 * 4);\n    this.foregroundUint8Array = new Uint8Array(cellCount * 4 * 4);\n    this.foregroundDataView = new DataView(this.foregroundUint8Array.buffer);\n    this.backgroundUint8Array = new Uint8Array(cellCount * 4 * 4);\n    this.backgroundDataView = new DataView(this.backgroundUint8Array.buffer);\n\n    // Init the positions buffer\n    let i = 0;\n    let j = 0;\n    let k = 0;\n    for (let y = 0; y < height; y++) {\n      for (let x = 0; x < width; x++) {\n        // Top-left\n        this.positionsArray[i++] = interpolate(x, width);\n        this.positionsArray[i++] = -interpolate(y, height);\n\n        // Top-right\n        this.positionsArray[i++] = interpolate(x + 1, width);\n        this.positionsArray[i++] = -interpolate(y, height);\n\n        // Bottom-right\n        this.positionsArray[i++] = interpolate(x + 1, width);\n        this.positionsArray[i++] = -interpolate(y + 1, height);\n\n        // Bottom-left\n        this.positionsArray[i++] = interpolate(x, width);\n        this.positionsArray[i++] = -interpolate(y + 1, height);\n\n        this.indexArray[j++] = k + 0;\n        this.indexArray[j++] = k + 1;\n        this.indexArray[j++] = k + 2;\n        this.indexArray[j++] = k + 0;\n        this.indexArray[j++] = k + 2;\n        this.indexArray[j++] = k + 3;\n\n        k += 4;\n      }\n    }\n\n    this.positionBuffer = gl.createBuffer() as WebGLBuffer;\n    this.indexBuffer = gl.createBuffer() as WebGLBuffer;\n    this.textureBuffer = gl.createBuffer() as WebGLBuffer;\n    this.foregroundBuffer = gl.createBuffer() as WebGLBuffer;\n    this.backgroundBuffer = gl.createBuffer() as WebGLBuffer;\n\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);\n    gl.bufferData(gl.ARRAY_BUFFER, this.positionsArray, gl.STATIC_DRAW);\n\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indexBuffer);\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this.indexArray, gl.STATIC_DRAW);\n\n    this.texture = this.loadTexture(FONT_IMAGE) as WebGLTexture;\n\n    this.renderLoop();\n  }\n\n  private getAttribLocation(name: string) {\n    const location = this.gl.getAttribLocation(this.program, name);\n    this.gl.enableVertexAttribArray(location);\n    return location;\n  }\n\n  private isOutOfRange(x: number, y: number) {\n    return x < 0 || x >= this.width || y < 0 || y >= this.height;\n  }\n\n  setCharCode(x: number, y: number, c: number) {\n    if (this.isOutOfRange(x, y)) {\n      return;\n    }\n\n    const textureX = (c % 16) + (0.5 / 256.0);\n    const textureY = ((c / 16) | 0) + (0.5 / 256.0);\n    const textureArrayIndex = 8 * (y * this.width + x);\n\n    this.textureArray[textureArrayIndex + 0] = textureX;\n    this.textureArray[textureArrayIndex + 1] = textureY;\n\n    this.textureArray[textureArrayIndex + 2] = textureX + 1;\n    this.textureArray[textureArrayIndex + 3] = textureY;\n\n    this.textureArray[textureArrayIndex + 4] = textureX + 1;\n    this.textureArray[textureArrayIndex + 5] = textureY + 1;\n\n    this.textureArray[textureArrayIndex + 6] = textureX;\n    this.textureArray[textureArrayIndex + 7] = textureY + 1;\n  }\n\n  clear() {\n    this.clearRect(0, 0, this.width, this.height);\n  }\n\n  clearRect(\n      rectX: number, rectY: number, rectWidth: number, rectHeight: number) {\n    const charCode = 0;\n    const x2 = rectX + rectWidth;\n    const y2 = rectY + rectHeight;\n    for (let y = rectY; y < y2; y++) {\n      for (let x = rectX; x < x2; x++) {\n        this.setCharCode(x, y, charCode);\n      }\n    }\n  }\n\n  /**\n   * Sets the foreground color of a cell.\n   * @param x The horizontal coordinate.\n   * @param y The vertical coordinate.\n   * @param color The 32-bit color (see createColor).\n   */\n  setForegroundColor(x: number, y: number, color: number) {\n    if (this.isOutOfRange(x, y)) {\n      return;\n    }\n\n    let index = 16 * (y * this.width + x);\n    for (let i = 0; i < 4; i++) {\n      this.foregroundDataView.setUint32(index, color, false);\n      index += 4;\n    }\n  }\n\n  /**\n   * Sets the background color of a cell.\n   * @param x The horizontal coordinate.\n   * @param y The vertical coordinate.\n   * @param color The 32-bit color (see createColor).\n   */\n  setBackgroundColor(x: number, y: number, color: number) {\n    if (this.isOutOfRange(x, y)) {\n      return;\n    }\n\n    let index = 16 * (y * this.width + x);\n    for (let i = 0; i < 4; i++) {\n      this.backgroundDataView.setUint32(index, color, false);\n      index += 4;\n    }\n  }\n\n  /**\n   * Draws a string with optional colors.\n   */\n  drawString(x: number, y: number, str: string, fg?: number, bg?: number) {\n    for (let i = 0; i < str.length; i++) {\n      this.setCharCode(x + i, y, str.charCodeAt(i));\n    }\n\n    if (fg) {\n      this.fillForegroundRect(x, y, str.length, 1, fg);\n    }\n\n    if (bg) {\n      this.fillBackgroundRect(x, y, str.length, 1, bg);\n    }\n  }\n\n  drawCenteredString(\n      x: number, y: number, str: string, fg?: number, bg?: number) {\n    this.drawString((x - str.length / 2) | 0, y, str, fg, bg);\n  }\n\n  fillForegroundRect(\n      x: number, y: number, w: number, h: number, color: number) {\n    for (let i = y; i < y + h; i++) {\n      for (let j = x; j < x + w; j++) {\n        this.setForegroundColor(j, i, color);\n      }\n    }\n  }\n\n  fillBackgroundRect(\n      x: number, y: number, w: number, h: number, color: number) {\n    for (let i = y; i < y + h; i++) {\n      for (let j = x; j < x + w; j++) {\n        this.setBackgroundColor(j, i, color);\n      }\n    }\n  }\n\n  isKeyDown(keyCode: number) {\n    const key = this.keys.getKey(keyCode);\n    return key && key.down;\n  }\n\n  isKeyPressed(keyCode: number) {\n    const key = this.keys.getKey(keyCode);\n    const count = key ? key.downCount : 0;\n    return count === 1 || (count > 30 && count % 3 === 0);\n  }\n\n  getKeyDownCount(keyCode: number) {\n    const key = this.keys.getKey(keyCode);\n    return key ? key.downCount : 0;\n  }\n\n  getMouse() {\n    return this.mouse;\n  }\n\n  private buildShader(type: GLint, source: string) {\n    const gl = this.gl;\n    const sh = gl.createShader(type);\n    if (!sh) {\n      throw new Error('An error occurred compiling the shader: ');\n    }\n    gl.shaderSource(sh, source);\n    gl.compileShader(sh);\n    if (!gl.getShaderParameter(sh, gl.COMPILE_STATUS)) {\n      throw new Error(\n          'An error occurred compiling the shader: ' + gl.getShaderInfoLog(sh));\n    }\n    return sh;\n  }\n\n  /**\n   * Initialize a texture and load an image.\n   * When the image finished loading copy it into the texture.\n   * @param url\n   */\n  private loadTexture(url: string) {\n    const gl = this.gl;\n    const texture = gl.createTexture();\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n\n    // Because images have to be download over the internet\n    // they might take a moment until they are ready.\n    // Until then put a single pixel in the texture so we can\n    // use it immediately. When the image has finished downloading\n    // we'll update the texture with the contents of the image.\n    const level = 0;\n    const internalFormat = gl.RGBA;\n    const width = 1;\n    const height = 1;\n    const border = 0;\n    const srcFormat = gl.RGBA;\n    const srcType = gl.UNSIGNED_BYTE;\n    const pixel = new Uint8Array([0, 0, 0, 255]);  // opaque black\n    gl.texImage2D(\n        gl.TEXTURE_2D, level, internalFormat, width, height, border, srcFormat,\n        srcType, pixel);\n\n    const image = new Image();\n    image.onload = () => {\n      gl.bindTexture(gl.TEXTURE_2D, texture);\n      gl.texImage2D(\n          gl.TEXTURE_2D, level, internalFormat, srcFormat, srcType, image);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n      gl.generateMipmap(gl.TEXTURE_2D);\n    };\n    image.src = url;\n\n    return texture;\n  }\n\n  //\n  // Draw the scene.\n  //\n  private render() {\n    const gl = this.gl;\n    gl.clearColor(0.0, 0.0, 0.0, 1.0);\n    gl.clearDepth(1.0);\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n    gl.viewport(0, 0, this.pixelWidth, this.pixelHeight);\n\n    // Tell WebGL how to pull out the positions from the position\n    // buffer into the vertexPosition attribute\n    {\n      const numComponents = 2;\n      const type = gl.FLOAT;\n      const normalize = false;\n      const stride = 0;\n      const offset = 0;\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);\n      gl.vertexAttribPointer(\n          this.positionAttribLocation, numComponents, type, normalize, stride,\n          offset);\n    }\n\n    // Tell WebGL how to pull out the texture coordinates from\n    // the texture coordinate buffer into the textureCoord attribute.\n    {\n      const numComponents = 2;\n      const type = gl.FLOAT;\n      const normalize = false;\n      const stride = 0;\n      const offset = 0;\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.textureBuffer);\n      gl.bufferData(gl.ARRAY_BUFFER, this.textureArray, gl.DYNAMIC_DRAW);\n      gl.vertexAttribPointer(\n          this.textureAttribLocation, numComponents, type, normalize, stride,\n          offset);\n    }\n\n    // Foreground color\n    {\n      const numComponents = 4;\n      const type = gl.UNSIGNED_BYTE;\n      const normalize = true;\n      const stride = 0;\n      const offset = 0;\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.foregroundBuffer);\n      gl.bufferData(\n          gl.ARRAY_BUFFER, this.foregroundUint8Array, gl.DYNAMIC_DRAW);\n      gl.vertexAttribPointer(\n          this.fgColorAttribLocation, numComponents, type, normalize, stride,\n          offset);\n    }\n\n    // Background color\n    {\n      const numComponents = 4;\n      const type = gl.UNSIGNED_BYTE;\n      const normalize = true;\n      const stride = 0;\n      const offset = 0;\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.backgroundBuffer);\n      gl.bufferData(\n          gl.ARRAY_BUFFER, this.backgroundUint8Array, gl.DYNAMIC_DRAW);\n      gl.vertexAttribPointer(\n          this.bgColorAttribLocation, numComponents, type, normalize, stride,\n          offset);\n    }\n\n    // Tell WebGL which indices to use to index the vertices\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indexBuffer);\n\n    // Tell WebGL to use our program when drawing\n    gl.useProgram(this.program);\n\n    // Tell WebGL we want to affect texture unit 0\n    gl.activeTexture(gl.TEXTURE0);\n\n    // Bind the texture to texture unit 0\n    gl.bindTexture(gl.TEXTURE_2D, this.texture);\n\n    // Tell the shader we bound the texture to texture unit 0\n    {\n      const vertexCount = this.width * this.height * 6;\n      const type = gl.UNSIGNED_SHORT;\n      const offset = 0;\n      gl.drawElements(gl.TRIANGLES, vertexCount, type, offset);\n    }\n  }\n\n  private renderLoop() {\n    this.keys.updateKeys();\n    if (this.update) {\n      this.update();\n    }\n    this.render();\n    requestAnimationFrame(this.renderLoop.bind(this));\n  }\n}\n"],"names":["COLOR_BLACK","COLOR_WHITE","COLOR_LIGHT_GRAY","COLOR_DARK_GRAY","COLOR_YELLOW","COLOR_BROWN","COLOR_LIGHT_RED","COLOR_DARK_RED","COLOR_LIGHT_GREEN","COLOR_DARK_GREEN","COLOR_LIGHT_CYAN","COLOR_DARK_CYAN","COLOR_LIGHT_BLUE","COLOR_DARK_BLUE","COLOR_LIGHT_MAGENTA","COLOR_DARK_MAGENTA","COLOR_ORANGE","createColor","r","g","b","createHsvColor","h","s","v","i","f","p","q","t","createBoolMatrix","width","height","result","Array","y","FovMap","[object Object]","blockedFunc","this","blocked","visible","originX","originY","minX","maxX","minY","maxY","radius","x","deltaX","deltaY","startSlopes","endSlopes","halfSlope","processedCell","extended","centreSlope","startSlope","endSlope","previousEndSlope","iteration","totalObstacles","obstaclesInLastLine","minSlope","Math","floor","idx","min","max","computeOctantY","computeOctantX","KEY_COUNT","Key","down","downCount","Keys","el","keys","addEventListener","e","setKey","state","stopPropagation","preventDefault","keyCode","VK_ESCAPE","VK_SPACE","VK_LEFT","VK_UP","VK_RIGHT","VK_DOWN","VK_A","VK_D","VK_M","VK_Q","VK_S","VK_W","VK_Z","RNG","seed","m","a","c","nextInt","start","end","rangeSize","FONT_CHAR_WIDTH","FONT_CHAR_HEIGHT","FONT_IMAGE","VERTEX_SHADER_SOURCE","FRAGMENT_SHADER_SOURCE","Mouse","buttons","update","offsetX","offsetY","type","button","interpolate","Terminal","canvas","pixelWidth","pixelHeight","style","outline","tabIndex","mouse","gl","getContext","antialias","Error","program","createProgram","attachShader","buildShader","VERTEX_SHADER","FRAGMENT_SHADER","linkProgram","useProgram","positionAttribLocation","getAttribLocation","textureAttribLocation","fgColorAttribLocation","bgColorAttribLocation","cellCount","positionsArray","Float32Array","indexArray","Uint16Array","textureArray","foregroundUint8Array","Uint8Array","foregroundDataView","DataView","buffer","backgroundUint8Array","backgroundDataView","j","k","positionBuffer","createBuffer","indexBuffer","textureBuffer","foregroundBuffer","backgroundBuffer","bindBuffer","ARRAY_BUFFER","bufferData","STATIC_DRAW","ELEMENT_ARRAY_BUFFER","texture","loadTexture","renderLoop","name","location","enableVertexAttribArray","isOutOfRange","textureX","textureY","textureArrayIndex","clearRect","rectX","rectY","rectWidth","rectHeight","x2","y2","setCharCode","color","index","setUint32","str","fg","bg","length","charCodeAt","fillForegroundRect","fillBackgroundRect","drawString","w","setForegroundColor","setBackgroundColor","key","getKey","count","source","sh","createShader","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","url","createTexture","bindTexture","TEXTURE_2D","internalFormat","RGBA","srcFormat","srcType","UNSIGNED_BYTE","pixel","texImage2D","image","Image","onload","texParameteri","TEXTURE_MAG_FILTER","NEAREST","TEXTURE_MIN_FILTER","generateMipmap","src","clearColor","clearDepth","clear","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","viewport","numComponents","FLOAT","normalize","stride","offset","vertexAttribPointer","DYNAMIC_DRAW","activeTexture","TEXTURE0","drawElements","TRIANGLES","UNSIGNED_SHORT","updateKeys","render","requestAnimationFrame","bind"],"mappings":"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"}