{"version":3,"file":"index.mjs","sources":["../src/blendmode.ts","../src/color.ts","../src/colors.ts","../src/cell.ts","../src/chars.ts","../src/console.ts","../src/font.ts","../src/fov.ts","../src/keys.ts","../src/rng.ts","../src/mouse.ts","../src/shaders.ts","../src/terminal.ts"],"sourcesContent":["\r\nexport enum BlendMode {\r\n  None = 0,\r\n  Blend = 1,\r\n  Add = 2\r\n}\r\n","\nexport type Color = number;\n\n/**\n * Creates a big-endian 32-bit RGBA color from red, green, and blue components.\n * @param r Red (0-255).\n * @param g Green (0-255).\n * @param b Blue (0-255).\n * @param a Optional alpha (0-255).\n * @return A 32-bit unsigned integer color.\n */\nexport function fromRgb(r: number, g: number, b: number, a?: number): Color {\n  if (a === undefined) {\n    a = 255;\n  }\n  return ((r << 24) + (g << 16) + (b << 8) + a) as Color;\n}\n\n\n/**\n * Converts a color from HSV format to RGBA format.\n *\n * Based on: https://stackoverflow.com/a/17243070/2051724\n *\n * @param h Hue (0.0 - 1.0).\n * @param s Saturation (0.0 - 1.0).\n * @param v Value (0.0 - 1.0).\n * @param a Optional alpha (0.0 - 1.0).\n * @return A 32-bit unsigned integer color.\n */\nexport function fromHsv(h: number, s: number, v: number, a?: number): Color {\n  const i = (h * 6) | 0;\n  const f = h * 6 - i;\n  const p = v * (1 - s);\n  const q = v * (1 - f * s);\n  const t = v * (1 - (1 - f) * s);\n  let r, g, b;\n  switch (i % 6) {\n    case 0:\n      r = v, g = t, b = p;\n      break;\n    case 1:\n      r = q, g = v, b = p;\n      break;\n    case 2:\n      r = p, g = v, b = t;\n      break;\n    case 3:\n      r = p, g = q, b = v;\n      break;\n    case 4:\n      r = t, g = p, b = v;\n      break;\n    case 5:\n      r = v, g = p, b = q;\n      break;\n    default:\n      r = 0;\n      g = 0;\n      b = 0;\n  }\n  if (a === undefined) {\n    a = 1.0;\n  }\n  return fromRgb((r * 255) | 0, (g * 255) | 0, (b * 255) | 0, (a * 255) | 0);\n}\n","\nimport {fromRgb} from './color';\n\nexport class Colors {\n  static readonly BLACK = fromRgb(0, 0, 0);\n  static readonly WHITE = fromRgb(0xff, 0xff, 0xff);\n  static readonly LIGHT_GRAY = fromRgb(0xaa, 0xaa, 0xaa);\n  static readonly DARK_GRAY = fromRgb(0x55, 0x55, 0x55);\n  static readonly YELLOW = fromRgb(0xff, 0xff, 0x55);\n  static readonly BROWN = fromRgb(0xaa, 0x55, 0x00);\n  static readonly LIGHT_RED = fromRgb(0xff, 0x55, 0x55);\n  static readonly DARK_RED = fromRgb(0xaa, 0x00, 0x00);\n  static readonly LIGHT_GREEN = fromRgb(0x55, 0xff, 0x55);\n  static readonly DARK_GREEN = fromRgb(0x00, 0xaa, 0x00);\n  static readonly LIGHT_CYAN = fromRgb(0x55, 0xff, 0xff);\n  static readonly DARK_CYAN = fromRgb(0x00, 0xaa, 0xaa);\n  static readonly LIGHT_BLUE = fromRgb(0x55, 0x55, 0xff);\n  static readonly DARK_BLUE = fromRgb(0x00, 0x00, 0xaa);\n  static readonly LIGHT_MAGENTA = fromRgb(0xff, 0x55, 0xff);\n  static readonly DARK_MAGENTA = fromRgb(0xaa, 0x00, 0xaa);\n  static readonly ORANGE = fromRgb(0xff, 0x88, 0x00);\n}\n","\nimport {BlendMode} from './blendmode';\nimport {Color, fromRgb} from './color';\nimport {Colors} from './colors';\n\nfunction convertCharCode(charCode: number|string): number {\n  if ((typeof charCode === 'string') && charCode.length > 0) {\n    return charCode.charCodeAt(0);\n  } else {\n    return charCode as number;\n  }\n}\n\nexport class Cell {\n  charCode: number;\n  fg: Color;\n  bg: Color;\n  meta?: object;\n  dirty: boolean;\n\n  constructor(charCode?: number|string, fg?: Color, bg?: Color, meta?: object) {\n    if (charCode !== undefined) {\n      this.charCode = convertCharCode(charCode) as number;\n    } else {\n      this.charCode = ' '.charCodeAt(0);\n    }\n\n    if (fg !== undefined) {\n      this.fg = fg;\n    } else {\n      this.fg = Colors.WHITE;\n    }\n\n    if (bg !== undefined) {\n      this.bg = bg;\n    } else {\n      this.bg = Colors.BLACK;\n    }\n\n    if (meta !== undefined) {\n      this.meta = meta;\n    }\n\n    this.dirty = true;\n  }\n\n  setCharCode(charCode: number) {\n    if (this.charCode !== charCode) {\n      this.charCode = charCode;\n      this.dirty = true;\n    }\n  }\n\n  setForeground(fg?: Color) {\n    if (fg !== undefined && fg !== null && fg !== this.fg) {\n      this.fg = fg;\n      this.dirty = true;\n    }\n  }\n\n  setBackground(bg?: Color) {\n    if (bg !== undefined && bg !== null && bg !== this.bg) {\n      this.bg = bg;\n      this.dirty = true;\n    }\n  }\n\n  setMeta(meta?: object) {\n    if (meta !== undefined) {\n      this.meta = meta;\n      this.dirty = true;\n    }\n  }\n\n  setValue(charCode: number, fg?: Color, bg?: Color, meta?: object) {\n    this.setCharCode(charCode);\n    this.setForeground(fg);\n    this.setBackground(bg);\n    this.setMeta(meta);\n    return this.dirty;\n  }\n\n  drawCell(otherCell: Cell, blendMode: BlendMode) {\n    const alpha = otherCell.bg & 0xFF;\n\n    if (blendMode === BlendMode.None || otherCell.charCode > 0) {\n      this.setCharCode(otherCell.charCode);\n      this.setForeground(otherCell.fg);\n    } else if (alpha > 0 && alpha < 255) {\n      this.setForeground(this.blendColors(this.fg, otherCell.bg, blendMode));\n    }\n\n    if (blendMode === BlendMode.None || alpha === 255) {\n      this.setBackground(otherCell.bg);\n    } else if (alpha > 0) {\n      this.setBackground(this.blendColors(this.bg, otherCell.bg, blendMode));\n    }\n  }\n\n  private blendColors(c1: Color, c2: Color, blendMode: BlendMode): Color {\n    const alpha = c2 & 0xFF;\n    const w1 = (255 - alpha) / 255.0;\n    const w2 = 1.0 - w1;\n    const r1 = (c1 >> 24) & 0xFF;\n    const g1 = (c1 >> 16) & 0xFF;\n    const b1 = (c1 >> 8) & 0xFF;\n    const r2 = (c2 >> 24) & 0xFF;\n    const g2 = (c2 >> 16) & 0xFF;\n    const b2 = (c2 >> 8) & 0xFF;\n\n    switch (blendMode) {\n      case BlendMode.Blend:\n        return fromRgb(\n            (w1 * r1 + w2 * r2) | 0, (w1 * g1 + w2 * g2) | 0,\n            (w1 * b1 + w2 * b2) | 0);\n\n      case BlendMode.Add:\n        return fromRgb(\n            this.clamp((r1 + w2 * r2) | 0), this.clamp((g1 + w2 * g2) | 0),\n            this.clamp((b1 + w2 * b2) | 0));\n\n      default:\n        return c2;\n    }\n  }\n\n  private clamp(x: number): number {\n    return Math.min(255, x);\n  }\n}\n","\n\n// https://en.wikipedia.org/wiki/Code_page_437\n// https://en.wikipedia.org/wiki/Block_Elements\n// https://en.wikipedia.org/wiki/Box-drawing_character\n\nexport class Chars {\n  static readonly SMILEY = 1;\n  static readonly INVERSE_SMILEY = 2;\n  static readonly HEART = 3;\n  static readonly DIAMOND = 4;\n  static readonly CLUB = 5;\n  static readonly SPADE = 6;\n  static readonly BULLET = 7;\n  static readonly INVERSE_BULLET = 8;\n\n  static readonly LIGHT_SHADE = 176;\n  static readonly MEDIUM_SHADE = 177;\n  static readonly DARK_SHADE = 178;\n\n  static readonly BOX_SINGLE_VERTICAL = 179;\n  static readonly BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT = 180;\n  static readonly BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT = 185;\n  static readonly BOX_DOUBLE_VERTICAL = 186;\n  static readonly BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT = 187;\n  static readonly BOX_DOUBLE_UP_AND_DOUBLE_LEFT = 188;\n  static readonly BOX_SINGLE_DOWN_AND_SINGLE_LEFT = 191;\n  static readonly BOX_SINGLE_UP_AND_SINGLE_RIGHT = 192;\n  static readonly BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP = 193;\n  static readonly BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN = 194;\n  static readonly BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT = 195;\n  static readonly BOX_SINGLE_HORIZONTAL = 196;\n  static readonly BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL = 197;\n  static readonly BOX_DOUBLE_UP_AND_DOUBLE_RIGHT = 200;\n  static readonly BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT = 201;\n  static readonly BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP = 202;\n  static readonly BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN = 203;\n  static readonly BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT = 204;\n  static readonly BOX_DOUBLE_HORIZONTAL = 205;\n  static readonly BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL = 206;\n  static readonly BOX_SINGLE_UP_AND_SINGLE_LEFT = 13 * 16 + 9;\n  static readonly BOX_SINGLE_DOWN_AND_SINGLE_RIGHT = 13 * 16 + 10;\n\n  static readonly CHECKER = 14 * 16 + 6;\n}\n","\nimport {BlendMode} from './blendmode';\nimport {Cell} from './cell';\nimport {Chars} from './chars';\nimport {Color} from './color';\n\nexport class Console {\n  readonly width: number;\n  readonly height: number;\n  private readonly grid: Cell[][];\n\n  constructor(width: number, height: number) {\n    this.width = width;\n    this.height = height;\n    this.grid = new Array();\n\n    for (let y = 0; y < height; y++) {\n      const row = new Array();\n      for (let x = 0; x < width; x++) {\n        row.push(new Cell());\n      }\n      this.grid.push(row);\n    }\n\n    this.clear();\n  }\n\n  clear() {\n    for (let y = 0; y < this.height; y++) {\n      for (let x = 0; x < this.width; x++) {\n        this.drawChar(x, y, 0);\n      }\n    }\n  }\n\n  getCell(x: number, y: number) {\n    if (x < 0 || y < 0 || x >= this.width || y >= this.height) {\n      return undefined;\n    }\n    return this.grid[y][x];\n  }\n\n  drawChar(x: number, y: number, c: number, fg?: Color, bg?: Color) {\n    if (x >= 0 && x < this.width && y >= 0 && y < this.height) {\n      this.grid[y][x].setValue(c, fg, bg);\n    }\n  }\n\n  drawString(x: number, y: number, str: string, fg?: Color, bg?: Color) {\n    for (let i = 0; i < str.length; i++) {\n      this.drawChar(x + i, y, str.charCodeAt(i), fg, bg);\n    }\n  }\n\n  drawCenteredString(\n      x: number, y: number, str: string, fg?: Color, bg?: Color) {\n    this.drawString(x - Math.floor(str.length / 2), y, str, fg, bg);\n  }\n\n  drawHLine(\n      x: number, y: number, width: number, c: number, fg?: Color, bg?: Color) {\n    for (let xi = x; xi < x + width; xi++) {\n      this.drawChar(xi, y, c, fg, bg);\n    }\n  }\n\n  drawVLine(\n      x: number, y: number, height: number, c: number, fg?: Color, bg?: Color) {\n    for (let yi = y; yi < y + height; yi++) {\n      this.drawChar(x, yi, c, fg, bg);\n    }\n  }\n\n  drawRect(\n      x: number, y: number, width: number, height: number, c: number,\n      fg?: Color, bg?: Color) {\n    this.drawHLine(x, y, width, c, fg, bg);\n    this.drawHLine(x, y + height - 1, width, c, fg, bg);\n    this.drawVLine(x, y, height, c, fg, bg);\n    this.drawVLine(x + width - 1, y, height, c, fg, bg);\n  }\n\n  drawDoubleBox(\n      x: number, y: number, width: number, height: number, fg?: Color,\n      bg?: Color) {\n    this.fillRect(x, y, width, height, 0, fg, bg);\n\n    this.drawHLine(x, y, width, Chars.BOX_DOUBLE_HORIZONTAL);\n    this.drawHLine(x, y + height - 1, width, Chars.BOX_DOUBLE_HORIZONTAL);\n\n    this.drawVLine(x, y, height, Chars.BOX_DOUBLE_VERTICAL);\n    this.drawVLine(x + width - 1, y, height, Chars.BOX_DOUBLE_VERTICAL);\n\n    this.drawChar(x, y, Chars.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT);\n    this.drawChar(x + width - 1, y, Chars.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT);\n    this.drawChar(x, y + height - 1, Chars.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT);\n    this.drawChar(\n        x + width - 1, y + height - 1, Chars.BOX_DOUBLE_UP_AND_DOUBLE_LEFT);\n  }\n\n  fillRect(\n      x: number, y: number, width: number, height: number, c: number,\n      fg?: Color, bg?: Color) {\n    for (let yi = y; yi < y + height; yi++) {\n      this.drawHLine(x, yi, width, c, fg, bg);\n    }\n  }\n\n  drawConsole(\n      dstX: number, dstY: number, srcConsole: Console, srcX: number,\n      srcY: number, srcWidth: number, srcHeight: number,\n      blendMode?: BlendMode) {\n    blendMode = blendMode || BlendMode.None;\n\n    for (let y = 0; y < srcHeight; y++) {\n      for (let x = 0; x < srcWidth; x++) {\n        const cell = srcConsole.getCell(srcX + x, srcY + y);\n        if (cell) {\n          this.drawCell(dstX + x, dstY + y, cell, blendMode);\n        }\n      }\n    }\n  }\n\n  private drawCell(x: number, y: number, cell: Cell, blendMode: BlendMode) {\n    if (x >= 0 && x < this.width && y >= 0 && y < this.height) {\n      this.grid[y][x].drawCell(cell, blendMode);\n    }\n  }\n}\n","\nexport class Font {\n  readonly url: string;\n  readonly charWidth: number;\n  readonly charHeight: number;\n  readonly scale: number;\n  readonly graphical: boolean;\n\n  constructor(\n      url: string, charWidth: number, charHeight: number, scale?: number,\n      graphical?: boolean) {\n    this.url = url;\n    this.charWidth = charWidth;\n    this.charHeight = charHeight;\n    this.scale = scale || 1.0;\n    this.graphical = !!graphical;\n  }\n}\n\n/**\n * Font image as data URL.\n * IBM terminal font.\n * See img/font.png.\n */\nconst FONT_IMAGE = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAA' +\n    'ACAAQMAAAD58POIAAAABlBMVEUAAAD///+l2Z/dAAAEtElEQVRIx2WTsYsUMRTGPxT' +\n    'OJniWgRMFsbR4oJyDBE+s/AdsrIJKtEixIKwPHOc8tbCwsdNKLCy0tlBQGBCnel55C' +\n    'K5y1dqIbKVbhBlfZkYP8UsI2d98ed+bMAtUVTxUHELn3Krb2HwCbHVtUSo4f/5AOHn' +\n    'lEvD8c1sWhf229WQ1bGy63tG2pXu/9e52oCvfgHfvy7JtMxDXgyffimKnzEfETq71R' +\n    'w6pclGpFvNLORYoihzLdrd+gjv7bNisYK3FoN2DLnx+D+esJRy3HZZnq/CZ9aA1vg6' +\n    'uQ9vacEvykbatu6pShw1rooYqOzqnNSqsceWss9Qe76ymuLD2sNpLAXS3RIe/4hgJh' +\n    'bceWSs9SE30RIEUmAzaWoraW0fDeUZMdgpvu4QEhYTW0AyjI1dSRxDkGhNQnR2Rmil' +\n    'yCoHuYE+jn4n5cCoSc47wDFmIuNqLSH9EMCNj4rI2IkQ+WYNERSFmabkkjTAW38mb1' +\n    'giJAdRB0K2o34ulCYEATokNs+cJkabQf22gpORS2zrhI/NF0xRoOIR4+XIQMsH/mEd' +\n    '8lVCH69drBdG3PxsFZR2Y60SG/c5XBal3bGt8vNxsN6gl1/BaQzdNE8GSUxZnhXne5' +\n    'pT/lFiHSNNIyzUfAoIEedUD8d4WPdglBVEee7IRKKUsFOwUTN7aBvAzPqygjXTZGws' +\n    'FHIWEfzTU+JUMFofnzImahlvex/hPHQi7OIwCu2R3JxkRPAyiruP96f2zYT+NEw70f' +\n    'cmACVLKQqbaFbUiQBlqSV4CWaadDCSI1L4M2dFkMH3LU16YOX+acyOMUUtggr86hF6' +\n    'H7e502NIAyNKswGz6qSz7C0oKEBEk1uMF5XdoMuD+goTUoaAsvTkl3Mby6gC8WSztl' +\n    'GJjkqagxeLIXie9GLYS76CLlF4IIvQeFFgXNEQXUIMdsxNdJsWECbXIijErdRDRFGG' +\n    'IpLNleVaqlDIQsOSHgX1dK0gJVPFGVW2Q1tBi6vB73+ggi7MMzx6NoDiDgyBEEdIBI' +\n    'EasIW3KYC2lvLotFt60zCwijWwvdrgCb4qqBzt+TuoYf6dG5vPIVmtsM3NVmZLL9Fo' +\n    '+Af9exwTWGjOdOkcO83lGRNbOZjHgkrZhTwp4knEM9BzMCAGGWJbfzzr/JlU3rJxES' +\n    'TkTqF+YK9esOiSDWVVJMNsfndaotAkRgB0eP3X4R0f3WwDHLn7RVrh26+tYtwI8eHn' +\n    'TWnvfnx/A6CCiNz/X258Vjw5mfrayvrJSp8Gx1GR1/GxrWg6OlJLWWEeV7FBDHS4DS' +\n    '3ZwQPUH6C8d0+k6hjGC2WwEd0fAdHrjV3e6+9WOwDARoDPiaNfpLGVDH+uMGKpIygV' +\n    '0tiOoZAR3RwCMAPiUWLzGiEUH6ztM4n1QTffRA+rwKeibnWPmHnAH89N7v0tEGUAdL' +\n    'jAzFCy1HZtbi+rIAHYARVJBXT1g7CkDqLpusdphsaoJvm9xa2sEdJ+IEmHr3gikH8D' +\n    'Whz9A1YMXAFZXVxei4gwe7YFEGWyNgJkN97Ej+PutEuabFaEAipIHcOLze0IU8EGTQ' +\n    'QJ/ZiAC1hUuO9LJW5JQKDjoFWjUtzWBylZlqUDRxzUmDMog4enaQ1Kyp/1Y7v1vfwP' +\n    'x3em+Z+50IgAAAABJRU5ErkJggg==';\n\nexport const DEFAULT_FONT = new Font(FONT_IMAGE, 8, 8);\n","\n// MRPAS\n// Mingos' Restrictive Precise Angle Shadowcasting\n// https://bitbucket.org/mingos/mrpas/overview\n\nfunction createBoolMatrix(width: number, height: number) {\n  const result = new Array(height);\n  for (let y = 0; y < height; y++) {\n    result[y] = new Array(width);\n  }\n  return result;\n}\n\nexport class FovMap {\n  private readonly width: number;\n  private readonly height: number;\n  private readonly blocked: boolean[][];\n  private readonly visible: boolean[][];\n  private originX: number;\n  private originY: number;\n  private minX: number;\n  private maxX: number;\n  private minY: number;\n  private maxY: number;\n  private radius: number;\n\n  /**\n   * Creates a new FOV map.\n   * @constructor\n   * @param width\n   * @param height\n   * @param blockedFunc\n   */\n  constructor(width: number, height: number, blockedFunc?: Function) {\n    this.width = width;\n    this.height = height;\n    this.blocked = createBoolMatrix(width, height);\n    this.visible = createBoolMatrix(width, height);\n    this.originX = 0;\n    this.originY = 0;\n    this.minX = 0;\n    this.maxX = 0;\n    this.minY = 0;\n    this.maxY = 0;\n    this.radius = 0;\n\n    if (blockedFunc) {\n      for (let y = 0; y < height; y++) {\n        for (let x = 0; x < width; x++) {\n          this.blocked[y][x] = blockedFunc(x, y);\n        }\n      }\n    }\n  }\n\n  setBlocked(x: number, y: number, blocked: boolean) {\n    if (x >= 0 && x < this.width && y >= 0 && y < this.height) {\n      this.blocked[y][x] = blocked;\n    }\n  }\n\n  isVisible(x: number, y: number) {\n    if (x < 0 || x >= this.width || y < 0 || y >= this.height) {\n      return false;\n    }\n    return this.visible[y][x];\n  }\n\n  /**\n   * Compute the FOV in an octant adjacent to the Y axis\n   */\n  private computeOctantY(deltaX: number, deltaY: number) {\n    const startSlopes: number[] = [];\n    const endSlopes: number[] = [];\n    let iteration = 1;\n    let totalObstacles = 0;\n    let obstaclesInLastLine = 0;\n    let minSlope = 0;\n    let x;\n    let y;\n    let halfSlope;\n    let processedCell;\n    let visible;\n    let extended;\n    let centreSlope;\n    let startSlope;\n    let endSlope;\n    let previousEndSlope;\n\n    for (y = this.originY + deltaY; y >= this.minY && y <= this.maxY;\n         y += deltaY, obstaclesInLastLine = totalObstacles, ++iteration) {\n      halfSlope = 0.5 / iteration;\n      previousEndSlope = -1;\n      for (processedCell = Math.floor(minSlope * iteration + 0.5),\n          x = this.originX + (processedCell * deltaX);\n           processedCell <= iteration && x >= this.minX && x <= this.maxX;\n           x += deltaX, ++processedCell, previousEndSlope = endSlope) {\n        visible = true;\n        extended = false;\n        centreSlope = processedCell / iteration;\n        startSlope = previousEndSlope;\n        endSlope = centreSlope + halfSlope;\n\n        if (obstaclesInLastLine > 0) {\n          if (!(this.visible[y - deltaY][x] && !this.blocked[y - deltaY][x]) &&\n              !(this.visible[y - deltaY][x - deltaX] &&\n                !this.blocked[y - deltaY][x - deltaX])) {\n            visible = false;\n          } else {\n            for (let idx = 0; idx < obstaclesInLastLine && visible; ++idx) {\n              if (startSlope <= endSlopes[idx] &&\n                  endSlope >= startSlopes[idx]) {\n                if (!this.blocked[y][x]) {\n                  if (centreSlope > startSlopes[idx] &&\n                      centreSlope < endSlopes[idx]) {\n                    visible = false;\n                    break;\n                  }\n                } else {\n                  if (startSlope >= startSlopes[idx] &&\n                      endSlope <= endSlopes[idx]) {\n                    visible = false;\n                    break;\n                  } else {\n                    startSlopes[idx] = Math.min(startSlopes[idx], startSlope);\n                    endSlopes[idx] = Math.max(endSlopes[idx], endSlope);\n                    extended = true;\n                  }\n                }\n              }\n            }\n          }\n        }\n        if (visible) {\n          this.visible[y][x] = true;\n          if (this.blocked[y][x]) {\n            if (minSlope >= startSlope) {\n              minSlope = endSlope;\n            } else if (!extended) {\n              startSlopes[totalObstacles] = startSlope;\n              endSlopes[totalObstacles++] = endSlope;\n            }\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * Compute the FOV in an octant adjacent to the X axis\n   */\n  private computeOctantX(deltaX: number, deltaY: number) {\n    const startSlopes: number[] = [];\n    const endSlopes: number[] = [];\n    let iteration = 1;\n    let totalObstacles = 0;\n    let obstaclesInLastLine = 0;\n    let minSlope = 0;\n    let x;\n    let y;\n    let halfSlope;\n    let processedCell;\n    let visible;\n    let extended;\n    let centreSlope;\n    let startSlope;\n    let endSlope;\n    let previousEndSlope;\n\n    for (x = this.originX + deltaX; x >= this.minX && x <= this.maxX;\n         x += deltaX, obstaclesInLastLine = totalObstacles, ++iteration) {\n      halfSlope = 0.5 / iteration;\n      previousEndSlope = -1;\n      for (processedCell = Math.floor(minSlope * iteration + 0.5),\n          y = this.originY + (processedCell * deltaY);\n           processedCell <= iteration && y >= this.minY && y <= this.maxY;\n           y += deltaY, ++processedCell, previousEndSlope = endSlope) {\n        visible = true;\n        extended = false;\n        centreSlope = processedCell / iteration;\n        startSlope = previousEndSlope;\n        endSlope = centreSlope + halfSlope;\n\n        if (obstaclesInLastLine > 0) {\n          if (!(this.visible[y][x - deltaX] && !this.blocked[y][x - deltaX]) &&\n              !(this.visible[y - deltaY][x - deltaX] &&\n                !this.blocked[y - deltaY][x - deltaX])) {\n            visible = false;\n          } else {\n            for (let idx = 0; idx < obstaclesInLastLine && visible; ++idx) {\n              if (startSlope <= endSlopes[idx] &&\n                  endSlope >= startSlopes[idx]) {\n                if (!this.blocked[y][x]) {\n                  if (centreSlope > startSlopes[idx] &&\n                      centreSlope < endSlopes[idx]) {\n                    visible = false;\n                    break;\n                  }\n                } else {\n                  if (startSlope >= startSlopes[idx] &&\n                      endSlope <= endSlopes[idx]) {\n                    visible = false;\n                    break;\n                  } else {\n                    startSlopes[idx] = Math.min(startSlopes[idx], startSlope);\n                    endSlopes[idx] = Math.max(endSlopes[idx], endSlope);\n                    extended = true;\n                  }\n                }\n              }\n            }\n          }\n        }\n        if (visible) {\n          this.visible[y][x] = true;\n          if (this.blocked[y][x]) {\n            if (minSlope >= startSlope) {\n              minSlope = endSlope;\n            } else if (!extended) {\n              startSlopes[totalObstacles] = startSlope;\n              endSlopes[totalObstacles++] = endSlope;\n            }\n          }\n        }\n      }\n    }\n  }\n\n  computeFov(originX: number, originY: number, radius: number) {\n    for (let y = 0; y < this.height; y++) {\n      for (let x = 0; x < this.width; x++) {\n        this.visible[y][x] = false;\n      }\n    }\n\n    this.visible[originY][originX] = true;\n    this.originX = originX;\n    this.originY = originY;\n    this.radius = radius;\n    this.minX = Math.max(0, originX - radius);\n    this.minY = Math.max(0, originY - radius);\n    this.maxX = Math.min(this.width - 1, originX + radius);\n    this.maxY = Math.min(this.height - 1, originY + radius);\n\n    this.computeOctantY(1, 1);\n    this.computeOctantX(1, 1);\n    this.computeOctantY(1, -1);\n    this.computeOctantX(1, -1);\n    this.computeOctantY(-1, 1);\n    this.computeOctantX(-1, 1);\n    this.computeOctantY(-1, -1);\n    this.computeOctantX(-1, -1);\n  }\n}\n","\n/**\n * Number of keys to track.\n */\nconst KEY_COUNT = 256;\n\n/**\n * Creates a new key instance.\n */\nexport class Key {\n  down: boolean;\n  downCount: number;\n\n  constructor() {\n    this.down = false;\n    this.downCount = 0;\n  }\n}\n\nexport class Keys {\n  private readonly keys: Key[];\n\n  /**\n   * Creates a new keyboard module.\n   *\n   * @param el DOM el to attach listeners.\n   */\n  constructor(el: Element) {\n    this.keys = new Array(KEY_COUNT);\n    for (let i = 0; i < KEY_COUNT; i++) {\n      this.keys[i] = new Key();\n    }\n\n    el.addEventListener('keydown', e => this.setKey(e as KeyboardEvent, true));\n    el.addEventListener('keyup', e => this.setKey(e as KeyboardEvent, false));\n  }\n\n\n  setKey(e: KeyboardEvent, state: boolean) {\n    e.stopPropagation();\n    e.preventDefault();\n    const keyCode = e.keyCode;\n    if (keyCode >= 0 && keyCode < KEY_COUNT) {\n      this.keys[keyCode].down = state;\n    }\n  }\n\n  updateKeys() {\n    for (let i = 0; i < KEY_COUNT; i++) {\n      if (this.keys[i].down) {\n        this.keys[i].downCount++;\n      } else {\n        this.keys[i].downCount = 0;\n      }\n    }\n  }\n\n  getKey(keyCode: number) {\n    return keyCode >= 0 && keyCode < KEY_COUNT ? this.keys[keyCode] : null;\n  }\n}\n\nexport const VK_CANCEL = 3;\nexport const VK_HELP = 6;\nexport const VK_BACK_SPACE = 8;\nexport const VK_TAB = 9;\nexport const VK_CLEAR = 12;\nexport const VK_RETURN = 13;\nexport const VK_ENTER = 14;\nexport const VK_SHIFT = 16;\nexport const VK_CONTROL = 17;\nexport const VK_ALT = 18;\nexport const VK_PAUSE = 19;\nexport const VK_CAPS_LOCK = 20;\nexport const VK_ESCAPE = 27;\nexport const VK_SPACE = 32;\nexport const VK_PAGE_UP = 33;\nexport const VK_PAGE_DOWN = 34;\nexport const VK_END = 35;\nexport const VK_HOME = 36;\nexport const VK_LEFT = 37;\nexport const VK_UP = 38;\nexport const VK_RIGHT = 39;\nexport const VK_DOWN = 40;\nexport const VK_PRINTSCREEN = 44;\nexport const VK_INSERT = 45;\nexport const VK_DELETE = 46;\nexport const VK_0 = 48;\nexport const VK_1 = 49;\nexport const VK_2 = 50;\nexport const VK_3 = 51;\nexport const VK_4 = 52;\nexport const VK_5 = 53;\nexport const VK_6 = 54;\nexport const VK_7 = 55;\nexport const VK_8 = 56;\nexport const VK_9 = 57;\nexport const VK_COLON = 58;\nexport const VK_SEMICOLON = 59;\nexport const VK_LESS_THAN = 60;\nexport const VK_EQUALS = 61;\nexport const VK_GREATER_THAN = 62;\nexport const VK_QUESTION_MARK = 63;\nexport const VK_AT = 64;\nexport const VK_A = 65;\nexport const VK_B = 66;\nexport const VK_C = 67;\nexport const VK_D = 68;\nexport const VK_E = 69;\nexport const VK_F = 70;\nexport const VK_G = 71;\nexport const VK_H = 72;\nexport const VK_I = 73;\nexport const VK_J = 74;\nexport const VK_K = 75;\nexport const VK_L = 76;\nexport const VK_M = 77;\nexport const VK_N = 78;\nexport const VK_O = 79;\nexport const VK_P = 80;\nexport const VK_Q = 81;\nexport const VK_R = 82;\nexport const VK_S = 83;\nexport const VK_T = 84;\nexport const VK_U = 85;\nexport const VK_V = 86;\nexport const VK_W = 87;\nexport const VK_X = 88;\nexport const VK_Y = 89;\nexport const VK_Z = 90;\nexport const VK_CONTEXT_MENU = 93;\nexport const VK_NUMPAD0 = 96;\nexport const VK_NUMPAD1 = 97;\nexport const VK_NUMPAD2 = 98;\nexport const VK_NUMPAD3 = 99;\nexport const VK_NUMPAD4 = 100;\nexport const VK_NUMPAD5 = 101;\nexport const VK_NUMPAD6 = 102;\nexport const VK_NUMPAD7 = 103;\nexport const VK_NUMPAD8 = 104;\nexport const VK_NUMPAD9 = 105;\nexport const VK_MULTIPLY = 106;\nexport const VK_ADD = 107;\nexport const VK_SEPARATOR = 108;\nexport const VK_SUBTRACT = 109;\nexport const VK_DECIMAL = 110;\nexport const VK_DIVIDE = 111;\nexport const VK_F1 = 112;\nexport const VK_F2 = 113;\nexport const VK_F3 = 114;\nexport const VK_F4 = 115;\nexport const VK_F5 = 116;\nexport const VK_F6 = 117;\nexport const VK_F7 = 118;\nexport const VK_F8 = 119;\nexport const VK_F9 = 120;\nexport const VK_F10 = 121;\nexport const VK_F11 = 122;\nexport const VK_F12 = 123;\nexport const VK_F13 = 124;\nexport const VK_F14 = 125;\nexport const VK_F15 = 126;\nexport const VK_F16 = 127;\nexport const VK_F17 = 128;\nexport const VK_F18 = 129;\nexport const VK_F19 = 130;\nexport const VK_F20 = 131;\nexport const VK_F21 = 132;\nexport const VK_F22 = 133;\nexport const VK_F23 = 134;\nexport const VK_F24 = 135;\nexport const VK_NUM_LOCK = 144;\nexport const VK_SCROLL_LOCK = 145;\nexport const VK_CIRCUMFLEX = 160;\nexport const VK_EXCLAMATION = 161;\nexport const VK_DOUBLE_QUOTE = 162;\nexport const VK_HASH = 163;\nexport const VK_DOLLAR = 164;\nexport const VK_PERCENT = 165;\nexport const VK_AMPERSAND = 166;\nexport const VK_UNDERSCORE = 167;\nexport const VK_OPEN_PAREN = 168;\nexport const VK_CLOSE_PAREN = 169;\nexport const VK_ASTERISK = 170;\nexport const VK_PLUS = 171;\nexport const VK_PIPE = 172;\nexport const VK_HYPHEN_MINUS = 173;\nexport const VK_OPEN_CURLY_BRACKET = 174;\nexport const VK_CLOSE_CURLY_BRACKET = 175;\nexport const VK_TILDE = 176;\nexport const VK_COMMA = 188;\nexport const VK_PERIOD = 190;\nexport const VK_SLASH = 191;\nexport const VK_BACK_QUOTE = 192;\nexport const VK_OPEN_BRACKET = 219;\nexport const VK_BACK_SLASH = 220;\nexport const VK_CLOSE_BRACKET = 221;\nexport const VK_QUOTE = 222;\nexport const VK_META = 224;\nexport const VK_ALTGR = 225;\nexport const VK_WIN = 91;\nexport const VK_KANA = 21;\nexport const VK_HANGUL = 21;\nexport const VK_EISU = 22;\nexport const VK_JUNJA = 23;\nexport const VK_FINAL = 24;\nexport const VK_HANJA = 25;\nexport const VK_KANJI = 25;\nexport const VK_CONVERT = 28;\nexport const VK_NONCONVERT = 29;\nexport const VK_ACCEPT = 30;\nexport const VK_MODECHANGE = 31;\nexport const VK_SELECT = 41;\nexport const VK_PRINT = 42;\nexport const VK_EXECUTE = 43;\nexport const VK_SLEEP = 95;\n","\n/**\n * Random number generator.\n *\n * LCG\n * https://stackoverflow.com/a/424445/2051724\n */\nexport class RNG {\n  private readonly m: number;\n  private readonly a: number;\n  private readonly c: number;\n  private state: number;\n\n  /**\n   * Creates a new random number generator.\n   *\n   * @param seed The integer seed.\n   */\n  constructor(seed: number) {\n    // LCG using GCC's constants\n    this.m = 0x80000000;  // 2**31;\n    this.a = 1103515245;\n    this.c = 12345;\n    this.state = seed || 1;\n  }\n\n  private nextInt() {\n    this.state = (this.a * this.state + this.c) % this.m;\n    return this.state;\n  }\n\n  nextFloat() {\n    // returns in range [0,1]\n    return this.nextInt() / (this.m - 1);\n  }\n\n  nextRange(start: number, end: number) {\n    // returns in range [start, end): including start, excluding end\n    // can't modulu nextInt because of weak randomness in lower bits\n    const rangeSize = end - start;\n    const randomUnder1 = this.nextInt() / this.m;\n    return start + ((randomUnder1 * rangeSize) | 0);\n  }\n}\n","import {Terminal} from './terminal';\nimport { Fullscreenable } from './fullscreenable';\nimport { TerminalOptions } from './terminaloptions';\n\nexport class Mouse {\n  private readonly el: HTMLElement;\n  private readonly width: number;\n  private readonly height: number;\n  private readonly options: TerminalOptions;\n  readonly buttons: boolean[];\n  private prevX: number;\n  private prevY: number;\n  x: number;\n  y: number;\n  dx: number;\n  dy: number;\n\n  constructor(terminal: Terminal, options: TerminalOptions) {\n    this.el = terminal.canvas;\n    this.width = terminal.width;\n    this.height = terminal.height;\n    this.options = options;\n    this.prevX = 0;\n    this.prevY = 0;\n    this.x = 0;\n    this.y = 0;\n    this.dx = 0;\n    this.dy = 0;\n    this.buttons = [false, false, false];\n\n    const el = this.el;\n    el.addEventListener('mousedown', e => this.handleEvent(e as MouseEvent));\n    el.addEventListener('mouseup', e => this.handleEvent(e as MouseEvent));\n    el.addEventListener('mousemove', e => this.handleEvent(e as MouseEvent));\n\n    const touchEventHandler = this.handleTouchEvent.bind(this);\n    el.addEventListener('touchstart', touchEventHandler);\n    el.addEventListener('touchend', touchEventHandler);\n    el.addEventListener('touchcancel', touchEventHandler);\n    el.addEventListener('touchmove', touchEventHandler);\n  }\n\n  private handleTouchEvent(e: TouchEvent) {\n    e.stopPropagation();\n    e.preventDefault();\n\n    if (e.type === 'touchend' && this.options.requestFullscreen) {\n      this.requestFullscreen();\n    }\n\n    if (e.touches.length > 0) {\n      const touch = e.touches[0];\n      this.updatePosition(touch.clientX, touch.clientY);\n      this.buttons[0] = true;\n    } else {\n      this.buttons[0] = false;\n    }\n  }\n\n  private handleEvent(e: MouseEvent) {\n    e.stopPropagation();\n    e.preventDefault();\n\n    this.updatePosition(e.clientX, e.clientY);\n\n    if (e.type === 'mousedown') {\n      this.buttons[e.button] = true;\n      if (this.options.requestFullscreen) {\n        this.requestFullscreen();\n      }\n    }\n\n    if (e.type === 'mouseup') {\n      this.buttons[e.button] = false;\n    }\n  }\n\n  private updatePosition(clientX: number, clientY: number) {\n    let rect: any = this.el.getBoundingClientRect();\n\n    // If the client rect is not the same aspect ratio as canvas,\n    // then we are fullscreen.\n    // Need to update client rect accordingly.\n\n    const terminalAspectRatio = this.width / this.height;\n    const rectAspectRatio = rect.width / rect.height;\n\n    if (rectAspectRatio - terminalAspectRatio > 0.001) {\n      const actualRectWidth = terminalAspectRatio * rect.height;\n      const rectExcess = rect.width - actualRectWidth;\n      rect = {\n        left: Math.floor(rectExcess / 2),\n        top: 0,\n        width: actualRectWidth,\n        height: rect.height\n      }\n    }\n\n    this.x = (this.width * (clientX - rect.left) / rect.width) | 0;\n    this.y = (this.height * (clientY - rect.top) / rect.height) | 0;\n  }\n\n  private requestFullscreen() {\n    const canvas = this.el as Fullscreenable;\n    if (canvas.requestFullscreen) {\n      canvas.requestFullscreen();\n    } else if (canvas.webkitRequestFullscreen) {\n      canvas.webkitRequestFullscreen();\n    } else if (canvas.mozRequestFullScreen) {\n      canvas.mozRequestFullScreen();\n    }\n  }\n\n  update() {\n    this.dx = this.x - this.prevX;\n    this.dy = this.y - this.prevY;\n    this.prevX = this.x;\n    this.prevY = this.y;\n  }\n}","\n/**\n * Vertex shader program.\n *\n * a = attribute vec2 aVertexPosition;\n * b = attribute vec2 aTextureCoord;\n * c = attribute vec3 aFgColor;\n * d = attribute vec3 aBgColor;\n * e = varying vec2 vTextureCoord;\n * f = varying vec4 vFgColor;\n * g = varying vec4 vBgColor;\n */\nexport const VERTEX_SHADER_SOURCE = 'attribute vec2 a;' +\n    'attribute vec2 b;' +\n    'attribute vec3 c;' +\n    'attribute vec3 d;' +\n    'varying highp vec2 e;' +\n    'varying highp vec4 f;' +\n    'varying highp vec4 g;' +\n    'void main(void){' +\n    'gl_Position=vec4(a.x,a.y,0,1);' +\n    'e=b/16.0;' +\n    'f=vec4(c.r,c.g,c.b,1);' +\n    'g=vec4(d.r,d.g,d.b,1);' +\n    '}';\n\n/**\n * Fragment shader program.\n *\n * e = varying vec2 vTextureCoord;\n * f = varying vec4 vFgColor;\n * g = varying vec4 vBgColor;\n * h = uniform bool uGraphicalTiles;\n * s = uniform sampler2D uSampler;\n */\nexport const FRAGMENT_SHADER_SOURCE = 'varying highp vec2 e;' +\n    'varying highp vec4 f;' +\n    'varying highp vec4 g;' +\n    'uniform bool h;' +\n    'uniform sampler2D s;' +\n    'void main(void){' +\n    'gl_FragColor=texture2D(s,e);' +\n    'if(!h){' +\n    'if(gl_FragColor.r<0.1) {' +\n    'gl_FragColor=g;' +\n    '} else {' +\n    'gl_FragColor=f;' +\n    '}' +\n    '}' +\n    '}';\n","\nimport {Cell} from './cell';\nimport {Console} from './console';\nimport {DEFAULT_FONT, Font} from './font';\nimport {Keys} from './keys';\nimport {Mouse} from './mouse';\nimport {FRAGMENT_SHADER_SOURCE, VERTEX_SHADER_SOURCE} from './shaders';\nimport {TerminalOptions} from './terminaloptions';\n\n/**\n * Linearly interpolates a number in the range 0-max to -1.0-1.0.\n *\n * @param i The value between 0 and max.\n * @param max The maximum value.\n * @returns The interpolated value between -1.0 and 1.0.\n */\nfunction interpolate(i: number, max: number) {\n  return -1.0 + 2.0 * (i / max);\n}\n\nconst DEFAULT_OPTIONS: TerminalOptions = {\n  font: DEFAULT_FONT,\n  requestFullscreen: false\n};\n\nexport class Terminal extends Console {\n  readonly canvas: HTMLCanvasElement;\n  private readonly font: Font;\n  private readonly pixelWidth: number;\n  private readonly pixelHeight: number;\n  private readonly gl: WebGLRenderingContext;\n  private readonly program: WebGLProgram;\n  private readonly positionAttribLocation: GLint;\n  private readonly textureAttribLocation: GLint;\n  private readonly fgColorAttribLocation: GLint;\n  private readonly bgColorAttribLocation: GLint;\n  private readonly positionsArray: Float32Array;\n  private readonly indexArray: Uint16Array;\n  private readonly textureArray: Float32Array;\n  private readonly foregroundUint8Array: Uint8Array;\n  private readonly foregroundDataView: DataView;\n  private readonly backgroundUint8Array: Uint8Array;\n  private readonly backgroundDataView: DataView;\n  private readonly positionBuffer: WebGLBuffer;\n  private readonly indexBuffer: WebGLBuffer;\n  private readonly textureBuffer: WebGLBuffer;\n  private readonly foregroundBuffer: WebGLBuffer;\n  private readonly backgroundBuffer: WebGLBuffer;\n  private readonly texture: WebGLTexture;\n  readonly keys: Keys;\n  readonly mouse: Mouse;\n  update?: Function;\n\n  constructor(\n      canvas: HTMLCanvasElement, width: number, height: number,\n      options?: TerminalOptions) {\n    super(width, height);\n\n    options = options || DEFAULT_OPTIONS;\n\n    this.canvas = canvas;\n    this.font = options.font || DEFAULT_FONT;\n    this.pixelWidth = width * this.font.charWidth;\n    this.pixelHeight = height * this.font.charHeight;\n\n    canvas.width = this.pixelWidth;\n    canvas.height = this.pixelHeight;\n    canvas.style.width = (this.font.scale * this.pixelWidth) + 'px';\n    canvas.style.height = (this.font.scale * this.pixelHeight) + 'px';\n    // canvas.style.imageRendering = 'pixelated';\n    canvas.style.outline = 'none';\n    canvas.tabIndex = 0;\n\n    this.keys = new Keys(canvas);\n    this.mouse = new Mouse(this, options);\n\n    // Get the WebGL context from the canvas\n    const gl = canvas.getContext('webgl', {antialias: false});\n    if (!gl) {\n      throw new Error(\n          'Unable to initialize WebGL. Your browser may not support it.');\n    }\n\n    const program = gl.createProgram();\n    if (!program) {\n      throw new Error(\n          'Unable to initialize WebGL. Your browser may not support it.');\n    }\n\n    this.gl = gl;\n    this.program = program;\n\n    gl.attachShader(\n        program, this.buildShader(gl.VERTEX_SHADER, VERTEX_SHADER_SOURCE));\n    gl.attachShader(\n        program, this.buildShader(gl.FRAGMENT_SHADER, FRAGMENT_SHADER_SOURCE));\n    gl.linkProgram(program);\n    gl.useProgram(program);\n\n    if (this.font.graphical) {\n      // Set the flag to ignore foreground/background colors, and use texture\n      // directly\n      gl.uniform1i(gl.getUniformLocation(program, 'h'), 1);\n    }\n\n    this.positionAttribLocation = this.getAttribLocation('a');\n    this.textureAttribLocation = this.getAttribLocation('b');\n    this.fgColorAttribLocation = this.getAttribLocation('c');\n    this.bgColorAttribLocation = this.getAttribLocation('d');\n\n    const cellCount = width * height;\n    this.positionsArray = new Float32Array(cellCount * 3 * 4);\n    this.indexArray = new Uint16Array(cellCount * 6);\n    this.textureArray = new Float32Array(cellCount * 2 * 4);\n    this.foregroundUint8Array = new Uint8Array(cellCount * 4 * 4);\n    this.foregroundDataView = new DataView(this.foregroundUint8Array.buffer);\n    this.backgroundUint8Array = new Uint8Array(cellCount * 4 * 4);\n    this.backgroundDataView = new DataView(this.backgroundUint8Array.buffer);\n\n    // Init the positions buffer\n    let i = 0;\n    let j = 0;\n    let k = 0;\n    for (let y = 0; y < height; y++) {\n      for (let x = 0; x < width; x++) {\n        // Top-left\n        this.positionsArray[i++] = interpolate(x, width);\n        this.positionsArray[i++] = -interpolate(y, height);\n\n        // Top-right\n        this.positionsArray[i++] = interpolate(x + 1, width);\n        this.positionsArray[i++] = -interpolate(y, height);\n\n        // Bottom-right\n        this.positionsArray[i++] = interpolate(x + 1, width);\n        this.positionsArray[i++] = -interpolate(y + 1, height);\n\n        // Bottom-left\n        this.positionsArray[i++] = interpolate(x, width);\n        this.positionsArray[i++] = -interpolate(y + 1, height);\n\n        this.indexArray[j++] = k + 0;\n        this.indexArray[j++] = k + 1;\n        this.indexArray[j++] = k + 2;\n        this.indexArray[j++] = k + 0;\n        this.indexArray[j++] = k + 2;\n        this.indexArray[j++] = k + 3;\n\n        k += 4;\n      }\n    }\n\n    this.positionBuffer = gl.createBuffer() as WebGLBuffer;\n    this.indexBuffer = gl.createBuffer() as WebGLBuffer;\n    this.textureBuffer = gl.createBuffer() as WebGLBuffer;\n    this.foregroundBuffer = gl.createBuffer() as WebGLBuffer;\n    this.backgroundBuffer = gl.createBuffer() as WebGLBuffer;\n\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);\n    gl.bufferData(gl.ARRAY_BUFFER, this.positionsArray, gl.STATIC_DRAW);\n\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indexBuffer);\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this.indexArray, gl.STATIC_DRAW);\n\n    this.texture = this.loadTexture(this.font.url) as WebGLTexture;\n\n    this.renderLoop();\n  }\n\n  private getAttribLocation(name: string) {\n    const location = this.gl.getAttribLocation(this.program, name);\n    this.gl.enableVertexAttribArray(location);\n    return location;\n  }\n\n  flush() {\n    let textureArrayIndex = 0;\n    let colorArrayIndex = 0;\n\n    for (let y = 0; y < this.height; y++) {\n      for (let x = 0; x < this.width; x++) {\n        const cell = this.getCell(x, y) as Cell;\n\n        if (!cell.dirty) {\n          textureArrayIndex += 8;\n          colorArrayIndex += 16;\n          continue;\n        }\n\n        const textureX = (cell.charCode % 16) + (0.5 / 256.0);\n        const textureY = ((cell.charCode / 16) | 0) + (0.5 / 256.0);\n\n        this.textureArray[textureArrayIndex++] = textureX;\n        this.textureArray[textureArrayIndex++] = textureY;\n\n        this.textureArray[textureArrayIndex++] = textureX + 1;\n        this.textureArray[textureArrayIndex++] = textureY;\n\n        this.textureArray[textureArrayIndex++] = textureX + 1;\n        this.textureArray[textureArrayIndex++] = textureY + 1;\n\n        this.textureArray[textureArrayIndex++] = textureX;\n        this.textureArray[textureArrayIndex++] = textureY + 1;\n\n        for (let i = 0; i < 4; i++) {\n          this.foregroundDataView.setUint32(colorArrayIndex, cell.fg, false);\n          this.backgroundDataView.setUint32(colorArrayIndex, cell.bg, false);\n          colorArrayIndex += 4;\n        }\n\n        cell.dirty = false;\n      }\n    }\n  }\n\n  isKeyDown(keyCode: number) {\n    const key = this.keys.getKey(keyCode);\n    return key && key.down;\n  }\n\n  isKeyPressed(keyCode: number) {\n    const key = this.keys.getKey(keyCode);\n    const count = key ? key.downCount : 0;\n    return count === 1 || (count > 30 && count % 3 === 0);\n  }\n\n  getKeyDownCount(keyCode: number) {\n    const key = this.keys.getKey(keyCode);\n    return key ? key.downCount : 0;\n  }\n\n  private buildShader(type: GLint, source: string) {\n    const gl = this.gl;\n    const sh = gl.createShader(type);\n    if (!sh) {\n      throw new Error('An error occurred compiling the shader: ');\n    }\n    gl.shaderSource(sh, source);\n    gl.compileShader(sh);\n    if (!gl.getShaderParameter(sh, gl.COMPILE_STATUS)) {\n      throw new Error(\n          'An error occurred compiling the shader: ' + gl.getShaderInfoLog(sh));\n    }\n    return sh;\n  }\n\n  /**\n   * Initialize a texture and load an image.\n   * When the image finished loading copy it into the texture.\n   * @param url\n   */\n  private loadTexture(url: string) {\n    const gl = this.gl;\n    const texture = gl.createTexture();\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n\n    // Because images have to be download over the internet\n    // they might take a moment until they are ready.\n    // Until then put a single pixel in the texture so we can\n    // use it immediately. When the image has finished downloading\n    // we'll update the texture with the contents of the image.\n    const level = 0;\n    const internalFormat = gl.RGBA;\n    const width = 1;\n    const height = 1;\n    const border = 0;\n    const srcFormat = gl.RGBA;\n    const srcType = gl.UNSIGNED_BYTE;\n    const pixel = new Uint8Array([0, 0, 0, 255]);  // opaque black\n    gl.texImage2D(\n        gl.TEXTURE_2D, level, internalFormat, width, height, border, srcFormat,\n        srcType, pixel);\n\n    const image = new Image();\n    image.onload = () => {\n      gl.bindTexture(gl.TEXTURE_2D, texture);\n      gl.texImage2D(\n          gl.TEXTURE_2D, level, internalFormat, srcFormat, srcType, image);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n    };\n    image.src = url;\n\n    return texture;\n  }\n\n  //\n  // Draw the scene.\n  //\n  private render() {\n    const gl = this.gl;\n    gl.clearColor(0.0, 0.0, 0.0, 1.0);\n    gl.clearDepth(1.0);\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n    gl.viewport(0, 0, this.pixelWidth, this.pixelHeight);\n\n    // Tell WebGL how to pull out the positions from the position\n    // buffer into the vertexPosition attribute\n    {\n      const numComponents = 2;\n      const type = gl.FLOAT;\n      const normalize = false;\n      const stride = 0;\n      const offset = 0;\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);\n      gl.vertexAttribPointer(\n          this.positionAttribLocation, numComponents, type, normalize, stride,\n          offset);\n    }\n\n    // Tell WebGL how to pull out the texture coordinates from\n    // the texture coordinate buffer into the textureCoord attribute.\n    {\n      const numComponents = 2;\n      const type = gl.FLOAT;\n      const normalize = false;\n      const stride = 0;\n      const offset = 0;\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.textureBuffer);\n      gl.bufferData(gl.ARRAY_BUFFER, this.textureArray, gl.DYNAMIC_DRAW);\n      gl.vertexAttribPointer(\n          this.textureAttribLocation, numComponents, type, normalize, stride,\n          offset);\n    }\n\n    // Foreground color\n    {\n      const numComponents = 4;\n      const type = gl.UNSIGNED_BYTE;\n      const normalize = true;\n      const stride = 0;\n      const offset = 0;\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.foregroundBuffer);\n      gl.bufferData(\n          gl.ARRAY_BUFFER, this.foregroundUint8Array, gl.DYNAMIC_DRAW);\n      gl.vertexAttribPointer(\n          this.fgColorAttribLocation, numComponents, type, normalize, stride,\n          offset);\n    }\n\n    // Background color\n    {\n      const numComponents = 4;\n      const type = gl.UNSIGNED_BYTE;\n      const normalize = true;\n      const stride = 0;\n      const offset = 0;\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.backgroundBuffer);\n      gl.bufferData(\n          gl.ARRAY_BUFFER, this.backgroundUint8Array, gl.DYNAMIC_DRAW);\n      gl.vertexAttribPointer(\n          this.bgColorAttribLocation, numComponents, type, normalize, stride,\n          offset);\n    }\n\n    // Tell WebGL which indices to use to index the vertices\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indexBuffer);\n\n    // Tell WebGL to use our program when drawing\n    gl.useProgram(this.program);\n\n    // Tell WebGL we want to affect texture unit 0\n    gl.activeTexture(gl.TEXTURE0);\n\n    // Bind the texture to texture unit 0\n    gl.bindTexture(gl.TEXTURE_2D, this.texture);\n\n    // Tell the shader we bound the texture to texture unit 0\n    {\n      const vertexCount = this.width * this.height * 6;\n      const type = gl.UNSIGNED_SHORT;\n      const offset = 0;\n      gl.drawElements(gl.TRIANGLES, vertexCount, type, offset);\n    }\n  }\n\n  private renderLoop() {\n    this.keys.updateKeys();\n    this.mouse.update();\n    if (this.update) {\n      this.update();\n    }\n    this.flush();\n    this.render();\n    requestAnimationFrame(this.renderLoop.bind(this));\n  }\n}\n"],"names":["BlendMode","fromRgb","r","g","b","a","undefined","fromHsv","h","s","v","i","f","p","q","t","Colors","Cell","[object Object]","charCode","fg","bg","meta","this","length","charCodeAt","convertCharCode","WHITE","BLACK","dirty","setCharCode","setForeground","setBackground","setMeta","otherCell","blendMode","alpha","None","blendColors","c1","c2","w1","w2","r1","g1","b1","r2","g2","b2","Blend","Add","clamp","x","Math","min","Chars","Console","width","height","grid","Array","y","row","push","clear","drawChar","c","setValue","str","drawString","floor","xi","yi","drawHLine","drawVLine","fillRect","BOX_DOUBLE_HORIZONTAL","BOX_DOUBLE_VERTICAL","BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT","BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT","BOX_DOUBLE_UP_AND_DOUBLE_RIGHT","BOX_DOUBLE_UP_AND_DOUBLE_LEFT","dstX","dstY","srcConsole","srcX","srcY","srcWidth","srcHeight","cell","getCell","drawCell","Font","url","charWidth","charHeight","scale","graphical","DEFAULT_FONT","createBoolMatrix","result","FovMap","blockedFunc","blocked","visible","originX","originY","minX","maxX","minY","maxY","radius","deltaX","deltaY","startSlopes","endSlopes","halfSlope","processedCell","extended","centreSlope","startSlope","endSlope","previousEndSlope","iteration","totalObstacles","obstaclesInLastLine","minSlope","idx","max","computeOctantY","computeOctantX","KEY_COUNT","Key","down","downCount","Keys","el","keys","addEventListener","e","setKey","state","stopPropagation","preventDefault","keyCode","VK_CANCEL","VK_HELP","VK_BACK_SPACE","VK_TAB","VK_CLEAR","VK_RETURN","VK_ENTER","VK_SHIFT","VK_CONTROL","VK_ALT","VK_PAUSE","VK_CAPS_LOCK","VK_ESCAPE","VK_SPACE","VK_PAGE_UP","VK_PAGE_DOWN","VK_END","VK_HOME","VK_LEFT","VK_UP","VK_RIGHT","VK_DOWN","VK_PRINTSCREEN","VK_INSERT","VK_DELETE","VK_0","VK_1","VK_2","VK_3","VK_4","VK_5","VK_6","VK_7","VK_8","VK_9","VK_COLON","VK_SEMICOLON","VK_LESS_THAN","VK_EQUALS","VK_GREATER_THAN","VK_QUESTION_MARK","VK_AT","VK_A","VK_B","VK_C","VK_D","VK_E","VK_F","VK_G","VK_H","VK_I","VK_J","VK_K","VK_L","VK_M","VK_N","VK_O","VK_P","VK_Q","VK_R","VK_S","VK_T","VK_U","VK_V","VK_W","VK_X","VK_Y","VK_Z","VK_CONTEXT_MENU","VK_NUMPAD0","VK_NUMPAD1","VK_NUMPAD2","VK_NUMPAD3","VK_NUMPAD4","VK_NUMPAD5","VK_NUMPAD6","VK_NUMPAD7","VK_NUMPAD8","VK_NUMPAD9","VK_MULTIPLY","VK_ADD","VK_SEPARATOR","VK_SUBTRACT","VK_DECIMAL","VK_DIVIDE","VK_F1","VK_F2","VK_F3","VK_F4","VK_F5","VK_F6","VK_F7","VK_F8","VK_F9","VK_F10","VK_F11","VK_F12","VK_F13","VK_F14","VK_F15","VK_F16","VK_F17","VK_F18","VK_F19","VK_F20","VK_F21","VK_F22","VK_F23","VK_F24","VK_NUM_LOCK","VK_SCROLL_LOCK","VK_CIRCUMFLEX","VK_EXCLAMATION","VK_DOUBLE_QUOTE","VK_HASH","VK_DOLLAR","VK_PERCENT","VK_AMPERSAND","VK_UNDERSCORE","VK_OPEN_PAREN","VK_CLOSE_PAREN","VK_ASTERISK","VK_PLUS","VK_PIPE","VK_HYPHEN_MINUS","VK_OPEN_CURLY_BRACKET","VK_CLOSE_CURLY_BRACKET","VK_TILDE","VK_COMMA","VK_PERIOD","VK_SLASH","VK_BACK_QUOTE","VK_OPEN_BRACKET","VK_BACK_SLASH","VK_CLOSE_BRACKET","VK_QUOTE","VK_META","VK_ALTGR","VK_WIN","VK_KANA","VK_HANGUL","VK_EISU","VK_JUNJA","VK_FINAL","VK_HANJA","VK_KANJI","VK_CONVERT","VK_NONCONVERT","VK_ACCEPT","VK_MODECHANGE","VK_SELECT","VK_PRINT","VK_EXECUTE","VK_SLEEP","RNG","seed","m","nextInt","start","end","rangeSize","Mouse","terminal","options","canvas","prevX","prevY","dx","dy","buttons","handleEvent","touchEventHandler","handleTouchEvent","bind","type","requestFullscreen","touches","touch","updatePosition","clientX","clientY","button","rect","getBoundingClientRect","terminalAspectRatio","actualRectWidth","left","top","webkitRequestFullscreen","mozRequestFullScreen","VERTEX_SHADER_SOURCE","FRAGMENT_SHADER_SOURCE","interpolate","DEFAULT_OPTIONS","font","Terminal","super","pixelWidth","pixelHeight","style","outline","tabIndex","mouse","gl","getContext","antialias","Error","program","createProgram","attachShader","buildShader","VERTEX_SHADER","FRAGMENT_SHADER","linkProgram","useProgram","uniform1i","getUniformLocation","positionAttribLocation","getAttribLocation","textureAttribLocation","fgColorAttribLocation","bgColorAttribLocation","cellCount","positionsArray","Float32Array","indexArray","Uint16Array","textureArray","foregroundUint8Array","Uint8Array","foregroundDataView","DataView","buffer","backgroundUint8Array","backgroundDataView","j","k","positionBuffer","createBuffer","indexBuffer","textureBuffer","foregroundBuffer","backgroundBuffer","bindBuffer","ARRAY_BUFFER","bufferData","STATIC_DRAW","ELEMENT_ARRAY_BUFFER","texture","loadTexture","renderLoop","name","location","enableVertexAttribArray","textureArrayIndex","colorArrayIndex","textureX","textureY","setUint32","key","getKey","count","source","sh","createShader","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","createTexture","bindTexture","TEXTURE_2D","internalFormat","RGBA","srcFormat","srcType","UNSIGNED_BYTE","pixel","texImage2D","image","Image","onload","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","TEXTURE_MAG_FILTER","LINEAR","TEXTURE_MIN_FILTER","src","clearColor","clearDepth","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","viewport","numComponents","FLOAT","normalize","stride","offset","vertexAttribPointer","DYNAMIC_DRAW","activeTexture","TEXTURE0","drawElements","TRIANGLES","UNSIGNED_SHORT","updateKeys","update","flush","render","requestAnimationFrame"],"mappings":"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"}