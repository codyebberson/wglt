
const MAP = [
    '                                                   ',
    '     ########        #########        ########     ',
    '     #......#        #.......#        #......#     ',
    '     #......#        #...#...#        #......#     ',
    '     #....#.#        #.#####.#        #......#     ',
    '     #....#.#        #...#...#        #......#     ',
    '     #..###.#        #.......#        #......#     ',
    '     #......##########.......##########......#     ',
    ' #####.......................................##### ',
    ' #...............................................# ',
    ' #...............................................# ',
    ' #...............................................# ',
    ' #...............................................# ',
    ' #...............................................# ',
    ' #####.......................................##### ',
    '     #......##########.......##########......#     ',
    '     #......#        #.......#        #......#     ',
    '     #......#        #.......#        #......#     ',
    '     #......#        #.......#        #......#     ',
    '     #......#        #.......#        #......#     ',
    '     #......#        #.......#        #......#     ',
    '     #......#        #.......#        #......#     ',
    '     #......#        #.......#        #......#     ',
    '     #......##########.......##########......#     ',
    ' #####.......................................##### ',
    ' #...............................................# ',
    ' #...............................................# ',
    ' #...............................................# ',
    ' #...............................................# ',
    ' #...............................................# ',
    ' #####.......................................##### ',
    '     #......#############.#############......#     ',
    '     #......#        #..#.#..#        #......#     ',
    '     #..#####        #..#.#..#        #......#     ',
    '     #......#        #..#.#..#        #......#     ',
    '     #####..#        #.......#        #......#     ',
    '     #......#        #.......#        #......#     ',
    '     ########        #########        ########     ',
    '                                                   ',
];

const MAP_WIDTH = MAP[0].length;
const MAP_HEIGHT = MAP.length;

const TILE_EMPTY = 0;
const TILE_WALL = 1 + 13 * 64 + 4;
const TILE_HALF_WALL = 1 + 14 * 64 + 4;
const TILE_FLOOR = 1 + 13 * 64 + 6;

const VIEW_DISTANCE = 15;

const app = new wglt.App({
    canvas: document.querySelector('canvas'),
    imageUrl: 'graphics.png',
    width: 224,
    height: 400,
    fillWindow: true,
});

const game = new wglt.Game(app, {
    tileWidth: 16,
    tileHeight: 24
});

const sprite = new wglt.Sprite(0, 120, 16, 24, 2, true, undefined, 0xffcf5cff);
const player = new wglt.Entity(game, 8, 3, 'Player', sprite, true);
game.player = player;
game.entities.push(player);

const map = new wglt.TileMap(app.gl, MAP_WIDTH, MAP_HEIGHT, 1);
map.tileWidth = 16;
map.tileHeight = 24;
game.tileMap = map;

// Clear the map to all walls
for (let y = 0; y < MAP_HEIGHT; y++) {
    for (let x = 0; x < MAP_WIDTH; x++) {
        const c = MAP[y].charAt(x);
        if (c === '#') {
            const c2 = MAP[y + 1].charAt(x);
            if (c2 === '#') {
                map.setTile(0, x, y, TILE_WALL, true);
            } else {
                map.setTile(0, x, y, TILE_HALF_WALL, true);
            }
        } else if (c === '.') {
            map.setTile(0, x, y, TILE_FLOOR, false);
        } else {
            map.setTile(0, x, y, TILE_EMPTY, true);
        }
    }
}

// Initial FOV
game.tileMap.computeFov(player.x, player.y, 12);

app.state = game;
