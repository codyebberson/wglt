<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>WGLT - Roguelike Tutorial - Part 6</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body class="example">
    <canvas></canvas>
    <p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_6">Part 6: Going Berserk!</a></p>
    <p>Stalking monsters, fights, splatter -- need we say more?</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part5.ts	2020-11-23 12:54:32.381932100 -0800</div>
<div class="c2">+++ part6.ts	2020-11-23 12:54:29.720619700 -0800</div>
<div class="c1">@@ -8,6 +8,7 @@</div>
<div class="c0"> import { RNG } from &#x27;../../src/rng&#x27;;</div>
<div class="c0"> import { Terminal } from &#x27;../../src/terminal&#x27;;</div>
<div class="c0"> </div>
<div class="c2">+</div>
<div class="c0"> // Actual size of the window</div>
<div class="c0"> const SCREEN_WIDTH = 80;</div>
<div class="c0"> const SCREEN_HEIGHT = 45;</div>
<div class="c1">@@ -35,14 +36,27 @@</div>
<div class="c0">     name: string;</div>
<div class="c0">     color: Color;</div>
<div class="c0">     blocks: boolean;</div>
<div class="c2">+    fighter?: Fighter;</div>
<div class="c2">+    ai?: BasicMonster;</div>
<div class="c0"> </div>
<div class="c3">-    constructor(x: number, y: number, char: string, name: string, color: Color, blocks: boolean) {</div>
<div class="c2">+    constructor(x: number, y: number, char: string, name: string, color: Color, blocks: boolean, components?: any) {</div>
<div class="c0">         this.x = x;</div>
<div class="c0">         this.y = y;</div>
<div class="c0">         this.char = char;</div>
<div class="c0">         this.name = name;</div>
<div class="c0">         this.color = color;</div>
<div class="c0">         this.blocks = !!blocks;</div>
<div class="c2">+</div>
<div class="c2">+        if (components) {</div>
<div class="c2">+            if (&#x27;fighter&#x27; in components) {</div>
<div class="c2">+                this.fighter = components.fighter;</div>
<div class="c2">+                (this.fighter as Fighter).owner = this;</div>
<div class="c2">+            }</div>
<div class="c2">+            if (&#x27;ai&#x27; in components) {</div>
<div class="c2">+                this.ai = components.ai;</div>
<div class="c2">+                (this.ai as BasicMonster).owner = this;</div>
<div class="c2">+            }</div>
<div class="c2">+        }</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c0">     move(dx: number, dy: number) {</div>
<div class="c1">@@ -53,6 +67,26 @@</div>
<div class="c0">         this.y += dy;</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c2">+    moveToward(targetX: number, targetY: number) {</div>
<div class="c2">+        const dx = targetX - this.x;</div>
<div class="c2">+        const dy = targetY - this.y;</div>
<div class="c2">+        const distance = Math.hypot(dx, dy);</div>
<div class="c2">+        this.move(Math.round(dx / distance), Math.round(dy / distance));</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    distanceTo(other: Entity) {</div>
<div class="c2">+        return Math.hypot(other.x - this.x, other.y - this.y);</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    sendToBack() {</div>
<div class="c2">+        this.remove();</div>
<div class="c2">+        entities.unshift(this);</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    remove() {</div>
<div class="c2">+        entities.splice(entities.indexOf(this), 1);</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c0">     draw() {</div>
<div class="c0">         if (map.isVisible(this.x, this.y)) {</div>
<div class="c0">             term.drawString(this.x, this.y, this.char, this.color);</div>
<div class="c1">@@ -60,6 +94,87 @@</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+class Fighter {</div>
<div class="c2">+    owner?: Entity;</div>
<div class="c2">+    maxHp: number;</div>
<div class="c2">+    defense: number;</div>
<div class="c2">+    power: number;</div>
<div class="c2">+    hp: number;</div>
<div class="c2">+    deathFunction?: (e: Entity) =&gt; void;</div>
<div class="c2">+</div>
<div class="c2">+    constructor(hp: number, defense: number, power: number, deathFunction?: (e: Entity) =&gt; void) {</div>
<div class="c2">+        this.owner = undefined;</div>
<div class="c2">+        this.maxHp = hp;</div>
<div class="c2">+        this.defense = defense;</div>
<div class="c2">+        this.power = power;</div>
<div class="c2">+        this.hp = hp;</div>
<div class="c2">+        this.deathFunction = deathFunction;</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    attack(target: Entity) {</div>
<div class="c2">+        if (!this.owner || !target.fighter) {</div>
<div class="c2">+            return;</div>
<div class="c2">+        }</div>
<div class="c2">+</div>
<div class="c2">+        const damage = this.power - target.fighter.defense;</div>
<div class="c2">+</div>
<div class="c2">+        if (damage &gt; 0) {</div>
<div class="c2">+            console.log(this.owner.name + &#x27; attacks &#x27; + target.name + &#x27; for &#x27; + damage + &#x27; hit points.&#x27;);</div>
<div class="c2">+            target.fighter.takeDamage(damage);</div>
<div class="c2">+        } else {</div>
<div class="c2">+            console.log(this.owner.name + &#x27; attacks &#x27; + target.name + &#x27; but it has no effect!&#x27;);</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    takeDamage(damage: number) {</div>
<div class="c2">+        if (!this.owner) {</div>
<div class="c2">+            return;</div>
<div class="c2">+        }</div>
<div class="c2">+</div>
<div class="c2">+        this.hp -= damage;</div>
<div class="c2">+</div>
<div class="c2">+        // Check for death. if there&#x27;s a death function, call it</div>
<div class="c2">+        if (this.hp &lt;= 0) {</div>
<div class="c2">+            this.hp = 0;</div>
<div class="c2">+            if (this.deathFunction) {</div>
<div class="c2">+                this.deathFunction(this.owner);</div>
<div class="c2">+            }</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+class BasicMonster {</div>
<div class="c2">+    owner?: Entity;</div>
<div class="c2">+</div>
<div class="c2">+    constructor() {</div>
<div class="c2">+        this.owner = undefined;</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    takeTurn() {</div>
<div class="c2">+        if (!player.fighter) {</div>
<div class="c2">+            return;</div>
<div class="c2">+        }</div>
<div class="c2">+</div>
<div class="c2">+        const monster = this.owner;</div>
<div class="c2">+        if (!monster || !monster.fighter) {</div>
<div class="c2">+            return;</div>
<div class="c2">+        }</div>
<div class="c2">+</div>
<div class="c2">+        // A basic monster takes its turn. if you can see it, it can see you</div>
<div class="c2">+        if (map.isVisible(monster.x, monster.y)) {</div>
<div class="c2">+</div>
<div class="c2">+            if (monster.distanceTo(player) &gt;= 2) {</div>
<div class="c2">+                // Move towards player if far away</div>
<div class="c2">+                monster.moveToward(player.x, player.y);</div>
<div class="c2">+</div>
<div class="c2">+            } else if (player.fighter.hp &gt; 0) {</div>
<div class="c2">+                // Close enough, attack! (if the player is still alive.)</div>
<div class="c2">+                monster.fighter.attack(player);</div>
<div class="c2">+            }</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function isBlocked(x: number, y: number) {</div>
<div class="c0">     // First test the map tile</div>
<div class="c0">     if (map.grid[y][x].blocked) {</div>
<div class="c1">@@ -189,10 +304,14 @@</div>
<div class="c0">         // 80% chance of getting an orc</div>
<div class="c0">         if (rng.nextRange(0, 100) &lt; 80) {</div>
<div class="c0">             // Create an orc</div>
<div class="c3">-            monster = new Entity(x, y, &#x27;o&#x27;, &#x27;orc&#x27;, Colors.LIGHT_GREEN, true);</div>
<div class="c2">+            const fighter = new Fighter(10, 0, 3, monsterDeath);</div>
<div class="c2">+            const ai = new BasicMonster();</div>
<div class="c2">+            monster = new Entity(x, y, &#x27;o&#x27;, &#x27;orc&#x27;, Colors.LIGHT_GREEN, true, { fighter: fighter, ai: ai });</div>
<div class="c0">         } else {</div>
<div class="c0">             // Create a troll</div>
<div class="c3">-            monster = new Entity(x, y, &#x27;T&#x27;, &#x27;troll&#x27;, Colors.DARK_GREEN, true);</div>
<div class="c2">+            const fighter = new Fighter(16, 1, 4, monsterDeath);</div>
<div class="c2">+            const ai = new BasicMonster();</div>
<div class="c2">+            monster = new Entity(x, y, &#x27;T&#x27;, &#x27;troll&#x27;, Colors.DARK_GREEN, true, { fighter: fighter, ai: ai });</div>
<div class="c0">         }</div>
<div class="c0"> </div>
<div class="c0">         entities.push(monster);</div>
<div class="c1">@@ -206,21 +325,31 @@</div>
<div class="c0">     let target = null;</div>
<div class="c0">     for (let i = 0; i &lt; entities.length; i++) {</div>
<div class="c0">         const entity = entities[i];</div>
<div class="c3">-        if (entity.x === x &amp;&amp; entity.y === y) {</div>
<div class="c2">+        if (entity.fighter &amp;&amp; entity.x === x &amp;&amp; entity.y === y) {</div>
<div class="c0">             target = entity;</div>
<div class="c0">             break;</div>
<div class="c0">         }</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c0">     if (target) {</div>
<div class="c3">-        console.log(&#x27;The &#x27; + target.name + &#x27; laughs at your puny efforts to attack him!&#x27;);</div>
<div class="c2">+        (player.fighter as Fighter).attack(target);</div>
<div class="c0">     } else {</div>
<div class="c0">         player.move(dx, dy);</div>
<div class="c0">         fovRecompute = true;</div>
<div class="c0">     }</div>
<div class="c2">+</div>
<div class="c2">+    for (let i = 0; i &lt; entities.length; i++) {</div>
<div class="c2">+        const entity = entities[i];</div>
<div class="c2">+        if (entity.ai) {</div>
<div class="c2">+            entity.ai.takeTurn();</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function handleKeys() {</div>
<div class="c2">+    if (!player.fighter || player.fighter.hp &lt;= 0) {</div>
<div class="c2">+        return;</div>
<div class="c2">+    }</div>
<div class="c0">     if (term.isKeyPressed(Keys.VK_UP)) {</div>
<div class="c0">         playerMoveOrAttack(0, -1);</div>
<div class="c0">     }</div>
<div class="c1">@@ -235,6 +364,21 @@</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function playerDeath(player: Entity) {</div>
<div class="c2">+    console.log(&#x27;You died!&#x27;);</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function monsterDeath(monster: Entity) {</div>
<div class="c2">+    console.log(monster.name + &#x27; is dead&#x27;);</div>
<div class="c2">+    monster.char = &#x27;%&#x27;;</div>
<div class="c2">+    monster.color = Colors.DARK_RED;</div>
<div class="c2">+    monster.blocks = false;</div>
<div class="c2">+    monster.fighter = undefined;</div>
<div class="c2">+    monster.ai = undefined;</div>
<div class="c2">+    monster.name = &#x27;remains of &#x27; + monster.name;</div>
<div class="c2">+    monster.sendToBack();</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function renderAll() {</div>
<div class="c0">     if (fovRecompute) {</div>
<div class="c0">         map.computeFov(player.x, player.y, TORCH_RADIUS);</div>
<div class="c1">@@ -267,7 +411,7 @@</div>
<div class="c0"> </div>
<div class="c0"> const term = new Terminal(document.querySelector(&#x27;canvas&#x27;) as HTMLCanvasElement, SCREEN_WIDTH, SCREEN_HEIGHT);</div>
<div class="c0"> const rng = new RNG(1);</div>
<div class="c3">-const player = new Entity(40, 25, &#x27;@&#x27;, &#x27;player&#x27;, Colors.WHITE, true);</div>
<div class="c2">+const player = new Entity(40, 25, &#x27;@&#x27;, &#x27;player&#x27;, Colors.WHITE, true, { fighter: new Fighter(20, 2, 5, playerDeath) });</div>
<div class="c0"> const entities = [player];</div>
<div class="c0"> const map = createMap();</div>
<div class="c0"> let fovRecompute = true;</div>
<!--ENDDIFF-->
    </div>
	<script src="part6.min.js"></script>
</body>

</html>