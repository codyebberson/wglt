<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>WGLT - Roguelike Tutorial - Part 6</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body>
    <canvas></canvas>
    <p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_6">Part 6: Going Berserk!</a></p>
    <p>Stalking monsters, fights, splatter -- need we say more?</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part5.js	2018-11-22 14:07:59.435113200 -0800</div>
<div class="c2">+++ part6.js	2018-11-23 18:00:42.442518600 -0800</div>
<div class="c1">@@ -44,7 +44,7 @@</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c3">-function Entity(x, y, char, name, color, blocks) {</div>
<div class="c2">+function Entity(x, y, char, name, color, blocks, components) {</div>
<div class="c0">     this.x = x;</div>
<div class="c0">     this.y = y;</div>
<div class="c0">     this.char = char;</div>
<div class="c1">@@ -52,6 +52,15 @@</div>
<div class="c0">     this.color = color;</div>
<div class="c0">     this.blocks = !!blocks;</div>
<div class="c0"> </div>
<div class="c2">+    if (components) {</div>
<div class="c2">+        for (var property in components) {</div>
<div class="c2">+            if (components.hasOwnProperty(property)) {</div>
<div class="c2">+                this[property] = components[property];</div>
<div class="c2">+                this[property].owner = this;</div>
<div class="c2">+            }</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c0">     this.move = function (dx, dy) {</div>
<div class="c0">         if (isBlocked(this.x + dx, this.y + dy)) {</div>
<div class="c0">             return;</div>
<div class="c1">@@ -60,6 +69,26 @@</div>
<div class="c0">         this.y += dy;</div>
<div class="c0">     };</div>
<div class="c0"> </div>
<div class="c2">+    this.moveToward = function (targetX, targetY) {</div>
<div class="c2">+        const dx = targetX - this.x;</div>
<div class="c2">+        const dy = targetY - this.y;</div>
<div class="c2">+        const distance = Math.hypot(dx, dy);</div>
<div class="c2">+        this.move(Math.round(dx / distance), Math.round(dy / distance));</div>
<div class="c2">+    };</div>
<div class="c2">+</div>
<div class="c2">+    this.distanceTo = function (other) {</div>
<div class="c2">+        return Math.hypot(other.x - this.x, other.y - this.y);</div>
<div class="c2">+    };</div>
<div class="c2">+</div>
<div class="c2">+    this.sendToBack = function () {</div>
<div class="c2">+        this.remove();</div>
<div class="c2">+        entities.unshift(this);</div>
<div class="c2">+    };</div>
<div class="c2">+</div>
<div class="c2">+    this.remove = function () {</div>
<div class="c2">+        entities.splice(entities.indexOf(this), 1);</div>
<div class="c2">+    };</div>
<div class="c2">+</div>
<div class="c0">     this.draw = function () {</div>
<div class="c0">         if (fovMap.isVisible(this.x, this.y)) {</div>
<div class="c0">             term.drawString(this.x, this.y, this.char, this.color);</div>
<div class="c1">@@ -67,6 +96,59 @@</div>
<div class="c0">     };</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function Fighter(hp, defense, power, deathFunction) {</div>
<div class="c2">+    this.owner = null;</div>
<div class="c2">+    this.maxHp = hp;</div>
<div class="c2">+    this.hp = hp;</div>
<div class="c2">+    this.defense = defense;</div>
<div class="c2">+    this.power = power;</div>
<div class="c2">+    this.deathFunction = deathFunction || null;</div>
<div class="c2">+</div>
<div class="c2">+    this.attack = function (target) {</div>
<div class="c2">+        const damage = this.power - target.fighter.defense;</div>
<div class="c2">+</div>
<div class="c2">+        if (damage &gt; 0) {</div>
<div class="c2">+            console.log(this.owner.name + ' attacks ' + target.name + ' for ' + damage + ' hit points.');</div>
<div class="c2">+            target.fighter.takeDamage(damage);</div>
<div class="c2">+        } else {</div>
<div class="c2">+            console.log(this.owner.name + ' attacks ' + target.name + ' but it has no effect!');</div>
<div class="c2">+        }</div>
<div class="c2">+    };</div>
<div class="c2">+</div>
<div class="c2">+    this.takeDamage = function (damage) {</div>
<div class="c2">+        this.hp -= damage;</div>
<div class="c2">+</div>
<div class="c2">+        // Check for death. if there's a death function, call it</div>
<div class="c2">+        if (this.hp &lt;= 0) {</div>
<div class="c2">+            this.hp = 0;</div>
<div class="c2">+            if (this.deathFunction) {</div>
<div class="c2">+                this.deathFunction(this.owner);</div>
<div class="c2">+            }</div>
<div class="c2">+        }</div>
<div class="c2">+    };</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function BasicMonster() {</div>
<div class="c2">+    this.owner = null;</div>
<div class="c2">+</div>
<div class="c2">+    this.takeTurn = function () {</div>
<div class="c2">+        const monster = this.owner;</div>
<div class="c2">+</div>
<div class="c2">+        // A basic monster takes its turn. if you can see it, it can see you</div>
<div class="c2">+        if (fovMap.isVisible(monster.x, monster.y)) {</div>
<div class="c2">+</div>
<div class="c2">+            if (monster.distanceTo(player) &gt;= 2) {</div>
<div class="c2">+                // Move towards player if far away</div>
<div class="c2">+                monster.moveToward(player.x, player.y);</div>
<div class="c2">+</div>
<div class="c2">+            } else if (player.fighter.hp &gt; 0) {</div>
<div class="c2">+                // Close enough, attack! (if the player is still alive.)</div>
<div class="c2">+                monster.fighter.attack(player);</div>
<div class="c2">+            }</div>
<div class="c2">+        }</div>
<div class="c2">+    };</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function isBlocked(x, y) {</div>
<div class="c0">     // First test the map tile</div>
<div class="c0">     if (map[y][x].blocked) {</div>
<div class="c1">@@ -196,10 +278,14 @@</div>
<div class="c0">         // 80% chance of getting an orc</div>
<div class="c0">         if (rng.nextRange(0, 100) &lt; 80) {</div>
<div class="c0">             // Create an orc</div>
<div class="c3">-            monster = new Entity(x, y, 'o', 'orc', wglt.Colors.LIGHT_GREEN, true);</div>
<div class="c2">+            const fighter = new Fighter(10, 0, 3, monsterDeath);</div>
<div class="c2">+            const ai = new BasicMonster();</div>
<div class="c2">+            monster = new Entity(x, y, 'o', 'orc', wglt.Colors.LIGHT_GREEN, true, { fighter: fighter, ai: ai });</div>
<div class="c0">         } else {</div>
<div class="c0">             // Create a troll</div>
<div class="c3">-            monster = new Entity(x, y, 'T', 'troll', wglt.Colors.DARK_GREEN, true);</div>
<div class="c2">+            const fighter = new Fighter(16, 1, 4, monsterDeath);</div>
<div class="c2">+            const ai = new BasicMonster();</div>
<div class="c2">+            monster = new Entity(x, y, 'T', 'troll', wglt.Colors.DARK_GREEN, true, { fighter: fighter, ai: ai });</div>
<div class="c0">         }</div>
<div class="c0"> </div>
<div class="c0">         entities.push(monster);</div>
<div class="c1">@@ -213,21 +299,31 @@</div>
<div class="c0">     let target = null;</div>
<div class="c0">     for (let i = 0; i &lt; entities.length; i++) {</div>
<div class="c0">         const entity = entities[i];</div>
<div class="c3">-        if (entity.x === x &amp;&amp; entity.y === y) {</div>
<div class="c2">+        if (entity.fighter &amp;&amp; entity.x === x &amp;&amp; entity.y === y) {</div>
<div class="c0">             target = entity;</div>
<div class="c0">             break;</div>
<div class="c0">         }</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c0">     if (target) {</div>
<div class="c3">-        console.log('The ' + target.name + ' laughs at your puny efforts to attack him!');</div>
<div class="c2">+        player.fighter.attack(target);</div>
<div class="c0">     } else {</div>
<div class="c0">         player.move(dx, dy);</div>
<div class="c0">         fovRecompute = true;</div>
<div class="c0">     }</div>
<div class="c2">+</div>
<div class="c2">+    for (let i = 0; i &lt; entities.length; i++) {</div>
<div class="c2">+        const entity = entities[i];</div>
<div class="c2">+        if (entity.ai) {</div>
<div class="c2">+            entity.ai.takeTurn();</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function handleKeys() {</div>
<div class="c2">+    if (player.fighter.hp &lt;= 0) {</div>
<div class="c2">+        return;</div>
<div class="c2">+    }</div>
<div class="c0">     if (term.isKeyPressed(wglt.Keys.VK_UP)) {</div>
<div class="c0">         playerMoveOrAttack(0, -1);</div>
<div class="c0">     }</div>
<div class="c1">@@ -242,6 +338,21 @@</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function playerDeath(player) {</div>
<div class="c2">+    console.log('You died!');</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function monsterDeath(monster) {</div>
<div class="c2">+    console.log(monster.name + ' is dead');</div>
<div class="c2">+    monster.char = '%';</div>
<div class="c2">+    monster.color = wglt.Colors.DARK_RED;</div>
<div class="c2">+    monster.blocks = false;</div>
<div class="c2">+    monster.fighter = null;</div>
<div class="c2">+    monster.ai = null;</div>
<div class="c2">+    monster.name = 'remains of ' + monster.name;</div>
<div class="c2">+    monster.sendToBack();</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function renderAll() {</div>
<div class="c0">     if (fovRecompute) {</div>
<div class="c0">         fovMap.computeFov(player.x, player.y, TORCH_RADIUS);</div>
<div class="c1">@@ -276,7 +387,7 @@</div>
<div class="c0"> </div>
<div class="c0"> const term = new wglt.Terminal(document.querySelector('canvas'), SCREEN_WIDTH, SCREEN_HEIGHT);</div>
<div class="c0"> const rng = new wglt.RNG(1);</div>
<div class="c3">-const player = new Entity(40, 25, '@', 'player', wglt.Colors.WHITE, true);</div>
<div class="c2">+const player = new Entity(40, 25, '@', 'player', wglt.Colors.WHITE, true, { fighter: new Fighter(20, 2, 5, playerDeath) });</div>
<div class="c0"> const entities = [player];</div>
<div class="c0"> const map = createMap();</div>
<div class="c0"> const fovMap = new wglt.FovMap(MAP_WIDTH, MAP_HEIGHT, (x, y) =&gt; map[y][x].blocked);</div>
<!--ENDDIFF-->
    </div>
    <script src="../../dist/index.js"></script>
	<script src="part6.js"></script>
</body>

</html>