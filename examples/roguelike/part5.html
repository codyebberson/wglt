<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>WGLT - Roguelike Tutorial - Part 5</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body>
	<canvas></canvas>
	<p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_5">Part 5: Preparing for combat</a></p>
	<p>Place some orcs and trolls around the dungeon (they won't stay there for long!). Also, deal with blocking objects and game states, which are important before coding the next part.</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part4.js	2018-11-20 15:58:55.475000300 -0800</div>
<div class="c2">+++ part5.js	2018-11-20 15:58:55.479987500 -0800</div>
<div class="c1">@@ -11,6 +11,7 @@</div>
<div class="c0"> const ROOM_MAX_SIZE = 10;</div>
<div class="c0"> const ROOM_MIN_SIZE = 6;</div>
<div class="c0"> const MAX_ROOMS = 30;</div>
<div class="c2">+const MAX_ROOM_MONSTERS = 3;</div>
<div class="c0"> const TORCH_RADIUS = 10;</div>
<div class="c0"> </div>
<div class="c0"> const COLOR_DARK_WALL = wglt.fromRgb(0, 0, 100);</div>
<div class="c1">@@ -43,14 +44,16 @@</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c3">-function Entity(x, y, char, color) {</div>
<div class="c2">+function Entity(x, y, char, name, color, blocks) {</div>
<div class="c0">     this.x = x;</div>
<div class="c0">     this.y = y;</div>
<div class="c0">     this.char = char;</div>
<div class="c2">+    this.name = name;</div>
<div class="c0">     this.color = color;</div>
<div class="c2">+    this.blocks = !!blocks;</div>
<div class="c0"> </div>
<div class="c0">     this.move = function (dx, dy) {</div>
<div class="c3">-        if (map[this.y + dy][this.x + dx].blocked) {</div>
<div class="c2">+        if (isBlocked(this.x + dx, this.y + dy)) {</div>
<div class="c0">             return;</div>
<div class="c0">         }</div>
<div class="c0">         this.x += dx;</div>
<div class="c1">@@ -64,6 +67,23 @@</div>
<div class="c0">     };</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function isBlocked(x, y) {</div>
<div class="c2">+    // First test the map tile</div>
<div class="c2">+    if (map[y][x].blocked) {</div>
<div class="c2">+        return true;</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    // Now check for any blocking objects</div>
<div class="c2">+    for (let i = 0; i &lt; entities.length; i++) {</div>
<div class="c2">+        const entity = entities[i];</div>
<div class="c2">+        if (entity.blocks &amp;&amp; entity.x === x &amp;&amp; entity.y === y) {</div>
<div class="c2">+            return true;</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    return false;</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function createRoom(map, room) {</div>
<div class="c0">     for (let y = room.y1 + 1; y &lt; room.y2; y++) {</div>
<div class="c0">         for (let x = room.x1 + 1; x &lt; room.x2; x++) {</div>
<div class="c1">@@ -151,6 +171,9 @@</div>
<div class="c0">                 }</div>
<div class="c0">             }</div>
<div class="c0"> </div>
<div class="c2">+            // Add some contents to this room, such as monsters</div>
<div class="c2">+            placeObjects(newRoom);</div>
<div class="c2">+</div>
<div class="c0">             // Finally, append the new room to the list</div>
<div class="c0">             rooms.push(newRoom);</div>
<div class="c0">         }</div>
<div class="c1">@@ -159,22 +182,63 @@</div>
<div class="c0">     return map;</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function placeObjects(room) {</div>
<div class="c2">+    // Choose random number of monsters</div>
<div class="c2">+    const numMonsters = rng.nextRange(0, MAX_ROOM_MONSTERS);</div>
<div class="c2">+</div>
<div class="c2">+    for (let i = 0; i &lt; numMonsters; i++) {</div>
<div class="c2">+        // Choose random spot for this monster</div>
<div class="c2">+        const x = rng.nextRange(room.x1 + 1, room.x2 - 1);</div>
<div class="c2">+        const y = rng.nextRange(room.y1 + 1, room.y2 - 1);</div>
<div class="c2">+        let monster = null;</div>
<div class="c2">+</div>
<div class="c2">+        // Only place it if the tile is not blocked</div>
<div class="c2">+        // 80% chance of getting an orc</div>
<div class="c2">+        if (rng.nextRange(0, 100) &lt; 80) {</div>
<div class="c2">+            // Create an orc</div>
<div class="c2">+            monster = new Entity(x, y, 'o', 'orc', wglt.Colors.LIGHT_GREEN, true);</div>
<div class="c2">+        } else {</div>
<div class="c2">+            // Create a troll</div>
<div class="c2">+            monster = new Entity(x, y, 'T', 'troll', wglt.Colors.DARK_GREEN, true);</div>
<div class="c2">+        }</div>
<div class="c2">+</div>
<div class="c2">+        entities.push(monster);</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function playerMoveOrAttack(dx, dy) {</div>
<div class="c2">+    const x = player.x + dx;</div>
<div class="c2">+    const y = player.y + dy;</div>
<div class="c2">+</div>
<div class="c2">+    let target = null;</div>
<div class="c2">+    for (let i = 0; i &lt; entities.length; i++) {</div>
<div class="c2">+        const entity = entities[i];</div>
<div class="c2">+        if (entity.x === x &amp;&amp; entity.y === y) {</div>
<div class="c2">+            target = entity;</div>
<div class="c2">+            break;</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    if (target) {</div>
<div class="c2">+        console.log('The ' + target.name + ' laughs at your puny efforts to attack him!');</div>
<div class="c2">+    } else {</div>
<div class="c2">+        player.move(dx, dy);</div>
<div class="c2">+        fovRecompute = true;</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function handleKeys() {</div>
<div class="c0">     if (term.isKeyPressed(wglt.Keys.VK_UP)) {</div>
<div class="c3">-        player.move(0, -1);</div>
<div class="c3">-        fovRecompute = true;</div>
<div class="c2">+        playerMoveOrAttack(0, -1);</div>
<div class="c0">     }</div>
<div class="c0">     if (term.isKeyPressed(wglt.Keys.VK_LEFT)) {</div>
<div class="c3">-        player.move(-1, 0);</div>
<div class="c3">-        fovRecompute = true;</div>
<div class="c2">+        playerMoveOrAttack(-1, 0);</div>
<div class="c0">     }</div>
<div class="c0">     if (term.isKeyPressed(wglt.Keys.VK_RIGHT)) {</div>
<div class="c3">-        player.move(1, 0);</div>
<div class="c3">-        fovRecompute = true;</div>
<div class="c2">+        playerMoveOrAttack(1, 0);</div>
<div class="c0">     }</div>
<div class="c0">     if (term.isKeyPressed(wglt.Keys.VK_DOWN)) {</div>
<div class="c3">-        player.move(0, 1);</div>
<div class="c3">-        fovRecompute = true;</div>
<div class="c2">+        playerMoveOrAttack(0, 1);</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c1">@@ -212,9 +276,8 @@</div>
<div class="c0"> </div>
<div class="c0"> const term = new wglt.Terminal(document.querySelector('canvas'), SCREEN_WIDTH, SCREEN_HEIGHT);</div>
<div class="c0"> const rng = new wglt.RNG(1);</div>
<div class="c3">-const player = new Entity(40, 25, '@', wglt.Colors.WHITE);</div>
<div class="c3">-const npc = new Entity(40, 20, '@', wglt.Colors.YELLOW);</div>
<div class="c3">-const entities = [player, npc];</div>
<div class="c2">+const player = new Entity(40, 25, '@', 'Hero', wglt.Colors.WHITE, true);</div>
<div class="c2">+const entities = [player];</div>
<div class="c0"> const map = createMap();</div>
<div class="c0"> const fovMap = new wglt.FovMap(MAP_WIDTH, MAP_HEIGHT, (x, y) =&gt; map[y][x].blocked);</div>
<div class="c0"> let fovRecompute = true;</div>
<!--ENDDIFF-->
    </div>
    <script src="../../dist/index.umd.js"></script>
	<script src="part5.js"></script>
</body>

</html>