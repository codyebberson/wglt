<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>WGLT - Roguelike Tutorial - Part 3</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body>
    <canvas></canvas>
    <p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_3">Part 3: The dungeon</a></p>
    <p>Learn how to code up a neat little dungeon generator.</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part2.js	2019-12-15 15:46:23.992039700 -0800</div>
<div class="c2">+++ part3.js	2019-12-15 15:46:58.722957400 -0800</div>
<div class="c1">@@ -2,6 +2,8 @@</div>
<div class="c0"> import {Colors} from &#x27;../../src/colors.js&#x27;;</div>
<div class="c0"> import {fromRgb} from &#x27;../../src/color.js&#x27;;</div>
<div class="c0"> import {Keys} from &#x27;../../src/keys.js&#x27;;</div>
<div class="c2">+import {Rect} from &#x27;../../src/rect.js&#x27;;</div>
<div class="c2">+import {RNG} from &#x27;../../src/rng.js&#x27;;</div>
<div class="c0"> import {Terminal} from &#x27;../../src/terminal.js&#x27;;</div>
<div class="c0"> import {TileMap} from &#x27;../../src/tilemap.js&#x27;;</div>
<div class="c0"> </div>
<div class="c1">@@ -13,6 +15,11 @@</div>
<div class="c0"> const MAP_WIDTH = 80;</div>
<div class="c0"> const MAP_HEIGHT = 45;</div>
<div class="c0"> </div>
<div class="c2">+// Parameters for dungeon generator</div>
<div class="c2">+const ROOM_MAX_SIZE = 10;</div>
<div class="c2">+const ROOM_MIN_SIZE = 6;</div>
<div class="c2">+const MAX_ROOMS = 30;</div>
<div class="c2">+</div>
<div class="c0"> const COLOR_DARK_WALL = fromRgb(0, 0, 100);</div>
<div class="c0"> const COLOR_DARK_GROUND = fromRgb(50, 50, 150);</div>
<div class="c0"> </div>
<div class="c1">@@ -37,6 +44,101 @@</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function createRoom(map: Console, room: Rect) {</div>
<div class="c2">+    for (let y = room.y + 1; y &lt; room.y2; y++) {</div>
<div class="c2">+        for (let x = room.x + 1; x &lt; room.x2; x++) {</div>
<div class="c2">+            map.grid[y][x].blocked = false;</div>
<div class="c2">+            map.grid[y][x].blockedSight = false;</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function createHTunnel(map: Console, x1: number, x2: number, y: number) {</div>
<div class="c2">+    for (let x = Math.min(x1, x2); x &lt;= Math.max(x1, x2); x++) {</div>
<div class="c2">+        map.grid[y][x].blocked = false;</div>
<div class="c2">+        map.grid[y][x].blockedSight = false;</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function createVTunnel(map: Console, y1: number, y2: number, x: number) {</div>
<div class="c2">+    for (let y = Math.min(y1, y2); y &lt;= Math.max(y1, y2); y++) {</div>
<div class="c2">+        map.grid[y][x].blocked = false;</div>
<div class="c2">+        map.grid[y][x].blockedSight = false;</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function createMap() {</div>
<div class="c2">+    const map = new Console(MAP_WIDTH, MAP_HEIGHT);</div>
<div class="c2">+    for (let y = 0; y &lt; MAP_HEIGHT; y++) {</div>
<div class="c2">+        for (let x = 0; x &lt; MAP_WIDTH; x++) {</div>
<div class="c2">+            map.grid[y][x].blocked = true;</div>
<div class="c2">+            map.grid[y][x].blockedSight = true;</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    const rooms = [];</div>
<div class="c2">+</div>
<div class="c2">+    for (let r = 0; r &lt; MAX_ROOMS; r++) {</div>
<div class="c2">+        // Random width and height</div>
<div class="c2">+        const w = rng.nextRange(ROOM_MIN_SIZE, ROOM_MAX_SIZE);</div>
<div class="c2">+        const h = rng.nextRange(ROOM_MIN_SIZE, ROOM_MAX_SIZE);</div>
<div class="c2">+</div>
<div class="c2">+        // Random position without going out of the boundaries of the map</div>
<div class="c2">+        const x = rng.nextRange(0, MAP_WIDTH - w - 1);</div>
<div class="c2">+        const y = rng.nextRange(0, MAP_HEIGHT - h - 1);</div>
<div class="c2">+</div>
<div class="c2">+        // &quot;Rect&quot; class makes rectangles easier to work with</div>
<div class="c2">+        const newRoom = new Rect(x, y, w, h);</div>
<div class="c2">+</div>
<div class="c2">+        // Run through the other rooms and see if they intersect with this one</div>
<div class="c2">+        let failed = false;</div>
<div class="c2">+        for (let j = 0; j &lt; rooms.length; j++) {</div>
<div class="c2">+            if (newRoom.intersects(rooms[j])) {</div>
<div class="c2">+                failed = true;</div>
<div class="c2">+                break;</div>
<div class="c2">+            }</div>
<div class="c2">+        }</div>
<div class="c2">+</div>
<div class="c2">+        if (!failed) {</div>
<div class="c2">+            // This means there are no intersections, so this room is valid</div>
<div class="c2">+</div>
<div class="c2">+            // &quot;paint&quot; it to the map&#x27;s tiles</div>
<div class="c2">+            createRoom(map, newRoom);</div>
<div class="c2">+</div>
<div class="c2">+            // Center coordinates of new room, will be useful later</div>
<div class="c2">+            const center = newRoom.getCenter();</div>
<div class="c2">+</div>
<div class="c2">+            if (rooms.length === 0) {</div>
<div class="c2">+                // This is the first room, where the player starts at</div>
<div class="c2">+                player.x = center.x;</div>
<div class="c2">+                player.y = center.y;</div>
<div class="c2">+            } else {</div>
<div class="c2">+                // All rooms after the first:</div>
<div class="c2">+                // Connect it to the previous room with a tunnel</div>
<div class="c2">+</div>
<div class="c2">+                // Center coordinates of previous room</div>
<div class="c2">+                const prev = rooms[rooms.length - 1].getCenter();</div>
<div class="c2">+</div>
<div class="c2">+                // Draw a coin (random number that is either 0 or 1)</div>
<div class="c2">+                if (rng.nextRange(0, 1) === 1) {</div>
<div class="c2">+                    // First move horizontally, then vertically</div>
<div class="c2">+                    createHTunnel(map, prev.x, center.x, prev.y);</div>
<div class="c2">+                    createVTunnel(map, prev.y, center.y, center.x);</div>
<div class="c2">+                } else {</div>
<div class="c2">+                    // First move vertically, then horizontally</div>
<div class="c2">+                    createVTunnel(map, prev.y, center.y, prev.x);</div>
<div class="c2">+                    createHTunnel(map, prev.x, center.x, center.y);</div>
<div class="c2">+                }</div>
<div class="c2">+            }</div>
<div class="c2">+</div>
<div class="c2">+            // Finally, append the new room to the list</div>
<div class="c2">+            rooms.push(newRoom);</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    return map;</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function handleKeys() {</div>
<div class="c0">     if (term.isKeyPressed(Keys.VK_UP)) {</div>
<div class="c0">         player.move(0, -1);</div>
<div class="c1">@@ -70,15 +172,11 @@</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> const term = new Terminal(document.querySelector(&#x27;canvas&#x27;), SCREEN_WIDTH, SCREEN_HEIGHT);</div>
<div class="c2">+const rng = new RNG(1);</div>
<div class="c0"> const player = new Entity(40, 25, &#x27;@&#x27;, Colors.WHITE);</div>
<div class="c0"> const npc = new Entity(40, 20, &#x27;@&#x27;, Colors.YELLOW);</div>
<div class="c0"> const entities = [player, npc];</div>
<div class="c3">-const map = new Console(MAP_WIDTH, MAP_HEIGHT);</div>
<div class="c3">-</div>
<div class="c3">-map.grid[22][30].blocked = true;</div>
<div class="c3">-map.grid[22][30].blockedSight = true;</div>
<div class="c3">-map.grid[22][50].blocked = true;</div>
<div class="c3">-map.grid[22][50].blockedSight = true;</div>
<div class="c2">+const map = createMap();</div>
<div class="c0"> </div>
<div class="c0"> term.update = function () {</div>
<div class="c0">     handleKeys();</div>
<!--ENDDIFF-->
    </div>
    <script src="part3.min.js"></script>
</body>

</html>