<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>WGLT - Roguelike Tutorial - Part 3</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body>
    <canvas></canvas>
    <p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_3">Part 3: The dungeon</a></p>
    <p>Learn how to code up a neat little dungeon generator.</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part2.js	2019-02-16 11:54:55.000000000 -0800</div>
<div class="c2">+++ part3.js	2019-02-16 11:55:52.000000000 -0800</div>
<div class="c1">@@ -7,17 +7,98 @@</div>
<div class="c0"> const TILE_WALL = 1 + 2 * 64 + 0;</div>
<div class="c0"> const TILE_FLOOR = 1 + 2 * 64 + 1;</div>
<div class="c0"> </div>
<div class="c2">+// Parameters for dungeon generator</div>
<div class="c2">+const ROOM_MAX_SIZE = 10;</div>
<div class="c2">+const ROOM_MIN_SIZE = 6;</div>
<div class="c2">+const MAX_ROOMS = 30;</div>
<div class="c2">+</div>
<div class="c2">+function createRoom(map, room) {</div>
<div class="c2">+    for (let y = room.y1 + 1; y &lt; room.y2; y++) {</div>
<div class="c2">+        for (let x = room.x1 + 1; x &lt; room.x2; x++) {</div>
<div class="c2">+            map.setTile(0, x, y, TILE_FLOOR, false);</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function createHTunnel(map, x1, x2, y) {</div>
<div class="c2">+    for (let x = Math.min(x1, x2); x &lt;= Math.max(x1, x2); x++) {</div>
<div class="c2">+        map.setTile(0, x, y, TILE_FLOOR, false);</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function createVTunnel(map, y1, y2, x) {</div>
<div class="c2">+    for (let y = Math.min(y1, y2); y &lt;= Math.max(y1, y2); y++) {</div>
<div class="c2">+        map.setTile(0, x, y, TILE_FLOOR, false);</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function createMap() {</div>
<div class="c3">-    // Clear the map to all floor</div>
<div class="c2">+    // Clear the map to all walls</div>
<div class="c0">     for (let y = 0; y &lt; MAP_HEIGHT; y++) {</div>
<div class="c0">         for (let x = 0; x &lt; MAP_WIDTH; x++) {</div>
<div class="c3">-            map.setTile(0, x, y, TILE_FLOOR, false);</div>
<div class="c2">+            map.setTile(0, x, y, TILE_WALL, true);</div>
<div class="c0">         }</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c3">-    // Add a couple walls</div>
<div class="c3">-    map.setTile(0, 25, 22, TILE_WALL, true);</div>
<div class="c3">-    map.setTile(0, 35, 22, TILE_WALL, true);</div>
<div class="c2">+    const rooms = [];</div>
<div class="c2">+</div>
<div class="c2">+    for (let r = 0; r &lt; MAX_ROOMS; r++) {</div>
<div class="c2">+        // Random width and height</div>
<div class="c2">+        const w = rng.nextRange(ROOM_MIN_SIZE, ROOM_MAX_SIZE);</div>
<div class="c2">+        const h = rng.nextRange(ROOM_MIN_SIZE, ROOM_MAX_SIZE);</div>
<div class="c2">+</div>
<div class="c2">+        // Random position without going out of the boundaries of the map</div>
<div class="c2">+        const x = rng.nextRange(1, MAP_WIDTH - w - 2);</div>
<div class="c2">+        const y = rng.nextRange(1, MAP_HEIGHT - h - 2);</div>
<div class="c2">+</div>
<div class="c2">+        // &quot;Rect&quot; class makes rectangles easier to work with</div>
<div class="c2">+        const newRoom = new wglt.Rect(x, y, w, h);</div>
<div class="c2">+</div>
<div class="c2">+        // Run through the other rooms and see if they intersect with this one</div>
<div class="c2">+        let failed = false;</div>
<div class="c2">+        for (let j = 0; j &lt; rooms.length; j++) {</div>
<div class="c2">+            if (newRoom.intersects(rooms[j])) {</div>
<div class="c2">+                failed = true;</div>
<div class="c2">+                break;</div>
<div class="c2">+            }</div>
<div class="c2">+        }</div>
<div class="c2">+</div>
<div class="c2">+        if (!failed) {</div>
<div class="c2">+            // This means there are no intersections, so this room is valid</div>
<div class="c2">+</div>
<div class="c2">+            // &quot;paint&quot; it to the map&#x27;s tiles</div>
<div class="c2">+            createRoom(map, newRoom);</div>
<div class="c2">+</div>
<div class="c2">+            // Center coordinates of new room, will be useful later</div>
<div class="c2">+            const center = newRoom.getCenter();</div>
<div class="c2">+</div>
<div class="c2">+            if (rooms.length === 0) {</div>
<div class="c2">+                // This is the first room, where the player starts at</div>
<div class="c2">+                player.x = center.x;</div>
<div class="c2">+                player.y = center.y;</div>
<div class="c2">+            } else {</div>
<div class="c2">+                // All rooms after the first:</div>
<div class="c2">+                // Connect it to the previous room with a tunnel</div>
<div class="c2">+</div>
<div class="c2">+                // Center coordinates of previous room</div>
<div class="c2">+                const prev = rooms[rooms.length - 1].getCenter();</div>
<div class="c2">+</div>
<div class="c2">+                // Draw a coin (random number that is either 0 or 1)</div>
<div class="c2">+                if (rng.nextRange(0, 1) === 1) {</div>
<div class="c2">+                    // First move horizontally, then vertically</div>
<div class="c2">+                    createHTunnel(map, prev.x, center.x, prev.y);</div>
<div class="c2">+                    createVTunnel(map, prev.y, center.y, center.x);</div>
<div class="c2">+                } else {</div>
<div class="c2">+                    // First move vertically, then horizontally</div>
<div class="c2">+                    createVTunnel(map, prev.y, center.y, prev.x);</div>
<div class="c2">+                    createHTunnel(map, prev.x, center.x, center.y);</div>
<div class="c2">+                }</div>
<div class="c2">+            }</div>
<div class="c2">+</div>
<div class="c2">+            // Finally, append the new room to the list</div>
<div class="c2">+            rooms.push(newRoom);</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> const app = new wglt.App({</div>
<div class="c1">@@ -32,6 +113,7 @@</div>
<div class="c0">     tileHeight: 16</div>
<div class="c0"> });</div>
<div class="c0"> </div>
<div class="c2">+const rng = new wglt.RNG(1);</div>
<div class="c0"> const sprite = new wglt.Sprite(0, 16, 16, 16, 2, true);</div>
<div class="c0"> const player = new wglt.Entity(game, 30, 20, &#x27;Player&#x27;, sprite, true);</div>
<div class="c0"> const map = new wglt.TileMap(app.gl, MAP_WIDTH, MAP_HEIGHT, 1);</div>
<!--ENDDIFF-->
    </div>
    <script src="../../dist/index.js"></script>
    <script src="part3.js"></script>
</body>

</html>
