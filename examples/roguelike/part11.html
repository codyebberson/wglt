<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>WGLT - Roguelike Tutorial - Part 11</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body class="example">
	<canvas></canvas>
	<p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_11">Part 11: Dungeon levels and character progression</a></p>
	<p>Let the player venture deeper into the dungeon and grow stronger, including experience gain, levels and raising stats!</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part10.ts	2020-11-23 12:54:20.462634300 -0800</div>
<div class="c2">+++ part11.ts	2020-11-23 12:54:18.049172200 -0800</div>
<div class="c1">@@ -38,14 +38,18 @@</div>
<div class="c0"> const TORCH_RADIUS = 10;</div>
<div class="c0"> </div>
<div class="c0"> // Spell values</div>
<div class="c3">-const HEAL_AMOUNT = 4;</div>
<div class="c3">-const LIGHTNING_DAMAGE = 20;</div>
<div class="c2">+const HEAL_AMOUNT = 40;</div>
<div class="c2">+const LIGHTNING_DAMAGE = 40;</div>
<div class="c0"> const LIGHTNING_RANGE = 5;</div>
<div class="c0"> const CONFUSE_RANGE = 8;</div>
<div class="c0"> const CONFUSE_NUM_TURNS = 10;</div>
<div class="c0"> const FIREBALL_RANGE = 10;</div>
<div class="c0"> const FIREBALL_RADIUS = 3;</div>
<div class="c3">-const FIREBALL_DAMAGE = 12;</div>
<div class="c2">+const FIREBALL_DAMAGE = 25;</div>
<div class="c2">+</div>
<div class="c2">+// Experience and level-ups</div>
<div class="c2">+const LEVEL_UP_BASE = 200;</div>
<div class="c2">+const LEVEL_UP_FACTOR = 150;</div>
<div class="c0"> </div>
<div class="c0"> const COLOR_DARK_WALL = fromRgb(0, 0, 100);</div>
<div class="c0"> const COLOR_LIGHT_WALL = fromRgb(130, 110, 50);</div>
<div class="c1">@@ -133,20 +137,14 @@</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> class Fighter {</div>
<div class="c3">-    owner?: Entity;</div>
<div class="c3">-    maxHp: number;</div>
<div class="c3">-    defense: number;</div>
<div class="c3">-    power: number;</div>
<div class="c3">-    hp: number;</div>
<div class="c3">-    deathFunction?: (e: Entity) =&gt; void;</div>
<div class="c3">-</div>
<div class="c3">-    constructor(hp: number, defense: number, power: number, deathFunction?: (e: Entity) =&gt; void) {</div>
<div class="c2">+    constructor(hp, defense, power, xp, deathFunction) {</div>
<div class="c0">         this.owner = undefined;</div>
<div class="c0">         this.maxHp = hp;</div>
<div class="c0">         this.defense = defense;</div>
<div class="c0">         this.power = power;</div>
<div class="c0">         this.hp = hp;</div>
<div class="c3">-        this.deathFunction = deathFunction;</div>
<div class="c2">+        this.xp = xp;</div>
<div class="c2">+        this.deathFunction = deathFunction || null;</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c0">     attack(target: Entity) {</div>
<div class="c1">@@ -177,6 +175,10 @@</div>
<div class="c0">             if (this.deathFunction) {</div>
<div class="c0">                 this.deathFunction(this.owner);</div>
<div class="c0">             }</div>
<div class="c2">+            if (this.owner !== player) {</div>
<div class="c2">+                player.fighter.xp += this.xp;</div>
<div class="c2">+                checkLevelUp();</div>
<div class="c2">+            }</div>
<div class="c0">         }</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c1">@@ -396,6 +398,12 @@</div>
<div class="c0">         }</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c2">+    // Create stairs at the center of the last room</div>
<div class="c2">+    const stairsLoc = rooms[rooms.length - 1].getCenter();</div>
<div class="c2">+    stairs = new Entity(stairsLoc.x, stairsLoc.y, &#x27;&lt;&#x27;, &#x27;stairs&#x27;, Colors.WHITE);</div>
<div class="c2">+    entities.push(stairs);</div>
<div class="c2">+    stairs.sendToBack();</div>
<div class="c2">+</div>
<div class="c0">     return map;</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c1">@@ -413,12 +421,12 @@</div>
<div class="c0">         // 80% chance of getting an orc</div>
<div class="c0">         if (rng.nextRange(0, 100) &lt; 80) {</div>
<div class="c0">             // Create an orc</div>
<div class="c3">-            const fighter = new Fighter(10, 0, 3, monsterDeath);</div>
<div class="c2">+            const fighter = new Fighter(10, 0, 3, 35, monsterDeath);</div>
<div class="c0">             const ai = new BasicMonster();</div>
<div class="c0">             monster = new Entity(x, y, &#x27;o&#x27;, &#x27;orc&#x27;, Colors.LIGHT_GREEN, true, { fighter: fighter, ai: ai });</div>
<div class="c0">         } else {</div>
<div class="c0">             // Create a troll</div>
<div class="c3">-            const fighter = new Fighter(16, 1, 4, monsterDeath);</div>
<div class="c2">+            const fighter = new Fighter(16, 1, 4, 100, monsterDeath);</div>
<div class="c0">             const ai = new BasicMonster();</div>
<div class="c0">             monster = new Entity(x, y, &#x27;T&#x27;, &#x27;troll&#x27;, Colors.DARK_GREEN, true, { fighter: fighter, ai: ai });</div>
<div class="c0">         }</div>
<div class="c1">@@ -606,6 +614,21 @@</div>
<div class="c0">             gui.add(new SelectDialog(&#x27;INVENTORY&#x27;, options, useInventory));</div>
<div class="c0">         }</div>
<div class="c0">     }</div>
<div class="c2">+    if (term.isKeyPressed(Keys.VK_C)) {</div>
<div class="c2">+        const levelUpXp = LEVEL_UP_BASE + player.level * LEVEL_UP_FACTOR;</div>
<div class="c2">+        gui.add(new MessageDialog(&#x27;CHARACTER&#x27;,</div>
<div class="c2">+            &#x27;Level: &#x27; + player.level +</div>
<div class="c2">+            &#x27;\nExperience: &#x27; + player.fighter.xp +</div>
<div class="c2">+            &#x27;\nExperience to level up: &#x27; + levelUpXp +</div>
<div class="c2">+            &#x27;\n\nMaximum HP: &#x27; + player.fighter.maxHp +</div>
<div class="c2">+            &#x27;\nAttack: &#x27; + player.fighter.power +</div>
<div class="c2">+            &#x27;\nDefense: &#x27; + player.fighter.defense));</div>
<div class="c2">+    }</div>
<div class="c2">+    if (term.isKeyPressed(Keys.VK_COMMA)) {</div>
<div class="c2">+        if (player.x === stairs.x &amp;&amp; player.y === stairs.y) {</div>
<div class="c2">+            nextLevel();</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function useInventory(choice: number) {</div>
<div class="c1">@@ -614,12 +637,39 @@</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function checkLevelUp() {</div>
<div class="c2">+    // See if the player&#x27;s experience is enough to level-up</div>
<div class="c2">+    const levelUpXp = LEVEL_UP_BASE + player.level * LEVEL_UP_FACTOR;</div>
<div class="c2">+    if (player.fighter.xp &gt;= levelUpXp) {</div>
<div class="c2">+        player.level++;</div>
<div class="c2">+        player.fighter.xp -= levelUpXp;</div>
<div class="c2">+        addMessage(&#x27;Your battle skills grow stronger! You reached level &#x27; + player.level + &#x27;!&#x27;, Colors.YELLOW);</div>
<div class="c2">+</div>
<div class="c2">+        const options = [</div>
<div class="c2">+            &#x27;Constitution (+20 HP, from &#x27; + player.fighter.maxHp + &#x27;)&#x27;,</div>
<div class="c2">+            &#x27;Strength (+1 attack, from &#x27; + player.fighter.power + &#x27;)&#x27;,</div>
<div class="c2">+            &#x27;Agility (+1 defense, from &#x27; + player.fighter.defense + &#x27;)&#x27;</div>
<div class="c2">+        ];</div>
<div class="c2">+</div>
<div class="c2">+        gui.add(new SelectDialog(&#x27;LEVEL UP&#x27;, options, (choice) =&gt; {</div>
<div class="c2">+            if (choice === 0) {</div>
<div class="c2">+                player.fighter.maxHp += 20;</div>
<div class="c2">+                player.fighter.hp += 20;</div>
<div class="c2">+            } else if (choice === 1) {</div>
<div class="c2">+                player.fighter.power += 1;</div>
<div class="c2">+            } else if (choice === 2) {</div>
<div class="c2">+                player.fighter.defense += 1;</div>
<div class="c2">+            }</div>
<div class="c2">+        }));</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function playerDeath(player: Entity) {</div>
<div class="c0">     addMessage(&#x27;You died!&#x27;, Colors.LIGHT_RED);</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function monsterDeath(monster: Entity) {</div>
<div class="c3">-    addMessage(capitalize(monster.name) + &#x27; is dead!&#x27;, Colors.BROWN);</div>
<div class="c2">+    addMessage(capitalize(monster.name) + &#x27; is dead! You gain &#x27; + monster.fighter.xp + &#x27; XP.&#x27;, Colors.ORANGE);</div>
<div class="c0">     monster.char = &#x27;%&#x27;;</div>
<div class="c0">     monster.color = Colors.DARK_RED;</div>
<div class="c0">     monster.blocks = false;</div>
<div class="c1">@@ -788,6 +838,13 @@</div>
<div class="c0">         &#x27;HP&#x27;, (player.fighter as Fighter).hp, (player.fighter as Fighter).maxHp,</div>
<div class="c0">         Colors.LIGHT_RED, Colors.DARK_RED);</div>
<div class="c0"> </div>
<div class="c2">+    renderBar(</div>
<div class="c2">+        1, PANEL_Y + 2, BAR_WIDTH,</div>
<div class="c2">+        &#x27;XP&#x27;, player.fighter.xp, LEVEL_UP_BASE + player.level * LEVEL_UP_FACTOR,</div>
<div class="c2">+        Colors.LIGHT_MAGENTA, Colors.DARK_MAGENTA);</div>
<div class="c2">+</div>
<div class="c2">+    term.drawString(1, PANEL_Y + 4, &#x27;Dungeon level &#x27; + dungeonLevel, Colors.ORANGE);</div>
<div class="c2">+</div>
<div class="c0">     // Display names of objects under the mouse</div>
<div class="c0">     term.drawString(1, PANEL_Y, getNamesUnderMouse(), Colors.LIGHT_GRAY);</div>
<div class="c0"> </div>
<div class="c1">@@ -817,9 +874,11 @@</div>
<div class="c0"> </div>
<div class="c0"> function newGame() {</div>
<div class="c0">     rng = new RNG(Date.now());</div>
<div class="c3">-    player = new Entity(40, 25, &#x27;@&#x27;, &#x27;player&#x27;, Colors.WHITE, true, { fighter: new Fighter(20, 2, 5, playerDeath) });</div>
<div class="c2">+    player = new Entity(40, 25, &#x27;@&#x27;, &#x27;player&#x27;, Colors.WHITE, true, { fighter: new Fighter(20, 2, 5, 0, playerDeath) });</div>
<div class="c2">+    player.level = 1;</div>
<div class="c0">     entities = [player];</div>
<div class="c0">     messages = [];</div>
<div class="c2">+    dungeonLevel = 1;</div>
<div class="c0">     map = createMap();</div>
<div class="c0">     fovRecompute = true;</div>
<div class="c0">     inventory = [];</div>
<div class="c1">@@ -827,6 +886,17 @@</div>
<div class="c0">     appState = &#x27;game&#x27;;</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function nextLevel() {</div>
<div class="c2">+    // Advance to the next level</div>
<div class="c2">+    addMessage(&#x27;You take a moment to rest, and recover your strength.&#x27;, Colors.LIGHT_MAGENTA);</div>
<div class="c2">+    player.fighter.heal(player.fighter.maxHp / 2); // heal the player by 50%</div>
<div class="c2">+    dungeonLevel++;</div>
<div class="c2">+    addMessage(&#x27;After a rare moment of peace, you descend deeper...&#x27;, Colors.LIGHT_RED);</div>
<div class="c2">+    entities = [player];</div>
<div class="c2">+    map = createMap(); // Create a fresh new level!</div>
<div class="c2">+    fovRecompute = true;</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function playGame() {</div>
<div class="c0">     handleKeys();</div>
<div class="c0">     renderAll();</div>
<div class="c1">@@ -861,8 +931,10 @@</div>
<div class="c0"> const gui = new GUI(term);</div>
<div class="c0"> let rng = null;</div>
<div class="c0"> let player = null;</div>
<div class="c2">+let stairs = null;</div>
<div class="c0"> let entities = null;</div>
<div class="c0"> let messages = null;</div>
<div class="c2">+let dungeonLevel = 0;</div>
<div class="c0"> let map = null;</div>
<div class="c0"> let fovRecompute = true;</div>
<div class="c0"> let inventory = null;</div>
<!--ENDDIFF-->
    </div>
	<script src="part11.min.js"></script>
</body>

</html>