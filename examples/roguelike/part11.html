<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>WGLT - Roguelike Tutorial - Part 11</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body>
	<canvas></canvas>
	<p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_11">Part 11: Dungeon levels and character progression</a></p>
	<p>Let the player venture deeper into the dungeon and grow stronger, including experience gain, levels and raising stats!</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part10.js	2019-02-16 17:52:56.000000000 -0800</div>
<div class="c2">+++ part11.js	2019-02-17 17:09:04.000000000 -0800</div>
<div class="c1">@@ -53,6 +53,9 @@</div>
<div class="c0">         }</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c2">+    // Reset field-of-view</div>
<div class="c2">+    map.resetFov();</div>
<div class="c2">+</div>
<div class="c0">     const rooms = [];</div>
<div class="c0"> </div>
<div class="c0">     for (let r = 0; r &lt; MAX_ROOMS; r++) {</div>
<div class="c1">@@ -93,7 +96,7 @@</div>
<div class="c0">                 // TEMP: Give the player a fireball</div>
<div class="c0">                 const item = new wglt.Item(game, player.x, player.y + 1, &#x27;fireball&#x27;, new wglt.Sprite(144, 16, 16, 16, 1));</div>
<div class="c0">                 item.onPickup = pickupCallback;</div>
<div class="c3">-                item.onUse = castFireball;</div>
<div class="c2">+                item.onUse = castConfuse;</div>
<div class="c0">                 game.items.push(item);</div>
<div class="c0"> </div>
<div class="c0">             } else {</div>
<div class="c1">@@ -122,6 +125,12 @@</div>
<div class="c0">             rooms.push(newRoom);</div>
<div class="c0">         }</div>
<div class="c0">     }</div>
<div class="c2">+</div>
<div class="c2">+    // Create stairs at the center of the last room</div>
<div class="c2">+    const stairsLoc = rooms[rooms.length - 1].getCenter();</div>
<div class="c2">+    stairs = new wglt.Entity(game, stairsLoc.x, stairsLoc.y, &#x27;stairs&#x27;, new wglt.Sprite(32, 32, 16, 16, 1), true);</div>
<div class="c2">+    game.entities.push(stairs);</div>
<div class="c2">+    // stairs.sendToBack();</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function placeObjects(room) {</div>
<div class="c1">@@ -145,6 +154,7 @@</div>
<div class="c0">         }</div>
<div class="c0"> </div>
<div class="c0">         monster.health = 20;</div>
<div class="c2">+        monster.canAttack = true;</div>
<div class="c0">         monster.ai = new wglt.BasicMonster(monster);</div>
<div class="c0">         monster.onAttack = attackCallback;</div>
<div class="c0">         monster.onDeath = monsterDeath;</div>
<div class="c1">@@ -205,7 +215,7 @@</div>
<div class="c0">     let result = null;</div>
<div class="c0">     for (let i = 0; i &lt; game.entities.length; i++) {</div>
<div class="c0">         const entity = game.entities[i];</div>
<div class="c3">-        if (entity !== app.player) {</div>
<div class="c2">+        if (entity !== player) {</div>
<div class="c0">             const dist = entity.distance(x, y);</div>
<div class="c0">             if (dist &lt; minDist) {</div>
<div class="c0">                 minDist = dist;</div>
<div class="c1">@@ -222,13 +232,13 @@</div>
<div class="c0"> </div>
<div class="c0"> function castHeal(item, entity) {</div>
<div class="c0">     // Heal the player</div>
<div class="c3">-    if (entity.health === entity.maxHealth) {</div>
<div class="c2">+    if (player.health === player.maxHealth) {</div>
<div class="c0">         messageLog.add(&#x27;You are already at full health.&#x27;, wglt.Colors.DARK_RED);</div>
<div class="c0">         return;</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c0">     messageLog.add(&#x27;Your wounds start to feel better!&#x27;, wglt.Colors.LIGHT_MAGENTA);</div>
<div class="c3">-    entity.health += HEAL_AMOUNT;</div>
<div class="c2">+    player.health += HEAL_AMOUNT;</div>
<div class="c0">     item.remove();</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c1">@@ -278,7 +288,7 @@</div>
<div class="c0"> </div>
<div class="c0">         messageLog.add(&#x27;The fireball explodes, burning everything within &#x27; + FIREBALL_RADIUS + &#x27; tiles!&#x27;, wglt.Colors.ORANGE);</div>
<div class="c0"> </div>
<div class="c3">-        for (let i = 0; i &lt; game.entities.length; i++) {</div>
<div class="c2">+        for (let i = game.entities.length - 1; i &gt;= 0; i--) {</div>
<div class="c0">             const entity = game.entities[i];</div>
<div class="c0">             if (entity.distance(x, y) &lt;= FIREBALL_RADIUS) {</div>
<div class="c0">                 messageLog.add(&#x27;The &#x27; + entity.name + &#x27; gets burned for &#x27; + FIREBALL_DAMAGE + &#x27; hit points.&#x27;, wglt.Colors.ORANGE);</div>
<div class="c1">@@ -294,7 +304,7 @@</div>
<div class="c0"> function castConfuse(item) {</div>
<div class="c0">     // Ask the player for a target to confuse</div>
<div class="c0">     messageLog.add(&#x27;Left-click to cast confuse, or right-click to cancel.&#x27;, wglt.Colors.LIGHT_CYAN);</div>
<div class="c3">-    app.startTargeting((x, y) =&gt; {</div>
<div class="c2">+    game.startTargeting((x, y) =&gt; {</div>
<div class="c0">         if (player.distance(x, y) &gt; CONFUSE_RANGE) {</div>
<div class="c0">             messageLog.add(&#x27;Target out of range.&#x27;, wglt.Colors.LIGHT_GRAY);</div>
<div class="c0">             return;</div>
<div class="c1">@@ -306,8 +316,8 @@</div>
<div class="c0">             return;</div>
<div class="c0">         }</div>
<div class="c0"> </div>
<div class="c3">-        monster.ai = new ConfusedMonster(monster.ai);</div>
<div class="c3">-        monster.ai.owner = monster;</div>
<div class="c2">+        monster.ai = new wglt.ConfusedMonster(monster);</div>
<div class="c2">+        // monster.ai.owner = monster;</div>
<div class="c0">         messageLog.add(&#x27;The eyes of the &#x27; + monster.name + &#x27; look vacant, as he stumbles around!&#x27;, wglt.Colors.LIGHT_GREEN);</div>
<div class="c0">         item.remove();</div>
<div class="c0">     });</div>
<div class="c1">@@ -333,6 +343,32 @@</div>
<div class="c0">     monster.ai = null;</div>
<div class="c0">     monster.name = &#x27;remains of &#x27; + monster.name;</div>
<div class="c0">     monster.sendToBack();</div>
<div class="c2">+</div>
<div class="c2">+    const xpGain = 10;</div>
<div class="c2">+    player.xp += xpGain;</div>
<div class="c2">+</div>
<div class="c2">+    while (player.xp &gt;= player.maxXp) {</div>
<div class="c2">+        player.level++;</div>
<div class="c2">+        player.xp = 0;</div>
<div class="c2">+        player.maxXp *= 2;</div>
<div class="c2">+        messageLog.add(&#x27;You reached level &#x27; + player.level, 0xFF8000FF);</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function nextLevel() {</div>
<div class="c2">+    // Advance to the next level</div>
<div class="c2">+    messageLog.add(&#x27;You take a moment to rest, and recover your strength.&#x27;, wglt.Colors.LIGHT_MAGENTA);</div>
<div class="c2">+    // player.fighter.heal(player.fighter.maxHp / 2); // heal the player by 50%</div>
<div class="c2">+    // dungeonLevel++;</div>
<div class="c2">+    messageLog.add(&#x27;After a rare moment of peace, you descend deeper...&#x27;, wglt.Colors.LIGHT_RED);</div>
<div class="c2">+    game.entities = [player];</div>
<div class="c2">+    // map = createMap(); // Create a fresh new level!</div>
<div class="c2">+    createMap();</div>
<div class="c2">+    // fovMap = new wglt.FovMap(MAP_WIDTH, MAP_HEIGHT, (x, y) =&gt; map[y][x].blocked);</div>
<div class="c2">+    // fovRecompute = true;</div>
<div class="c2">+</div>
<div class="c2">+    // Initial FOV</div>
<div class="c2">+    game.tileMap.computeFov(player.x, player.y, 12);</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> const app = new wglt.App({</div>
<div class="c1">@@ -355,6 +391,23 @@</div>
<div class="c0"> const player = new wglt.Entity(game, 30, 20, &#x27;Player&#x27;, sprite, true);</div>
<div class="c0"> player.onAttack = attackCallback;</div>
<div class="c0"> player.onDeath = playerDeath;</div>
<div class="c2">+player.level = 1;</div>
<div class="c2">+player.xp = 0;</div>
<div class="c2">+player.maxXp = 10;</div>
<div class="c2">+player.onBump = function (other) {</div>
<div class="c2">+    // if (other.canPickup) {</div>
<div class="c2">+</div>
<div class="c2">+    // }</div>
<div class="c2">+    if (other.canAttack) {</div>
<div class="c2">+        player.attack(other);</div>
<div class="c2">+        return true;</div>
<div class="c2">+    }</div>
<div class="c2">+    if (other.name === &#x27;stairs&#x27;) {</div>
<div class="c2">+        //console.log(&#x27;up da stairs&#x27;);</div>
<div class="c2">+        nextLevel();</div>
<div class="c2">+        return true;</div>
<div class="c2">+    }</div>
<div class="c2">+};</div>
<div class="c0"> </div>
<div class="c0"> const map = new wglt.TileMap(app.gl, MAP_WIDTH, MAP_HEIGHT, 1);</div>
<div class="c0"> game.tileMap = map;</div>
<div class="c1">@@ -368,11 +421,17 @@</div>
<div class="c0"> const playerStats = new wglt.Panel(game.gui, new wglt.Rect(1, 1, 100, 100));</div>
<div class="c0"> playerStats.drawContents = function () {</div>
<div class="c0">     const frameY = 0;</div>
<div class="c3">-    const hpPercent = player.health / player.maxHealth;</div>
<div class="c0">     app.drawString(player.name, 1, frameY);</div>
<div class="c2">+</div>
<div class="c2">+    const hpPercent = player.health / player.maxHealth;</div>
<div class="c0">     app.drawImage(0, frameY + 7, 32, 64, 32, 12);</div>
<div class="c0">     app.drawImage(2, frameY + 9, 32, 80, 8, 8, undefined, Math.round(hpPercent * 28));</div>
<div class="c0">     app.drawString(player.health + &#x27;/&#x27; + player.maxHealth, 3, frameY + 10);</div>
<div class="c2">+</div>
<div class="c2">+    const xpPercent = player.xp / player.maxXp;</div>
<div class="c2">+    app.drawImage(32, frameY + 7, 32, 64, 32, 12);</div>
<div class="c2">+    app.drawImage(34, frameY + 9, 32, 80, 8, 8, undefined, Math.round(xpPercent * 28));</div>
<div class="c2">+    app.drawString(player.xp + &#x27;/&#x27; + player.maxXp, 35, frameY + 10);</div>
<div class="c0"> };</div>
<div class="c0"> game.gui.add(playerStats);</div>
<div class="c0"> </div>
<div class="c1">@@ -397,7 +456,7 @@</div>
<div class="c0"> game.tileMap.computeFov(player.x, player.y, 12);</div>
<div class="c0"> </div>
<div class="c0"> const mainMenu = new wglt.AppState(app);</div>
<div class="c3">-mainMenu.update = function() {</div>
<div class="c2">+mainMenu.update = function () {</div>
<div class="c0">     // Draw background</div>
<div class="c0">     app.drawImage(0, 0, 0, 768, 400, 224);</div>
<div class="c0"> </div>
<!--ENDDIFF-->
    </div>
    <script src="../../dist/index.js"></script>
	<script src="part11.js"></script>
</body>

</html>
