<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>WGLT - Roguelike Tutorial - Part 4</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body>
	<canvas></canvas>
	<p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_4">Part 4: Field-of-view and exploration</a></p>
	<p>Display the player's field-of-view (FOV) and explore the dungeon gradually (also known as fog-of-war).</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part3.js	2019-12-15 15:46:58.722957400 -0800</div>
<div class="c2">+++ part4.js	2019-12-15 15:47:20.146711400 -0800</div>
<div class="c1">@@ -19,9 +19,12 @@</div>
<div class="c0"> const ROOM_MAX_SIZE = 10;</div>
<div class="c0"> const ROOM_MIN_SIZE = 6;</div>
<div class="c0"> const MAX_ROOMS = 30;</div>
<div class="c2">+const TORCH_RADIUS = 10;</div>
<div class="c0"> </div>
<div class="c0"> const COLOR_DARK_WALL = fromRgb(0, 0, 100);</div>
<div class="c2">+const COLOR_LIGHT_WALL = fromRgb(130, 110, 50);</div>
<div class="c0"> const COLOR_DARK_GROUND = fromRgb(50, 50, 150);</div>
<div class="c2">+const COLOR_LIGHT_GROUND = fromRgb(200, 180, 50);</div>
<div class="c0"> </div>
<div class="c0"> class Entity {
    x: number;
    y: number;
    char: string;
    name: string;
    color: Color;
    blocks: boolean;
</div>
<div class="c0">     constructor(x: number, y: number, char: string, color: Color) {</div>
<div class="c1">@@ -40,7 +43,9 @@</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c0">     draw() {</div>
<div class="c3">-        term.drawString(this.x, this.y, this.char, this.color);</div>
<div class="c2">+        if (map.isVisible(this.x, this.y)) {</div>
<div class="c2">+            term.drawString(this.x, this.y, this.char, this.color);</div>
<div class="c2">+        }</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c1">@@ -142,27 +147,44 @@</div>
<div class="c0"> function handleKeys() {</div>
<div class="c0">     if (term.isKeyPressed(Keys.VK_UP)) {</div>
<div class="c0">         player.move(0, -1);</div>
<div class="c2">+        fovRecompute = true;</div>
<div class="c0">     }</div>
<div class="c0">     if (term.isKeyPressed(Keys.VK_LEFT)) {</div>
<div class="c0">         player.move(-1, 0);</div>
<div class="c2">+        fovRecompute = true;</div>
<div class="c0">     }</div>
<div class="c0">     if (term.isKeyPressed(Keys.VK_RIGHT)) {</div>
<div class="c0">         player.move(1, 0);</div>
<div class="c2">+        fovRecompute = true;</div>
<div class="c0">     }</div>
<div class="c0">     if (term.isKeyPressed(Keys.VK_DOWN)) {</div>
<div class="c0">         player.move(0, 1);</div>
<div class="c2">+        fovRecompute = true;</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function renderAll() {</div>
<div class="c2">+    if (fovRecompute) {</div>
<div class="c2">+        map.computeFov(player.x, player.y, TORCH_RADIUS);</div>
<div class="c2">+        fovRecompute = false;</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c0">     for (let y = 0; y &lt; MAP_HEIGHT; y++) {</div>
<div class="c0">         for (let x = 0; x &lt; MAP_WIDTH; x++) {</div>
<div class="c3">-            let wall = map.grid[y][x].blockedSight;</div>
<div class="c3">-            if (wall) {</div>
<div class="c3">-                term.drawChar(x, y, 0, 0, COLOR_DARK_WALL);</div>
<div class="c3">-            } else {</div>
<div class="c3">-                term.drawChar(x, y, 0, 0, COLOR_DARK_GROUND);</div>
<div class="c2">+            const visible = map.isVisible(x, y);</div>
<div class="c2">+            const wall = map.grid[y][x].blockedSight;</div>
<div class="c2">+            let color = Colors.BLACK;</div>
<div class="c2">+</div>
<div class="c2">+            if (visible) {</div>
<div class="c2">+                // It&#x27;s visible</div>
<div class="c2">+                color = wall ? COLOR_LIGHT_WALL : COLOR_LIGHT_GROUND;</div>
<div class="c2">+                map.grid[y][x].explored = true;</div>
<div class="c2">+            } else if (map.grid[y][x].explored) {</div>
<div class="c2">+                // It&#x27;s remembered</div>
<div class="c2">+                color = wall ? COLOR_DARK_WALL : COLOR_DARK_GROUND;</div>
<div class="c0">             }</div>
<div class="c2">+</div>
<div class="c2">+            term.drawChar(x, y, 0, 0, color);</div>
<div class="c0">         }</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c1">@@ -177,6 +199,7 @@</div>
<div class="c0"> const npc = new Entity(40, 20, &#x27;@&#x27;, Colors.YELLOW);</div>
<div class="c0"> const entities = [player, npc];</div>
<div class="c0"> const map = createMap();</div>
<div class="c2">+let fovRecompute = true;</div>
<div class="c0"> </div>
<div class="c0"> term.update = function () {</div>
<div class="c0">     handleKeys();</div>
<!--ENDDIFF-->
    </div>
	<script src="part4.min.js"></script>
</body>

</html>