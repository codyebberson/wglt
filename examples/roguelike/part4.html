<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>WGLT - Roguelike Tutorial - Part 4</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body>
	<canvas></canvas>
	<p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_4">Part 4: Field-of-view and exploration</a></p>
	<p>Display the player's field-of-view (FOV) and explore the dungeon gradually (also known as fog-of-war).</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part3.js	2018-11-22 14:06:56.122070600 -0800</div>
<div class="c2">+++ part4.js	2018-11-22 14:07:00.532618100 -0800</div>
<div class="c1">@@ -11,13 +11,17 @@</div>
<div class="c0"> const ROOM_MAX_SIZE = 10;</div>
<div class="c0"> const ROOM_MIN_SIZE = 6;</div>
<div class="c0"> const MAX_ROOMS = 30;</div>
<div class="c2">+const TORCH_RADIUS = 10;</div>
<div class="c0"> </div>
<div class="c0"> const COLOR_DARK_WALL = wglt.fromRgb(0, 0, 100);</div>
<div class="c2">+const COLOR_LIGHT_WALL = wglt.fromRgb(130, 110, 50);</div>
<div class="c0"> const COLOR_DARK_GROUND = wglt.fromRgb(50, 50, 150);</div>
<div class="c2">+const COLOR_LIGHT_GROUND = wglt.fromRgb(200, 180, 50);</div>
<div class="c0"> </div>
<div class="c0"> function Tile(blocked) {</div>
<div class="c0">     this.blocked = blocked;</div>
<div class="c0">     this.blockSight = blocked;</div>
<div class="c2">+    this.explored = false;</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function Rect(x, y, w, h) {</div>
<div class="c1">@@ -54,7 +58,9 @@</div>
<div class="c0">     };</div>
<div class="c0"> </div>
<div class="c0">     this.draw = function () {</div>
<div class="c3">-        term.drawString(this.x, this.y, this.char, this.color);</div>
<div class="c2">+        if (fovMap.isVisible(this.x, this.y)) {</div>
<div class="c2">+            term.drawString(this.x, this.y, this.char, this.color);</div>
<div class="c2">+        }</div>
<div class="c0">     };</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c1">@@ -156,29 +162,46 @@</div>
<div class="c0"> function handleKeys() {</div>
<div class="c0">     if (term.isKeyPressed(wglt.Keys.VK_UP)) {</div>
<div class="c0">         player.move(0, -1);</div>
<div class="c2">+        fovRecompute = true;</div>
<div class="c0">     }</div>
<div class="c0">     if (term.isKeyPressed(wglt.Keys.VK_LEFT)) {</div>
<div class="c0">         player.move(-1, 0);</div>
<div class="c2">+        fovRecompute = true;</div>
<div class="c0">     }</div>
<div class="c0">     if (term.isKeyPressed(wglt.Keys.VK_RIGHT)) {</div>
<div class="c0">         player.move(1, 0);</div>
<div class="c2">+        fovRecompute = true;</div>
<div class="c0">     }</div>
<div class="c0">     if (term.isKeyPressed(wglt.Keys.VK_DOWN)) {</div>
<div class="c0">         player.move(0, 1);</div>
<div class="c2">+        fovRecompute = true;</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function renderAll() {</div>
<div class="c2">+    if (fovRecompute) {</div>
<div class="c2">+        fovMap.computeFov(player.x, player.y, TORCH_RADIUS);</div>
<div class="c2">+        fovRecompute = false;</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c0">     term.clear();</div>
<div class="c0"> </div>
<div class="c0">     for (let y = 0; y &lt; MAP_HEIGHT; y++) {</div>
<div class="c0">         for (let x = 0; x &lt; MAP_WIDTH; x++) {</div>
<div class="c3">-            let wall = map[y][x].blockSight;</div>
<div class="c3">-            if (wall) {</div>
<div class="c3">-                term.drawChar(x, y, 0, 0, COLOR_DARK_WALL);</div>
<div class="c3">-            } else {</div>
<div class="c3">-                term.drawChar(x, y, 0, 0, COLOR_DARK_GROUND);</div>
<div class="c2">+            const visible = fovMap.isVisible(x, y);</div>
<div class="c2">+            const wall = map[y][x].blockSight;</div>
<div class="c2">+            let color = wglt.Colors.BLACK;</div>
<div class="c2">+</div>
<div class="c2">+            if (visible) {</div>
<div class="c2">+                // It's visible</div>
<div class="c2">+                color = wall ? COLOR_LIGHT_WALL : COLOR_LIGHT_GROUND;</div>
<div class="c2">+                map[y][x].explored = true;</div>
<div class="c2">+            } else if (map[y][x].explored) {</div>
<div class="c2">+                // It's remembered</div>
<div class="c2">+                color = wall ? COLOR_DARK_WALL : COLOR_DARK_GROUND;</div>
<div class="c0">             }</div>
<div class="c2">+</div>
<div class="c2">+            term.drawChar(x, y, 0, 0, color);</div>
<div class="c0">         }</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c1">@@ -193,6 +216,8 @@</div>
<div class="c0"> const npc = new Entity(40, 20, '@', wglt.Colors.YELLOW);</div>
<div class="c0"> const entities = [player, npc];</div>
<div class="c0"> const map = createMap();</div>
<div class="c2">+const fovMap = new wglt.FovMap(MAP_WIDTH, MAP_HEIGHT, (x, y) =&gt; map[y][x].blocked);</div>
<div class="c2">+let fovRecompute = true;</div>
<div class="c0"> </div>
<div class="c0"> term.update = function () {</div>
<div class="c0">     handleKeys();</div>
<!--ENDDIFF-->
    </div>
    <script src="../../dist/index.umd.js"></script>
	<script src="part4.js"></script>
</body>

</html>