<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>WGLT - Roguelike Tutorial - Part 9</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body class="example">
	<canvas></canvas>
	<p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_9">Part 9: Spells and ranged combat</a></p>
	<p>The player's strategic choices increase exponentially as we add a few magic scrolls to the mix. Covers damage and mind spells, as well as ranged combat.</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part8.ts	2020-11-23 12:54:25.015765100 -0800</div>
<div class="c2">+++ part9.ts	2020-11-23 12:54:22.760264400 -0800</div>
<div class="c1">@@ -38,12 +38,24 @@</div>
<div class="c0"> </div>
<div class="c0"> // Spell values</div>
<div class="c0"> const HEAL_AMOUNT = 4;</div>
<div class="c2">+const LIGHTNING_DAMAGE = 20;</div>
<div class="c2">+const LIGHTNING_RANGE = 5;</div>
<div class="c2">+const CONFUSE_RANGE = 8;</div>
<div class="c2">+const CONFUSE_NUM_TURNS = 10;</div>
<div class="c2">+const FIREBALL_RANGE = 10;</div>
<div class="c2">+const FIREBALL_RADIUS = 3;</div>
<div class="c2">+const FIREBALL_DAMAGE = 12;</div>
<div class="c0"> </div>
<div class="c0"> const COLOR_DARK_WALL = fromRgb(0, 0, 100);</div>
<div class="c0"> const COLOR_LIGHT_WALL = fromRgb(130, 110, 50);</div>
<div class="c0"> const COLOR_DARK_GROUND = fromRgb(50, 50, 150);</div>
<div class="c0"> const COLOR_LIGHT_GROUND = fromRgb(200, 180, 50);</div>
<div class="c0"> </div>
<div class="c2">+interface AI {</div>
<div class="c2">+    owner?: Entity;</div>
<div class="c2">+    takeTurn(): void;</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> class Entity {</div>
<div class="c0">     x: number;</div>
<div class="c0">     y: number;</div>
<div class="c1">@@ -52,7 +64,7 @@</div>
<div class="c0">     color: Color;</div>
<div class="c0">     blocks: boolean;</div>
<div class="c0">     fighter?: Fighter;</div>
<div class="c3">-    ai?: BasicMonster;</div>
<div class="c2">+    ai?: AI;</div>
<div class="c0">     item?: Item;</div>
<div class="c0"> </div>
<div class="c0">     constructor(x: number, y: number, char: string, name: string, color: Color, blocks: boolean, components?: any) {</div>
<div class="c1">@@ -63,6 +75,7 @@</div>
<div class="c0">         this.color = color;</div>
<div class="c0">         this.blocks = !!blocks;</div>
<div class="c0"> </div>
<div class="c2">+</div>
<div class="c0">         if (components) {</div>
<div class="c0">             if (&#x27;fighter&#x27; in components) {</div>
<div class="c0">                 this.fighter = components.fighter;</div>
<div class="c1">@@ -98,6 +111,10 @@</div>
<div class="c0">         return Math.hypot(other.x - this.x, other.y - this.y);</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c2">+    distance(x: number, y: number) {</div>
<div class="c2">+        return Math.hypot(x - this.x, y - this.y);</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c0">     sendToBack() {</div>
<div class="c0">         this.remove();</div>
<div class="c0">         entities.unshift(this);</div>
<div class="c1">@@ -199,6 +216,33 @@</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+class ConfusedMonster {</div>
<div class="c2">+    owner?: Entity;</div>
<div class="c2">+    oldAi: AI;</div>
<div class="c2">+    numTurns: number;</div>
<div class="c2">+</div>
<div class="c2">+    constructor(oldAi: AI) {</div>
<div class="c2">+        this.owner = undefined;</div>
<div class="c2">+        this.oldAi = oldAi;</div>
<div class="c2">+        this.numTurns = CONFUSE_NUM_TURNS;</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    takeTurn() {</div>
<div class="c2">+        if (!this.owner) {</div>
<div class="c2">+            return;</div>
<div class="c2">+        }</div>
<div class="c2">+        if (this.numTurns &gt; 0) {</div>
<div class="c2">+            // Still confused...</div>
<div class="c2">+            // Move in a random direction, and decrease the number of turns confused</div>
<div class="c2">+            this.owner.move(rng.nextRange(-1, 1), rng.nextRange(-1, 1));</div>
<div class="c2">+            this.numTurns--;</div>
<div class="c2">+        } else {</div>
<div class="c2">+            this.owner.ai = this.oldAi;</div>
<div class="c2">+            addMessage(&#x27;The &#x27; + this.owner.name + &#x27; is no longer confused!&#x27;, Colors.LIGHT_RED);</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> class Item {</div>
<div class="c0">     owner?: Entity;</div>
<div class="c0">     useFunction: (item: Item) =&gt; void;</div>
<div class="c1">@@ -389,10 +433,25 @@</div>
<div class="c0">         const x = rng.nextRange(room.x + 1, room.x2 - 1)</div>
<div class="c0">         const y = rng.nextRange(room.y + 1, room.y2 - 1)</div>
<div class="c0"> </div>
<div class="c3">-        // Create a healing potion</div>
<div class="c3">-        const itemComponent = new Item(castHeal);</div>
<div class="c2">+        const dice = rng.nextRange(0, 100);</div>
<div class="c2">+        let item = null;</div>
<div class="c0"> </div>
<div class="c3">-        const item = new Entity(x, y, &#x27;!&#x27;, &#x27;healing potion&#x27;, Colors.DARK_MAGENTA, false, { item: itemComponent });</div>
<div class="c2">+        if (dice &lt; 50) {</div>
<div class="c2">+            // Create a healing potion (50% chance)</div>
<div class="c2">+            item = new Entity(x, y, &#x27;!&#x27;, &#x27;healing potion&#x27;, Colors.DARK_MAGENTA, false, { item: new Item(castHeal) });</div>
<div class="c2">+</div>
<div class="c2">+        } else if (dice &lt; 50 + 20) {</div>
<div class="c2">+            // Create a lightning bolt scroll (20% chance)</div>
<div class="c2">+            item = new Entity(x, y, &#x27;#&#x27;, &#x27;scroll of lightning bolt&#x27;, Colors.YELLOW, false, { item: new Item(castLightning) });</div>
<div class="c2">+</div>
<div class="c2">+        } else if (dice &lt; 50 + 20 + 15) {</div>
<div class="c2">+            // Create a fireball scroll (15% chance)</div>
<div class="c2">+            item = new Entity(x, y, &#x27;#&#x27;, &#x27;scroll of fireball&#x27;, Colors.YELLOW, false, { item: new Item(castFireball) });</div>
<div class="c2">+</div>
<div class="c2">+        } else {</div>
<div class="c2">+            // Create a confuse scroll (15% chance)</div>
<div class="c2">+            item = new Entity(x, y, &#x27;#&#x27;, &#x27;scroll of confusion&#x27;, Colors.YELLOW, false, { item: new Item(castConfuse) });</div>
<div class="c2">+        }</div>
<div class="c0"> </div>
<div class="c0">         entities.push(item);</div>
<div class="c0">         item.sendToBack();  // items appear below other objects</div>
<div class="c1">@@ -487,6 +546,32 @@</div>
<div class="c0">         return;</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c2">+    if (targetFunction) {</div>
<div class="c2">+        if (term.isKeyPressed(Keys.VK_ENTER) || term.mouse.buttons[0].isClicked()) {</div>
<div class="c2">+            endTargeting(targetCursor.x, targetCursor.y);</div>
<div class="c2">+        }</div>
<div class="c2">+        if (term.isKeyPressed(Keys.VK_ESCAPE) || term.mouse.buttons[2].isClicked()) {</div>
<div class="c2">+            cancelTargeting();</div>
<div class="c2">+        }</div>
<div class="c2">+        if (term.isKeyPressed(Keys.VK_UP)) {</div>
<div class="c2">+            targetCursor.y--;</div>
<div class="c2">+        }</div>
<div class="c2">+        if (term.isKeyPressed(Keys.VK_LEFT)) {</div>
<div class="c2">+            targetCursor.x--;</div>
<div class="c2">+        }</div>
<div class="c2">+        if (term.isKeyPressed(Keys.VK_RIGHT)) {</div>
<div class="c2">+            targetCursor.x++;</div>
<div class="c2">+        }</div>
<div class="c2">+        if (term.isKeyPressed(Keys.VK_DOWN)) {</div>
<div class="c2">+            targetCursor.y++;</div>
<div class="c2">+        }</div>
<div class="c2">+        if (term.mouse.dx !== 0 || term.mouse.dy !== 0) {</div>
<div class="c2">+            targetCursor.x = term.mouse.x;</div>
<div class="c2">+            targetCursor.y = term.mouse.y;</div>
<div class="c2">+        }</div>
<div class="c2">+        return;</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c0">     if (term.isKeyPressed(Keys.VK_UP)) {</div>
<div class="c0">         playerMoveOrAttack(0, -1);</div>
<div class="c0">     }</div>
<div class="c1">@@ -539,6 +624,26 @@</div>
<div class="c0">     monster.sendToBack();</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function getClosestMonster(x: number, y: number, range: number) {</div>
<div class="c2">+    let minDist = range + 1;</div>
<div class="c2">+    let result = null;</div>
<div class="c2">+    for (let i = 0; i &lt; entities.length; i++) {</div>
<div class="c2">+        const entity = entities[i];</div>
<div class="c2">+        if (entity.fighter &amp;&amp; entity !== player) {</div>
<div class="c2">+            const dist = entity.distance(x, y);</div>
<div class="c2">+            if (dist &lt; minDist) {</div>
<div class="c2">+                minDist = dist;</div>
<div class="c2">+                result = entity;</div>
<div class="c2">+            }</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+    return result;</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function getMonsterAt(x: number, y: number) {</div>
<div class="c2">+    return getClosestMonster(x, y, 0);</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function castHeal(item: Item) {</div>
<div class="c0">     if (!player.fighter) {</div>
<div class="c0">         return;</div>
<div class="c1">@@ -555,6 +660,83 @@</div>
<div class="c0">     item.remove();</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function castLightning(item: Item) {</div>
<div class="c2">+    // Find closest enemy (inside a maximum range) and damage it</div>
<div class="c2">+    const monster = getClosestMonster(player.x, player.y, LIGHTNING_RANGE);</div>
<div class="c2">+    if (!monster) {</div>
<div class="c2">+        addMessage(&#x27;No enemy is close enough to strike.&#x27;, Colors.LIGHT_RED);</div>
<div class="c2">+        return;</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    // Zap it!</div>
<div class="c2">+    addMessage(&#x27;A lightning bolt strikes the &#x27; + monster.name + &#x27; with a loud thunder!&#x27;, Colors.LIGHT_BLUE);</div>
<div class="c2">+    addMessage(&#x27;The damage is &#x27; + LIGHTNING_DAMAGE + &#x27; hit points&#x27;, Colors.LIGHT_BLUE);</div>
<div class="c2">+    (monster.fighter as Fighter).takeDamage(LIGHTNING_DAMAGE);</div>
<div class="c2">+    item.remove();</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function castFireball(item: Item) {</div>
<div class="c2">+    // Ask the player for a target tile to throw a fireball at</div>
<div class="c2">+    addMessage(&#x27;Left-click to cast fireball, or right-click to cancel.&#x27;, Colors.LIGHT_CYAN);</div>
<div class="c2">+    startTargeting((x, y) =&gt; {</div>
<div class="c2">+        if (player.distance(x, y) &gt; FIREBALL_RANGE) {</div>
<div class="c2">+            addMessage(&#x27;Target out of range.&#x27;, Colors.LIGHT_GRAY);</div>
<div class="c2">+            return;</div>
<div class="c2">+        }</div>
<div class="c2">+</div>
<div class="c2">+        addMessage(&#x27;The fireball explodes, burning everything within &#x27; + FIREBALL_RADIUS + &#x27; tiles!&#x27;, Colors.ORANGE);</div>
<div class="c2">+</div>
<div class="c2">+        for (let i = 0; i &lt; entities.length; i++) {</div>
<div class="c2">+            const entity = entities[i];</div>
<div class="c2">+            if (entity.fighter &amp;&amp; entity.distance(x, y) &lt;= FIREBALL_RADIUS) {</div>
<div class="c2">+                addMessage(&#x27;The &#x27; + entity.name + &#x27; gets burned for &#x27; + FIREBALL_DAMAGE + &#x27; hit points.&#x27;, Colors.ORANGE);</div>
<div class="c2">+                entity.fighter.takeDamage(FIREBALL_DAMAGE);</div>
<div class="c2">+            }</div>
<div class="c2">+        }</div>
<div class="c2">+</div>
<div class="c2">+        item.remove();</div>
<div class="c2">+    });</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function castConfuse(item: Item) {</div>
<div class="c2">+    // Ask the player for a target to confuse</div>
<div class="c2">+    addMessage(&#x27;Left-click to cast confuse, or right-click to cancel.&#x27;, Colors.LIGHT_CYAN);</div>
<div class="c2">+    startTargeting((x, y) =&gt; {</div>
<div class="c2">+        if (player.distance(x, y) &gt; CONFUSE_RANGE) {</div>
<div class="c2">+            addMessage(&#x27;Target out of range.&#x27;, Colors.LIGHT_GRAY);</div>
<div class="c2">+            return;</div>
<div class="c2">+        }</div>
<div class="c2">+</div>
<div class="c2">+        const monster = getMonsterAt(x, y);</div>
<div class="c2">+        if (!monster) {</div>
<div class="c2">+            addMessage(&#x27;No monster there.&#x27;, Colors.LIGHT_GRAY);</div>
<div class="c2">+            return;</div>
<div class="c2">+        }</div>
<div class="c2">+</div>
<div class="c2">+        monster.ai = new ConfusedMonster(monster.ai as AI);</div>
<div class="c2">+        (monster.ai as AI).owner = monster;</div>
<div class="c2">+        addMessage(&#x27;The eyes of the &#x27; + monster.name + &#x27; look vacant, as he stumbles around!&#x27;, Colors.LIGHT_GREEN);</div>
<div class="c2">+        item.remove();</div>
<div class="c2">+    });</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function startTargeting(callback: (x: number, y: number) =&gt; void) {</div>
<div class="c2">+    targetFunction = callback;</div>
<div class="c2">+    targetCursor.x = player.x;</div>
<div class="c2">+    targetCursor.y = player.y;</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function endTargeting(x: number, y: number) {</div>
<div class="c2">+    if (targetFunction) {</div>
<div class="c2">+        targetFunction(x, y);</div>
<div class="c2">+        cancelTargeting();</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function cancelTargeting() {</div>
<div class="c2">+    targetFunction = undefined;</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function renderAll() {</div>
<div class="c0">     if (fovRecompute) {</div>
<div class="c0">         map.computeFov(player.x, player.y, TORCH_RADIUS);</div>
<div class="c1">@@ -604,6 +786,13 @@</div>
<div class="c0">     // Display names of objects under the mouse</div>
<div class="c0">     term.drawString(1, PANEL_Y, getNamesUnderMouse(), Colors.LIGHT_GRAY);</div>
<div class="c0"> </div>
<div class="c2">+    if (targetFunction) {</div>
<div class="c2">+        const targetCell = term.getCell(targetCursor.x, targetCursor.y);</div>
<div class="c2">+        if (targetCell) {</div>
<div class="c2">+            targetCell.setBackground(Colors.WHITE);</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c0">     // Draw dialog boxes</div>
<div class="c0">     gui.draw();</div>
<div class="c0"> }</div>
<div class="c1">@@ -617,6 +806,8 @@</div>
<div class="c0"> const map = createMap();</div>
<div class="c0"> let fovRecompute = true;</div>
<div class="c0"> const inventory: Entity[] = [];</div>
<div class="c2">+let targetFunction = undefined as undefined | ((x: number, y: number) =&gt; void);</div>
<div class="c2">+let targetCursor = { x: 0, y: 0 };</div>
<div class="c0"> </div>
<div class="c0"> addMessage(&#x27;Welcome stranger! Prepare to perish!&#x27;, Colors.DARK_RED);</div>
<div class="c0"> </div>
<!--ENDDIFF-->
    </div>
	<script src="part9.min.js"></script>
</body>

</html>