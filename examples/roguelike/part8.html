<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>WGLT - Roguelike Tutorial - Part 8</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body>
	<canvas></canvas>
	<p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_8">Part 8: Items and Inventory</a></p>
	<p>The player gets to collect ("borrow") items from the dungeon and use them, with a neat inventory screen. More items added in the next part.</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part7.js	2019-12-13 11:26:18.237487500 -0800</div>
<div class="c2">+++ part8.js	2019-12-13 11:28:56.758058200 -0800</div>
<div class="c1">@@ -5,6 +5,8 @@</div>
<div class="c0"> import {fromRgb} from &#x27;../../src/color.js&#x27;;</div>
<div class="c0"> import {RNG} from &#x27;../../src/rng.js&#x27;;</div>
<div class="c0"> import {FovMap} from &#x27;../../src/fov.js&#x27;;</div>
<div class="c2">+import {GUI} from &#x27;../../src/gui.js&#x27;;</div>
<div class="c2">+import {SelectDialog} from &#x27;../../src/gui/selectdialog.js&#x27;;</div>
<div class="c0"> </div>
<div class="c0"> // Actual size of the window</div>
<div class="c0"> const SCREEN_WIDTH = 80;</div>
<div class="c1">@@ -27,8 +29,12 @@</div>
<div class="c0"> const ROOM_MIN_SIZE = 6;</div>
<div class="c0"> const MAX_ROOMS = 30;</div>
<div class="c0"> const MAX_ROOM_MONSTERS = 3;</div>
<div class="c2">+const MAX_ROOM_ITEMS = 2;</div>
<div class="c0"> const TORCH_RADIUS = 10;</div>
<div class="c0"> </div>
<div class="c2">+// Spell values</div>
<div class="c2">+const HEAL_AMOUNT = 4;</div>
<div class="c2">+</div>
<div class="c0"> const COLOR_DARK_WALL = fromRgb(0, 0, 100);</div>
<div class="c0"> const COLOR_LIGHT_WALL = fromRgb(130, 110, 50);</div>
<div class="c0"> const COLOR_DARK_GROUND = fromRgb(50, 50, 150);</div>
<div class="c1">@@ -141,6 +147,10 @@</div>
<div class="c0">             }</div>
<div class="c0">         }</div>
<div class="c0">     };</div>
<div class="c2">+</div>
<div class="c2">+    this.heal = function (amount) {</div>
<div class="c2">+        this.hp = Math.min(this.hp + amount, this.maxHp);</div>
<div class="c2">+    };</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function BasicMonster() {</div>
<div class="c1">@@ -164,6 +174,32 @@</div>
<div class="c0">     };</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function Item(useFunction) {</div>
<div class="c2">+    this.useFunction = useFunction;</div>
<div class="c2">+</div>
<div class="c2">+    this.pickUp = function () {</div>
<div class="c2">+        if (inventory.length &gt;= 26) {</div>
<div class="c2">+            addMessage(&#x27;Your inventory is full, cannot pick up &#x27; + this.owner.name + &#x27;.&#x27;, Colors.LIGHT_RED);</div>
<div class="c2">+        } else {</div>
<div class="c2">+            inventory.push(this.owner);</div>
<div class="c2">+            this.owner.remove();</div>
<div class="c2">+            addMessage(&#x27;You picked up a &#x27; + this.owner.name + &#x27;!&#x27;, Colors.LIGHT_GREEN);</div>
<div class="c2">+        }</div>
<div class="c2">+    };</div>
<div class="c2">+</div>
<div class="c2">+    this.use = function () {</div>
<div class="c2">+        if (this.useFunction) {</div>
<div class="c2">+            this.useFunction(this);</div>
<div class="c2">+        } else {</div>
<div class="c2">+            addMessage(&#x27;The &#x27; + this.owner.name + &#x27; cannot be used.&#x27;);</div>
<div class="c2">+        }</div>
<div class="c2">+    };</div>
<div class="c2">+</div>
<div class="c2">+    this.remove = function () {</div>
<div class="c2">+        inventory.splice(inventory.indexOf(this.owner), 1);</div>
<div class="c2">+    };</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function isBlocked(x, y) {</div>
<div class="c0">     // First test the map tile</div>
<div class="c0">     if (map[y][x].blocked) {</div>
<div class="c1">@@ -305,6 +341,23 @@</div>
<div class="c0"> </div>
<div class="c0">         entities.push(monster);</div>
<div class="c0">     }</div>
<div class="c2">+</div>
<div class="c2">+    // Choose random number of items</div>
<div class="c2">+    const numItems = rng.nextRange(0, MAX_ROOM_ITEMS);</div>
<div class="c2">+</div>
<div class="c2">+    for (let i = 0; i &lt; numItems; i++) {</div>
<div class="c2">+        // Choose random spot for this item</div>
<div class="c2">+        const x = rng.nextRange(room.x1 + 1, room.x2 - 1)</div>
<div class="c2">+        const y = rng.nextRange(room.y1 + 1, room.y2 - 1)</div>
<div class="c2">+</div>
<div class="c2">+        // Create a healing potion</div>
<div class="c2">+        const itemComponent = new Item(castHeal);</div>
<div class="c2">+</div>
<div class="c2">+        const item = new Entity(x, y, &#x27;!&#x27;, &#x27;healing potion&#x27;, Colors.DARK_MAGENTA, false, { item: itemComponent });</div>
<div class="c2">+</div>
<div class="c2">+        entities.push(item);</div>
<div class="c2">+        item.sendToBack();  // items appear below other objects</div>
<div class="c2">+    }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function renderBar(x, y, totalWidth, name, value, maximum, barColor, backColor) {</div>
<div class="c1">@@ -390,6 +443,11 @@</div>
<div class="c0">     if (player.fighter.hp &lt;= 0) {</div>
<div class="c0">         return;</div>
<div class="c0">     }</div>
<div class="c2">+</div>
<div class="c2">+    if (gui.handleInput()) {</div>
<div class="c2">+        return;</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c0">     if (term.isKeyPressed(Keys.VK_UP)) {</div>
<div class="c0">         playerMoveOrAttack(0, -1);</div>
<div class="c0">     }</div>
<div class="c1">@@ -402,6 +460,29 @@</div>
<div class="c0">     if (term.isKeyPressed(Keys.VK_DOWN)) {</div>
<div class="c0">         playerMoveOrAttack(0, 1);</div>
<div class="c0">     }</div>
<div class="c2">+    if (term.isKeyPressed(Keys.VK_G)) {</div>
<div class="c2">+        // Pick up an item</div>
<div class="c2">+        for (let i = 0; i &lt; entities.length; i++) {</div>
<div class="c2">+            const entity = entities[i];</div>
<div class="c2">+            if (entity.x === player.x &amp;&amp; entity.y === player.y &amp;&amp; entity.item) {</div>
<div class="c2">+                entity.item.pickUp();</div>
<div class="c2">+            }</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+    if (term.isKeyPressed(Keys.VK_I)) {</div>
<div class="c2">+        if (inventory.length === 0) {</div>
<div class="c2">+            gui.add(new MessageDialog(&#x27;ALERT&#x27;, &#x27;Inventory is empty&#x27;));</div>
<div class="c2">+        } else {</div>
<div class="c2">+            const options = inventory.map(item =&gt; item.name);</div>
<div class="c2">+            gui.add(new SelectDialog(&#x27;INVENTORY&#x27;, options, useInventory));</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function useInventory(choice) {</div>
<div class="c2">+    if (choice &gt;= 0) {</div>
<div class="c2">+        inventory[choice].item.use();</div>
<div class="c2">+    }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function playerDeath(player) {</div>
<div class="c1">@@ -419,6 +500,18 @@</div>
<div class="c0">     monster.sendToBack();</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function castHeal(item) {</div>
<div class="c2">+    // Heal the player</div>
<div class="c2">+    if (player.fighter.hp === player.fighter.maxHp) {</div>
<div class="c2">+        addMessage(&#x27;You are already at full health.&#x27;, Colors.DARK_RED);</div>
<div class="c2">+        return;</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    addMessage(&#x27;Your wounds start to feel better!&#x27;, Colors.LIGHT_MAGENTA);</div>
<div class="c2">+    player.fighter.heal(HEAL_AMOUNT);</div>
<div class="c2">+    item.remove();</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function renderAll() {</div>
<div class="c0">     if (fovRecompute) {</div>
<div class="c0">         fovMap.computeFov(player.x, player.y, TORCH_RADIUS);</div>
<div class="c1">@@ -469,9 +562,13 @@</div>
<div class="c0"> </div>
<div class="c0">     // Display names of objects under the mouse</div>
<div class="c0">     term.drawString(1, PANEL_Y, getNamesUnderMouse(), Colors.LIGHT_GRAY);</div>
<div class="c2">+</div>
<div class="c2">+    // Draw dialog boxes</div>
<div class="c2">+    gui.draw();</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> const term = new Terminal(document.querySelector(&#x27;canvas&#x27;), SCREEN_WIDTH, SCREEN_HEIGHT);</div>
<div class="c2">+const gui = new GUI(term);</div>
<div class="c0"> const rng = new RNG(1);</div>
<div class="c0"> const player = new Entity(40, 25, &#x27;@&#x27;, &#x27;player&#x27;, Colors.WHITE, true, { fighter: new Fighter(20, 2, 5, playerDeath) });</div>
<div class="c0"> const entities = [player];</div>
<div class="c1">@@ -479,6 +576,7 @@</div>
<div class="c0"> const map = createMap();</div>
<div class="c0"> const fovMap = new FovMap(MAP_WIDTH, MAP_HEIGHT, (x, y) =&gt; map[y][x].blocked);</div>
<div class="c0"> let fovRecompute = true;</div>
<div class="c2">+const inventory = [];</div>
<div class="c0"> </div>
<div class="c0"> addMessage(&#x27;Welcome stranger! Prepare to perish!&#x27;, Colors.DARK_RED);</div>
<div class="c0"> </div>
<!--ENDDIFF-->
    </div>
	<script src="part8.min.js"></script>
</body>

</html>