{"version":3,"sources":["webpack://wglt/webpack/universalModuleDefinition","webpack://wglt/./src/color.ts","webpack://wglt/./src/colors.ts","webpack://wglt/./src/point.ts","webpack://wglt/./src/rect.ts","webpack://wglt/./src/gui/dialogstate.ts","webpack://wglt/./src/gui/defaultdialogrenderer.ts","webpack://wglt/./src/gui.ts","webpack://wglt/./src/blendmode.ts","webpack://wglt/./src/chars.ts","webpack://wglt/./src/cell.ts","webpack://wglt/./src/console.ts","webpack://wglt/./src/font.ts","webpack://wglt/./src/input.ts","webpack://wglt/./src/keys.ts","webpack://wglt/./src/mouse.ts","webpack://wglt/./src/terminal.ts","webpack://wglt/./src/shaders.ts","webpack://wglt/./src/gui/dialog.ts","webpack://wglt/./src/gui/messagedialog.ts","webpack://wglt/./src/gui/selectdialog.ts","webpack://wglt/./src/path.ts","webpack://wglt/./src/rng.ts","webpack://wglt/./examples/roguelike/entity.ts","webpack://wglt/./examples/roguelike/actor.ts","webpack://wglt/./examples/roguelike/ai.ts","webpack://wglt/./examples/roguelike/item.ts","webpack://wglt/./examples/roguelike/game.ts","webpack://wglt/./src/image.ts","webpack://wglt/./examples/roguelike/mainmenu.ts","webpack://wglt/./examples/roguelike/index.ts","webpack://wglt/./examples/roguelike/app.ts","webpack://wglt/webpack/bootstrap","webpack://wglt/webpack/startup","webpack://wglt/webpack/runtime/make namespace object"],"names":["root","factory","exports","module","define","amd","globalThis","fromRgb","r","g","b","a","undefined","Colors","BLACK","WHITE","LIGHT_GRAY","DARK_GRAY","YELLOW","BROWN","LIGHT_RED","DARK_RED","LIGHT_GREEN","DARK_GREEN","LIGHT_CYAN","DARK_CYAN","LIGHT_BLUE","DARK_BLUE","LIGHT_MAGENTA","DARK_MAGENTA","ORANGE","Point","constructor","x","y","this","Rect","width","height","left","top","x2","y2","getCenter","intersects","other","contains","point","DialogState","dialog","rect","contentsOffset","open","count","DefaultDialogRenderer","getState","terminal","contentsRect","draw","term","dialogState","fillRect","drawSingleBox","drawCenteredString","title","drawContents","GUI","renderer","dialogs","add","push","handleInput","length","activeIndex","activeState","splice","i","BlendMode","Chars","Cell","charCode","fg","bg","charCodeAt","convertCharCode","dirty","blocked","blockedSight","explored","visible","pathId","h","prev","setCharCode","setForeground","setBackground","setValue","drawCell","None","otherCell","blendMode","alpha","blendColors","c1","c2","w1","w2","r1","g1","b1","r2","g2","b2","Blend","Add","clamp","Math","min","Console","blockedFunc","grid","originX","originY","minX","maxX","minY","maxY","radius","row","clear","drawChar","getCell","getCharCode","c","drawString","str","lines","split","line","j","floor","drawHLine","xi","drawVLine","yi","drawRect","drawBox","topChar","rightChar","bottomChar","leftChar","topLeftChar","topRightChar","bottomRightChar","bottomLeftChar","BOX_SINGLE_HORIZONTAL","BOX_SINGLE_VERTICAL","BOX_SINGLE_DOWN_AND_SINGLE_RIGHT","BOX_SINGLE_DOWN_AND_SINGLE_LEFT","BOX_SINGLE_UP_AND_SINGLE_LEFT","BOX_SINGLE_UP_AND_SINGLE_RIGHT","drawDoubleBox","BOX_DOUBLE_HORIZONTAL","BOX_DOUBLE_VERTICAL","BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT","BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT","BOX_DOUBLE_UP_AND_DOUBLE_LEFT","BOX_DOUBLE_UP_AND_DOUBLE_RIGHT","drawConsole","dstX","dstY","srcConsole","srcX","srcY","srcWidth","srcHeight","cell","setBlocked","setBlockedSight","isVisible","isBlocked","isBlockedSight","computeOctantY","deltaX","deltaY","startSlopes","endSlopes","halfSlope","processedCell","extended","centreSlope","startSlope","endSlope","previousEndSlope","iteration","totalObstacles","obstaclesInLastLine","minSlope","idx","max","computeOctantX","computeFov","opt_noClear","opt_octants","updateExplored","tile","DEFAULT_FONT","url","charWidth","charHeight","scale","graphical","Input","down","downTime","repeat","repeatTime","downCount","upCount","setDown","performance","now","update","time","isPressed","isClicked","KEY_COUNT","Keyboard","el","keys","Array","addEventListener","e","setKey","state","keyCode","Keys","VK_F11","stopPropagation","preventDefault","updateKeys","getKey","Mouse","canvas","prevX","prevY","dx","dy","buttons","handleEvent","touchEventHandler","handleTouchEvent","bind","touches","touch","updatePosition","clientX","clientY","type","button","focus","getBoundingClientRect","terminalAspectRatio","rectAspectRatio","actualWidth","excess","actualHeight","interpolate","DEFAULT_OPTIONS","font","Terminal","options","super","pixelWidth","pixelHeight","style","imageRendering","outline","tabIndex","handleResize","window","mouse","gl","getContext","antialias","Error","program","createProgram","attachShader","buildShader","VERTEX_SHADER","FRAGMENT_SHADER","linkProgram","useProgram","uniform1i","getUniformLocation","positionAttribLocation","getAttribLocation","textureAttribLocation","fgColorAttribLocation","bgColorAttribLocation","cellCount","positionsArray","Float32Array","indexArray","Uint16Array","textureArray","foregroundUint8Array","Uint8Array","foregroundDataView","DataView","buffer","backgroundUint8Array","backgroundDataView","k","positionBuffer","createBuffer","indexBuffer","textureBuffer","foregroundBuffer","backgroundBuffer","bindBuffer","ARRAY_BUFFER","bufferData","STATIC_DRAW","ELEMENT_ARRAY_BUFFER","texture","loadTexture","lastRenderTime","renderDelta","fps","averageFps","requestAnimationFrame","parent","parentElement","widthFactor","offsetWidth","heightFactor","offsetHeight","factor","name","location","enableVertexAttribArray","flush","textureArrayIndex","colorArrayIndex","textureX","textureY","setUint32","isKeyDown","key","isKeyPressed","getKeyDownCount","getMovementKey","VK_NUMPAD1","VK_B","VK_NUMPAD2","VK_J","VK_DOWN","VK_NUMPAD3","VK_N","VK_NUMPAD4","VK_H","VK_LEFT","VK_NUMPAD5","VK_PERIOD","VK_NUMPAD6","VK_L","VK_RIGHT","VK_NUMPAD7","VK_Y","VK_NUMPAD8","VK_K","VK_NUMPAD9","VK_U","source","sh","createShader","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","createTexture","bindTexture","TEXTURE_2D","internalFormat","RGBA","srcFormat","srcType","UNSIGNED_BYTE","pixel","texImage2D","image","Image","onload","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","TEXTURE_MAG_FILTER","LINEAR","TEXTURE_MIN_FILTER","src","render","clearColor","clearDepth","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","viewport","numComponents","FLOAT","normalize","stride","offset","vertexAttribPointer","DYNAMIC_DRAW","activeTexture","TEXTURE0","vertexCount","UNSIGNED_SHORT","drawElements","TRIANGLES","t","renderLoop","Dialog","MessageDialog","message","console","VK_ESCAPE","SelectDialog","callback","hoverIndex","String","fromCharCode","VK_A","isMouseOverOption","index","dxs","dys","costs","buildPath","result","curr","reverse","SortedSet","initialValues","values","insert","array","low","high","mid","midCell","pop","size","RNG","seed","m","nextInt","nextFloat","nextRange","start","end","rangeSize","isNaN","chooseIndex","chances","total","reduce","roll","runningTotal","chooseKey","chancesMap","property","hasOwnProperty","Entity","game","char","color","blocks","distanceTo","hypot","distance","sendToBack","remove","entities","unshift","indexOf","map","app","Actor","level","inventory","hp","xp","baseMaxHp","baseDefense","basePower","move","moveToward","targetX","targetY","round","getEquippedInSlot","slot","find","item","equipped","getAllEquipped","filter","equip","old","dequip","addMessage","acc","maxHpBonus","defenseBonus","powerBonus","attack","target","damage","power","defense","takeDamage","takeXp","checkLevelUp","death","heal","amount","maxHp","player","ai","pickUp","useItem","useFunction","removeItem","setAi","owner","BasicMonster","takeTurn","monster","ConfusedMonster","oldAi","numTurns","rng","Item","PANEL_Y","SCREEN_HEIGHT","COLOR_DARK_WALL","COLOR_LIGHT_WALL","COLOR_DARK_GROUND","COLOR_LIGHT_GROUND","Game","Date","messages","createMap","fovRecompute","targetCursor","pathIndex","pathWalking","dagger","entity","createRoom","room","createHTunnel","x1","createVTunnel","y1","rooms","w","newRoom","failed","center","placeObjects","stairsLoc","stairs","fromDungeonLevel","table","value","maxMonsters","monsterChances","maxItems","itemChances","numMonsters","choice","numItems","castHeal","castLightning","castFireball","castConfuse","renderBar","totalWidth","maximum","barColor","backColor","barWidth","getNamesUnderMouse","names","join","msg","opt_color","PANEL_HEIGHT","shift","text","playerMoveOrAttack","handleKeys","gui","movementKey","targetFunction","VK_ENTER","endTargeting","cancelTargeting","VK_G","VK_I","useInventory","VK_C","levelUpXp","VK_COMMA","nextLevel","path","dest","maxDist","sourceCell","q","u","v","Infinity","alt","computePath","next","getClosestMonster","range","minDist","dist","getMonsterAt","startTargeting","renderAll","wall","BAR_WIDTH","targetCell","PATTERNS","BLOCK_TOP_HALF","active","BLOCK_RIGHT_HALF","getImageData","img","document","createElement","ctx","drawImage","data","draw2x2","con","i1","i2","i3","i4","colors","minError","Number","MAX_VALUE","bestCharCode","bestBg","bestFg","pattern","patternColors","computeColors","error","arrayToColor","sum","avg","cellError","delta","sqrt","rgb","menuBg","loadImage2x","MainMenu","newGame","continueGame","querySelector","mainMenu","__webpack_module_cache__","__webpack_require__","moduleId","__webpack_modules__","Symbol","toStringTag","Object","defineProperty"],"mappings":"CAAA,SAA2CA,EAAMC,GAC1B,kBAAZC,SAA0C,kBAAXC,OACxCA,OAAOD,QAAUD,IACQ,oBAAXG,QAAyBA,OAAOC,IAC9CD,OAAO,GAAIH,GACe,kBAAZC,QACdA,QAAc,KAAID,IAElBD,EAAW,KAAIC,IARjB,CASGK,YAAY,WACf,M,wCCCO,SAASC,EAAQC,EAAWC,EAAWC,EAAWC,GAIvD,YAHUC,IAAND,IACFA,EAAI,MAEGH,GAAK,KAAOC,GAAK,KAAOC,GAAK,GAAKC,E,OCZtC,MAAME,EAAS,CACpBC,MAAOP,EAAQ,EAAG,EAAG,GACrBQ,MAAOR,EAAQ,IAAM,IAAM,KAC3BS,WAAYT,EAAQ,IAAM,IAAM,KAChCU,UAAWV,EAAQ,GAAM,GAAM,IAC/BW,OAAQX,EAAQ,IAAM,IAAM,IAC5BY,MAAOZ,EAAQ,IAAM,GAAM,GAC3Ba,UAAWb,EAAQ,IAAM,GAAM,IAC/Bc,SAAUd,EAAQ,IAAM,EAAM,GAC9Be,YAAaf,EAAQ,GAAM,IAAM,IACjCgB,WAAYhB,EAAQ,EAAM,IAAM,GAChCiB,WAAYjB,EAAQ,GAAM,IAAM,KAChCkB,UAAWlB,EAAQ,EAAM,IAAM,KAC/BmB,WAAYnB,EAAQ,GAAM,GAAM,KAChCoB,UAAWpB,EAAQ,EAAM,EAAM,KAC/BqB,cAAerB,EAAQ,IAAM,GAAM,KACnCsB,aAActB,EAAQ,IAAM,EAAM,KAClCuB,OAAQvB,EAAQ,IAAM,IAAM,I,wHCnBvB,MAAMwB,EAGXC,YAAYC,EAAWC,GAAW,sCAChCC,KAAKF,EAAIA,EACTE,KAAKD,EAAIA,G,wHCJN,MAAME,EAUXJ,YAAYC,EAAWC,EAAWG,EAAeC,GAAgB,wKAC/DH,KAAKF,EAAIE,KAAKI,KAAON,EACrBE,KAAKD,EAAIC,KAAKK,IAAMN,EACpBC,KAAKE,MAAQA,EACbF,KAAKG,OAASA,EACdH,KAAKM,GAAKR,EAAII,EACdF,KAAKO,GAAKR,EAAII,EAGhBK,YACE,OAAO,IAAIZ,EAAMI,KAAKF,EAAKE,KAAKE,MAAQ,EAAK,EAAGF,KAAKD,EAAKC,KAAKG,OAAS,EAAK,GAG/EM,WAAWC,GACT,OAAOV,KAAKF,GAAKY,EAAMJ,IAAMN,KAAKM,IAAMI,EAAMZ,GAAKE,KAAKD,GAAKW,EAAMH,IAAMP,KAAKO,IAAMG,EAAMX,EAG5FY,SAASC,GACP,OAAOA,EAAMd,GAAKE,KAAKF,GAAKc,EAAMb,EAAIC,KAAKM,IAAMM,EAAMb,GAAKC,KAAKD,GAAKa,EAAMb,EAAIC,KAAKO,I,wHCzBlF,MAAMM,EAQXhB,YAAYiB,EAAgBC,EAAYC,GAAuB,mJAC7DhB,KAAKc,OAASA,EACdd,KAAKe,KAAOA,EACZf,KAAKgB,eAAiBA,EACtBhB,KAAKiB,MAAO,EACZjB,KAAKkB,MAAQ,GCVV,MAAMC,EACXC,SAASC,EAAoBP,GAC3B,MAAMZ,EAAQY,EAAOQ,aAAapB,MAAQ,EACpCC,EAASW,EAAOQ,aAAanB,OAAS,EACtCL,GAAMuB,EAASnB,MAAQA,GAAS,EAAK,EACrCH,GAAMsB,EAASlB,OAASA,GAAU,EAAK,EAC7C,OAAO,IAAIU,EACTC,EAAQ,IAAIb,EAAKH,EAAGC,EAAGG,EAAOC,GAAS,IAAIP,EAAME,EAAI,EAAGC,EAAI,IAGhEwB,KAAKC,EAAgBC,GACnB,MAAMX,EAASW,EAAYX,QACrB,EAAEhB,EAAF,EAAKC,EAAL,MAAQG,EAAR,OAAeC,GAAWsB,EAAYV,KAC5CS,EAAKE,SAAS5B,EAAGC,EAAGG,EAAOC,EAAQ,EAAGzB,EAAOE,MAAOF,EAAOC,OAC3D6C,EAAKG,cAAc7B,EAAGC,EAAGG,EAAOC,GAChCqB,EAAKI,mBAAmB9B,EAAKI,EAAQ,EAAK,EAAGH,EAAG,IAAMe,EAAOe,MAAQ,KACrEf,EAAOgB,aAAaN,EAAMC,EAAYT,iB,wHClBnC,MAAMe,EAKXlC,YAAYwB,EAAoBW,GAA2B,6EACzDhC,KAAKqB,SAAWA,EAChBrB,KAAKgC,SAAWA,GAAY,IAAIb,EAChCnB,KAAKiC,QAAU,GAGjBC,IAAIpB,GACFd,KAAKiC,QAAQE,KAAKnC,KAAKgC,SAASZ,SAASpB,KAAKqB,SAAUP,IAQ1DsB,cACE,GAA4B,IAAxBpC,KAAKiC,QAAQI,OACf,OAAO,EAGT,MAAMC,EAActC,KAAKiC,QAAQI,OAAS,EACpCE,EAAcvC,KAAKiC,QAAQjC,KAAKiC,QAAQI,OAAS,GAMvD,OALqBE,EAAYzB,OAChBsB,YAAYpC,KAAKqB,SAAUkB,EAAYvB,iBACtDhB,KAAKiC,QAAQO,OAAOF,EAAa,IAG5B,EAGTf,OACE,IAAK,IAAIkB,EAAI,EAAGA,EAAIzC,KAAKiC,QAAQI,OAAQI,IACvCzC,KAAKgC,SAAST,KAAKvB,KAAKqB,SAAUrB,KAAKiC,QAAQQ,KCvC9C,IAAKC,ECEAC,E,kIDFAD,O,eAAAA,I,iBAAAA,I,cAAAA,M,KESL,MAAME,EAgBX/C,YAAYC,EAAWC,EAAW8C,EAA4BC,EAAYC,GAAY,6TACpF/C,KAAKF,EAAIA,EACTE,KAAKD,EAAIA,EAGPC,KAAK6C,cADUpE,IAAboE,EA5BR,SAAyBA,GACvB,MAAyB,kBAAbA,GAA0BA,EAASR,OAAS,EAC/CQ,EAASG,WAAW,GAEpBH,EAyBWI,CAAgBJ,GAEhB,IAAIG,WAAW,GAI/BhD,KAAK8C,QADIrE,IAAPqE,EACQA,EAEApE,EAAOE,MAIjBoB,KAAK+C,QADItE,IAAPsE,EACQA,EAEArE,EAAOC,MAGnBqB,KAAKkD,OAAQ,EACblD,KAAKmD,SAAU,EACfnD,KAAKoD,cAAe,EACpBpD,KAAKqD,UAAW,EAChBrD,KAAKsD,SAAU,EACftD,KAAKuD,QAAU,EACfvD,KAAK1B,EAAI,EACT0B,KAAKwD,EAAI,EACTxD,KAAKyD,KAAO,KAGdC,YAAYb,GACN7C,KAAK6C,WAAaA,IACpB7C,KAAK6C,SAAWA,EAChB7C,KAAKkD,OAAQ,GAIjBS,cAAcb,QACDrE,IAAPqE,GAA2B,OAAPA,GAAeA,IAAO9C,KAAK8C,KACjD9C,KAAK8C,GAAKA,EACV9C,KAAKkD,OAAQ,GAIjBU,cAAcb,QACDtE,IAAPsE,GAA2B,OAAPA,GAAeA,IAAO/C,KAAK+C,KACjD/C,KAAK+C,GAAKA,EACV/C,KAAKkD,OAAQ,GAIjBW,SAAShB,EAA2BC,EAAYC,GAgB9C,MAfwB,kBAAbF,IACTA,EAAWA,EAASG,WAAW,IAET,kBAAbH,GACT7C,KAAK0D,YAAYb,QAENpE,IAAPqE,GACF9C,KAAK2D,cAAcb,QAEVrE,IAAPsE,GACF/C,KAAK4D,cAAcb,IAGrB/C,KAAK8D,SAASjB,EAAUH,EAAUqB,MAE7B/D,KAAKkD,MAGdY,SAASE,EAAiBC,GACxB,MAAMC,EAAuB,IAAfF,EAAUjB,GAEpBkB,IAAcvB,EAAUqB,MAAQC,EAAUnB,SAAW,GACvD7C,KAAK0D,YAAYM,EAAUnB,UAC3B7C,KAAK2D,cAAcK,EAAUlB,KACpBoB,EAAQ,GAAKA,EAAQ,KAC9BlE,KAAK2D,cAAc3D,KAAKmE,YAAYnE,KAAK8C,GAAIkB,EAAUjB,GAAIkB,IAGzDA,IAAcvB,EAAUqB,MAAkB,MAAVG,EAClClE,KAAK4D,cAAcI,EAAUjB,IACpBmB,EAAQ,GACjBlE,KAAK4D,cAAc5D,KAAKmE,YAAYnE,KAAK+C,GAAIiB,EAAUjB,GAAIkB,IAIvDE,YAAYC,EAAWC,EAAWJ,GACxC,MACMK,GAAM,KADO,IAALD,IACa,IACrBE,EAAK,EAAMD,EACXE,EAAMJ,GAAM,GAAM,IAClBK,EAAML,GAAM,GAAM,IAClBM,EAAMN,GAAM,EAAK,IACjBO,EAAMN,GAAM,GAAM,IAClBO,EAAMP,GAAM,GAAM,IAClBQ,EAAMR,GAAM,EAAK,IAEvB,OAAQJ,GACN,KAAKvB,EAAUoC,MACb,OAAO1G,EACJkG,EAAKE,EAAKD,EAAKI,EAAM,EAAIL,EAAKG,EAAKF,EAAKK,EAAM,EAC9CN,EAAKI,EAAKH,EAAKM,EAAM,GAE1B,KAAKnC,EAAUqC,IACb,OAAO3G,EACL4B,KAAKgF,MAAOR,EAAKD,EAAKI,EAAM,GAAI3E,KAAKgF,MAAOP,EAAKF,EAAKK,EAAM,GAC5D5E,KAAKgF,MAAON,EAAKH,EAAKM,EAAM,IAEhC,QACE,OAAOR,GAILW,MAAMlF,GACZ,OAAOmF,KAAKC,IAAI,IAAKpF,I,kID7Ib6C,O,mBAAAA,I,mCAAAA,I,iBAAAA,I,qBAAAA,I,eAAAA,I,iBAAAA,I,mBAAAA,I,mCAAAA,I,+BAAAA,I,iCAAAA,I,6BAAAA,I,+CAAAA,I,+EAAAA,I,+EAAAA,I,+CAAAA,I,uEAAAA,I,mEAAAA,I,uEAAAA,I,qEAAAA,I,+EAAAA,I,mFAAAA,I,iFAAAA,I,mDAAAA,I,2FAAAA,I,qEAAAA,I,yEAAAA,I,+EAAAA,I,mFAAAA,I,iFAAAA,I,mDAAAA,I,2FAAAA,I,mEAAAA,I,yEAAAA,I,6BAAAA,I,2CAAAA,I,uCAAAA,I,yCAAAA,I,sCAAAA,M,KEAL,MAAMwC,EAYXtF,YAAYK,EAAeC,EAAgBiF,GAAiD,uOAC1FpF,KAAKE,MAAQA,EACbF,KAAKG,OAASA,EACdH,KAAKqF,KAAO,GACZrF,KAAKsF,QAAU,EACftF,KAAKuF,QAAU,EACfvF,KAAKwF,KAAO,EACZxF,KAAKyF,KAAO,EACZzF,KAAK0F,KAAO,EACZ1F,KAAK2F,KAAO,EACZ3F,KAAK4F,OAAS,EAEd,IAAK,IAAI7F,EAAI,EAAGA,EAAII,EAAQJ,IAAK,CAC/B,MAAM8F,EAAM,GACZ,IAAK,IAAI/F,EAAI,EAAGA,EAAII,EAAOJ,IACzB+F,EAAI1D,KAAK,IAAIS,EAAK9C,EAAGC,IAEvBC,KAAKqF,KAAKlD,KAAK0D,GAKjB,GAFA7F,KAAK8F,QAEDV,EACF,IAAK,IAAIrF,EAAI,EAAGA,EAAII,EAAQJ,IAC1B,IAAK,IAAID,EAAI,EAAGA,EAAII,EAAOJ,IACzBE,KAAKqF,KAAKtF,GAAGD,GAAGqD,QAAUnD,KAAKqF,KAAKtF,GAAGD,GAAGsD,aAAegC,EAAYtF,EAAGC,GAMhF+F,QACE,IAAK,IAAI/F,EAAI,EAAGA,EAAIC,KAAKG,OAAQJ,IAC/B,IAAK,IAAID,EAAI,EAAGA,EAAIE,KAAKE,MAAOJ,IAC9BE,KAAK+F,SAASjG,EAAGC,EAAG,GAK1BiG,QAAQlG,EAAWC,GACjB,KAAID,EAAI,GAAKC,EAAI,GAAKD,GAAKE,KAAKE,OAASH,GAAKC,KAAKG,QAGnD,OAAOH,KAAKqF,KAAKtF,GAAGD,GAGtBmG,YAAYnG,EAAWC,GACrB,KAAID,EAAI,GAAKC,EAAI,GAAKD,GAAKE,KAAKE,OAASH,GAAKC,KAAKG,QAGnD,OAAOH,KAAKqF,KAAKtF,GAAGD,GAAG+C,SAGzBkD,SAASjG,EAAWC,EAAWmG,EAAoBpD,EAAYC,GACzDjD,GAAK,GAAKA,EAAIE,KAAKE,OAASH,GAAK,GAAKA,EAAIC,KAAKG,QACjDH,KAAKqF,KAAS,EAAJtF,GAAW,EAAJD,GAAO+D,SAASqC,EAAGpD,EAAIC,GAI5CoD,WAAWrG,EAAWC,EAAWqG,EAAatD,EAAYC,GACxD,MAAMsD,EAAQD,EAAIE,MAAM,MACxB,IAAK,IAAI7D,EAAI,EAAGA,EAAI4D,EAAMhE,OAAQI,IAAK,CACrC,MAAM8D,EAAOF,EAAM5D,GACnB,IAAK,IAAI+D,EAAI,EAAGA,EAAID,EAAKlE,OAAQmE,IAC/BxG,KAAK+F,SAASjG,EAAI0G,EAAGzG,EAAI0C,EAAG8D,EAAKvD,WAAWwD,GAAI1D,EAAIC,IAK1DnB,mBAAmB9B,EAAWC,EAAWqG,EAAatD,EAAYC,GAChE/C,KAAKmG,WAAWrG,EAAImF,KAAKwB,MAAML,EAAI/D,OAAS,GAAItC,EAAGqG,EAAKtD,EAAIC,GAG9D2D,UAAU5G,EAAWC,EAAWG,EAAegG,EAAoBpD,EAAYC,GAC7E,IAAK,IAAI4D,EAAK7G,EAAG6G,EAAK7G,EAAII,EAAOyG,IAC/B3G,KAAK+F,SAASY,EAAI5G,EAAGmG,EAAGpD,EAAIC,GAIhC6D,UAAU9G,EAAWC,EAAWI,EAAgB+F,EAAoBpD,EAAYC,GAC9E,IAAK,IAAI8D,EAAK9G,EAAG8G,EAAK9G,EAAII,EAAQ0G,IAChC7G,KAAK+F,SAASjG,EAAG+G,EAAIX,EAAGpD,EAAIC,GAIhC+D,SAAShH,EAAWC,EAAWG,EAAeC,EAAgB+F,EAAoBpD,EAAYC,GAC5F/C,KAAK0G,UAAU5G,EAAGC,EAAGG,EAAOgG,EAAGpD,EAAIC,GACnC/C,KAAK0G,UAAU5G,EAAGC,EAAII,EAAS,EAAGD,EAAOgG,EAAGpD,EAAIC,GAChD/C,KAAK4G,UAAU9G,EAAGC,EAAGI,EAAQ+F,EAAGpD,EAAIC,GACpC/C,KAAK4G,UAAU9G,EAAII,EAAQ,EAAGH,EAAGI,EAAQ+F,EAAGpD,EAAIC,GAGlDgE,QACEjH,EAAWC,EAAWG,EAAeC,EACrC6G,EAAiBC,EAAmBC,EAAoBC,EACxDC,EAAqBC,EAAsBC,EAAyBC,EACpEzE,EAAYC,GACZ/C,KAAK0B,SAAS5B,EAAGC,EAAGG,EAAOC,EAAQ,EAAG2C,EAAIC,GAE1C/C,KAAK0G,UAAU5G,EAAGC,EAAGG,EAAO8G,GAC5BhH,KAAK0G,UAAU5G,EAAGC,EAAII,EAAS,EAAGD,EAAOgH,GAEzClH,KAAK4G,UAAU9G,EAAGC,EAAGI,EAAQgH,GAC7BnH,KAAK4G,UAAU9G,EAAII,EAAQ,EAAGH,EAAGI,EAAQ8G,GAEzCjH,KAAK+F,SAASjG,EAAGC,EAAGqH,GACpBpH,KAAK+F,SAASjG,EAAII,EAAQ,EAAGH,EAAGsH,GAChCrH,KAAK+F,SAASjG,EAAGC,EAAII,EAAS,EAAGoH,GACjCvH,KAAK+F,SAASjG,EAAII,EAAQ,EAAGH,EAAII,EAAS,EAAGmH,GAG/C3F,cAAc7B,EAAWC,EAAWG,EAAeC,EAAgB2C,EAAYC,GAC7E/C,KAAK+G,QACHjH,EAAGC,EAAGG,EAAOC,EAAQwC,EAAM6E,sBAC3B7E,EAAM8E,oBAAqB9E,EAAM6E,sBACjC7E,EAAM8E,oBAAqB9E,EAAM+E,iCACjC/E,EAAMgF,gCACNhF,EAAMiF,8BACNjF,EAAMkF,+BAAgC/E,EAAIC,GAG9C+E,cAAchI,EAAWC,EAAWG,EAAeC,EAAgB2C,EAAYC,GAC7E/C,KAAK+G,QACHjH,EAAGC,EAAGG,EAAOC,EAAQwC,EAAMoF,sBAC3BpF,EAAMqF,oBAAqBrF,EAAMoF,sBACjCpF,EAAMqF,oBAAqBrF,EAAMsF,iCACjCtF,EAAMuF,gCACNvF,EAAMwF,8BACNxF,EAAMyF,+BAAgCtF,EAAIC,GAG9CrB,SAAS5B,EAAWC,EAAWG,EAAeC,EAAgB+F,EAAoBpD,EAAYC,GAC5F,IAAK,IAAI8D,EAAK9G,EAAG8G,EAAK9G,EAAII,EAAQ0G,IAChC7G,KAAK0G,UAAU5G,EAAG+G,EAAI3G,EAAOgG,EAAGpD,EAAIC,GAIxCsF,YACEC,EAAcC,EACdC,EACAC,EAAcC,EAAcC,EAAkBC,EAC9C3E,GAEAA,EAAYA,GAAavB,EAAUqB,KAEnC,IAAK,IAAIhE,EAAI,EAAGA,EAAI6I,EAAW7I,IAC7B,IAAK,IAAID,EAAI,EAAGA,EAAI6I,EAAU7I,IAAK,CACjC,MAAM+I,EAAOL,EAAWxC,QAAQyC,EAAO3I,EAAG4I,EAAO3I,GAC7C8I,GACF7I,KAAK8D,SAASwE,EAAOxI,EAAGyI,EAAOxI,EAAG8I,EAAM5E,IAMhDH,SAAShE,EAAWC,EAAW8I,EAAY5E,GACrCnE,GAAK,GAAKA,EAAIE,KAAKE,OAASH,GAAK,GAAKA,EAAIC,KAAKG,QACjDH,KAAKqF,KAAKtF,GAAGD,GAAGgE,SAAS+E,EAAM5E,GAInC6E,WAAWhJ,EAAWC,EAAWoD,GAC3BrD,GAAK,GAAKA,EAAIE,KAAKE,OAASH,GAAK,GAAKA,EAAIC,KAAKG,SACjDH,KAAKqF,KAAKtF,GAAGD,GAAGqD,QAAUA,GAI9B4F,gBAAgBjJ,EAAWC,EAAWqD,GAChCtD,GAAK,GAAKA,EAAIE,KAAKE,OAASH,GAAK,GAAKA,EAAIC,KAAKG,SACjDH,KAAKqF,KAAKtF,GAAGD,GAAGsD,aAAeA,GAInC4F,UAAUlJ,EAAWC,GACnB,QAAID,EAAIE,KAAKwF,MAAQ1F,EAAIE,KAAKyF,MAAQ1F,EAAIC,KAAK0F,MAAQ3F,EAAIC,KAAK2F,OAGzD3F,KAAKqF,KAAKtF,GAAGD,GAAGwD,QAGzB2F,UAAUnJ,EAAWC,GACnB,OAAID,EAAI,GAAKA,EAAIE,KAAKE,OAASH,EAAI,GAAKA,EAAIC,KAAKG,QAG1CH,KAAKqF,KAAKtF,GAAGD,GAAGqD,QAGzB+F,eAAepJ,EAAWC,GACxB,OAAID,EAAI,GAAKA,EAAIE,KAAKE,OAASH,EAAI,GAAKA,EAAIC,KAAKG,QAG1CH,KAAKqF,KAAKtF,GAAGD,GAAGsD,aAMjB+F,eAAeC,EAAgBC,GACrC,MAAMC,EAAwB,GACxBC,EAAsB,GAC5B,IAIIzJ,EACAC,EACAyJ,EACAC,EACAnG,EACAoG,EACAC,EACAC,EACAC,EACAC,EAbAC,EAAY,EACZC,EAAiB,EACjBC,EAAsB,EACtBC,EAAW,EAYf,IAAKnK,EAAIC,KAAKuF,QAAU8D,EAAQtJ,GAAKC,KAAK0F,MAAQ3F,GAAKC,KAAK2F,KAC1D5F,GAAKsJ,EAAQY,EAAsBD,IAAkBD,EAGrD,IAFAP,EAAY,GAAMO,EAClBD,GAAoB,EACfL,EAAgBxE,KAAKwB,MAAMyD,EAAWH,EAAY,IACrDjK,EAAIE,KAAKsF,QAAWmE,EAAgBL,EACpCK,GAAiBM,GAAajK,GAAKE,KAAKwF,MAAQ1F,GAAKE,KAAKyF,KAC1D3F,GAAKsJ,IAAUK,EAAeK,EAAmBD,EAAU,CAO3D,GANAvG,GAAU,EACVoG,GAAW,EACXC,EAAcF,EAAgBM,EAC9BH,EAAaE,EACbD,EAAWF,EAAcH,EAErBS,EAAsB,EACxB,GAAMjK,KAAKqF,KAAKtF,EAAIsJ,GAAQvJ,GAAGwD,UAC5BtD,KAAKqF,KAAKtF,EAAIsJ,GAAQvJ,GAAGsD,cACxBpD,KAAKqF,KAAKtF,EAAIsJ,GAAQvJ,EAAIsJ,GAAQ9F,UACjCtD,KAAKqF,KAAKtF,EAAIsJ,GAAQvJ,EAAIsJ,GAAQhG,cAGrC,IAAK,IAAI+G,EAAM,EAAGA,EAAMF,GAAuB3G,IAAW6G,EACxD,GAAIP,GAAcL,EAAUY,IAC1BN,GAAYP,EAAYa,GACxB,GAAKnK,KAAKqF,KAAKtF,GAAGD,GAAGsD,aAMd,CACL,GAAIwG,GAAcN,EAAYa,IAC5BN,GAAYN,EAAUY,GAAM,CAC5B7G,GAAU,EACV,MAEAgG,EAAYa,GAAOlF,KAAKC,IAAIoE,EAAYa,GAAMP,GAC9CL,EAAUY,GAAOlF,KAAKmF,IAAIb,EAAUY,GAAMN,GAC1CH,GAAW,OAbb,GAAIC,EAAcL,EAAYa,IAC5BR,EAAcJ,EAAUY,GAAM,CAC9B7G,GAAU,EACV,YATRA,GAAU,EA0BVA,IACFtD,KAAKqF,KAAKtF,GAAGD,GAAGwD,SAAU,EACtBtD,KAAKqF,KAAKtF,GAAGD,GAAGsD,eACd8G,GAAYN,EACdM,EAAWL,EACDH,IACVJ,EAAYU,GAAkBJ,EAC9BL,EAAUS,KAAoBH,MAWlCQ,eAAejB,EAAgBC,GACrC,MAAMC,EAAwB,GACxBC,EAAsB,GAC5B,IAIIzJ,EACAC,EACAyJ,EACAC,EACAnG,EACAoG,EACAC,EACAC,EACAC,EACAC,EAbAC,EAAY,EACZC,EAAiB,EACjBC,EAAsB,EACtBC,EAAW,EAYf,IAAKpK,EAAIE,KAAKsF,QAAU8D,EAAQtJ,GAAKE,KAAKwF,MAAQ1F,GAAKE,KAAKyF,KAC1D3F,GAAKsJ,EAAQa,EAAsBD,IAAkBD,EAGrD,IAFAP,EAAY,GAAMO,EAClBD,GAAoB,EACfL,EAAgBxE,KAAKwB,MAAMyD,EAAWH,EAAY,IACrDhK,EAAIC,KAAKuF,QAAWkE,EAAgBJ,EACpCI,GAAiBM,GAAahK,GAAKC,KAAK0F,MAAQ3F,GAAKC,KAAK2F,KAC1D5F,GAAKsJ,IAAUI,EAAeK,EAAmBD,EAAU,CAO3D,GANAvG,GAAU,EACVoG,GAAW,EACXC,EAAcF,EAAgBM,EAC9BH,EAAaE,EACbD,EAAWF,EAAcH,EAErBS,EAAsB,EACxB,GAAMjK,KAAKqF,KAAKtF,GAAGD,EAAIsJ,GAAQ9F,UAC5BtD,KAAKqF,KAAKtF,GAAGD,EAAIsJ,GAAQhG,cACxBpD,KAAKqF,KAAKtF,EAAIsJ,GAAQvJ,EAAIsJ,GAAQ9F,UACjCtD,KAAKqF,KAAKtF,EAAIsJ,GAAQvJ,EAAIsJ,GAAQhG,cAGrC,IAAK,IAAI+G,EAAM,EAAGA,EAAMF,GAAuB3G,IAAW6G,EACxD,GAAIP,GAAcL,EAAUY,IAC1BN,GAAYP,EAAYa,GACxB,GAAKnK,KAAKqF,KAAKtF,GAAGD,GAAGsD,aAMd,CACL,GAAIwG,GAAcN,EAAYa,IAC5BN,GAAYN,EAAUY,GAAM,CAC5B7G,GAAU,EACV,MAEAgG,EAAYa,GAAOlF,KAAKC,IAAIoE,EAAYa,GAAMP,GAC9CL,EAAUY,GAAOlF,KAAKmF,IAAIb,EAAUY,GAAMN,GAC1CH,GAAW,OAbb,GAAIC,EAAcL,EAAYa,IAC5BR,EAAcJ,EAAUY,GAAM,CAC9B7G,GAAU,EACV,YATRA,GAAU,EA0BVA,IACFtD,KAAKqF,KAAKtF,GAAGD,GAAGwD,SAAU,EACtBtD,KAAKqF,KAAKtF,GAAGD,GAAGsD,eACd8G,GAAYN,EACdM,EAAWL,EACDH,IACVJ,EAAYU,GAAkBJ,EAC9BL,EAAUS,KAAoBH,MAQ1CS,WAAWhF,EAAiBC,EAAiBK,EAAgB2E,EAAuBC,GAKlF,GAJAxK,KAAKsF,QAAUA,EACftF,KAAKuF,QAAUA,EACfvF,KAAK4F,OAASA,EAEV2E,EACFvK,KAAKwF,KAAOP,KAAKC,IAAIlF,KAAKwF,KAAMP,KAAKmF,IAAI,EAAG9E,EAAUM,IACtD5F,KAAK0F,KAAOT,KAAKC,IAAIlF,KAAK0F,KAAMT,KAAKmF,IAAI,EAAG7E,EAAUK,IACtD5F,KAAKyF,KAAOR,KAAKmF,IAAIpK,KAAKyF,KAAMR,KAAKC,IAAIlF,KAAKE,MAAQ,EAAGoF,EAAUM,IACnE5F,KAAK2F,KAAOV,KAAKmF,IAAIpK,KAAK2F,KAAMV,KAAKC,IAAIlF,KAAKG,OAAS,EAAGoF,EAAUK,QAE/D,CACL5F,KAAKwF,KAAOP,KAAKmF,IAAI,EAAG9E,EAAUM,GAClC5F,KAAK0F,KAAOT,KAAKmF,IAAI,EAAG7E,EAAUK,GAClC5F,KAAKyF,KAAOR,KAAKC,IAAIlF,KAAKE,MAAQ,EAAGoF,EAAUM,GAC/C5F,KAAK2F,KAAOV,KAAKC,IAAIlF,KAAKG,OAAS,EAAGoF,EAAUK,GAEhD,IAAK,IAAI7F,EAAIC,KAAK0F,KAAM3F,GAAKC,KAAK2F,KAAM5F,IACtC,IAAK,IAAID,EAAIE,KAAKwF,KAAM1F,GAAKE,KAAKyF,KAAM3F,IACtCE,KAAKqF,KAAKtF,GAAGD,GAAGwD,SAAU,EAKhCtD,KAAKqF,KAAKE,GAASD,GAAShC,SAAU,OAElB7E,IAAhB+L,GACFxK,KAAKmJ,eAAe,EAAG,GACvBnJ,KAAKqK,eAAe,EAAG,GACvBrK,KAAKqK,eAAe,GAAI,GACxBrK,KAAKmJ,eAAe,GAAI,GACxBnJ,KAAKmJ,gBAAgB,GAAI,GACzBnJ,KAAKqK,gBAAgB,GAAI,GACzBrK,KAAKqK,gBAAgB,EAAG,GACxBrK,KAAKmJ,gBAAgB,EAAG,KAWN,EAAdqB,GACFxK,KAAKmJ,eAAe,EAAG,GAGP,EAAdqB,GACFxK,KAAKqK,eAAe,EAAG,GAGP,EAAdG,GACFxK,KAAKqK,eAAe,GAAI,GAGR,EAAdG,GACFxK,KAAKmJ,eAAe,GAAI,GAGR,GAAdqB,GACFxK,KAAKmJ,gBAAgB,GAAI,GAGT,GAAdqB,GACFxK,KAAKqK,gBAAgB,GAAI,GAGT,GAAdG,GACFxK,KAAKqK,gBAAgB,EAAG,GAGR,IAAdG,GACFxK,KAAKmJ,gBAAgB,EAAG,IAQ9BsB,iBACE,IAAK,IAAI1K,EAAIC,KAAK0F,KAAM3F,GAAKC,KAAK2F,KAAM5F,IACtC,IAAK,IAAID,EAAIE,KAAKwF,KAAM1F,GAAKE,KAAKyF,KAAM3F,IAAK,CAC3C,MAAM4K,EAAO1K,KAAKqF,KAAKtF,GAAGD,GAC1B4K,EAAKrH,SAAWqH,EAAKrH,UAAYqH,EAAKpH,U,wHCpb9C,MAyBaqH,EAAe,IAhDrB,MAOL9K,YACE+K,EAAaC,EAAmBC,EAChCC,EAAgBC,GAAqB,8HACrChL,KAAK4K,IAAMA,EACX5K,KAAK6K,UAAYA,EACjB7K,KAAK8K,WAAaA,EAClB9K,KAAK+K,MAAQA,GAAS,EACtB/K,KAAKgL,YAAcA,IASJ,qoDAyB8B,EAAG,G,wHChC7C,MAAMC,EAQXpL,cAAc,wJACZG,KAAKkL,MAAO,EACZlL,KAAKmL,SAAW,EAChBnL,KAAKoL,QAAS,EACdpL,KAAKqL,WAAa,EAClBrL,KAAKsL,UAAY,EACjBtL,KAAKuL,QAAU,IAGjBC,QAAQN,GACFlL,KAAKkL,OAASA,IAChBlL,KAAKkL,KAAOA,EACZlL,KAAKoL,QAAS,EACdpL,KAAKmL,SAAWnL,KAAKqL,WAAaI,YAAYC,OAIlDC,OAAOC,GACL5L,KAAKoL,QAAS,EACVpL,KAAKkL,MACPlL,KAAKsL,YACLtL,KAAKuL,QAAU,EACXK,EAAO5L,KAAKmL,UA1CK,KA0C6BS,EAAO5L,KAAKqL,YApC1C,oBAqClBrL,KAAKoL,QAAS,EACdpL,KAAKqL,WAAaO,KAGpB5L,KAAKsL,UAAY,EACjBtL,KAAKuL,WASTM,YACE,OAA0B,IAAnB7L,KAAKsL,WAAmBtL,KAAKoL,OAStCU,YACE,OAAwB,IAAjB9L,KAAKuL,SCpEhB,MAAMQ,EAAY,IAEX,MAAMC,EAQXnM,YAAYoM,G,iBAAiB,G,EAAA,U,EAAA,M,sFAC3BjM,KAAKkM,KAAO,IAAIC,MAAMJ,GACtB,IAAK,IAAItJ,EAAI,EAAGA,EAAIsJ,EAAWtJ,IAC7BzC,KAAKkM,KAAKzJ,GAAK,IAAIwI,EAGrBgB,EAAGG,iBAAiB,WAAWC,GAAKrM,KAAKsM,OAAOD,GAAG,KACnDJ,EAAGG,iBAAiB,SAASC,GAAKrM,KAAKsM,OAAOD,GAAG,KAInDC,OAAOD,EAAkBE,GACvB,MAAMC,EAAUH,EAAEG,QACdA,IAAYC,EAAKC,SAIrBL,EAAEM,kBACFN,EAAEO,iBACEJ,GAAW,GAAKA,EAAUT,GAC5B/L,KAAKkM,KAAKM,GAAShB,QAAQe,IAI/BM,WAAWjB,GACT,IAAK,IAAInJ,EAAI,EAAGA,EAAIsJ,EAAWtJ,IAC7BzC,KAAKkM,KAAKzJ,GAAGkJ,OAAOC,GAIxBkB,OAAON,GACL,OAAOA,GAAW,GAAKA,EAAUT,EAAY/L,KAAKkM,KAAKM,GAAW,MAI/D,IAAKC,E,kIAAAA,O,yBAAAA,I,qBAAAA,I,iCAAAA,I,mBAAAA,I,wBAAAA,I,wBAAAA,I,wBAAAA,I,4BAAAA,I,oBAAAA,I,wBAAAA,I,gCAAAA,I,0BAAAA,I,wBAAAA,I,4BAAAA,I,gCAAAA,I,oBAAAA,I,sBAAAA,I,sBAAAA,I,kBAAAA,I,wBAAAA,I,sBAAAA,I,oCAAAA,I,0BAAAA,I,0BAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,wBAAAA,I,gCAAAA,I,gCAAAA,I,0BAAAA,I,sCAAAA,I,wCAAAA,I,kBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,gBAAAA,I,sCAAAA,I,4BAAAA,I,4BAAAA,I,4BAAAA,I,4BAAAA,I,6BAAAA,I,6BAAAA,I,6BAAAA,I,6BAAAA,I,6BAAAA,I,6BAAAA,I,+BAAAA,I,qBAAAA,I,iCAAAA,I,+BAAAA,I,6BAAAA,I,2BAAAA,I,mBAAAA,I,mBAAAA,I,mBAAAA,I,mBAAAA,I,mBAAAA,I,mBAAAA,I,mBAAAA,I,mBAAAA,I,mBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,qBAAAA,I,+BAAAA,I,qCAAAA,I,mCAAAA,I,qCAAAA,I,uCAAAA,I,uBAAAA,I,2BAAAA,I,6BAAAA,I,iCAAAA,I,mCAAAA,I,mCAAAA,I,qCAAAA,I,+BAAAA,I,uBAAAA,I,uBAAAA,I,uCAAAA,I,mDAAAA,I,qDAAAA,I,yBAAAA,I,yBAAAA,I,2BAAAA,I,yBAAAA,I,mCAAAA,I,uCAAAA,I,mCAAAA,I,yCAAAA,I,yBAAAA,I,uBAAAA,I,yBAAAA,I,oBAAAA,I,sBAAAA,I,0BAAAA,I,sBAAAA,I,wBAAAA,I,wBAAAA,I,wBAAAA,I,wBAAAA,I,4BAAAA,I,kCAAAA,I,0BAAAA,I,kCAAAA,I,0BAAAA,I,wBAAAA,I,4BAAAA,I,yBAAAA,M,KC7CL,MAAMM,EAYXlN,YAAYwB,GAAoB,wNAC9BrB,KAAKiM,GAAK5K,EAAS2L,OACnBhN,KAAKE,MAAQmB,EAASnB,MACtBF,KAAKG,OAASkB,EAASlB,OACvBH,KAAKiN,MAAQ,EACbjN,KAAKkN,MAAQ,EACblN,KAAKF,EAAI,EACTE,KAAKD,EAAI,EACTC,KAAKmN,GAAK,EACVnN,KAAKoN,GAAK,EACVpN,KAAKqN,QAAU,CAAC,IAAIpC,EAAS,IAAIA,EAAS,IAAIA,GAE9C,MAAMgB,EAAKjM,KAAKiM,GAChBA,EAAGG,iBAAiB,aAAaC,GAAKrM,KAAKsN,YAAYjB,KACvDJ,EAAGG,iBAAiB,WAAWC,GAAKrM,KAAKsN,YAAYjB,KACrDJ,EAAGG,iBAAiB,aAAaC,GAAKrM,KAAKsN,YAAYjB,KACvDJ,EAAGG,iBAAiB,eAAeC,GAAKrM,KAAKsN,YAAYjB,KAEzD,MAAMkB,EAAoBvN,KAAKwN,iBAAiBC,KAAKzN,MACrDiM,EAAGG,iBAAiB,aAAcmB,GAClCtB,EAAGG,iBAAiB,WAAYmB,GAChCtB,EAAGG,iBAAiB,cAAemB,GACnCtB,EAAGG,iBAAiB,YAAamB,GAG3BC,iBAAiBnB,GAIvB,GAHAA,EAAEM,kBACFN,EAAEO,iBAEEP,EAAEqB,QAAQrL,OAAS,EAAG,CACxB,MAAMsL,EAAQtB,EAAEqB,QAAQ,GACxB1N,KAAK4N,eAAeD,EAAME,QAASF,EAAMG,SACzC9N,KAAKqN,QAAQ,GAAG7B,SAAQ,QAExBxL,KAAKqN,QAAQ,GAAG7B,SAAQ,GAIpB8B,YAAYjB,GAClBA,EAAEM,kBACFN,EAAEO,iBAEF5M,KAAK4N,eAAevB,EAAEwB,QAASxB,EAAEyB,SAElB,cAAXzB,EAAE0B,OACJ/N,KAAKqN,QAAQhB,EAAE2B,QAAQxC,SAAQ,GAC/BxL,KAAKiM,GAAGgC,SAGK,YAAX5B,EAAE0B,MACJ/N,KAAKqN,QAAQhB,EAAE2B,QAAQxC,SAAQ,GAI3BoC,eAAeC,EAAiBC,GACtC,IAAI/M,EAAuBf,KAAKiM,GAAGiC,wBAMnC,MAAMC,EAAsBnO,KAAKE,MAAQF,KAAKG,OACxCiO,EAAkBrN,EAAKb,MAAQa,EAAKZ,OAE1C,GAAIiO,EAAkBD,EAAsB,IAAM,CAChD,MAAME,EAAcF,EAAsBpN,EAAKZ,OACzCmO,EAASvN,EAAKb,MAAQmO,EAC5BtN,EAAO,IAAId,EAAKgF,KAAKwB,MAAM6H,EAAS,GAAI,EAAGD,EAAatN,EAAKZ,QAG/D,GAAIiO,EAAkBD,GAAuB,IAAM,CACjD,MAAMI,EAAexN,EAAKb,MAAQiO,EAC5BG,EAASvN,EAAKZ,OAASoO,EAC7BxN,EAAO,IAAId,EAAK,EAAGgF,KAAKwB,MAAM6H,EAAS,GAAIvN,EAAKb,MAAOqO,GAGzDvO,KAAKF,EAAKE,KAAKE,OAAS2N,EAAU9M,EAAKX,MAAQW,EAAKb,MAAS,EAC7DF,KAAKD,EAAKC,KAAKG,QAAU2N,EAAU/M,EAAKV,KAAOU,EAAKZ,OAAU,EAGhEwL,OAAOC,GACL5L,KAAKmN,GAAKnN,KAAKF,EAAIE,KAAKiN,MACxBjN,KAAKoN,GAAKpN,KAAKD,EAAIC,KAAKkN,MACxBlN,KAAKiN,MAAQjN,KAAKF,EAClBE,KAAKkN,MAAQlN,KAAKD,EAElB,IAAK,IAAI0C,EAAI,EAAGA,EAAIzC,KAAKqN,QAAQhL,OAAQI,IACvCzC,KAAKqN,QAAQ5K,GAAGkJ,OAAOC,I,wHCxF7B,SAAS4C,EAAY/L,EAAW2H,GAC9B,OAAqB3H,EAAI2H,EAAX,EAAN,EAOV,MAAMqE,EAAkB,CACtBC,KAAM/D,GAGD,MAAMgE,UAAiBxJ,EAgC5BtF,YAAYmN,EAA2B9M,EAAeC,EAAgByO,GACpEC,MAAM3O,EAAOC,GADkF,24BAG/FyO,EAAUA,GAAWH,EAErBzO,KAAKgN,OAASA,EACdhN,KAAK0O,KAAOE,EAAQF,MAAQ/D,EAC5B3K,KAAK8O,WAAa5O,EAAQF,KAAK0O,KAAK7D,UACpC7K,KAAK+O,YAAc5O,EAASH,KAAK0O,KAAK5D,WAEtCkC,EAAO9M,MAAQF,KAAK8O,WACpB9B,EAAO7M,OAASH,KAAK+O,YACrB/B,EAAOgC,MAAMC,eAAiB,YAC9BjC,EAAOgC,MAAME,QAAU,OACvBlC,EAAOmC,SAAW,EAClBnP,KAAKoP,eACLC,OAAOjD,iBAAiB,UAAU,IAAMpM,KAAKoP,iBAE7CpP,KAAKkM,KAAO,IAAIF,EAASgB,GACzBhN,KAAKsP,MAAQ,IAAIvC,EAAM/M,MAGvB,MAAMuP,EAAKvC,EAAOwC,WAAW,QAAS,CAAEC,WAAW,IACnD,IAAKF,EACH,MAAM,IAAIG,MACR,gEAGJ,MAAMC,EAAUJ,EAAGK,gBACnB,IAAKD,EACH,MAAM,IAAID,MACR,gEAGJ1P,KAAKuP,GAAKA,EACVvP,KAAK2P,QAAUA,EAEfJ,EAAGM,aAAaF,EAAS3P,KAAK8P,YAAYP,EAAGQ,cCrFb,4ODsFhCR,EAAGM,aAAaF,EAAS3P,KAAK8P,YAAYP,EAAGS,gBC/DX,+SDgElCT,EAAGU,YAAYN,GACfJ,EAAGW,WAAWP,GAEV3P,KAAK0O,KAAK1D,WAGZuE,EAAGY,UAAUZ,EAAGa,mBAAmBT,EAAS,KAAM,GAGpD3P,KAAKqQ,uBAAyBrQ,KAAKsQ,kBAAkB,KACrDtQ,KAAKuQ,sBAAwBvQ,KAAKsQ,kBAAkB,KACpDtQ,KAAKwQ,sBAAwBxQ,KAAKsQ,kBAAkB,KACpDtQ,KAAKyQ,sBAAwBzQ,KAAKsQ,kBAAkB,KAEpD,MAAMI,EAAYxQ,EAAQC,EAC1BH,KAAK2Q,eAAiB,IAAIC,aAAyB,EAAZF,EAAgB,GACvD1Q,KAAK6Q,WAAa,IAAIC,YAAwB,EAAZJ,GAClC1Q,KAAK+Q,aAAe,IAAIH,aAAyB,EAAZF,EAAgB,GACrD1Q,KAAKgR,qBAAuB,IAAIC,WAAuB,EAAZP,EAAgB,GAC3D1Q,KAAKkR,mBAAqB,IAAIC,SAASnR,KAAKgR,qBAAqBI,QACjEpR,KAAKqR,qBAAuB,IAAIJ,WAAuB,EAAZP,EAAgB,GAC3D1Q,KAAKsR,mBAAqB,IAAIH,SAASnR,KAAKqR,qBAAqBD,QAGjE,IAAI3O,EAAI,EACJ+D,EAAI,EACJ+K,EAAI,EACR,IAAK,IAAIxR,EAAI,EAAGA,EAAII,EAAQJ,IAC1B,IAAK,IAAID,EAAI,EAAGA,EAAII,EAAOJ,IAEzBE,KAAK2Q,eAAelO,KAAO+L,EAAY1O,EAAGI,GAC1CF,KAAK2Q,eAAelO,MAAQ+L,EAAYzO,EAAGI,GAG3CH,KAAK2Q,eAAelO,KAAO+L,EAAY1O,EAAI,EAAGI,GAC9CF,KAAK2Q,eAAelO,MAAQ+L,EAAYzO,EAAGI,GAG3CH,KAAK2Q,eAAelO,KAAO+L,EAAY1O,EAAI,EAAGI,GAC9CF,KAAK2Q,eAAelO,MAAQ+L,EAAYzO,EAAI,EAAGI,GAG/CH,KAAK2Q,eAAelO,KAAO+L,EAAY1O,EAAGI,GAC1CF,KAAK2Q,eAAelO,MAAQ+L,EAAYzO,EAAI,EAAGI,GAE/CH,KAAK6Q,WAAWrK,KAAO+K,EAAI,EAC3BvR,KAAK6Q,WAAWrK,KAAO+K,EAAI,EAC3BvR,KAAK6Q,WAAWrK,KAAO+K,EAAI,EAC3BvR,KAAK6Q,WAAWrK,KAAO+K,EAAI,EAC3BvR,KAAK6Q,WAAWrK,KAAO+K,EAAI,EAC3BvR,KAAK6Q,WAAWrK,KAAO+K,EAAI,EAE3BA,GAAK,EAITvR,KAAKwR,eAAiBjC,EAAGkC,eACzBzR,KAAK0R,YAAcnC,EAAGkC,eACtBzR,KAAK2R,cAAgBpC,EAAGkC,eACxBzR,KAAK4R,iBAAmBrC,EAAGkC,eAC3BzR,KAAK6R,iBAAmBtC,EAAGkC,eAE3BlC,EAAGuC,WAAWvC,EAAGwC,aAAc/R,KAAKwR,gBACpCjC,EAAGyC,WAAWzC,EAAGwC,aAAc/R,KAAK2Q,eAAgBpB,EAAG0C,aAEvD1C,EAAGuC,WAAWvC,EAAG2C,qBAAsBlS,KAAK0R,aAC5CnC,EAAGyC,WAAWzC,EAAG2C,qBAAsBlS,KAAK6Q,WAAYtB,EAAG0C,aAE3DjS,KAAKmS,QAAUnS,KAAKoS,YAAYpS,KAAK0O,KAAK9D,KAE1C5K,KAAKqS,eAAiB,EACtBrS,KAAKsS,YAAc,EACnBtS,KAAKuS,IAAM,EACXvS,KAAKwS,WAAa,EAElBxS,KAAKyS,wBAGCrD,eACN,MAAMsD,EAAS1S,KAAKgN,OAAO2F,cAC3B,IAAKD,EACH,OAEF,MAAME,EAAcF,EAAOG,YAAc7S,KAAK8O,WACxCgE,EAAeJ,EAAOK,aAAe/S,KAAK+O,YAC1CiE,EAAS/N,KAAKC,IAAI0N,EAAaE,GAC/B5S,EAAS8S,EAAShT,KAAK8O,WAAc,EACrC3O,EAAU6S,EAAShT,KAAK+O,YAAe,EAC7C/O,KAAKgN,OAAOgC,MAAM9O,MAAQA,EAAQ,KAClCF,KAAKgN,OAAOgC,MAAM7O,OAASA,EAAS,KAG9BmQ,kBAAkB2C,GACxB,MAAMC,EAAWlT,KAAKuP,GAAGe,kBAAkBtQ,KAAK2P,QAASsD,GAEzD,OADAjT,KAAKuP,GAAG4D,wBAAwBD,GACzBA,EAGDE,QACN,IAAIC,EAAoB,EACpBC,EAAkB,EAEtB,IAAK,IAAIvT,EAAI,EAAGA,EAAIC,KAAKG,OAAQJ,IAC/B,IAAK,IAAID,EAAI,EAAGA,EAAIE,KAAKE,MAAOJ,IAAK,CACnC,MAAM+I,EAAO7I,KAAKgG,QAAQlG,EAAGC,GAE7B,IAAK8I,EAAK3F,MAAO,CACfmQ,GAAqB,EACrBC,GAAmB,GACnB,SAGF,MAAMC,EAAY1K,EAAKhG,SAAW,GAC5B2Q,EAAa3K,EAAKhG,SAAW,GAAM,EAEzC7C,KAAK+Q,aAAasC,KAAuBE,EACzCvT,KAAK+Q,aAAasC,KAAuBG,EAEzCxT,KAAK+Q,aAAasC,KAAuBE,EAAW,EACpDvT,KAAK+Q,aAAasC,KAAuBG,EAEzCxT,KAAK+Q,aAAasC,KAAuBE,EAAW,EACpDvT,KAAK+Q,aAAasC,KAAuBG,EAAW,EAEpDxT,KAAK+Q,aAAasC,KAAuBE,EACzCvT,KAAK+Q,aAAasC,KAAuBG,EAAW,EAEpD,IAAK,IAAI/Q,EAAI,EAAGA,EAAI,EAAGA,IACrBzC,KAAKkR,mBAAmBuC,UAAUH,EAAiBzK,EAAK/F,IAAI,GAC5D9C,KAAKsR,mBAAmBmC,UAAUH,EAAiBzK,EAAK9F,IAAI,GAC5DuQ,GAAmB,EAGrBzK,EAAK3F,OAAQ,GAKnBwQ,UAAUlH,GACR,MAAMmH,EAAM3T,KAAKkM,KAAKY,OAAON,GAC7B,QAASmH,GAAOA,EAAIzI,KAGtB0I,aAAapH,GACX,MAAMmH,EAAM3T,KAAKkM,KAAKY,OAAON,GAC7B,QAASmH,GAAOA,EAAI9H,YAGtBgI,gBAAgBrH,GACd,MAAMmH,EAAM3T,KAAKkM,KAAKY,OAAON,GAC7B,OAAOmH,EAAMA,EAAIrI,UAAY,EAc/BwI,iBACE,OAAI9T,KAAK4T,aAAanH,EAAKsH,aAAe/T,KAAK4T,aAAanH,EAAKuH,MACxD,IAAIpU,GAAO,EAAG,GAEnBI,KAAK4T,aAAanH,EAAKwH,aAAejU,KAAK4T,aAAanH,EAAKyH,OAASlU,KAAK4T,aAAanH,EAAK0H,SACxF,IAAIvU,EAAM,EAAG,GAElBI,KAAK4T,aAAanH,EAAK2H,aAAepU,KAAK4T,aAAanH,EAAK4H,MACxD,IAAIzU,EAAM,EAAG,GAElBI,KAAK4T,aAAanH,EAAK6H,aAAetU,KAAK4T,aAAanH,EAAK8H,OAASvU,KAAK4T,aAAanH,EAAK+H,SACxF,IAAI5U,GAAO,EAAG,GAEnBI,KAAK4T,aAAanH,EAAKgI,aAAezU,KAAK4T,aAAanH,EAAKiI,WACxD,IAAI9U,EAAM,EAAG,GAElBI,KAAK4T,aAAanH,EAAKkI,aAAe3U,KAAK4T,aAAanH,EAAKmI,OAAS5U,KAAK4T,aAAanH,EAAKoI,UACxF,IAAIjV,EAAM,EAAG,GAElBI,KAAK4T,aAAanH,EAAKqI,aAAe9U,KAAK4T,aAAanH,EAAKsI,MACxD,IAAInV,GAAO,GAAI,GAEpBI,KAAK4T,aAAanH,EAAKuI,aAAehV,KAAK4T,aAAanH,EAAKwI,OAASjV,KAAK4T,aAAanH,EAAK0H,SACxF,IAAIvU,EAAM,GAAI,GAEnBI,KAAK4T,aAAanH,EAAKyI,aAAelV,KAAK4T,aAAanH,EAAK0I,MACxD,IAAIvV,EAAM,GAAI,QADvB,EAMMkQ,YAAY/B,EAAcqH,GAChC,MAAM7F,EAAKvP,KAAKuP,GACV8F,EAAK9F,EAAG+F,aAAavH,GAC3B,IAAKsH,EACH,MAAM,IAAI3F,MAAM,4CAIlB,GAFAH,EAAGgG,aAAaF,EAAID,GACpB7F,EAAGiG,cAAcH,IACZ9F,EAAGkG,mBAAmBJ,EAAI9F,EAAGmG,gBAChC,MAAM,IAAIhG,MACR,2CAA6CH,EAAGoG,iBAAiBN,IAErE,OAAOA,EAQDjD,YAAYxH,GAClB,MAAM2E,EAAKvP,KAAKuP,GACV4C,EAAU5C,EAAGqG,gBACnBrG,EAAGsG,YAAYtG,EAAGuG,WAAY3D,GAO9B,MACM4D,EAAiBxG,EAAGyG,KAIpBC,EAAY1G,EAAGyG,KACfE,EAAU3G,EAAG4G,cACbC,EAAQ,IAAInF,WAAW,CAAC,EAAG,EAAG,EAAG,MACvC1B,EAAG8G,WACD9G,EAAGuG,WATS,EASUC,EAPV,EACC,EACA,EAKgDE,EAC7DC,EAASE,GAEX,MAAME,EAAQ,IAAIC,MAYlB,OAXAD,EAAME,OAAS,KACbjH,EAAGsG,YAAYtG,EAAGuG,WAAY3D,GAC9B5C,EAAG8G,WACD9G,EAAGuG,WAhBO,EAgBYC,EAAgBE,EAAWC,EAASI,GAC5D/G,EAAGkH,cAAclH,EAAGuG,WAAYvG,EAAGmH,eAAgBnH,EAAGoH,eACtDpH,EAAGkH,cAAclH,EAAGuG,WAAYvG,EAAGqH,eAAgBrH,EAAGoH,eACtDpH,EAAGkH,cAAclH,EAAGuG,WAAYvG,EAAGsH,mBAAoBtH,EAAGuH,QAC1DvH,EAAGkH,cAAclH,EAAGuG,WAAYvG,EAAGwH,mBAAoBxH,EAAGuH,SAE5DR,EAAMU,IAAMpM,EAELuH,EAMD8E,SACN,MAAM1H,EAAKvP,KAAKuP,GAChBA,EAAG2H,WAAW,EAAK,EAAK,EAAK,GAC7B3H,EAAG4H,WAAW,GACd5H,EAAGzJ,MAAMyJ,EAAG6H,iBAAmB7H,EAAG8H,kBAClC9H,EAAG+H,SAAS,EAAG,EAAGtX,KAAK8O,WAAY9O,KAAK+O,aAIxC,CACE,MAAMwI,EAAgB,EAChBxJ,EAAOwB,EAAGiI,MACVC,GAAY,EACZC,EAAS,EACTC,EAAS,EACfpI,EAAGuC,WAAWvC,EAAGwC,aAAc/R,KAAKwR,gBACpCjC,EAAGqI,oBACD5X,KAAKqQ,uBAAwBkH,EAAexJ,EAAM0J,EAAWC,EAC7DC,GAKJ,CACE,MAAMJ,EAAgB,EAChBxJ,EAAOwB,EAAGiI,MACVC,GAAY,EACZC,EAAS,EACTC,EAAS,EACfpI,EAAGuC,WAAWvC,EAAGwC,aAAc/R,KAAK2R,eACpCpC,EAAGyC,WAAWzC,EAAGwC,aAAc/R,KAAK+Q,aAAcxB,EAAGsI,cACrDtI,EAAGqI,oBACD5X,KAAKuQ,sBAAuBgH,EAAexJ,EAAM0J,EAAWC,EAC5DC,GAIJ,CACE,MAAMJ,EAAgB,EAChBxJ,EAAOwB,EAAG4G,cACVsB,GAAY,EACZC,EAAS,EACTC,EAAS,EACfpI,EAAGuC,WAAWvC,EAAGwC,aAAc/R,KAAK4R,kBACpCrC,EAAGyC,WACDzC,EAAGwC,aAAc/R,KAAKgR,qBAAsBzB,EAAGsI,cACjDtI,EAAGqI,oBACD5X,KAAKwQ,sBAAuB+G,EAAexJ,EAAM0J,EAAWC,EAC5DC,GAIJ,CACE,MAAMJ,EAAgB,EAChBxJ,EAAOwB,EAAG4G,cACVsB,GAAY,EACZC,EAAS,EACTC,EAAS,EACfpI,EAAGuC,WAAWvC,EAAGwC,aAAc/R,KAAK6R,kBACpCtC,EAAGyC,WACDzC,EAAGwC,aAAc/R,KAAKqR,qBAAsB9B,EAAGsI,cACjDtI,EAAGqI,oBACD5X,KAAKyQ,sBAAuB8G,EAAexJ,EAAM0J,EAAWC,EAC5DC,GAIJpI,EAAGuC,WAAWvC,EAAG2C,qBAAsBlS,KAAK0R,aAG5CnC,EAAGW,WAAWlQ,KAAK2P,SAGnBJ,EAAGuI,cAAcvI,EAAGwI,UAGpBxI,EAAGsG,YAAYtG,EAAGuG,WAAY9V,KAAKmS,SAGnC,CACE,MAAM6F,EAAchY,KAAKE,MAAQF,KAAKG,OAAS,EACzC4N,EAAOwB,EAAG0I,eACVN,EAAS,EACfpI,EAAG2I,aAAa3I,EAAG4I,UAAWH,EAAajK,EAAM4J,IAI7ClF,wBACNpD,OAAOoD,uBAAsB2F,GAAKpY,KAAKqY,WAAWD,KAG5CC,WAAWzM,GACW,IAAxB5L,KAAKqS,gBACPrS,KAAKqS,eAAiBzG,EACtB5L,KAAKuS,IAAM,IAEXvS,KAAKsS,YAAc1G,EAAO5L,KAAKqS,eAC/BrS,KAAKqS,eAAiBzG,EACtB5L,KAAKuS,IAAM,IAASvS,KAAKsS,YACzBtS,KAAKwS,WAAa,IAAOxS,KAAKwS,WAAa,IAAOxS,KAAKuS,KAGzDvS,KAAKkM,KAAKW,WAAWjB,GACrB5L,KAAKsP,MAAM3D,OAAOC,GACd5L,KAAK2L,QACP3L,KAAK2L,SAEP3L,KAAKoT,QACLpT,KAAKiX,SACLjX,KAAKyS,yB,wHE1cF,MAAe6F,EAIpBzY,YAAYyB,EAAoBO,GAAe,qDAC7C7B,KAAKsB,aAAeA,EACpBtB,KAAK6B,MAAQA,GCHV,MAAM0W,UAAsBD,EAGjCzY,YAAYgC,EAAe2W,GACzB,MAAMnS,EAAQmS,EAAQlS,MAAM,MAC5B,IAAIpG,EAAQ2B,EAAMQ,OAClB,IAAK,IAAII,EAAI,EAAGA,EAAI4D,EAAMhE,OAAQI,IAChCvC,EAAQ+E,KAAKmF,IAAIlK,EAAOmG,EAAM5D,GAAGJ,QAGnC,MAAMlC,EAASkG,EAAMhE,O,UAErBwM,MADa,IAAI5O,EAAK,EAAG,EAAGC,EAAOC,GACvB0B,G,OAT8B,G,EAAA,W,EAAA,M,sFAU1C7B,KAAKqG,MAAQA,EAGfvE,aAAa2W,EAAkBd,GAC7B,IAAK,IAAIlV,EAAI,EAAGA,EAAIzC,KAAKqG,MAAMhE,OAAQI,IACrCgW,EAAQtS,WAAWwR,EAAO7X,EAAG6X,EAAO5X,EAAI0C,EAAGzC,KAAKqG,MAAM5D,IAI1DL,YAAYf,EAAoBsW,GAC9B,OAAOtW,EAASuS,aAAanH,EAAKiM,Y,wHCtB/B,MAAMC,UAAqBL,EAKhCzY,YACEgC,EAAe+M,EAAmBgK,GAClC,IAAI1Y,EAAQ2B,EAAMQ,OAClB,IAAK,IAAII,EAAI,EAAGA,EAAImM,EAAQvM,OAAQI,IAClCvC,EAAQ+E,KAAKmF,IAAIlK,EAAO0O,EAAQnM,GAAGJ,OAAS,GAG9C,MAAMlC,EAASyO,EAAQvM,OAEvBwM,MADa,IAAI5O,EAAK,EAAG,EAAGC,EAAOC,GACvB0B,GARqD,+EASjE7B,KAAK4O,QAAUA,EACf5O,KAAK4Y,SAAWA,EAChB5Y,KAAK6Y,YAAc,EAGrB/W,aAAa2W,EAAkBd,GAC7B,IAAK,IAAIlV,EAAI,EAAGA,EAAIzC,KAAK4O,QAAQvM,OAAQI,IAAK,CAC5C,MAAM2D,EAAM0S,OAAOC,aAAa,GAAKtW,GAAK,MAAQzC,KAAK4O,QAAQnM,GAC3DA,IAAMzC,KAAK6Y,WACbJ,EAAQtS,WAAWwR,EAAO7X,EAAG6X,EAAO5X,EAAI0C,EAAG2D,EAAK1H,EAAOC,MAAOD,EAAOE,OAErE6Z,EAAQtS,WAAWwR,EAAO7X,EAAG6X,EAAO5X,EAAI0C,EAAG2D,EAAK1H,EAAOE,MAAOF,EAAOC,QAK3EyD,YAAYf,EAAoBsW,GAE9B,GADA3X,KAAK6Y,YAAc,EACfxX,EAASiO,MAAMxP,GAAK6X,EAAO7X,GAC7BuB,EAASiO,MAAMxP,EAAI6X,EAAO7X,EAAIE,KAAKsB,aAAapB,OAChDmB,EAASiO,MAAMvP,GAAK4X,EAAO5X,GAC3BsB,EAASiO,MAAMvP,EAAI4X,EAAO5X,EAAIC,KAAKsB,aAAanB,SAChDH,KAAK6Y,WAAaxX,EAASiO,MAAMvP,EAAI4X,EAAO5X,EACF,IAAtCsB,EAASiO,MAAMjC,QAAQ,GAAG9B,SAE5B,OADAvL,KAAK4Y,SAAS5Y,KAAK6Y,aACZ,EAGX,IAAK,IAAIpW,EAAI,EAAGA,EAAIzC,KAAK4O,QAAQvM,OAAQI,IACvC,GAAIpB,EAASuS,aAAanH,EAAKuM,KAAOvW,GAEpC,OADAzC,KAAK4Y,SAASnW,IACP,EAGX,OAAOpB,EAASuS,aAAanH,EAAKiM,WAG5BO,kBAAkB5X,EAAoBsW,EAAeuB,GAC3D,OAAO7X,EAASiO,MAAMxP,GAAK6X,EAAO7X,GAChCuB,EAASiO,MAAMxP,EAAI6X,EAAO7X,EAAIE,KAAKsB,aAAapB,OAChDmB,EAASiO,MAAMvP,IAAM4X,EAAO5X,EAAImZ,GC5DtC,MAAMC,EAAM,EAAE,EAAG,EAAG,GAAI,EAAG,GAAI,EAAG,EAAG,GAC/BC,EAAM,EAAE,GAAI,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,GAC/BC,EAAQ,CAAC,IAAK,EAAG,IAAK,EAAG,EAAG,IAAK,EAAG,KAC1C,IAAI9V,EAAS,EAsDb,SAAS+V,EAAUzQ,GACjB,MAAM0Q,EAAS,GACf,IAAIC,EAAoB3Q,EACxB,KAAO2Q,GACLD,EAAOpX,KAAKqX,GACZA,EAAOA,EAAK/V,KAGd,OADA8V,EAAOE,UACAF,EAGT,MAAMG,EAGJ7Z,YAAY8Z,G,iBAAuB,G,EAAA,Y,EAAA,M,sFACjC3Z,KAAK4Z,OAASD,EAGhBE,OAAOhR,GACL,MAAMiR,EAAQ9Z,KAAK4Z,OACnB,IAAIG,EAAM,EACNC,EAAOF,EAAMzX,OACb6W,EAAQ,EAEZ,KAAOa,EAAMC,GAAM,CACjB,MAAMC,EAAOF,EAAMC,IAAU,EACvBE,EAAUJ,EAAMG,GAClBC,EAAQ5b,EAAI4b,EAAQ1W,EAAIqF,EAAKvK,EAAIuK,EAAKrF,GACxCuW,EAAME,EAAM,EACZf,EAAQa,IAERC,EAAOC,EACPf,EAAQc,GAGZF,EAAMtX,OAAO0W,EAAO,EAAGrQ,GAGzBsR,MACE,OAAOna,KAAK4Z,OAAOO,MAGrBC,OACE,OAAOpa,KAAK4Z,OAAOvX,Q,wHCjGhB,MAAMgY,EAWXxa,YAAYya,GAAe,gFAEzBta,KAAKua,EAAI,WACTva,KAAKxB,EAAI,WACTwB,KAAKkG,EAAI,MACTlG,KAAKuM,MAAQ+N,GAAQ,EAGvBE,UAEE,OADAxa,KAAKuM,OAASvM,KAAKxB,EAAIwB,KAAKuM,MAAQvM,KAAKkG,GAAKlG,KAAKua,EAC5Cva,KAAKuM,MAMdkO,YAEE,OAAOza,KAAKwa,WAAaxa,KAAKua,EAAI,GAQpCG,UAAUC,EAAeC,GAGvB,MAAMC,EAAYD,EAAMD,EAElBpB,EAASoB,GADM3a,KAAKwa,UAAYxa,KAAKua,EACHM,EAAa,GACrD,GAAIC,MAAMvB,GACR,MAAM,IAAI7J,MAAM,YAElB,OAAO6J,EAGTwB,YAAYC,GACV,MAAMC,EAAQD,EAAQE,QAAO,CAAC1c,EAAGD,IAAMC,EAAID,IACrC4c,EAAOnb,KAAK0a,UAAU,EAAGO,EAAQ,GACvC,IAAIG,EAAe,EAEnB,IAAK,IAAI3Y,EAAI,EAAGA,EAAIuY,EAAQ3Y,OAAQI,IAElC,GADA2Y,GAAgBJ,EAAQvY,GACpB0Y,GAAQC,EACV,OAAO3Y,EAIX,OAAOuY,EAAQ3Y,OAAS,EAG1BgZ,UAAUC,GACR,MAAM1B,EAAS,GACToB,EAAU,GAEhB,IAAK,MAAMO,KAAYD,EACjBA,EAAWE,eAAeD,KAC5B3B,EAAOzX,KAAKoZ,GACZP,EAAQ7Y,KAAKmZ,EAAWC,KAI5B,OAAO3B,EAAO5Z,KAAK+a,YAAYC,K,wHC/E5B,MAAMS,EASX5b,YAAY6b,EAAY5b,EAAWC,EAAW4b,EAAc1I,EAAc2I,EAAcC,GAAkB,uJACxG7b,KAAK0b,KAAOA,EACZ1b,KAAKF,EAAIA,EACTE,KAAKD,EAAIA,EACTC,KAAK2b,KAAOA,EACZ3b,KAAKiT,KAAOA,EACZjT,KAAK4b,MAAQA,EACb5b,KAAK6b,SAAWA,EAGlBC,WAAWpb,GACT,OAAOuE,KAAK8W,MAAMrb,EAAMZ,EAAIE,KAAKF,EAAGY,EAAMX,EAAIC,KAAKD,GAGrDic,SAASlc,EAAWC,GAClB,OAAOkF,KAAK8W,MAAMjc,EAAIE,KAAKF,EAAGC,EAAIC,KAAKD,GAGzCkc,aACEjc,KAAKkc,SACLlc,KAAK0b,KAAKS,SAASC,QAAQpc,MAG7Bkc,SACElc,KAAK0b,KAAKS,SAAS3Z,OAAOxC,KAAK0b,KAAKS,SAASE,QAAQrc,MAAO,GAG9DuB,OACMvB,KAAK0b,KAAKY,IAAItT,UAAUhJ,KAAKF,EAAGE,KAAKD,IACvCC,KAAK0b,KAAKa,IAAI/a,KAAK2E,WAAWnG,KAAKF,EAAGE,KAAKD,EAAGC,KAAK2b,KAAM3b,KAAK4b,Q,wHClC7D,MAAMY,UAAcf,EAUzB5b,YAAY6b,EAAY5b,EAAWC,EAAW4b,EAAc1I,EAAc2I,GACxE/M,MAAM6M,EAAM5b,EAAGC,EAAG4b,EAAM1I,EAAM2I,GAAO,GADiD,iMAEtF5b,KAAKyc,MAAQ,EACbzc,KAAK0c,UAAY,GACjB1c,KAAK2c,GAAK,EACV3c,KAAK4c,GAAK,EACV5c,KAAK6c,UAAY,EACjB7c,KAAK8c,YAAc,EACnB9c,KAAK+c,UAAY,EAGnBC,KAAK7P,EAAYC,GACXpN,KAAK0b,KAAKzS,UAAUjJ,KAAKF,EAAIqN,EAAInN,KAAKD,EAAIqN,KAG9CpN,KAAKF,GAAKqN,EACVnN,KAAKD,GAAKqN,GAGZ6P,WAAWC,EAAiBC,GAC1B,MAAMhQ,EAAK+P,EAAUld,KAAKF,EACpBsN,EAAK+P,EAAUnd,KAAKD,EACpBic,EAAW/W,KAAK8W,MAAM5O,EAAIC,GAChCpN,KAAKgd,KAAK/X,KAAKmY,MAAMjQ,EAAK6O,GAAW/W,KAAKmY,MAAMhQ,EAAK4O,IAGvDqB,kBAAkBC,GAChB,OAAOtd,KAAK0c,UAAUa,MAAKC,GAAQA,EAAKF,OAASA,GAAQE,EAAKC,WAGhEC,iBACE,OAAO1d,KAAK0c,UAAUiB,QAAOH,GAAQA,EAAKC,WAG5CG,MAAMJ,GACJ,MAAMK,EAAM7d,KAAKqd,kBAAkBG,EAAKF,MACpCO,GACF7d,KAAK8d,OAAOD,GAGdL,EAAKC,UAAW,EAChBzd,KAAK0b,KAAKqC,WAAW,YAAcP,EAAKvK,KAAO,OAASuK,EAAKF,KAAO,IAAK5e,EAAOS,aAGlF2e,OAAON,GACAA,EAAKC,WAGVD,EAAKC,UAAW,EAChBzd,KAAK0b,KAAKqC,WAAW,aAAeP,EAAKvK,KAAO,OAASuK,EAAKF,KAAO,IAAK5e,EAAOK,SAGnF,YACE,OAAOiB,KAAK6c,UAAY7c,KAAK0d,iBAAiBxC,QAAO,CAAC8C,EAAKR,IAASQ,EAAMR,EAAKS,YAAY,GAG7F,cACE,OAAOje,KAAK8c,YAAc9c,KAAK0d,iBAAiBxC,QAAO,CAAC8C,EAAKR,IAASQ,EAAMR,EAAKU,cAAc,GAGjG,YACE,OAAOle,KAAK+c,UAAY/c,KAAK0d,iBAAiBxC,QAAO,CAAC8C,EAAKR,IAASQ,EAAMR,EAAKW,YAAY,GAG7FC,OAAOC,GACL,MAAMC,EAASte,KAAKue,MAAQF,EAAOG,QAE/BF,EAAS,GACXte,KAAK0b,KAAKqC,WAAW/d,KAAKiT,KAAO,YAAcoL,EAAOpL,KAAO,QAAUqL,EAAS,gBAChFD,EAAOI,WAAWH,GACA,IAAdD,EAAO1B,IACT3c,KAAK0e,OAAOL,EAAOzB,KAGrB5c,KAAK0b,KAAKqC,WAAW/d,KAAKiT,KAAO,YAAcoL,EAAOpL,KAAO,0BAIjEyL,OAAO9B,GACL5c,KAAK4c,IAAMA,EACX5c,KAAK0b,KAAKiD,eAGZF,WAAWH,GACTte,KAAK2c,IAAM2B,EACPte,KAAK2c,IAAM,IACb3c,KAAK2c,GAAK,EACV3c,KAAK4e,SAITC,KAAKC,GACH9e,KAAK2c,GAAK1X,KAAKC,IAAIlF,KAAK2c,GAAKmC,EAAQ9e,KAAK+e,OAG5CH,QACM5e,OAASA,KAAK0b,KAAKsD,OACrBhf,KAAK0b,KAAKqC,WAAW,YAAarf,EAAOQ,UAEzCc,KAAK0b,KAAKqC,WAAW/d,KAAKiT,KAAO,YAAavU,EAAOiB,QAEvDK,KAAK2b,KAAO,IACZ3b,KAAK4b,MAAQld,EAAOQ,SACpBc,KAAK6b,QAAS,EACd7b,KAAKif,QAAKxgB,EACVuB,KAAKiT,KAAO,cAAgBjT,KAAKiT,KACjCjT,KAAKic,aAGPiD,OAAO1B,GACDxd,KAAK0c,UAAUra,QAAU,GAC3BrC,KAAK0b,KAAKqC,WAAW,0CAA4CP,EAAKvK,KAAO,IAAKvU,EAAOO,YAEzFe,KAAK0c,UAAUva,KAAKqb,GACpBA,EAAKtB,SACLlc,KAAK0b,KAAKqC,WAAW,mBAAqBP,EAAKvK,KAAO,IAAKvU,EAAOS,cAItEggB,QAAQ3B,GACFA,EAAK4B,YACP5B,EAAK4B,YAAY5B,GAEjBxd,KAAK0b,KAAKqC,WAAW,OAASP,EAAKvK,KAAO,oBAI9CoM,WAAW7B,GACTxd,KAAK0c,UAAUla,OAAOxC,KAAK0c,UAAUL,QAAQmB,GAAO,GAGtD8B,MAAML,GACJjf,KAAKif,GAAKA,EACVA,EAAGM,MAAQvf,M,wHC5IR,MAAMwf,EAGX3f,cAAc,uBACZG,KAAKuf,WAAQ9gB,EAGfghB,WACE,MAAMC,EAAU1f,KAAKuf,MACrB,IAAKG,EACH,OAGF,MAAMhE,EAAOgE,EAAQhE,KACfsD,EAAStD,EAAKsD,OAGhBtD,EAAKY,IAAItT,UAAU0W,EAAQ5f,EAAG4f,EAAQ3f,KAEpC2f,EAAQ5D,WAAWkD,IAAW,EAEhCU,EAAQzC,WAAW+B,EAAOlf,EAAGkf,EAAOjf,GAE3Bif,EAAOrC,GAAK,GAErB+C,EAAQtB,OAAOY,KAMhB,MAAMW,EAKX9f,YAAY+f,GAAW,wEACrB5f,KAAKuf,WAAQ9gB,EACbuB,KAAK4f,MAAQA,EACb5f,KAAK6f,SA9CiB,GAiDxBJ,WACE,IAAKzf,KAAKuf,MACR,OAEF,MAAM7D,EAAO1b,KAAKuf,MAAM7D,KACxB,GAAI1b,KAAK6f,SAAW,EAAG,CAGrB,MAAMC,EAAMpE,EAAKoE,IACjB9f,KAAKuf,MAAMvC,KAAK8C,EAAIpF,WAAW,EAAG,GAAIoF,EAAIpF,WAAW,EAAG,IACxD1a,KAAK6f,gBAEL7f,KAAKuf,MAAMN,GAAKjf,KAAK4f,MACrBlE,EAAKqC,WAAW,OAAS/d,KAAKuf,MAAMtM,KAAO,0BAA2BvU,EAAOO,Y,wHC7D5E,MAAM8gB,WAAatE,EAQxB5b,YAAY6b,EAAY5b,EAAWC,EAAW4b,EAAc1I,EAAc2I,GACxE/M,MAAM6M,EAAM5b,EAAGC,EAAG4b,EAAM1I,EAAM2I,GAAO,GADiD,mKAEtF5b,KAAKme,WAAa,EAClBne,KAAKke,aAAe,EACpBle,KAAKie,WAAa,EAClBje,KAAKsd,KAAO,GACZtd,KAAKyd,UAAW,G,yHCDpB,MAUMuC,GAAUC,GAuBVC,GAAkB9hB,EAAQ,EAAG,EAAG,KAChC+hB,GAAmB/hB,EAAQ,IAAK,IAAK,IACrCgiB,GAAoBhiB,EAAQ,GAAI,GAAI,KACpCiiB,GAAqBjiB,EAAQ,IAAK,IAAK,IAEtC,MAAMkiB,GAgBXzgB,YAAY0c,GAAU,kXACpBvc,KAAKuc,IAAMA,EACXvc,KAAK8f,IAAM,IAAIzF,EAAIkG,KAAK7U,OACxB1L,KAAKgf,OAAS,IAAIxC,EAAMxc,KAAM,GAAI,GAAI,IAAK,SAAUtB,EAAOE,OAC5DoB,KAAKgf,OAAOvC,MAAQ,EACpBzc,KAAKgf,OAAOrC,GAAK,IACjB3c,KAAKgf,OAAOnC,UAAY,IACxB7c,KAAKgf,OAAOlC,YAAc,EAC1B9c,KAAKgf,OAAOjC,UAAY,EACxB/c,KAAKmc,SAAW,CAACnc,KAAKgf,QACtBhf,KAAKwgB,SAAW,GAChBxgB,KAAKyc,MAAQ,EACbzc,KAAKsc,IAAMtc,KAAKygB,YAChBzgB,KAAK0gB,cAAe,EACpB1gB,KAAK2gB,aAAe,CAAE7gB,EAAG,EAAGC,EAAG,GAC/BC,KAAK4gB,UAAY,EACjB5gB,KAAK6gB,aAAc,EACnB7gB,KAAK+d,WAAW,uCAAwCrf,EAAOQ,UAG/D,MAAM4hB,EAAS,IAAIf,GAAK/f,KAAM,EAAG,EAAG,IAAK,SAAUtB,EAAOW,YAC1DyhB,EAAOxD,KAAO,aACdwD,EAAO3C,WAAa,EACpBne,KAAKgf,OAAOtC,UAAUva,KAAK2e,GAC3B9gB,KAAKgf,OAAOpB,MAAMkD,GAGpB7X,UAAUnJ,EAAWC,GAEnB,GAAIC,KAAKsc,IAAIjX,KAAKtF,GAAGD,GAAGqD,QACtB,OAAO,EAIT,IAAK,IAAIV,EAAI,EAAGA,EAAIzC,KAAKmc,SAAS9Z,OAAQI,IAAK,CAC7C,MAAMse,EAAS/gB,KAAKmc,SAAS1Z,GAC7B,GAAIse,EAAOlF,QAAUkF,EAAOjhB,IAAMA,GAAKihB,EAAOhhB,IAAMA,EAClD,OAAO,EAIX,OAAO,EAGTihB,WAAW1E,EAAc2E,GACvB,IAAK,IAAIlhB,EAAIkhB,EAAKlhB,EAAI,EAAGA,EAAIkhB,EAAK1gB,GAAIR,IACpC,IAAK,IAAID,EAAImhB,EAAKnhB,EAAI,EAAGA,EAAImhB,EAAK3gB,GAAIR,IACpCwc,EAAIjX,KAAKtF,GAAGD,GAAGqD,SAAU,EACzBmZ,EAAIjX,KAAKtF,GAAGD,GAAGsD,cAAe,EAKpC8d,cAAc5E,EAAc6E,EAAY7gB,EAAYP,GAClD,IAAK,IAAID,EAAImF,KAAKC,IAAIic,EAAI7gB,GAAKR,GAAKmF,KAAKmF,IAAI+W,EAAI7gB,GAAKR,IACpDwc,EAAIjX,KAAKtF,GAAGD,GAAGqD,SAAU,EACzBmZ,EAAIjX,KAAKtF,GAAGD,GAAGsD,cAAe,EAIlCge,cAAc9E,EAAc+E,EAAY9gB,EAAYT,GAClD,IAAK,IAAIC,EAAIkF,KAAKC,IAAImc,EAAI9gB,GAAKR,GAAKkF,KAAKmF,IAAIiX,EAAI9gB,GAAKR,IACpDuc,EAAIjX,KAAKtF,GAAGD,GAAGqD,SAAU,EACzBmZ,EAAIjX,KAAKtF,GAAGD,GAAGsD,cAAe,EAIlCqd,YACE,MAAMnE,EAAM,IAAInX,EAtHF,GACC,IAsHf,IAAK,IAAIpF,EAAI,EAAGA,EAtHD,GAsHiBA,IAC9B,IAAK,IAAID,EAAI,EAAGA,EAxHJ,GAwHmBA,IAC7Bwc,EAAIjX,KAAKtF,GAAGD,GAAGqD,SAAU,EACzBmZ,EAAIjX,KAAKtF,GAAGD,GAAGsD,cAAe,EAIlC,MAAMke,EAAQ,GAEd,IAAK,IAAIjjB,EAAI,EAAGA,EAnHF,GAmHiBA,IAAK,CAElC,MAAMkjB,EAAIvhB,KAAK8f,IAAIpF,UAtHH,EADA,IAwHVlX,EAAIxD,KAAK8f,IAAIpF,UAvHH,EADA,IA2HV5a,EAAIE,KAAK8f,IAAIpF,UAAU,EAtIjB,GAsIgC6G,EAAI,GAC1CxhB,EAAIC,KAAK8f,IAAIpF,UAAU,EAtIhB,GAsIgClX,EAAI,GAG3Cge,EAAU,IAAIvhB,EAAKH,EAAGC,EAAGwhB,EAAG/d,GAGlC,IAAIie,GAAS,EACb,IAAK,IAAIjb,EAAI,EAAGA,EAAI8a,EAAMjf,OAAQmE,IAChC,GAAIgb,EAAQ/gB,WAAW6gB,EAAM9a,IAAK,CAChCib,GAAS,EACT,MAIJ,IAAKA,EAAQ,CAIXzhB,KAAKghB,WAAW1E,EAAKkF,GAGrB,MAAME,EAASF,EAAQhhB,YAEvB,GAAqB,IAAjB8gB,EAAMjf,OAERrC,KAAKgf,OAAOlf,EAAI4hB,EAAO5hB,EACvBE,KAAKgf,OAAOjf,EAAI2hB,EAAO3hB,MAClB,CAKL,MAAM0D,EAAO6d,EAAMA,EAAMjf,OAAS,GAAG7B,YAGJ,IAA7BR,KAAK8f,IAAIpF,UAAU,EAAG,IAExB1a,KAAKkhB,cAAc5E,EAAK7Y,EAAK3D,EAAG4hB,EAAO5hB,EAAG2D,EAAK1D,GAC/CC,KAAKohB,cAAc9E,EAAK7Y,EAAK1D,EAAG2hB,EAAO3hB,EAAG2hB,EAAO5hB,KAGjDE,KAAKohB,cAAc9E,EAAK7Y,EAAK1D,EAAG2hB,EAAO3hB,EAAG0D,EAAK3D,GAC/CE,KAAKkhB,cAAc5E,EAAK7Y,EAAK3D,EAAG4hB,EAAO5hB,EAAG4hB,EAAO3hB,IAIjD1B,EAAI,GAEN2B,KAAK2hB,aAAaH,GAIpBF,EAAMnf,KAAKqf,IAKf,MAAMI,EAAYN,EAAMA,EAAMjf,OAAS,GAAG7B,YAI1C,OAHAR,KAAK6hB,OAAS,IAAIpG,EAAOzb,KAAM4hB,EAAU9hB,EAAG8hB,EAAU7hB,EAAG,IAAK,SAAUrB,EAAOE,OAC/EoB,KAAKmc,SAASha,KAAKnC,KAAK6hB,QACxB7hB,KAAK6hB,OAAO5F,aACLK,EAGTwF,iBAAiBC,GAGf,IAAK,IAAItf,EAAI,EAAGA,EAAIsf,EAAM1f,OAAQI,IAAK,CACrC,MAAMuf,EAAQD,EAAMtf,GAAG,GACjBga,EAAQsF,EAAMtf,GAAG,GACvB,GAAIzC,KAAKyc,OAASA,EAChB,OAAOuF,EAGX,OAAO,EAGTL,aAAaV,GAIX,MAAMgB,EAAcjiB,KAAK8hB,iBAAiB,CAAC,CAAC,EAAG,GAAI,CAAC,EAAG,GAAI,CAAC,EAAG,GAAI,CAAC,EAAG,KAGjEI,EAAiB,CACrB,IAAO,GACP,MAASliB,KAAK8hB,iBAAiB,CAAC,CAAC,GAAI,GAAI,CAAC,GAAI,GAAI,CAAC,GAAI,MAInDK,EAAWniB,KAAK8hB,iBAAiB,CAAC,CAAC,EAAG,GAAI,CAAC,EAAG,KAG9CM,EAAc,CAClB,KAAQ,GACR,UAAapiB,KAAK8hB,iBAAiB,CAAC,CAAC,GAAI,KACzC,SAAY9hB,KAAK8hB,iBAAiB,CAAC,CAAC,GAAI,KACxC,QAAW9hB,KAAK8hB,iBAAiB,CAAC,CAAC,GAAI,KACvC,MAAS9hB,KAAK8hB,iBAAiB,CAAC,CAAC,EAAG,KACpC,OAAU9hB,KAAK8hB,iBAAiB,CAAC,CAAC,GAAI,MAIlCO,EAAcriB,KAAK8f,IAAIpF,UAAU,EAAGuH,EAAc,GAExD,IAAK,IAAIxf,EAAI,EAAGA,EAAI4f,EAAa5f,IAAK,CAEpC,MAAM3C,EAAIE,KAAK8f,IAAIpF,UAAUuG,EAAKnhB,EAAI,EAAGmhB,EAAK3gB,GAAK,GAC7CP,EAAIC,KAAK8f,IAAIpF,UAAUuG,EAAKlhB,EAAI,EAAGkhB,EAAK1gB,GAAK,GACnD,IAAImf,EAAU,KAEd,MAAM4C,EAAStiB,KAAK8f,IAAIzE,UAAU6G,GACnB,QAAXI,GACF5C,EAAU,IAAIlD,EAAMxc,KAAMF,EAAGC,EAAG,IAAK,MAAOrB,EAAOS,aACnDugB,EAAQ/C,GAAK,GACb+C,EAAQ5C,YAAc,EACtB4C,EAAQ3C,UAAY,EACpB2C,EAAQ9C,GAAK,GACb8C,EAAQJ,MAAM,IAAIE,IAEE,UAAX8C,IACT5C,EAAU,IAAIlD,EAAMxc,KAAMF,EAAGC,EAAG,IAAK,QAASrB,EAAOU,YACrDsgB,EAAQ/C,GAAK,GACb+C,EAAQ5C,YAAc,EACtB4C,EAAQ3C,UAAY,EACpB2C,EAAQ9C,GAAK,IACb8C,EAAQJ,MAAM,IAAIE,IAGhBE,GACF1f,KAAKmc,SAASha,KAAKud,GAKvB,MAAM6C,EAAWviB,KAAK8f,IAAIpF,UAAU,EAAGyH,EAAW,GAElD,IAAK,IAAI1f,EAAI,EAAGA,EAAI8f,EAAU9f,IAAK,CAEjC,MAAM3C,EAAIE,KAAK8f,IAAIpF,UAAUuG,EAAKnhB,EAAI,EAAGmhB,EAAK3gB,GAAK,GAC7CP,EAAIC,KAAK8f,IAAIpF,UAAUuG,EAAKlhB,EAAI,EAAGkhB,EAAK1gB,GAAK,GACnD,IAAIid,EAAO,KAEX,MAAM8E,EAAStiB,KAAK8f,IAAIzE,UAAU+G,GACnB,SAAXE,GAEF9E,EAAO,IAAIuC,GAAK/f,KAAMF,EAAGC,EAAG,IAAK,iBAAkBrB,EAAOgB,cAC1D8d,EAAK4B,YAAe5B,GAASxd,KAAKwiB,SAAShF,IAEvB,cAAX8E,GAET9E,EAAO,IAAIuC,GAAK/f,KAAMF,EAAGC,EAAG,IAAK,2BAA4BrB,EAAOK,QACpEye,EAAK4B,YAAe5B,GAASxd,KAAKyiB,cAAcjF,IAE5B,aAAX8E,GAET9E,EAAO,IAAIuC,GAAK/f,KAAMF,EAAGC,EAAG,IAAK,qBAAsBrB,EAAOK,QAC9Dye,EAAK4B,YAAe5B,GAASxd,KAAK0iB,aAAalF,IAE3B,YAAX8E,GAET9E,EAAO,IAAIuC,GAAK/f,KAAMF,EAAGC,EAAG,IAAK,sBAAuBrB,EAAOK,QAC/Dye,EAAK4B,YAAe5B,GAASxd,KAAK2iB,YAAYnF,IAE1B,UAAX8E,GAET9E,EAAO,IAAIuC,GAAK/f,KAAMF,EAAGC,EAAG,IAAK,QAASrB,EAAOW,YACjDme,EAAK4B,YAAe5B,GAASxd,KAAKgf,OAAOpB,MAAMJ,IAE3B,WAAX8E,IAET9E,EAAO,IAAIuC,GAAK/f,KAAMF,EAAGC,EAAG,IAAK,SAAUrB,EAAOM,OAClDwe,EAAK4B,YAAe5B,GAASxd,KAAKgf,OAAOpB,MAAMJ,IAG7CA,IACFxd,KAAKmc,SAASha,KAAKqb,GACnBA,EAAKvB,eAKX2G,UAAU9iB,EAAWC,EAAW8iB,EAAoB5P,EAAc+O,EAAec,EAAiBC,EAAiBC,GAEjH,MAAMC,EAAWhe,KAAKmY,MAAM4E,EAAQc,EAAUD,GAG9C7iB,KAAKuc,IAAI/a,KAAKE,SAAS5B,EAAGC,EAAG8iB,EAAY,EAAG,EAAG,EAAGG,GAG9CC,EAAW,GACbjjB,KAAKuc,IAAI/a,KAAKE,SAAS5B,EAAGC,EAAGkjB,EAAU,EAAG,EAAG,EAAGF,GAIlD/iB,KAAKuc,IAAI/a,KAAKI,mBAAmB9B,EAAI+iB,EAAa,EAAG9iB,EAAGkT,EAAO,KAAO+O,EAAQ,IAAMc,EAASpkB,EAAOE,OAGtGskB,qBACE,MAAMpjB,EAAIE,KAAKuc,IAAI/a,KAAK8N,MAAMxP,EACxBC,EAAIC,KAAKuc,IAAI/a,KAAK8N,MAAMvP,EAE9B,IAAKC,KAAKsc,IAAItT,UAAUlJ,EAAGC,GACzB,MAAO,GAGT,MAAMojB,EAAQ,GAEd,IAAK,IAAI1gB,EAAI,EAAGA,EAAIzC,KAAKmc,SAAS9Z,OAAQI,IAAK,CAC7C,MAAMse,EAAS/gB,KAAKmc,SAAS1Z,GACzBse,EAAOjhB,IAAMA,GAAKihB,EAAOhhB,IAAMA,GACjCojB,EAAMhhB,KAAK4e,EAAO9N,MAItB,OAAOkQ,EAAMC,KAAK,MAGpBrF,WAAWsF,EAAaC,GACtB,KAAOtjB,KAAKwgB,SAASne,QA1VNkhB,GA2VbvjB,KAAKwgB,SAASgD,QAEhBxjB,KAAKwgB,SAASre,KAAK,CAAEshB,KAAMJ,EAAKzH,MAAQ0H,GAAa5kB,EAAOE,QAG9D8kB,mBAAmBvW,EAAYC,GAC7B,MAAMtN,EAAIE,KAAKgf,OAAOlf,EAAIqN,EACpBpN,EAAIC,KAAKgf,OAAOjf,EAAIqN,EAE1B,IAAIiR,EAAuB,KAC3B,IAAK,IAAI5b,EAAI,EAAGA,EAAIzC,KAAKmc,SAAS9Z,OAAQI,IAAK,CAC7C,MAAMse,EAAS/gB,KAAKmc,SAAS1Z,GAC7B,GAAIse,aAAkBvE,GAASuE,GAAU/gB,KAAKgf,QAAU+B,EAAOjhB,IAAMA,GAAKihB,EAAOhhB,IAAMA,EAAG,CACxFse,EAAS0C,EACT,OAIA1C,GAAUA,EAAOxC,OACnB7b,KAAKgf,OAAOZ,OAAOC,IAEnBre,KAAKgf,OAAOhC,KAAK7P,EAAIC,GACrBpN,KAAK0gB,cAAe,GAGtB,IAAK,IAAIje,EAAI,EAAGA,EAAIzC,KAAKmc,SAAS9Z,OAAQI,IAAK,CAC7C,MAAMse,EAAS/gB,KAAKmc,SAAS1Z,GACzBse,aAAkBvE,GAASuE,EAAO9B,IACpC8B,EAAO9B,GAAGQ,YAKhBkE,aACE,GAAI3jB,KAAKgf,OAAOrC,IAAM,EACpB,OAGF,GAAI3c,KAAKuc,IAAIqH,IAAIxhB,cACf,OAGF,MAAMZ,EAAOxB,KAAKuc,IAAI/a,KAChBqiB,EAAcriB,EAAKsS,iBAEzB,GAAI9T,KAAK8jB,eAeP,OAdItiB,EAAKoS,aAAanH,EAAKsX,WAAaviB,EAAK8N,MAAMjC,QAAQ,GAAGvB,cAC5D9L,KAAKgkB,aAAahkB,KAAK2gB,aAAa7gB,EAAGE,KAAK2gB,aAAa5gB,IAEvDyB,EAAKoS,aAAanH,EAAKiM,YAAclX,EAAK8N,MAAMjC,QAAQ,GAAGvB,cAC7D9L,KAAKikB,kBAEHJ,IACF7jB,KAAK2gB,aAAa7gB,GAAK+jB,EAAY/jB,EACnCE,KAAK2gB,aAAa5gB,GAAK8jB,EAAY9jB,QAEf,IAAlByB,EAAK8N,MAAMnC,IAA8B,IAAlB3L,EAAK8N,MAAMlC,KACpCpN,KAAK2gB,aAAa7gB,EAAI0B,EAAK8N,MAAMxP,EACjCE,KAAK2gB,aAAa5gB,EAAIyB,EAAK8N,MAAMvP,IAOrC,GAHI8jB,GACF7jB,KAAK0jB,mBAAmBG,EAAY/jB,EAAG+jB,EAAY9jB,GAEjDyB,EAAKoS,aAAanH,EAAKyX,MAEzB,IAAK,IAAIzhB,EAAI,EAAGA,EAAIzC,KAAKmc,SAAS9Z,OAAQI,IAAK,CAC7C,MAAMse,EAAS/gB,KAAKmc,SAAS1Z,GACzBse,aAAkBhB,IAAQgB,EAAOjhB,IAAME,KAAKgf,OAAOlf,GAAKihB,EAAOhhB,IAAMC,KAAKgf,OAAOjf,GACnFC,KAAKgf,OAAOE,OAAO6B,GAIzB,GAAIvf,EAAKoS,aAAanH,EAAK0X,MACzB,GAAqC,IAAjCnkB,KAAKgf,OAAOtC,UAAUra,OACxBrC,KAAKuc,IAAIqH,IAAI1hB,IAAI,IAAIqW,EAAc,QAAS,2BACvC,CACL,MAAM3J,EAAU5O,KAAKgf,OAAOtC,UAAUJ,KAAIkB,GACpCA,EAAKC,SACAD,EAAKvK,KAAO,QAAUuK,EAAKF,KAAO,IAElCE,EAAKvK,OAGhBjT,KAAKuc,IAAIqH,IAAI1hB,IAAI,IAAIyW,EAAa,YAAa/J,GAAU0T,GAAWtiB,KAAKokB,aAAa9B,MAG1F,GAAI9gB,EAAKoS,aAAanH,EAAK4X,MAAO,CAChC,MAAMC,EAlaU,IACE,IAiagBtkB,KAAKgf,OAAOvC,MAC9Czc,KAAKuc,IAAIqH,IAAI1hB,IAAI,IAAIqW,EAAc,YACjC,UAAYvY,KAAKgf,OAAOvC,MACxB,iBAAmBzc,KAAKgf,OAAOpC,GAC/B,6BAA+B0H,EAC/B,mBAAqBtkB,KAAKgf,OAAOD,MACjC,aAAe/e,KAAKgf,OAAOT,MAC3B,cAAgBve,KAAKgf,OAAOR,UAwBhC,GAtBIhd,EAAKoS,aAAanH,EAAK8X,WACrBvkB,KAAKgf,OAAOlf,IAAME,KAAK6hB,QAAQ/hB,GAAKE,KAAKgf,OAAOjf,IAAMC,KAAK6hB,QAAQ9hB,GACrEC,KAAKwkB,YAMJxkB,KAAK6gB,cACJrf,EAAK8N,MAAMxP,GAAK,GAClB0B,EAAK8N,MAAMxP,EA/cD,IAgdV0B,EAAK8N,MAAMvP,GAAK,GAChByB,EAAK8N,MAAMvP,EAhdA,GAidXC,KAAKykB,KNtdN,SAAqBnI,EAAclH,EAAesP,EAAaC,GACpEphB,IAEA,MAAMqhB,EAAatI,EAAIjX,KAAK+P,EAAOrV,GAAGqV,EAAOtV,GAC7C8kB,EAAWrhB,OAASA,EACpBqhB,EAAWtmB,EAAI,EACfsmB,EAAWphB,EAAIyB,KAAK8W,MAAM3G,EAAOtV,EAAI4kB,EAAK5kB,EAAGsV,EAAOrV,EAAI2kB,EAAK3kB,GAC7D6kB,EAAWnhB,KAAO,KAElB,MAAMohB,EAAI,IAAInL,EAAU,CAACkL,IAEzB,KAAOC,EAAEzK,OAAS,GAAG,CACnB,MAAM0K,EAAID,EAAE1K,MAEZ,GAAI2K,EAAEhlB,IAAM4kB,EAAK5kB,GAAKglB,EAAE/kB,IAAM2kB,EAAK3kB,EACjC,OAAOuZ,EAAUwL,GAGnB,IAAK,IAAIriB,EAAI,EAAGA,EAAI0W,EAAI9W,OAAQI,IAAK,CACnC,MAAM3C,EAAIglB,EAAEhlB,EAAIqZ,EAAI1W,GACd1C,EAAI+kB,EAAE/kB,EAAIqZ,EAAI3W,GACpB,GAAI3C,GAAK,GAAKA,EAAIwc,EAAIpc,OAASH,GAAK,GAAKA,EAAIuc,EAAInc,OAAQ,CACvD,MAAM4kB,EAAIzI,EAAIjX,KAAKtF,GAAGD,GACtB,GAAIilB,EAAE5hB,SAAW4hB,EAAE1hB,WAAavD,IAAM4kB,EAAK5kB,GAAKC,IAAM2kB,EAAK3kB,GACzD,SAEEglB,EAAExhB,SAAWA,IACfwhB,EAAExhB,OAASA,EACXwhB,EAAEzmB,EAAI0mB,IACND,EAAEvhB,EAAIyB,KAAK8W,MAAMjc,EAAI4kB,EAAK5kB,EAAGC,EAAI2kB,EAAK3kB,GACtCglB,EAAEthB,KAAO,MAEX,MAAMwhB,EAAMH,EAAExmB,EAAI+a,EAAM5W,GACpBwiB,EAAMF,EAAEzmB,GAAK2mB,GAAON,IACtBI,EAAEzmB,EAAI2mB,EACNF,EAAEthB,KAAOqhB,EACTD,EAAEhL,OAAOkL,OMkbCG,CAAYllB,KAAKsc,IAAKtc,KAAKgf,OAAQxd,EAAK8N,MAAO,KAE3DtP,KAAKykB,UAAOhmB,IAGXuB,KAAK6gB,aAAe7gB,KAAKykB,MAA0C,IAAlCjjB,EAAK8N,MAAMjC,QAAQ,GAAG9B,UAC1DvL,KAAK6gB,aAAc,EACnB7gB,KAAK4gB,UAAY,GAEf5gB,KAAK6gB,aAAe7gB,KAAKykB,MAAQzkB,KAAK4gB,WAAa,EAAG,CAExD,KAAO5gB,KAAK4gB,UAAY5gB,KAAKykB,KAAKpiB,QAChCrC,KAAKgf,OAAOlf,IAAME,KAAKykB,KAAKzkB,KAAK4gB,WAAW9gB,GAC5CE,KAAKgf,OAAOjf,IAAMC,KAAKykB,KAAKzkB,KAAK4gB,WAAW7gB,GAC5CC,KAAK4gB,YAGP,GAAI5gB,KAAK4gB,UAAY5gB,KAAKykB,KAAKpiB,OAAQ,CAErC,MAAM8iB,EAAOnlB,KAAKykB,KAAKzkB,KAAK4gB,WAC5B5gB,KAAK0jB,mBAAmByB,EAAKrlB,EAAIE,KAAKgf,OAAOlf,EAAGqlB,EAAKplB,EAAIC,KAAKgf,OAAOjf,GACjEC,KAAKgf,OAAOlf,IAAMqlB,EAAKrlB,GAAKE,KAAKgf,OAAOjf,IAAMolB,EAAKplB,IAErDC,KAAK6gB,aAAc,EACnB7gB,KAAK4gB,WAAa,EAClB5gB,KAAKykB,UAAOhmB,QAIduB,KAAK6gB,aAAc,EACnB7gB,KAAK4gB,WAAa,EAClB5gB,KAAKykB,UAAOhmB,GAKlB2lB,aAAa9B,GACPA,GAAU,GACZtiB,KAAKgf,OAAOG,QAAQnf,KAAKgf,OAAOtC,UAAU4F,IAI9C3D,eAEE,MAAM2F,EApeY,IACE,IAmectkB,KAAKgf,OAAOvC,MAC9C,GAAIzc,KAAKgf,OAAOpC,IAAM0H,EAAW,CAC/BtkB,KAAKgf,OAAOvC,QACZzc,KAAKgf,OAAOpC,IAAM0H,EAClBtkB,KAAK+d,WAAW,uDAAyD/d,KAAKgf,OAAOvC,MAAQ,IAAK/d,EAAOK,QAEzG,MAAM6P,EAAU,CACd,8BAAgC5O,KAAKgf,OAAOD,MAAQ,IACpD,6BAA+B/e,KAAKgf,OAAOT,MAAQ,IACnD,6BAA+Bve,KAAKgf,OAAOR,QAAU,KAGvDxe,KAAKuc,IAAIqH,IAAI1hB,IAAI,IAAIyW,EAAa,WAAY/J,GAAU0T,IACvC,IAAXA,GACFtiB,KAAKgf,OAAOnC,WAAa,GACzB7c,KAAKgf,OAAOrC,IAAM,IACE,IAAX2F,EACTtiB,KAAKgf,OAAOjC,WAAa,EACL,IAAXuF,IACTtiB,KAAKgf,OAAOlC,aAAe,QAMnCsI,kBAAkBtlB,EAAWC,EAAWslB,GACtC,IAAIC,EAAUD,EAAQ,EAClB9L,EAAS,KACb,IAAK,IAAI9W,EAAI,EAAGA,EAAIzC,KAAKmc,SAAS9Z,OAAQI,IAAK,CAC7C,MAAMse,EAAS/gB,KAAKmc,SAAS1Z,GAC7B,GAAIse,aAAkBvE,GAASuE,IAAW/gB,KAAKgf,OAAQ,CACrD,MAAMuG,EAAOxE,EAAO/E,SAASlc,EAAGC,GAC5BwlB,EAAOD,IACTA,EAAUC,EACVhM,EAASwH,IAIf,OAAOxH,EAGTiM,aAAa1lB,EAAWC,GACtB,OAAOC,KAAKolB,kBAAkBtlB,EAAGC,EAAG,GAGtCyiB,SAAShF,GAEHxd,KAAKgf,OAAOrC,KAAO3c,KAAKgf,OAAOD,OAKnC/e,KAAK+d,WAAW,oCAAqCrf,EAAOe,eAC5DO,KAAKgf,OAAOH,KAliBI,GAmiBhB7e,KAAKgf,OAAOK,WAAW7B,IANrBxd,KAAK+d,WAAW,kCAAmCrf,EAAOQ,UAS9DujB,cAAcjF,GAEZ,MAAMkC,EAAU1f,KAAKolB,kBAAkBplB,KAAKgf,OAAOlf,EAAGE,KAAKgf,OAAOjf,EAtiB9C,GAuiBf2f,GAML1f,KAAK+d,WAAW,gCAAkC2B,EAAQzM,KAAO,wBAAyBvU,EAAOa,YACjGS,KAAK+d,WAAW,8BAAqDrf,EAAOa,YAC5EmgB,EAAQjB,WAhjBa,IAijBrBze,KAAKgf,OAAOK,WAAW7B,IARrBxd,KAAK+d,WAAW,sCAAuCrf,EAAOO,WAWlEyjB,aAAalF,GAEXxd,KAAK+d,WAAW,yDAA0Drf,EAAOW,YACjFW,KAAKylB,gBAAe,CAAC3lB,EAAGC,KACtB,GAAIC,KAAKgf,OAAOhD,SAASlc,EAAGC,GArjBX,GAsjBfC,KAAK+d,WAAW,uBAAwBrf,EAAOG,gBADjD,CAKAmB,KAAK+d,WAAW,4DAAmFrf,EAAOiB,QAE1G,IAAK,IAAI8C,EAAI,EAAGA,EAAIzC,KAAKmc,SAAS9Z,OAAQI,IAAK,CAC7C,MAAMse,EAAS/gB,KAAKmc,SAAS1Z,GACzBse,aAAkBvE,GAASuE,EAAOpE,GAAK,GAAKoE,EAAO/E,SAASlc,EAAGC,IA7jBnD,IA8jBdC,KAAK+d,WAAW,OAASgD,EAAO9N,KAAhB,kCAA+EvU,EAAOiB,QACtGohB,EAAOtC,WA9jBO,KAkkBlBze,KAAKgf,OAAOK,WAAW7B,OAI3BmF,YAAYnF,GAEVxd,KAAK+d,WAAW,wDAAyDrf,EAAOW,YAChFW,KAAKylB,gBAAe,CAAC3lB,EAAGC,KACtB,GAAIC,KAAKgf,OAAOhD,SAASlc,EAAGC,GA7kBZ,EA+kBd,YADAC,KAAK+d,WAAW,uBAAwBrf,EAAOG,YAIjD,MAAM6gB,EAAU1f,KAAKwlB,aAAa1lB,EAAGC,GAChC2f,GAKLA,EAAQJ,MAAM,IAAIK,EAAgBD,EAAQT,KAC1Cjf,KAAK+d,WAAW,mBAAqB2B,EAAQzM,KAAO,uCAAwCvU,EAAOS,aACnGa,KAAKgf,OAAOK,WAAW7B,IANrBxd,KAAK+d,WAAW,oBAAqBrf,EAAOG,eAUlD4mB,eAAe7M,GACb5Y,KAAK8jB,eAAiBlL,EACtB5Y,KAAK2gB,aAAa7gB,EAAIE,KAAKgf,OAAOlf,EAClCE,KAAK2gB,aAAa5gB,EAAIC,KAAKgf,OAAOjf,EAGpCikB,aAAalkB,EAAWC,GAClBC,KAAK8jB,iBACP9jB,KAAK8jB,eAAehkB,EAAGC,GACvBC,KAAKikB,mBAITA,kBACEjkB,KAAK8jB,oBAAiBrlB,EAGxBinB,YACE,MAAMlkB,EAAOxB,KAAKuc,IAAI/a,KAElBxB,KAAK0gB,eACP1gB,KAAKsc,IAAIhS,WAAWtK,KAAKgf,OAAOlf,EAAGE,KAAKgf,OAAOjf,EAznBhC,IA0nBfC,KAAK0gB,cAAe,GAGtB,IAAK,IAAI3gB,EAAI,EAAGA,EA1oBD,GA0oBiBA,IAC9B,IAAK,IAAID,EAAI,EAAGA,EA5oBJ,GA4oBmBA,IAAK,CAClC,MAAMwD,EAAUtD,KAAKsc,IAAItT,UAAUlJ,EAAGC,GAChC4lB,EAAO3lB,KAAKsc,IAAIjX,KAAKtF,GAAGD,GAAGsD,aACjC,IAAIwY,EAAQld,EAAOC,MAEf2E,GAEFsY,EAAQ+J,EAAOxF,GAAmBE,GAClCrgB,KAAKsc,IAAIjX,KAAKtF,GAAGD,GAAGuD,UAAW,GACtBrD,KAAKsc,IAAIjX,KAAKtF,GAAGD,GAAGuD,WAE7BuY,EAAQ+J,EAAOzF,GAAkBE,IAGnC5e,EAAKuE,SAASjG,EAAGC,EAAG,EAAG,EAAG6b,GAM9B,IAAK5b,KAAK6gB,aAAe7gB,KAAKykB,KAC5B,IAAK,IAAIhiB,EAAI,EAAGA,EAAIzC,KAAKykB,KAAKpiB,OAAQI,IACpCjB,EAAKuE,SAAS/F,KAAKykB,KAAKhiB,GAAG3C,EAAGE,KAAKykB,KAAKhiB,GAAG1C,EAAG,EAAG,EAAGrB,EAAOE,OAK/D,IAAK,IAAI6D,EAAI,EAAGA,EAAIzC,KAAKmc,SAAS9Z,OAAQI,IACxCzC,KAAKmc,SAAS1Z,GAAGlB,OAInBC,EAAKE,SAAS,EAAGse,GAhrBA,GASA,EAuqBqC,EAAGthB,EAAOE,MAAOF,EAAOC,OAG9E,IAAIoB,EAAIigB,GACR,IAAK,IAAIvd,EAAI,EAAGA,EAAIzC,KAAKwgB,SAASne,OAAQI,IAAK,CAC7C,MAAM+V,EAAUxY,KAAKwgB,SAAS/d,GAC9BjB,EAAK2E,WA3qBGyf,GA2qBe7lB,EAAGyY,EAAQiL,KAAMjL,EAAQoD,OAChD7b,IAmBF,GAfAC,KAAK4iB,UACH,EAAG5C,GAprBS,GAqrBZ,KAAMhgB,KAAKgf,OAAOrC,GAAI3c,KAAKgf,OAAOD,MAClCrgB,EAAOO,UAAWP,EAAOQ,UAE3Bc,KAAK4iB,UACH,EAAG5C,GAzrBS,GA0rBZ,KAAMhgB,KAAKgf,OAAOpC,GApqBF,IACE,IAmqBoB5c,KAAKgf,OAAOvC,MAClD/d,EAAOe,cAAef,EAAOgB,cAE/B8B,EAAK2E,WAAW,EAAG6Z,GAAa,iBAAmBhgB,KAAKyc,MAAO/d,EAAOiB,QAGtE6B,EAAK2E,WAAW,EAAG6Z,GAAShgB,KAAKkjB,qBAAsBxkB,EAAOG,YAE1DmB,KAAK8jB,eAAgB,CACvB,MAAM+B,EAAarkB,EAAKwE,QAAQhG,KAAK2gB,aAAa7gB,EAAGE,KAAK2gB,aAAa5gB,GACnE8lB,GACFA,EAAWjiB,cAAclF,EAAOE,OAKpCoB,KAAKuc,IAAIqH,IAAIriB,OAGfijB,YAEExkB,KAAK+d,WAAW,wDAAyDrf,EAAOe,eAChFO,KAAKgf,OAAOH,KAAK7e,KAAKgf,OAAOD,MAAQ,GACrC/e,KAAKyc,QACLzc,KAAK+d,WAAW,sDAAuDrf,EAAOO,WAC9Ee,KAAKmc,SAAW,CAACnc,KAAKgf,QACtBhf,KAAKsc,IAAMtc,KAAKygB,YAChBzgB,KAAK0gB,cAAe,EAGtB/U,SACE3L,KAAK2jB,aACL3jB,KAAK0lB,aC1uBT,MAAMI,GAAW,CACf,CAAEjjB,SAAUF,EAAMojB,eAAgBC,OAAQ,CAAC,EAAG,EAAG,EAAG,IACpD,CAAEnjB,SAAUF,EAAMsjB,iBAAkBD,OAAQ,CAAC,EAAG,EAAG,EAAG,KA2CxD,SAASE,GAAaC,GACpB,MAAMnZ,EAASoZ,SAASC,cAAc,UACtCrZ,EAAO9M,MAAQimB,EAAIjmB,MACnB8M,EAAO7M,OAASgmB,EAAIhmB,OAEpB,MAAMmmB,EAAMtZ,EAAOwC,WAAW,MAG9B,OAFA8W,EAAIC,UAAUJ,EAAK,EAAG,GAEfG,EAAIJ,aAAa,EAAG,EAAGC,EAAIjmB,MAAOimB,EAAIhmB,QAAQqmB,KAGvD,SAASC,GACPC,EAAcF,EAAyB1mB,EAAWC,EAAWwhB,GAE7D,MAAMoF,EAAK,GAAK5mB,EAAIwhB,EAAIzhB,GAMlB8mB,EAAK,GAAK7mB,EAAIwhB,EAAIzhB,EAAI,GAMtB+mB,EAAK,IAAM9mB,EAAI,GAAKwhB,EAAIzhB,GAMxBgnB,EAAK,IAAM/mB,EAAI,GAAKwhB,EAAIzhB,EAAI,GAK5BinB,EAAS,CAAC,CAtBLP,EAAKG,GACLH,EAAKG,EAAK,GACVH,EAAKG,EAAK,IAoBS,CAhBnBH,EAAKI,GACLJ,EAAKI,EAAK,GACVJ,EAAKI,EAAK,IAcuB,CAVjCJ,EAAKK,GACLL,EAAKK,EAAK,GACVL,EAAKK,EAAK,IAQqC,CAJ/CL,EAAKM,GACLN,EAAKM,EAAK,GACVN,EAAKM,EAAK,KAOrB,IAAIE,EAAWC,OAAOC,UAClBC,EAAe,EACfC,EAAS,KACTC,EAAS,KAEb,IAAK,IAAI5kB,EAAI,EAAGA,EAAIqjB,GAASzjB,OAAQI,IAAK,CACxC,MAAM6kB,EAAUxB,GAASrjB,GACnB8kB,EAAgBC,GAAcF,EAAQtB,OAAQe,GAChDQ,EAAcE,MAAQT,IACxBA,EAAWO,EAAcE,MACzBN,EAAeG,EAAQzkB,SACvBukB,EAASG,EAAcxkB,GACvBskB,EAASE,EAAczkB,IAI3B4jB,EAAI3gB,SAASjG,EAAI,EAAGC,EAAI,EAAGonB,EAAcO,GAAaL,GAAqBK,GAAaN,IAG1F,SAASI,GAAcF,EAAmBP,GACxC,MAAMY,EAAM,CAAC,CAAC,EAAG,EAAG,GAAI,CAAC,EAAG,EAAG,IACzBC,EAAM,CAAC,CAAC,EAAG,EAAG,GAAI,CAAC,EAAG,EAAG,IACzB1mB,EAAQ,CAAC,EAAG,GAElB,IAAK,IAAIuB,EAAI,EAAGA,EAAI,EAAGA,IAAK,CAC1B,IAAK,IAAI+D,EAAI,EAAGA,EAAI,EAAGA,IACrBmhB,EAAIL,EAAQ7kB,IAAI+D,IAAMugB,EAAOtkB,GAAG+D,GAElCtF,EAAMomB,EAAQ7kB,MAGhB,IAAK,IAAIA,EAAI,EAAGA,EAAI,EAAGA,IACrB,IAAK,IAAI+D,EAAI,EAAGA,EAAI,EAAGA,IACrBohB,EAAInlB,GAAG+D,GAAKmhB,EAAIllB,GAAG+D,GAAKtF,EAAMuB,GAIlC,IAAIglB,EAAQ,EAEZ,IAAK,IAAIhlB,EAAI,EAAGA,EAAI,EAAGA,IAAK,CAC1B,IAAIolB,EAAY,EAChB,IAAK,IAAIrhB,EAAI,EAAGA,EAAI,EAAGA,IAAK,CAC1B,MAAMshB,EAAQf,EAAOtkB,GAAG+D,GAAKohB,EAAIN,EAAQ7kB,IAAI+D,GAC7CqhB,GAAaC,EAAQA,EAEvBL,GAASxiB,KAAK8iB,KAAKF,GAGrB,MAAO,CAAE9kB,GAAI6kB,EAAI,GAAI9kB,GAAI8kB,EAAI,GAAIH,SAGnC,SAASC,GAAaM,GACpB,OAAO5pB,EAAQ4pB,EAAI,GAAIA,EAAI,GAAIA,EAAI,IC9IrC,IAAIC,GAAyB,MD6BtB,SAAqBrd,EAAagO,GACvC,MAAMuN,EAAM,IAAI5P,MAChB4P,EAAI3P,OAAS,KACX,MAAM+K,EAAI4E,EAAIjmB,MACRsD,EAAI2iB,EAAIhmB,OACRqmB,EAAON,GAAaC,GACpB5M,EAAS,IAAIpU,EAAQoc,EAAI,EAAG/d,EAAI,GAEtC,IAAK,IAAIzD,EAAI,EAAGA,EAAIyD,EAAGzD,GAAK,EAC1B,IAAK,IAAID,EAAI,EAAGA,EAAIyhB,EAAGzhB,GAAK,EAC1B2mB,GAAQlN,EAAQiN,EAAM1mB,EAAGC,EAAGwhB,GAIhC3I,EAASW,IAEX4M,EAAInP,IAAMpM,EC3CZsd,CAAY,YAAa3O,IAAa0O,GAAS1O,KAExC,MAAM4O,GAGXtoB,YAAY0c,G,iBAAU,G,EAAA,S,EAAA,M,sFACpBvc,KAAKuc,IAAMA,EAGb5Q,SACE,MAAMnK,EAAOxB,KAAKuc,IAAI/a,KAChBoiB,EAAM5jB,KAAKuc,IAAIqH,IAErB,GAA2B,IAAvBA,EAAI3hB,QAAQI,OAAc,CAC5B,MAAMuM,EAAU,CAAC,kBAAmB,sBACpCgV,EAAI1hB,IAAI,IAAIyW,EAAa,YAAa/J,GAAU0T,IAM9C,OALe,IAAXA,EACFtiB,KAAKuc,IAAI6L,UACW,IAAX9F,GACTtiB,KAAKuc,IAAI8L,eAEH/F,GACN,KAAK,EACHtiB,KAAKuc,IAAI6L,UACT,MACF,KAAK,EACHpoB,KAAKuc,IAAI8L,oBAMjBzE,EAAIxhB,cAEJZ,EAAKsE,QAEDmiB,IACFzmB,EAAK6G,YAAY,EAAG,EAAG4f,GAAQ,EAAG,EAAG,GAAI,IAG3CzmB,EAAKI,mBAAmB,GAAI,GAAI,6BAA8BlD,EAAOK,QACrEyC,EAAKI,mBAAmB,GAAI,GAAI,WAAYlD,EAAOK,QACnD6kB,EAAIriB,Q,yHChDR,ICUO,MAOL1B,cAAc,uHACZG,KAAKwB,KAAO,IAAImN,EAASyX,SAASkC,cAAc,UAf/B,GACC,IAelBtoB,KAAK4jB,IAAM,IAAI7hB,EAAI/B,KAAKwB,MACxBxB,KAAKuoB,SAAW,IAAIJ,GAASnoB,MAC7BA,KAAKuM,MAAQvM,KAAKuoB,SAElBvoB,KAAKwB,KAAKmK,OAAS,IAAM3L,KAAKuM,MAAMZ,SAGtCyc,UACEpoB,KAAK0b,KAAO,IAAI4E,GAAKtgB,MACrBA,KAAKuM,MAAQvM,KAAK0b,KAGpB2M,eACMroB,KAAK0b,OACP1b,KAAKuM,MAAQvM,KAAK0b,UClCpB8M,EAA2B,GAG/B,SAASC,EAAoBC,GAE5B,GAAGF,EAAyBE,GAC3B,OAAOF,EAAyBE,GAAU3qB,QAG3C,IAAIC,EAASwqB,EAAyBE,GAAY,CAGjD3qB,QAAS,IAOV,OAHA4qB,EAAoBD,GAAU1qB,EAAQA,EAAOD,QAAS0qB,GAG/CzqB,EAAOD,QCjBf,OCFA0qB,EAAoBpqB,EAAKN,IACH,qBAAX6qB,QAA0BA,OAAOC,aAC1CC,OAAOC,eAAehrB,EAAS6qB,OAAOC,YAAa,CAAE7G,MAAO,WAE7D8G,OAAOC,eAAehrB,EAAS,aAAc,CAAEikB,OAAO,KDFhDyG,EAAoB,M","file":"index.min.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"wglt\"] = factory();\n\telse\n\t\troot[\"wglt\"] = factory();\n})(globalThis, function() {\nreturn ","\nexport type Color = number;\n\n/**\n * Creates a big-endian 32-bit RGBA color from red, green, and blue components.\n * @param r Red (0-255).\n * @param g Green (0-255).\n * @param b Blue (0-255).\n * @param a Optional alpha (0-255).\n * @return A 32-bit unsigned integer color.\n */\nexport function fromRgb(r: number, g: number, b: number, a?: number): Color {\n  if (a === undefined) {\n    a = 255;\n  }\n  return ((r << 24) + (g << 16) + (b << 8) + a);\n}\n\n\n/**\n * Converts a color from HSV format to RGBA format.\n *\n * Based on: https://stackoverflow.com/a/17243070/2051724\n *\n * @param h Hue (0.0 - 1.0).\n * @param s Saturation (0.0 - 1.0).\n * @param v Value (0.0 - 1.0).\n * @param a Optional alpha (0.0 - 1.0).\n * @return A 32-bit unsigned integer color.\n */\nexport function fromHsv(h: number, s: number, v: number, a?: number): Color {\n  const i = (h * 6) | 0;\n  const f = h * 6 - i;\n  const p = v * (1 - s);\n  const q = v * (1 - f * s);\n  const t = v * (1 - (1 - f) * s);\n  let r, g, b;\n  switch (i % 6) {\n    case 0:\n      r = v, g = t, b = p;\n      break;\n    case 1:\n      r = q, g = v, b = p;\n      break;\n    case 2:\n      r = p, g = v, b = t;\n      break;\n    case 3:\n      r = p, g = q, b = v;\n      break;\n    case 4:\n      r = t, g = p, b = v;\n      break;\n    case 5:\n      r = v, g = p, b = q;\n      break;\n    default:\n      r = 0;\n      g = 0;\n      b = 0;\n  }\n  if (a === undefined) {\n    a = 1.0;\n  }\n  return fromRgb((r * 255) | 0, (g * 255) | 0, (b * 255) | 0, (a * 255) | 0);\n}\n","\nimport { fromRgb } from './color';\n\nexport const Colors = {\n  BLACK: fromRgb(0, 0, 0),\n  WHITE: fromRgb(0xff, 0xff, 0xff),\n  LIGHT_GRAY: fromRgb(0xaa, 0xaa, 0xaa),\n  DARK_GRAY: fromRgb(0x55, 0x55, 0x55),\n  YELLOW: fromRgb(0xff, 0xff, 0x55),\n  BROWN: fromRgb(0xaa, 0x55, 0x00),\n  LIGHT_RED: fromRgb(0xff, 0x55, 0x55),\n  DARK_RED: fromRgb(0xaa, 0x00, 0x00),\n  LIGHT_GREEN: fromRgb(0x55, 0xff, 0x55),\n  DARK_GREEN: fromRgb(0x00, 0xaa, 0x00),\n  LIGHT_CYAN: fromRgb(0x55, 0xff, 0xff),\n  DARK_CYAN: fromRgb(0x00, 0xaa, 0xaa),\n  LIGHT_BLUE: fromRgb(0x55, 0x55, 0xff),\n  DARK_BLUE: fromRgb(0x00, 0x00, 0xaa),\n  LIGHT_MAGENTA: fromRgb(0xff, 0x55, 0xff),\n  DARK_MAGENTA: fromRgb(0xaa, 0x00, 0xaa),\n  ORANGE: fromRgb(0xff, 0x88, 0x00),\n};\n","\nexport class Point {\n  readonly x: number;\n  readonly y: number;\n  constructor(x: number, y: number) {\n    this.x = x;\n    this.y = y;\n  }\n}\n","import { Point } from './point';\n\nexport class Rect {\n  readonly x: number;\n  readonly y: number;\n  readonly width: number;\n  readonly height: number;\n  readonly left: number;\n  readonly top: number;\n  readonly x2: number;\n  readonly y2: number;\n\n  constructor(x: number, y: number, width: number, height: number) {\n    this.x = this.left = x;\n    this.y = this.top = y;\n    this.width = width;\n    this.height = height;\n    this.x2 = x + width;\n    this.y2 = y + height;\n  }\n\n  getCenter(): Point {\n    return new Point(this.x + (this.width / 2) | 0, this.y + (this.height / 2) | 0);\n  }\n\n  intersects(other: Rect): boolean {\n    return this.x <= other.x2 && this.x2 >= other.x && this.y <= other.y2 && this.y2 >= other.y;\n  }\n\n  contains(point: Point | Rect): boolean {\n    return point.x >= this.x && point.y < this.x2 && point.y >= this.y && point.y < this.y2;\n  }\n}\n","import { Point } from '../point';\nimport { Rect } from '../rect';\nimport { Dialog } from './dialog';\nimport { Console } from '../console';\n\nexport class DialogState {\n  readonly dialog: Dialog;\n  readonly rect: Rect;\n  readonly contentsOffset: Point;\n  open: boolean;\n  count: number;\n  buffer?: Console;\n\n  constructor(dialog: Dialog, rect: Rect, contentsOffset: Point) {\n    this.dialog = dialog;\n    this.rect = rect;\n    this.contentsOffset = contentsOffset;\n    this.open = false;\n    this.count = 0;\n  }\n}\n","\nimport { Colors } from '../colors';\nimport { Point } from '../point';\nimport { Rect } from '../rect';\nimport { DialogState } from './dialogstate';\nimport { Terminal } from '../terminal';\nimport { Dialog } from './dialog';\n\nexport class DefaultDialogRenderer {\n  getState(terminal: Terminal, dialog: Dialog): DialogState {\n    const width = dialog.contentsRect.width + 4;\n    const height = dialog.contentsRect.height + 4;\n    const x = ((terminal.width - width) / 2) | 0;\n    const y = ((terminal.height - height) / 2) | 0;\n    return new DialogState(\n      dialog, new Rect(x, y, width, height), new Point(x + 2, y + 2));\n  }\n\n  draw(term: Terminal, dialogState: DialogState): void {\n    const dialog = dialogState.dialog;\n    const { x, y, width, height } = dialogState.rect;\n    term.fillRect(x, y, width, height, 0, Colors.WHITE, Colors.BLACK);\n    term.drawSingleBox(x, y, width, height);\n    term.drawCenteredString(x + (width / 2) | 0, y, ' ' + dialog.title + ' ');\n    dialog.drawContents(term, dialogState.contentsOffset);\n  }\n}","import { Dialog } from './gui/dialog';\nimport { DialogState } from './gui/dialogstate';\nimport { DialogRenderer } from './gui/dialogrenderer';\nimport { DefaultDialogRenderer } from './gui/defaultdialogrenderer';\nimport { Terminal } from './terminal';\n\nexport class GUI {\n  readonly terminal: Terminal;\n  readonly renderer: DialogRenderer;\n  readonly dialogs: DialogState[];\n\n  constructor(terminal: Terminal, renderer?: DialogRenderer) {\n    this.terminal = terminal;\n    this.renderer = renderer || new DefaultDialogRenderer();\n    this.dialogs = [];\n  }\n\n  add(dialog: Dialog): void {\n    this.dialogs.push(this.renderer.getState(this.terminal, dialog));\n  }\n\n  /**\n   * Handles input for currently active dialog.\n   * Returns true if the input was handled.\n   * Returns false otherwise.\n   */\n  handleInput(): boolean {\n    if (this.dialogs.length === 0) {\n      return false;\n    }\n\n    const activeIndex = this.dialogs.length - 1;\n    const activeState = this.dialogs[this.dialogs.length - 1];\n    const activeDialog = activeState.dialog;\n    if (activeDialog.handleInput(this.terminal, activeState.contentsOffset)) {\n      this.dialogs.splice(activeIndex, 1);\n    }\n\n    return true;\n  }\n\n  draw(): void {\n    for (let i = 0; i < this.dialogs.length; i++) {\n      this.renderer.draw(this.terminal, this.dialogs[i]);\n    }\n  }\n}\n","\n/**\n * The BlendMode enum defines how translucent cells are rendered.\n */\nexport enum BlendMode {\n  /**\n   * No blending.  Alpha is ignored.\n   */\n  None = 0,\n\n  /**\n   * Alpha blending.\n   *\n   * dstRGB = (srcRGB * srcA) + (dstRGB * (1-srcA))\n   *\n   * dstA = srcA + (dstA * (1-srcA))\n   */\n  Blend = 1,\n\n  /**\n   * Additive blending.\n   *\n   * dstRGB = (srcRGB * srcA) + dstRGB\n   *\n   * dstA = dstA\n   */\n  Add = 2\n}\n","\n\n// https://en.wikipedia.org/wiki/Code_page_437\n// https://en.wikipedia.org/wiki/Block_Elements\n// https://en.wikipedia.org/wiki/Box-drawing_character\n\nexport enum Chars {\n  SMILEY = 1,\n  INVERSE_SMILEY = 2,\n  HEART = 3,\n  DIAMOND = 4,\n  CLUB = 5,\n  SPADE = 6,\n  BULLET = 7,\n  INVERSE_BULLET = 8,\n\n  LIGHT_SHADE = 176,\n  MEDIUM_SHADE = 177,\n  DARK_SHADE = 178,\n\n  BOX_SINGLE_VERTICAL = 179,\n  BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT = 180,\n  BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT = 185,\n  BOX_DOUBLE_VERTICAL = 186,\n  BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT = 187,\n  BOX_DOUBLE_UP_AND_DOUBLE_LEFT = 188,\n  BOX_SINGLE_DOWN_AND_SINGLE_LEFT = 191,\n  BOX_SINGLE_UP_AND_SINGLE_RIGHT = 192,\n  BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP = 193,\n  BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN = 194,\n  BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT = 195,\n  BOX_SINGLE_HORIZONTAL = 196,\n  BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL = 197,\n  BOX_DOUBLE_UP_AND_DOUBLE_RIGHT = 200,\n  BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT = 201,\n  BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP = 202,\n  BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN = 203,\n  BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT = 204,\n  BOX_DOUBLE_HORIZONTAL = 205,\n  BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL = 206,\n  BOX_SINGLE_UP_AND_SINGLE_LEFT = 13 * 16 + 9,\n  BOX_SINGLE_DOWN_AND_SINGLE_RIGHT = 13 * 16 + 10,\n\n  BLOCK_FULL = 219,\n  BLOCK_BOTTOM_HALF = 13 * 16 + 12,\n  BLOCK_LEFT_HALF = 13 * 16 + 13,\n  BLOCK_RIGHT_HALF = 13 * 16 + 14,\n  BLOCK_TOP_HALF = 13 * 16 + 15,\n}\n","\nimport { BlendMode } from './blendmode';\nimport { Colors } from './colors';\nimport { Color, fromRgb } from './color';\n\nfunction convertCharCode(charCode: string | number): number {\n  if ((typeof charCode === 'string') && charCode.length > 0) {\n    return charCode.charCodeAt(0);\n  } else {\n    return charCode as number;\n  }\n}\n\nexport class Cell {\n  readonly x: number;\n  readonly y: number;\n  charCode: number;\n  fg: Color;\n  bg: Color;\n  dirty: boolean;\n  blocked: boolean;\n  blockedSight: boolean;\n  explored: boolean;\n  visible: boolean;\n  pathId: number;\n  g: number;\n  h: number;\n  prev: Cell | null;\n\n  constructor(x: number, y: number, charCode?: string | number, fg?: Color, bg?: Color) {\n    this.x = x;\n    this.y = y;\n\n    if (charCode !== undefined) {\n      this.charCode = convertCharCode(charCode);\n    } else {\n      this.charCode = ' '.charCodeAt(0);\n    }\n\n    if (fg !== undefined) {\n      this.fg = fg;\n    } else {\n      this.fg = Colors.WHITE;\n    }\n\n    if (bg !== undefined) {\n      this.bg = bg;\n    } else {\n      this.bg = Colors.BLACK;\n    }\n\n    this.dirty = true;\n    this.blocked = false;\n    this.blockedSight = false;\n    this.explored = false;\n    this.visible = false;\n    this.pathId = -1;\n    this.g = 0;\n    this.h = 0;\n    this.prev = null;\n  }\n\n  setCharCode(charCode: number): void {\n    if (this.charCode !== charCode) {\n      this.charCode = charCode;\n      this.dirty = true;\n    }\n  }\n\n  setForeground(fg: Color): void {\n    if (fg !== undefined && fg !== null && fg !== this.fg) {\n      this.fg = fg;\n      this.dirty = true;\n    }\n  }\n\n  setBackground(bg: Color): void {\n    if (bg !== undefined && bg !== null && bg !== this.bg) {\n      this.bg = bg;\n      this.dirty = true;\n    }\n  }\n\n  setValue(charCode: string | number, fg?: Color, bg?: Color): boolean {\n    if (typeof charCode === 'string') {\n      charCode = charCode.charCodeAt(0);\n    }\n    if (typeof charCode === 'number') {\n      this.setCharCode(charCode);\n\n      if (fg !== undefined) {\n        this.setForeground(fg);\n      }\n      if (bg !== undefined) {\n        this.setBackground(bg);\n      }\n    } else {\n      this.drawCell(charCode, BlendMode.None);\n    }\n    return this.dirty;\n  }\n\n  drawCell(otherCell: Cell, blendMode?: BlendMode): void {\n    const alpha = otherCell.bg & 0xFF;\n\n    if (blendMode === BlendMode.None || otherCell.charCode > 0) {\n      this.setCharCode(otherCell.charCode);\n      this.setForeground(otherCell.fg);\n    } else if (alpha > 0 && alpha < 255) {\n      this.setForeground(this.blendColors(this.fg, otherCell.bg, blendMode));\n    }\n\n    if (blendMode === BlendMode.None || alpha === 255) {\n      this.setBackground(otherCell.bg);\n    } else if (alpha > 0) {\n      this.setBackground(this.blendColors(this.bg, otherCell.bg, blendMode));\n    }\n  }\n\n  private blendColors(c1: Color, c2: Color, blendMode?: BlendMode): Color {\n    const alpha = c2 & 0xFF;\n    const w1 = (255 - alpha) / 255.0;\n    const w2 = 1.0 - w1;\n    const r1 = (c1 >> 24) & 0xFF;\n    const g1 = (c1 >> 16) & 0xFF;\n    const b1 = (c1 >> 8) & 0xFF;\n    const r2 = (c2 >> 24) & 0xFF;\n    const g2 = (c2 >> 16) & 0xFF;\n    const b2 = (c2 >> 8) & 0xFF;\n\n    switch (blendMode) {\n      case BlendMode.Blend:\n        return fromRgb(\n          (w1 * r1 + w2 * r2) | 0, (w1 * g1 + w2 * g2) | 0,\n          (w1 * b1 + w2 * b2) | 0);\n\n      case BlendMode.Add:\n        return fromRgb(\n          this.clamp((r1 + w2 * r2) | 0), this.clamp((g1 + w2 * g2) | 0),\n          this.clamp((b1 + w2 * b2) | 0));\n\n      default:\n        return c2;\n    }\n  }\n\n  private clamp(x: number): number {\n    return Math.min(255, x);\n  }\n}\n","\nimport { BlendMode } from './blendmode';\nimport { Cell } from './cell';\nimport { Chars } from './chars';\nimport { Color } from './color';\n\nexport class Console {\n  readonly width: number;\n  readonly height: number;\n  readonly grid: Cell[][];\n  originX: number;\n  originY: number;\n  minX: number;\n  maxX: number;\n  minY: number;\n  maxY: number;\n  radius: number;\n\n  constructor(width: number, height: number, blockedFunc?: (x: number, y: number) => boolean) {\n    this.width = width;\n    this.height = height;\n    this.grid = [];\n    this.originX = 0;\n    this.originY = 0;\n    this.minX = 0;\n    this.maxX = 0;\n    this.minY = 0;\n    this.maxY = 0;\n    this.radius = 0;\n\n    for (let y = 0; y < height; y++) {\n      const row = [];\n      for (let x = 0; x < width; x++) {\n        row.push(new Cell(x, y));\n      }\n      this.grid.push(row);\n    }\n\n    this.clear();\n\n    if (blockedFunc) {\n      for (let y = 0; y < height; y++) {\n        for (let x = 0; x < width; x++) {\n          this.grid[y][x].blocked = this.grid[y][x].blockedSight = blockedFunc(x, y);\n        }\n      }\n    }\n  }\n\n  clear(): void {\n    for (let y = 0; y < this.height; y++) {\n      for (let x = 0; x < this.width; x++) {\n        this.drawChar(x, y, 0);\n      }\n    }\n  }\n\n  getCell(x: number, y: number): Cell|undefined {\n    if (x < 0 || y < 0 || x >= this.width || y >= this.height) {\n      return undefined;\n    }\n    return this.grid[y][x];\n  }\n\n  getCharCode(x: number, y: number): number|undefined {\n    if (x < 0 || y < 0 || x >= this.width || y >= this.height) {\n      return undefined;\n    }\n    return this.grid[y][x].charCode;\n  }\n\n  drawChar(x: number, y: number, c: string | number, fg?: Color, bg?: Color): void {\n    if (x >= 0 && x < this.width && y >= 0 && y < this.height) {\n      this.grid[y | 0][x | 0].setValue(c, fg, bg);\n    }\n  }\n\n  drawString(x: number, y: number, str: string, fg?: Color, bg?: Color): void {\n    const lines = str.split('\\n');\n    for (let i = 0; i < lines.length; i++) {\n      const line = lines[i];\n      for (let j = 0; j < line.length; j++) {\n        this.drawChar(x + j, y + i, line.charCodeAt(j), fg, bg);\n      }\n    }\n  }\n\n  drawCenteredString(x: number, y: number, str: string, fg?: Color, bg?: Color): void {\n    this.drawString(x - Math.floor(str.length / 2), y, str, fg, bg);\n  }\n\n  drawHLine(x: number, y: number, width: number, c: string | number, fg?: Color, bg?: Color): void {\n    for (let xi = x; xi < x + width; xi++) {\n      this.drawChar(xi, y, c, fg, bg);\n    }\n  }\n\n  drawVLine(x: number, y: number, height: number, c: string | number, fg?: Color, bg?: Color): void {\n    for (let yi = y; yi < y + height; yi++) {\n      this.drawChar(x, yi, c, fg, bg);\n    }\n  }\n\n  drawRect(x: number, y: number, width: number, height: number, c: string | number, fg?: Color, bg?: Color): void {\n    this.drawHLine(x, y, width, c, fg, bg);\n    this.drawHLine(x, y + height - 1, width, c, fg, bg);\n    this.drawVLine(x, y, height, c, fg, bg);\n    this.drawVLine(x + width - 1, y, height, c, fg, bg);\n  }\n\n  drawBox(\n    x: number, y: number, width: number, height: number,\n    topChar: number, rightChar: number, bottomChar: number, leftChar: number,\n    topLeftChar: number, topRightChar: number, bottomRightChar: number, bottomLeftChar: number,\n    fg?: Color, bg?: Color): void {\n    this.fillRect(x, y, width, height, 0, fg, bg);\n\n    this.drawHLine(x, y, width, topChar);\n    this.drawHLine(x, y + height - 1, width, bottomChar);\n\n    this.drawVLine(x, y, height, leftChar);\n    this.drawVLine(x + width - 1, y, height, rightChar);\n\n    this.drawChar(x, y, topLeftChar);\n    this.drawChar(x + width - 1, y, topRightChar);\n    this.drawChar(x, y + height - 1, bottomLeftChar);\n    this.drawChar(x + width - 1, y + height - 1, bottomRightChar);\n  }\n\n  drawSingleBox(x: number, y: number, width: number, height: number, fg?: Color, bg?: Color): void {\n    this.drawBox(\n      x, y, width, height, Chars.BOX_SINGLE_HORIZONTAL,\n      Chars.BOX_SINGLE_VERTICAL, Chars.BOX_SINGLE_HORIZONTAL,\n      Chars.BOX_SINGLE_VERTICAL, Chars.BOX_SINGLE_DOWN_AND_SINGLE_RIGHT,\n      Chars.BOX_SINGLE_DOWN_AND_SINGLE_LEFT,\n      Chars.BOX_SINGLE_UP_AND_SINGLE_LEFT,\n      Chars.BOX_SINGLE_UP_AND_SINGLE_RIGHT, fg, bg);\n  }\n\n  drawDoubleBox(x: number, y: number, width: number, height: number, fg?: Color, bg?: Color): void {\n    this.drawBox(\n      x, y, width, height, Chars.BOX_DOUBLE_HORIZONTAL,\n      Chars.BOX_DOUBLE_VERTICAL, Chars.BOX_DOUBLE_HORIZONTAL,\n      Chars.BOX_DOUBLE_VERTICAL, Chars.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT,\n      Chars.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT,\n      Chars.BOX_DOUBLE_UP_AND_DOUBLE_LEFT,\n      Chars.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT, fg, bg);\n  }\n\n  fillRect(x: number, y: number, width: number, height: number, c: string | number, fg?: Color, bg?: Color): void {\n    for (let yi = y; yi < y + height; yi++) {\n      this.drawHLine(x, yi, width, c, fg, bg);\n    }\n  }\n\n  drawConsole(\n    dstX: number, dstY: number,\n    srcConsole: Console,\n    srcX: number, srcY: number, srcWidth: number, srcHeight: number,\n    blendMode?: BlendMode): void {\n\n    blendMode = blendMode || BlendMode.None;\n\n    for (let y = 0; y < srcHeight; y++) {\n      for (let x = 0; x < srcWidth; x++) {\n        const cell = srcConsole.getCell(srcX + x, srcY + y);\n        if (cell) {\n          this.drawCell(dstX + x, dstY + y, cell, blendMode);\n        }\n      }\n    }\n  }\n\n  drawCell(x: number, y: number, cell: Cell, blendMode?: BlendMode): void {\n    if (x >= 0 && x < this.width && y >= 0 && y < this.height) {\n      this.grid[y][x].drawCell(cell, blendMode);\n    }\n  }\n\n  setBlocked(x: number, y: number, blocked: boolean): void {\n    if (x >= 0 && x < this.width && y >= 0 && y < this.height) {\n      this.grid[y][x].blocked = blocked;\n    }\n  }\n\n  setBlockedSight(x: number, y: number, blockedSight: boolean): void {\n    if (x >= 0 && x < this.width && y >= 0 && y < this.height) {\n      this.grid[y][x].blockedSight = blockedSight;\n    }\n  }\n\n  isVisible(x: number, y: number): boolean {\n    if (x < this.minX || x > this.maxX || y < this.minY || y > this.maxY) {\n      return false;\n    }\n    return this.grid[y][x].visible;\n  }\n\n  isBlocked(x: number, y: number): boolean {\n    if (x < 0 || x > this.width || y < 0 || y > this.height) {\n      return true;\n    }\n    return this.grid[y][x].blocked;\n  }\n\n  isBlockedSight(x: number, y: number): boolean {\n    if (x < 0 || x > this.width || y < 0 || y > this.height) {\n      return true;\n    }\n    return this.grid[y][x].blockedSight;\n  }\n\n  /**\n   * Compute the FOV in an octant adjacent to the Y axis\n   */\n  private computeOctantY(deltaX: number, deltaY: number): void {\n    const startSlopes: number[] = [];\n    const endSlopes: number[] = [];\n    let iteration = 1;\n    let totalObstacles = 0;\n    let obstaclesInLastLine = 0;\n    let minSlope = 0;\n    let x;\n    let y;\n    let halfSlope;\n    let processedCell;\n    let visible;\n    let extended;\n    let centreSlope;\n    let startSlope;\n    let endSlope;\n    let previousEndSlope;\n\n    for (y = this.originY + deltaY; y >= this.minY && y <= this.maxY;\n      y += deltaY, obstaclesInLastLine = totalObstacles, ++iteration) {\n      halfSlope = 0.5 / iteration;\n      previousEndSlope = -1;\n      for (processedCell = Math.floor(minSlope * iteration + 0.5),\n        x = this.originX + (processedCell * deltaX);\n        processedCell <= iteration && x >= this.minX && x <= this.maxX;\n        x += deltaX, ++processedCell, previousEndSlope = endSlope) {\n        visible = true;\n        extended = false;\n        centreSlope = processedCell / iteration;\n        startSlope = previousEndSlope;\n        endSlope = centreSlope + halfSlope;\n\n        if (obstaclesInLastLine > 0) {\n          if (!(this.grid[y - deltaY][x].visible &&\n            !this.grid[y - deltaY][x].blockedSight) &&\n            !(this.grid[y - deltaY][x - deltaX].visible &&\n              !this.grid[y - deltaY][x - deltaX].blockedSight)) {\n            visible = false;\n          } else {\n            for (let idx = 0; idx < obstaclesInLastLine && visible; ++idx) {\n              if (startSlope <= endSlopes[idx] &&\n                endSlope >= startSlopes[idx]) {\n                if (!this.grid[y][x].blockedSight) {\n                  if (centreSlope > startSlopes[idx] &&\n                    centreSlope < endSlopes[idx]) {\n                    visible = false;\n                    break;\n                  }\n                } else {\n                  if (startSlope >= startSlopes[idx] &&\n                    endSlope <= endSlopes[idx]) {\n                    visible = false;\n                    break;\n                  } else {\n                    startSlopes[idx] = Math.min(startSlopes[idx], startSlope);\n                    endSlopes[idx] = Math.max(endSlopes[idx], endSlope);\n                    extended = true;\n                  }\n                }\n              }\n            }\n          }\n        }\n        if (visible) {\n          this.grid[y][x].visible = true;\n          if (this.grid[y][x].blockedSight) {\n            if (minSlope >= startSlope) {\n              minSlope = endSlope;\n            } else if (!extended) {\n              startSlopes[totalObstacles] = startSlope;\n              endSlopes[totalObstacles++] = endSlope;\n            }\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * Compute the FOV in an octant adjacent to the X axis\n   */\n  private computeOctantX(deltaX: number, deltaY: number): void {\n    const startSlopes: number[] = [];\n    const endSlopes: number[] = [];\n    let iteration = 1;\n    let totalObstacles = 0;\n    let obstaclesInLastLine = 0;\n    let minSlope = 0;\n    let x;\n    let y;\n    let halfSlope;\n    let processedCell;\n    let visible;\n    let extended;\n    let centreSlope;\n    let startSlope;\n    let endSlope;\n    let previousEndSlope;\n\n    for (x = this.originX + deltaX; x >= this.minX && x <= this.maxX;\n      x += deltaX, obstaclesInLastLine = totalObstacles, ++iteration) {\n      halfSlope = 0.5 / iteration;\n      previousEndSlope = -1;\n      for (processedCell = Math.floor(minSlope * iteration + 0.5),\n        y = this.originY + (processedCell * deltaY);\n        processedCell <= iteration && y >= this.minY && y <= this.maxY;\n        y += deltaY, ++processedCell, previousEndSlope = endSlope) {\n        visible = true;\n        extended = false;\n        centreSlope = processedCell / iteration;\n        startSlope = previousEndSlope;\n        endSlope = centreSlope + halfSlope;\n\n        if (obstaclesInLastLine > 0) {\n          if (!(this.grid[y][x - deltaX].visible &&\n            !this.grid[y][x - deltaX].blockedSight) &&\n            !(this.grid[y - deltaY][x - deltaX].visible &&\n              !this.grid[y - deltaY][x - deltaX].blockedSight)) {\n            visible = false;\n          } else {\n            for (let idx = 0; idx < obstaclesInLastLine && visible; ++idx) {\n              if (startSlope <= endSlopes[idx] &&\n                endSlope >= startSlopes[idx]) {\n                if (!this.grid[y][x].blockedSight) {\n                  if (centreSlope > startSlopes[idx] &&\n                    centreSlope < endSlopes[idx]) {\n                    visible = false;\n                    break;\n                  }\n                } else {\n                  if (startSlope >= startSlopes[idx] &&\n                    endSlope <= endSlopes[idx]) {\n                    visible = false;\n                    break;\n                  } else {\n                    startSlopes[idx] = Math.min(startSlopes[idx], startSlope);\n                    endSlopes[idx] = Math.max(endSlopes[idx], endSlope);\n                    extended = true;\n                  }\n                }\n              }\n            }\n          }\n        }\n        if (visible) {\n          this.grid[y][x].visible = true;\n          if (this.grid[y][x].blockedSight) {\n            if (minSlope >= startSlope) {\n              minSlope = endSlope;\n            } else if (!extended) {\n              startSlopes[totalObstacles] = startSlope;\n              endSlopes[totalObstacles++] = endSlope;\n            }\n          }\n        }\n      }\n    }\n  }\n\n  computeFov(originX: number, originY: number, radius: number, opt_noClear?: boolean, opt_octants?: number): void {\n    this.originX = originX;\n    this.originY = originY;\n    this.radius = radius;\n\n    if (opt_noClear) {\n      this.minX = Math.min(this.minX, Math.max(0, originX - radius));\n      this.minY = Math.min(this.minY, Math.max(0, originY - radius));\n      this.maxX = Math.max(this.maxX, Math.min(this.width - 1, originX + radius));\n      this.maxY = Math.max(this.maxY, Math.min(this.height - 1, originY + radius));\n\n    } else {\n      this.minX = Math.max(0, originX - radius);\n      this.minY = Math.max(0, originY - radius);\n      this.maxX = Math.min(this.width - 1, originX + radius);\n      this.maxY = Math.min(this.height - 1, originY + radius);\n\n      for (let y = this.minY; y <= this.maxY; y++) {\n        for (let x = this.minX; x <= this.maxX; x++) {\n          this.grid[y][x].visible = false;\n        }\n      }\n    }\n\n    this.grid[originY][originX].visible = true;\n\n    if (opt_octants === undefined) {\n      this.computeOctantY(1, 1);\n      this.computeOctantX(1, 1);\n      this.computeOctantX(1, -1);\n      this.computeOctantY(1, -1);\n      this.computeOctantY(-1, -1);\n      this.computeOctantX(-1, -1);\n      this.computeOctantX(-1, 1);\n      this.computeOctantY(-1, 1);\n    } else {\n      //   \\ 4 | 3 /\n      //    \\  |  /\n      //  5  \\ | /  2\n      //      \\|/\n      // ------+-------\n      //      /|\\\n      //  6  / | \\  1\n      //    /  |  \\\n      //   / 7 | 0 \\\n      if (opt_octants & 0x001) {\n        this.computeOctantY(1, 1);\n      }\n\n      if (opt_octants & 0x002) {\n        this.computeOctantX(1, 1);\n      }\n\n      if (opt_octants & 0x004) {\n        this.computeOctantX(1, -1);\n      }\n\n      if (opt_octants & 0x008) {\n        this.computeOctantY(1, -1);\n      }\n\n      if (opt_octants & 0x010) {\n        this.computeOctantY(-1, -1);\n      }\n\n      if (opt_octants & 0x020) {\n        this.computeOctantX(-1, -1);\n      }\n\n      if (opt_octants & 0x040) {\n        this.computeOctantX(-1, 1);\n      }\n\n      if (opt_octants & 0x080) {\n        this.computeOctantY(-1, 1);\n      }\n    }\n  }\n\n  /**\n   * All visible tiles are marked as explored.\n   */\n  updateExplored(): void {\n    for (let y = this.minY; y <= this.maxY; y++) {\n      for (let x = this.minX; x <= this.maxX; x++) {\n        const tile = this.grid[y][x];\n        tile.explored = tile.explored || tile.visible;\n      }\n    }\n  }\n}\n","\nexport class Font {\n  readonly url: string;\n  readonly charWidth: number;\n  readonly charHeight: number;\n  readonly scale: number;\n  readonly graphical: boolean;\n\n  constructor(\n    url: string, charWidth: number, charHeight: number,\n    scale?: number, graphical?: boolean) {\n    this.url = url;\n    this.charWidth = charWidth;\n    this.charHeight = charHeight;\n    this.scale = scale || 1.0;\n    this.graphical = !!graphical;\n  }\n}\n\n/**\n * Font image as data URL.\n * IBM terminal font.\n * See img/font.png.\n */\nconst FONT_IMAGE = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAQ' +\n  'MAAAD58POIAAAABlBMVEUAAAD///+l2Z/dAAAEhklEQVRIx42Sv4oUQRDGC4UzadSwwMUD8' +\n  'QEKlbWD4Q58B/NGpTVocKO1wXHUzMAH0AcwMTYVGg5ag0IzEXaRjdZEZKNzkKbHqtnzHypY' +\n  '09M9+5uvqr7pbYCuC6ftaRhgONXs30eAh0O1rYDm4IS/eH0B8GxRW2vxo396yu/fb0ZFrW1' +\n  'zcOXlPU/XPwK8PGjbWhVwM4KnH61912oK4+zmmHJaQotyt1kvtC2Atdo24iohPDiG/v4eIC' +\n  'JsY3Wy8Yvr0DSIBOdxgH6v8wsriWhc8s0AtaK/GzSl1jR0nSjQnwki6FQxNFKjgzO2a7BBq' +\n  'ucH7dL4M9z96CIhT1Fs/AgKgcA6dKCxI29DaHNwRJ4EGAU1sU0OG9rmE4SIc3A4FChACqqh' +\n  'JRwpxkqh9wxag4DSmEJ5DtpFwAP4GUf6lmKcFFti1BYuQp4xN8kxM2kNhjdkTOiTUeAKGvh' +\n  'A1rLpMbYACQzCITlTDRMbLYoEa2JWPSMRFZIupcSzMVKcEUkX+sOG+ChNX2vD8ex6k7OFHL' +\n  '0P1655JuPd53WAD+yTv3UrCQiuHmYBbfIxpkImuvpBQBkVb5g4XHv3JkNireG8AO9zDhBZu' +\n  '2z2OMZ11S5/RIlyMefMNaZ4GsCz5xcjyM6hHYEjAYEfO8Ig1rklAe9sRIeYAdwyoIBq6YIz' +\n  'CAKiWoifA3m3o2AzWcdYKOdY47EIf8QABCuYgIUVmdVMEYEDA0Hmo/3D6KKJbh5mxhP3UsW' +\n  'IE97wnEygyizOfOLi2JOJW8CeOblW9IHeKZgv4zxuzDryOmb+4aQH+MXV6e0ywdUcxqCjBW' +\n  'l5GpbzZduOG1QEiGXP86T7EfiJfkMQ4OO4H0yqyNC2zlziWEN7Ywuc2fQ4p5BNkS5QYXP2h' +\n  '5NtRJh0vCKQidtVJmCGAwDSSQpYggSxiRIyzewsgCh4xxiTPDMh5aj//l7btqkr6rQyIOtL' +\n  'ji4lVRQwXdzvus40Y53M33fh50GZwF4ExQeMlvuTggLzSi4ElKczUO7zVtpwdyMKdqZKOWb' +\n  '2nDblawPxPmuMwFEWBW+jlZR1eYtS442kiBGMWCi/h1/+GAR6NYOJWiqNJXFygFtrkx5C0O' +\n  '3IeFGs67HhEEhmBu/BUOT+0551pXxYIF+Elpi5AKRkLl5GUbCCZddyMv621ujEBPP4vSy2f' +\n  'otTx3U+d3WBiFOA6VSGSB49v/M7GBX9FPrDaT2c9qr4PCpwZ7qz813R94dVFIe19v33GlMZ' +\n  'UghQFb8BrfE7QBmgBMbrn2B3enn/y3B5+DL8UBAdnejdYdBxeV9ejwoYNTgW0Ok/gA7UG2G' +\n  'AzanhL0DG7q4svynwF8UwDPu7u/vD0IudzSltMtVbP+J/gUbR29oJ7Fg9s6Uy+DnpiTCOYc' +\n  '4cXOeXMWfsusSw7FOg9x655nax6BlecwpOQQ68WBwp+H2LMQTuOq2RUigzh2Q/R3CWARJIJ' +\n  'G199EwOTyKBlQMznshCRGeQ5gHABAQl6M4gLEdAzVaBWMCiANdsayDCHBA/hagKYfielrJI' +\n  'lipKKQIA9Nf3wBloTHT6BuAx15zRNa1nAAAAAElFTkSuQmCC';\n\nexport const DEFAULT_FONT = new Font(FONT_IMAGE, 8, 8);\n","\n/**\n * The delay in frames before input repeating.\n * Time in milliseconds.\n */\nconst INPUT_REPEAT_DELAY = 200.0;\n\n/**\n * The delay between subsequent repeat firing.\n * Time in milliseconds.\n */\nconst INPUT_REPEAT_RATE = 1000.0 / 15.0;\n\n/**\n * The Input class represents a pysical input.\n * Example: keyboard key or mouse button.\n */\nexport class Input {\n  down: boolean;\n  downTime: number;\n  repeat: boolean;\n  repeatTime: number;\n  downCount: number;\n  upCount: number;\n\n  constructor() {\n    this.down = false;\n    this.downTime = 0;\n    this.repeat = false;\n    this.repeatTime = 0;\n    this.downCount = 0;\n    this.upCount = 100;\n  }\n\n  setDown(down: boolean): void {\n    if (this.down !== down) {\n      this.down = down;\n      this.repeat = false;\n      this.downTime = this.repeatTime = performance.now();\n    }\n  }\n\n  update(time: number): void {\n    this.repeat = false;\n    if (this.down) {\n      this.downCount++;\n      this.upCount = 0;\n      if (time - this.downTime >= INPUT_REPEAT_DELAY && time - this.repeatTime >= INPUT_REPEAT_RATE) {\n        this.repeat = true;\n        this.repeatTime = time;\n      }\n    } else {\n      this.downCount = 0;\n      this.upCount++;\n    }\n  }\n\n  /**\n   * Returns true if the input is \"pressed\".\n   * Pressed is a one time event when the input first goes down.\n   * It then repeats on repeat delay.\n   */\n  isPressed(): boolean {\n    return this.downCount === 1 || this.repeat;\n    // const count = this.downCount;\n    // return count === 1 || (count > INPUT_REPEAT_DELAY && count % INPUT_REPEAT_RATE === 0);\n  }\n\n  /**\n   * Returns true if the input is \"clicked\".\n   * Clicked is a one time event when the input first goes up.\n   */\n  isClicked(): boolean {\n    return this.upCount === 1;\n  }\n}\n","import { Input } from './input';\n\n/**\n * Number of keys to track.\n */\nconst KEY_COUNT = 256;\n\nexport class Keyboard {\n  readonly keys: Input[];\n\n  /**\n   * Creates a new keyboard module.\n   *\n   * @param el DOM el to attach listeners.\n   */\n  constructor(el: HTMLElement) {\n    this.keys = new Array(KEY_COUNT);\n    for (let i = 0; i < KEY_COUNT; i++) {\n      this.keys[i] = new Input();\n    }\n\n    el.addEventListener('keydown', e => this.setKey(e, true));\n    el.addEventListener('keyup', e => this.setKey(e, false));\n  }\n\n\n  setKey(e: KeyboardEvent, state: boolean): void {\n    const keyCode = e.keyCode;\n    if (keyCode === Keys.VK_F11) {\n      // Allow fullscreen requests to go through\n      return;\n    }\n    e.stopPropagation();\n    e.preventDefault();\n    if (keyCode >= 0 && keyCode < KEY_COUNT) {\n      this.keys[keyCode].setDown(state);\n    }\n  }\n\n  updateKeys(time: number): void {\n    for (let i = 0; i < KEY_COUNT; i++) {\n      this.keys[i].update(time);\n    }\n  }\n\n  getKey(keyCode: number): Input | null {\n    return keyCode >= 0 && keyCode < KEY_COUNT ? this.keys[keyCode] : null;\n  }\n}\n\nexport enum Keys {\n  VK_CANCEL = 3,\n  VK_HELP = 6,\n  VK_BACK_SPACE = 8,\n  VK_TAB = 9,\n  VK_CLEAR = 12,\n  VK_ENTER = 13,\n  VK_SHIFT = 16,\n  VK_CONTROL = 17,\n  VK_ALT = 18,\n  VK_PAUSE = 19,\n  VK_CAPS_LOCK = 20,\n  VK_ESCAPE = 27,\n  VK_SPACE = 32,\n  VK_PAGE_UP = 33,\n  VK_PAGE_DOWN = 34,\n  VK_END = 35,\n  VK_HOME = 36,\n  VK_LEFT = 37,\n  VK_UP = 38,\n  VK_RIGHT = 39,\n  VK_DOWN = 40,\n  VK_PRINTSCREEN = 44,\n  VK_INSERT = 45,\n  VK_DELETE = 46,\n  VK_0 = 48,\n  VK_1 = 49,\n  VK_2 = 50,\n  VK_3 = 51,\n  VK_4 = 52,\n  VK_5 = 53,\n  VK_6 = 54,\n  VK_7 = 55,\n  VK_8 = 56,\n  VK_9 = 57,\n  VK_COLON = 58,\n  VK_SEMICOLON = 59,\n  VK_LESS_THAN = 60,\n  VK_EQUALS = 61,\n  VK_GREATER_THAN = 62,\n  VK_QUESTION_MARK = 63,\n  VK_AT = 64,\n  VK_A = 65,\n  VK_B = 66,\n  VK_C = 67,\n  VK_D = 68,\n  VK_E = 69,\n  VK_F = 70,\n  VK_G = 71,\n  VK_H = 72,\n  VK_I = 73,\n  VK_J = 74,\n  VK_K = 75,\n  VK_L = 76,\n  VK_M = 77,\n  VK_N = 78,\n  VK_O = 79,\n  VK_P = 80,\n  VK_Q = 81,\n  VK_R = 82,\n  VK_S = 83,\n  VK_T = 84,\n  VK_U = 85,\n  VK_V = 86,\n  VK_W = 87,\n  VK_X = 88,\n  VK_Y = 89,\n  VK_Z = 90,\n  VK_CONTEXT_MENU = 93,\n  VK_NUMPAD0 = 96,\n  VK_NUMPAD1 = 97,\n  VK_NUMPAD2 = 98,\n  VK_NUMPAD3 = 99,\n  VK_NUMPAD4 = 100,\n  VK_NUMPAD5 = 101,\n  VK_NUMPAD6 = 102,\n  VK_NUMPAD7 = 103,\n  VK_NUMPAD8 = 104,\n  VK_NUMPAD9 = 105,\n  VK_MULTIPLY = 106,\n  VK_ADD = 107,\n  VK_SEPARATOR = 108,\n  VK_SUBTRACT = 109,\n  VK_DECIMAL = 110,\n  VK_DIVIDE = 111,\n  VK_F1 = 112,\n  VK_F2 = 113,\n  VK_F3 = 114,\n  VK_F4 = 115,\n  VK_F5 = 116,\n  VK_F6 = 117,\n  VK_F7 = 118,\n  VK_F8 = 119,\n  VK_F9 = 120,\n  VK_F10 = 121,\n  VK_F11 = 122,\n  VK_F12 = 123,\n  VK_F13 = 124,\n  VK_F14 = 125,\n  VK_F15 = 126,\n  VK_F16 = 127,\n  VK_F17 = 128,\n  VK_F18 = 129,\n  VK_F19 = 130,\n  VK_F20 = 131,\n  VK_F21 = 132,\n  VK_F22 = 133,\n  VK_F23 = 134,\n  VK_F24 = 135,\n  VK_NUM_LOCK = 144,\n  VK_SCROLL_LOCK = 145,\n  VK_CIRCUMFLEX = 160,\n  VK_EXCLAMATION = 161,\n  VK_DOUBLE_QUOTE = 162,\n  VK_HASH = 163,\n  VK_DOLLAR = 164,\n  VK_PERCENT = 165,\n  VK_AMPERSAND = 166,\n  VK_UNDERSCORE = 167,\n  VK_OPEN_PAREN = 168,\n  VK_CLOSE_PAREN = 169,\n  VK_ASTERISK = 170,\n  VK_PLUS = 171,\n  VK_PIPE = 172,\n  VK_HYPHEN_MINUS = 173,\n  VK_OPEN_CURLY_BRACKET = 174,\n  VK_CLOSE_CURLY_BRACKET = 175,\n  VK_TILDE = 176,\n  VK_COMMA = 188,\n  VK_PERIOD = 190,\n  VK_SLASH = 191,\n  VK_BACK_QUOTE = 192,\n  VK_OPEN_BRACKET = 219,\n  VK_BACK_SLASH = 220,\n  VK_CLOSE_BRACKET = 221,\n  VK_QUOTE = 222,\n  VK_META = 224,\n  VK_ALTGR = 225,\n  VK_WIN = 91,\n  VK_KANA = 21,\n  VK_HANGUL = 21,\n  VK_EISU = 22,\n  VK_JUNJA = 23,\n  VK_FINAL = 24,\n  VK_HANJA = 25,\n  VK_KANJI = 25,\n  VK_CONVERT = 28,\n  VK_NONCONVERT = 29,\n  VK_ACCEPT = 30,\n  VK_MODECHANGE = 31,\n  VK_SELECT = 41,\n  VK_PRINT = 42,\n  VK_EXECUTE = 43,\n  VK_SLEEP = 95,\n}\n","\nimport { Rect } from './rect';\nimport { Input } from './input';\nimport { Terminal } from './terminal';\n\nexport class Mouse {\n  readonly el: HTMLCanvasElement;\n  readonly width: number;\n  readonly height: number;\n  private prevX: number;\n  private prevY: number;\n  x: number;\n  y: number;\n  dx: number;\n  dy: number;\n  readonly buttons: Input[];\n\n  constructor(terminal: Terminal) {\n    this.el = terminal.canvas;\n    this.width = terminal.width;\n    this.height = terminal.height;\n    this.prevX = 0;\n    this.prevY = 0;\n    this.x = 0;\n    this.y = 0;\n    this.dx = 0;\n    this.dy = 0;\n    this.buttons = [new Input(), new Input(), new Input()];\n\n    const el = this.el;\n    el.addEventListener('mousedown', e => this.handleEvent(e));\n    el.addEventListener('mouseup', e => this.handleEvent(e));\n    el.addEventListener('mousemove', e => this.handleEvent(e));\n    el.addEventListener('contextmenu', e => this.handleEvent(e));\n\n    const touchEventHandler = this.handleTouchEvent.bind(this);\n    el.addEventListener('touchstart', touchEventHandler);\n    el.addEventListener('touchend', touchEventHandler);\n    el.addEventListener('touchcancel', touchEventHandler);\n    el.addEventListener('touchmove', touchEventHandler);\n  }\n\n  private handleTouchEvent(e: TouchEvent): void {\n    e.stopPropagation();\n    e.preventDefault();\n\n    if (e.touches.length > 0) {\n      const touch = e.touches[0];\n      this.updatePosition(touch.clientX, touch.clientY);\n      this.buttons[0].setDown(true);\n    } else {\n      this.buttons[0].setDown(false);\n    }\n  }\n\n  private handleEvent(e: MouseEvent): void {\n    e.stopPropagation();\n    e.preventDefault();\n\n    this.updatePosition(e.clientX, e.clientY);\n\n    if (e.type === 'mousedown') {\n      this.buttons[e.button].setDown(true);\n      this.el.focus();\n    }\n\n    if (e.type === 'mouseup') {\n      this.buttons[e.button].setDown(false);\n    }\n  }\n\n  private updatePosition(clientX: number, clientY: number): void {\n    let rect: Rect | DOMRect = this.el.getBoundingClientRect();\n\n    // If the client rect is not the same aspect ratio as canvas,\n    // then we are fullscreen.\n    // Need to update client rect accordingly.\n\n    const terminalAspectRatio = this.width / this.height;\n    const rectAspectRatio = rect.width / rect.height;\n\n    if (rectAspectRatio - terminalAspectRatio > 0.01) {\n      const actualWidth = terminalAspectRatio * rect.height;\n      const excess = rect.width - actualWidth;\n      rect = new Rect(Math.floor(excess / 2), 0, actualWidth, rect.height);\n    }\n\n    if (rectAspectRatio - terminalAspectRatio < -0.01) {\n      const actualHeight = rect.width / terminalAspectRatio;\n      const excess = rect.height - actualHeight;\n      rect = new Rect(0, Math.floor(excess / 2), rect.width, actualHeight);\n    }\n\n    this.x = (this.width * (clientX - rect.left) / rect.width) | 0;\n    this.y = (this.height * (clientY - rect.top) / rect.height) | 0;\n  }\n\n  update(time: number): void {\n    this.dx = this.x - this.prevX;\n    this.dy = this.y - this.prevY;\n    this.prevX = this.x;\n    this.prevY = this.y;\n\n    for (let i = 0; i < this.buttons.length; i++) {\n      this.buttons[i].update(time);\n    }\n  }\n}","\nimport { Console } from './console';\nimport { Cell } from './cell';\nimport { DEFAULT_FONT, Font } from './font';\nimport { Keyboard, Keys } from './keys';\nimport { Mouse } from './mouse';\nimport { FRAGMENT_SHADER_SOURCE, VERTEX_SHADER_SOURCE } from './shaders';\nimport { Point } from './point';\n\n/**\n * Linearly interpolates a number in the range 0-max to -1.0-1.0.\n *\n * @param i The value between 0 and max.\n * @param max The maximum value.\n * @returns The interpolated value between -1.0 and 1.0.\n */\nfunction interpolate(i: number, max: number) {\n  return -1.0 + 2.0 * (i / max);\n}\n\ninterface TerminalOptions {\n  font?: Font,\n}\n\nconst DEFAULT_OPTIONS = {\n  font: DEFAULT_FONT,\n};\n\nexport class Terminal extends Console {\n  readonly canvas: HTMLCanvasElement;\n  readonly font: Font;\n  readonly pixelWidth: number;\n  readonly pixelHeight: number;\n  readonly keys: Keyboard;\n  readonly mouse: Mouse;\n  readonly gl: WebGLRenderingContext;\n  readonly program: WebGLProgram;\n  readonly positionAttribLocation: number;\n  readonly textureAttribLocation: number;\n  readonly fgColorAttribLocation: number;\n  readonly bgColorAttribLocation: number;\n  readonly positionsArray: Float32Array;\n  readonly indexArray: Uint16Array;\n  readonly textureArray: Float32Array;\n  readonly foregroundUint8Array: Uint8Array;\n  readonly foregroundDataView: DataView;\n  readonly backgroundUint8Array: Uint8Array;\n  readonly backgroundDataView: DataView;\n  readonly positionBuffer: WebGLBuffer;\n  readonly indexBuffer: WebGLBuffer;\n  readonly textureBuffer: WebGLBuffer;\n  readonly foregroundBuffer: WebGLBuffer;\n  readonly backgroundBuffer: WebGLBuffer;\n  readonly texture: WebGLTexture;\n  private lastRenderTime: number;\n  private renderDelta: number;\n  fps: number;\n  averageFps: number;\n  update?: () => void;\n\n  constructor(canvas: HTMLCanvasElement, width: number, height: number, options?: TerminalOptions) {\n    super(width, height);\n\n    options = options || DEFAULT_OPTIONS;\n\n    this.canvas = canvas;\n    this.font = options.font || DEFAULT_FONT;\n    this.pixelWidth = width * this.font.charWidth;\n    this.pixelHeight = height * this.font.charHeight;\n\n    canvas.width = this.pixelWidth;\n    canvas.height = this.pixelHeight;\n    canvas.style.imageRendering = 'pixelated';\n    canvas.style.outline = 'none';\n    canvas.tabIndex = 0;\n    this.handleResize();\n    window.addEventListener('resize', () => this.handleResize());\n\n    this.keys = new Keyboard(canvas);\n    this.mouse = new Mouse(this);\n\n    // Get the WebGL context from the canvas\n    const gl = canvas.getContext('webgl', { antialias: false });\n    if (!gl) {\n      throw new Error(\n        'Unable to initialize WebGL. Your browser may not support it.');\n    }\n\n    const program = gl.createProgram();\n    if (!program) {\n      throw new Error(\n        'Unable to initialize WebGL. Your browser may not support it.');\n    }\n\n    this.gl = gl;\n    this.program = program;\n\n    gl.attachShader(program, this.buildShader(gl.VERTEX_SHADER, VERTEX_SHADER_SOURCE));\n    gl.attachShader(program, this.buildShader(gl.FRAGMENT_SHADER, FRAGMENT_SHADER_SOURCE));\n    gl.linkProgram(program);\n    gl.useProgram(program);\n\n    if (this.font.graphical) {\n      // Set the flag to ignore foreground/background colors, and use texture\n      // directly\n      gl.uniform1i(gl.getUniformLocation(program, 'h'), 1);\n    }\n\n    this.positionAttribLocation = this.getAttribLocation('a');\n    this.textureAttribLocation = this.getAttribLocation('b');\n    this.fgColorAttribLocation = this.getAttribLocation('c');\n    this.bgColorAttribLocation = this.getAttribLocation('d');\n\n    const cellCount = width * height;\n    this.positionsArray = new Float32Array(cellCount * 3 * 4);\n    this.indexArray = new Uint16Array(cellCount * 6);\n    this.textureArray = new Float32Array(cellCount * 2 * 4);\n    this.foregroundUint8Array = new Uint8Array(cellCount * 4 * 4);\n    this.foregroundDataView = new DataView(this.foregroundUint8Array.buffer);\n    this.backgroundUint8Array = new Uint8Array(cellCount * 4 * 4);\n    this.backgroundDataView = new DataView(this.backgroundUint8Array.buffer);\n\n    // Init the positions buffer\n    let i = 0;\n    let j = 0;\n    let k = 0;\n    for (let y = 0; y < height; y++) {\n      for (let x = 0; x < width; x++) {\n        // Top-left\n        this.positionsArray[i++] = interpolate(x, width);\n        this.positionsArray[i++] = -interpolate(y, height);\n\n        // Top-right\n        this.positionsArray[i++] = interpolate(x + 1, width);\n        this.positionsArray[i++] = -interpolate(y, height);\n\n        // Bottom-right\n        this.positionsArray[i++] = interpolate(x + 1, width);\n        this.positionsArray[i++] = -interpolate(y + 1, height);\n\n        // Bottom-left\n        this.positionsArray[i++] = interpolate(x, width);\n        this.positionsArray[i++] = -interpolate(y + 1, height);\n\n        this.indexArray[j++] = k + 0;\n        this.indexArray[j++] = k + 1;\n        this.indexArray[j++] = k + 2;\n        this.indexArray[j++] = k + 0;\n        this.indexArray[j++] = k + 2;\n        this.indexArray[j++] = k + 3;\n\n        k += 4;\n      }\n    }\n\n    this.positionBuffer = gl.createBuffer() as WebGLBuffer;\n    this.indexBuffer = gl.createBuffer() as WebGLBuffer;\n    this.textureBuffer = gl.createBuffer() as WebGLBuffer;\n    this.foregroundBuffer = gl.createBuffer() as WebGLBuffer;\n    this.backgroundBuffer = gl.createBuffer() as WebGLBuffer;\n\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);\n    gl.bufferData(gl.ARRAY_BUFFER, this.positionsArray, gl.STATIC_DRAW);\n\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indexBuffer);\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this.indexArray, gl.STATIC_DRAW);\n\n    this.texture = this.loadTexture(this.font.url);\n\n    this.lastRenderTime = 0;\n    this.renderDelta = 0;\n    this.fps = 0;\n    this.averageFps = 0;\n\n    this.requestAnimationFrame();\n  }\n\n  private handleResize() {\n    const parent = this.canvas.parentElement;\n    if (!parent) {\n      return;\n    }\n    const widthFactor = parent.offsetWidth / this.pixelWidth;\n    const heightFactor = parent.offsetHeight / this.pixelHeight;\n    const factor = Math.min(widthFactor, heightFactor);\n    const width = (factor * this.pixelWidth) | 0;\n    const height = (factor * this.pixelHeight) | 0;\n    this.canvas.style.width = width + 'px';\n    this.canvas.style.height = height + 'px';\n  }\n\n  private getAttribLocation(name: string) {\n    const location = this.gl.getAttribLocation(this.program, name);\n    this.gl.enableVertexAttribArray(location);\n    return location;\n  }\n\n  private flush() {\n    let textureArrayIndex = 0;\n    let colorArrayIndex = 0;\n\n    for (let y = 0; y < this.height; y++) {\n      for (let x = 0; x < this.width; x++) {\n        const cell = this.getCell(x, y) as Cell;\n\n        if (!cell.dirty) {\n          textureArrayIndex += 8;\n          colorArrayIndex += 16;\n          continue;\n        }\n\n        const textureX = (cell.charCode % 16);\n        const textureY = ((cell.charCode / 16) | 0);\n\n        this.textureArray[textureArrayIndex++] = textureX;\n        this.textureArray[textureArrayIndex++] = textureY;\n\n        this.textureArray[textureArrayIndex++] = textureX + 1;\n        this.textureArray[textureArrayIndex++] = textureY;\n\n        this.textureArray[textureArrayIndex++] = textureX + 1;\n        this.textureArray[textureArrayIndex++] = textureY + 1;\n\n        this.textureArray[textureArrayIndex++] = textureX;\n        this.textureArray[textureArrayIndex++] = textureY + 1;\n\n        for (let i = 0; i < 4; i++) {\n          this.foregroundDataView.setUint32(colorArrayIndex, cell.fg, false);\n          this.backgroundDataView.setUint32(colorArrayIndex, cell.bg, false);\n          colorArrayIndex += 4;\n        }\n\n        cell.dirty = false;\n      }\n    }\n  }\n\n  isKeyDown(keyCode: number): boolean {\n    const key = this.keys.getKey(keyCode);\n    return !!key && key.down;\n  }\n\n  isKeyPressed(keyCode: number): boolean {\n    const key = this.keys.getKey(keyCode);\n    return !!key && key.isPressed();\n  }\n\n  getKeyDownCount(keyCode: number): number {\n    const key = this.keys.getKey(keyCode);\n    return key ? key.downCount : 0;\n  }\n\n  /**\n   * Returns a standard roguelike movement key if pressed.\n   * Implemented control systems:\n   * 1) Numpad arrows\n   * 2) VIM keys\n   * 3) Normal arrows (4 directions only)\n   * 4) Numpad 5 and '.' (period) for \"wait\"\n   * If a key is pressed, returns the movement delta.\n   * If no key is pressed, returns undefined.\n   * See: http://www.roguebasin.com/index.php?title=Preferred_Key_Controls\n   */\n  getMovementKey(): Point | undefined {\n    if (this.isKeyPressed(Keys.VK_NUMPAD1) || this.isKeyPressed(Keys.VK_B)) {\n      return new Point(-1, 1);\n    }\n    if (this.isKeyPressed(Keys.VK_NUMPAD2) || this.isKeyPressed(Keys.VK_J) || this.isKeyPressed(Keys.VK_DOWN)) {\n      return new Point(0, 1);\n    }\n    if (this.isKeyPressed(Keys.VK_NUMPAD3) || this.isKeyPressed(Keys.VK_N)) {\n      return new Point(1, 1);\n    }\n    if (this.isKeyPressed(Keys.VK_NUMPAD4) || this.isKeyPressed(Keys.VK_H) || this.isKeyPressed(Keys.VK_LEFT)) {\n      return new Point(-1, 0);\n    }\n    if (this.isKeyPressed(Keys.VK_NUMPAD5) || this.isKeyPressed(Keys.VK_PERIOD)) {\n      return new Point(0, 0);\n    }\n    if (this.isKeyPressed(Keys.VK_NUMPAD6) || this.isKeyPressed(Keys.VK_L) || this.isKeyPressed(Keys.VK_RIGHT)) {\n      return new Point(1, 0);\n    }\n    if (this.isKeyPressed(Keys.VK_NUMPAD7) || this.isKeyPressed(Keys.VK_Y)) {\n      return new Point(-1, -1);\n    }\n    if (this.isKeyPressed(Keys.VK_NUMPAD8) || this.isKeyPressed(Keys.VK_K) || this.isKeyPressed(Keys.VK_DOWN)) {\n      return new Point(0, -1);\n    }\n    if (this.isKeyPressed(Keys.VK_NUMPAD9) || this.isKeyPressed(Keys.VK_U)) {\n      return new Point(1, -1);\n    }\n    return undefined;\n  }\n\n  private buildShader(type: number, source: string) {\n    const gl = this.gl;\n    const sh = gl.createShader(type);\n    if (!sh) {\n      throw new Error('An error occurred compiling the shader: ');\n    }\n    gl.shaderSource(sh, source);\n    gl.compileShader(sh);\n    if (!gl.getShaderParameter(sh, gl.COMPILE_STATUS)) {\n      throw new Error(\n        'An error occurred compiling the shader: ' + gl.getShaderInfoLog(sh));\n    }\n    return sh;\n  }\n\n  /**\n   * Initialize a texture and load an image.\n   * When the image finished loading copy it into the texture.\n   * @param url\n   */\n  private loadTexture(url: string) {\n    const gl = this.gl;\n    const texture = gl.createTexture() as WebGLTexture;\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n\n    // Because images have to be download over the internet\n    // they might take a moment until they are ready.\n    // Until then put a single pixel in the texture so we can\n    // use it immediately. When the image has finished downloading\n    // we'll update the texture with the contents of the image.\n    const level = 0;\n    const internalFormat = gl.RGBA;\n    const width = 1;\n    const height = 1;\n    const border = 0;\n    const srcFormat = gl.RGBA;\n    const srcType = gl.UNSIGNED_BYTE;\n    const pixel = new Uint8Array([0, 0, 0, 255]);  // opaque black\n    gl.texImage2D(\n      gl.TEXTURE_2D, level, internalFormat, width, height, border, srcFormat,\n      srcType, pixel);\n\n    const image = new Image();\n    image.onload = () => {\n      gl.bindTexture(gl.TEXTURE_2D, texture);\n      gl.texImage2D(\n        gl.TEXTURE_2D, level, internalFormat, srcFormat, srcType, image);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n    };\n    image.src = url;\n\n    return texture;\n  }\n\n  //\n  // Draw the scene.\n  //\n  private render() {\n    const gl = this.gl;\n    gl.clearColor(0.0, 0.0, 0.0, 1.0);\n    gl.clearDepth(1.0);\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n    gl.viewport(0, 0, this.pixelWidth, this.pixelHeight);\n\n    // Tell WebGL how to pull out the positions from the position\n    // buffer into the vertexPosition attribute\n    {\n      const numComponents = 2;\n      const type = gl.FLOAT;\n      const normalize = false;\n      const stride = 0;\n      const offset = 0;\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);\n      gl.vertexAttribPointer(\n        this.positionAttribLocation, numComponents, type, normalize, stride,\n        offset);\n    }\n\n    // Tell WebGL how to pull out the texture coordinates from\n    // the texture coordinate buffer into the textureCoord attribute.\n    {\n      const numComponents = 2;\n      const type = gl.FLOAT;\n      const normalize = false;\n      const stride = 0;\n      const offset = 0;\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.textureBuffer);\n      gl.bufferData(gl.ARRAY_BUFFER, this.textureArray, gl.DYNAMIC_DRAW);\n      gl.vertexAttribPointer(\n        this.textureAttribLocation, numComponents, type, normalize, stride,\n        offset);\n    }\n\n    // Foreground color\n    {\n      const numComponents = 4;\n      const type = gl.UNSIGNED_BYTE;\n      const normalize = true;\n      const stride = 0;\n      const offset = 0;\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.foregroundBuffer);\n      gl.bufferData(\n        gl.ARRAY_BUFFER, this.foregroundUint8Array, gl.DYNAMIC_DRAW);\n      gl.vertexAttribPointer(\n        this.fgColorAttribLocation, numComponents, type, normalize, stride,\n        offset);\n    }\n\n    // Background color\n    {\n      const numComponents = 4;\n      const type = gl.UNSIGNED_BYTE;\n      const normalize = true;\n      const stride = 0;\n      const offset = 0;\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.backgroundBuffer);\n      gl.bufferData(\n        gl.ARRAY_BUFFER, this.backgroundUint8Array, gl.DYNAMIC_DRAW);\n      gl.vertexAttribPointer(\n        this.bgColorAttribLocation, numComponents, type, normalize, stride,\n        offset);\n    }\n\n    // Tell WebGL which indices to use to index the vertices\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indexBuffer);\n\n    // Tell WebGL to use our program when drawing\n    gl.useProgram(this.program);\n\n    // Tell WebGL we want to affect texture unit 0\n    gl.activeTexture(gl.TEXTURE0);\n\n    // Bind the texture to texture unit 0\n    gl.bindTexture(gl.TEXTURE_2D, this.texture);\n\n    // Tell the shader we bound the texture to texture unit 0\n    {\n      const vertexCount = this.width * this.height * 6;\n      const type = gl.UNSIGNED_SHORT;\n      const offset = 0;\n      gl.drawElements(gl.TRIANGLES, vertexCount, type, offset);\n    }\n  }\n\n  private requestAnimationFrame() {\n    window.requestAnimationFrame(t => this.renderLoop(t));\n  }\n\n  private renderLoop(time: number) {\n    if (this.lastRenderTime === 0) {\n      this.lastRenderTime = time;\n      this.fps = 0;\n    } else {\n      this.renderDelta = time - this.lastRenderTime;\n      this.lastRenderTime = time;\n      this.fps = 1000.0 / this.renderDelta;\n      this.averageFps = 0.95 * this.averageFps + 0.05 * this.fps;\n    }\n\n    this.keys.updateKeys(time);\n    this.mouse.update(time);\n    if (this.update) {\n      this.update();\n    }\n    this.flush();\n    this.render();\n    this.requestAnimationFrame();\n  }\n}\n","\n/**\n * Vertex shader program.\n *\n * a = attribute vec2 aVertexPosition;\n * b = attribute vec2 aTextureCoord;\n * c = attribute vec3 aFgColor;\n * d = attribute vec3 aBgColor;\n * e = varying vec2 vTextureCoord;\n * f = varying vec4 vFgColor;\n * g = varying vec4 vBgColor;\n */\nexport const VERTEX_SHADER_SOURCE = 'attribute vec2 a;' +\n    'attribute vec2 b;' +\n    'attribute vec3 c;' +\n    'attribute vec3 d;' +\n    'varying highp vec2 e;' +\n    'varying highp vec4 f;' +\n    'varying highp vec4 g;' +\n    'void main(void){' +\n    'gl_Position=vec4(a.x,a.y,0,1);' +\n    'e=b/16.0;' +\n    'f=vec4(c.r,c.g,c.b,1);' +\n    'g=vec4(d.r,d.g,d.b,1);' +\n    '}';\n\n/**\n * Fragment shader program.\n *\n * e = varying vec2 vTextureCoord;\n * f = varying vec4 vFgColor;\n * g = varying vec4 vBgColor;\n * h = uniform bool uGraphicalTiles;\n * s = uniform sampler2D uSampler;\n */\nexport const FRAGMENT_SHADER_SOURCE = 'varying highp vec2 e;' +\n    'varying highp vec4 f;' +\n    'varying highp vec4 g;' +\n    'uniform bool h;' +\n    'uniform sampler2D s;' +\n    'void main(void){' +\n    'gl_FragColor=texture2D(s,e);' +\n    'if(h){' +\n    // Using graphical tiles\n    'if(gl_FragColor.a<0.1){' +\n    // The current pixel of the foreground sprite is transparent.\n    // Draw the background tile instead.\n    // Use the background red channel for the tile X coordinate.\n    // Use the background green channel for the tile Y coordinate.\n    // Use the fractional component of the texture coord for the pixel offset.\n    'gl_FragColor=texture2D(s,g.rg*16.0+fract(e*16.0)/16.0);' +\n    '}' +\n    '}else{' +\n    // Using ASCII characters\n    'if(gl_FragColor.r<0.1) {' +\n    // Black background, so use bgColor\n    'gl_FragColor=g;' +\n    '} else {' +\n    // White background, so use fgColor\n    'gl_FragColor=f;' +\n    '}' +\n    '}' +\n    '}';\n","import { Rect } from '../rect';\nimport { Point } from '../point';\nimport { Console } from '../console';\nimport { Terminal } from '../terminal';\n\nexport abstract class Dialog {\n  readonly contentsRect: Rect;\n  readonly title: string;\n\n  constructor(contentsRect: Rect, title: string) {\n    this.contentsRect = contentsRect;\n    this.title = title;\n  }\n\n  abstract drawContents(console: Console, offset: Point): void;\n\n  abstract handleInput(terminal: Terminal, offset: Point): boolean;\n}\n","\nimport { Keys } from '../keys';\nimport { Rect } from '../rect';\nimport { Dialog } from './dialog';\nimport { Console } from '../console';\nimport { Terminal } from '../terminal';\nimport { Point } from '../point';\n\nexport class MessageDialog extends Dialog {\n  readonly lines: string[];\n\n  constructor(title: string, message: string) {\n    const lines = message.split('\\n');\n    let width = title.length;\n    for (let i = 0; i < lines.length; i++) {\n      width = Math.max(width, lines[i].length);\n    }\n\n    const height = lines.length;\n    const rect = new Rect(0, 0, width, height);\n    super(rect, title);\n    this.lines = lines;\n  }\n\n  drawContents(console: Console, offset: Point): void {\n    for (let i = 0; i < this.lines.length; i++) {\n      console.drawString(offset.x, offset.y + i, this.lines[i]);\n    }\n  }\n\n  handleInput(terminal: Terminal, offset: Point): boolean {\n    return terminal.isKeyPressed(Keys.VK_ESCAPE);\n  }\n}\n","\nimport { Colors } from '../colors';\nimport { Console } from '../console';\nimport { Keys } from '../keys';\nimport { Point } from '../point';\nimport { Rect } from '../rect';\nimport { Terminal } from '../terminal';\nimport { Dialog } from './dialog';\n\nexport class SelectDialog extends Dialog {\n  readonly options: string[];\n  readonly callback: (i: number) => void;\n  private hoverIndex: number;\n\n  constructor(\n    title: string, options: string[], callback: (i: number) => void) {\n    let width = title.length;\n    for (let i = 0; i < options.length; i++) {\n      width = Math.max(width, options[i].length + 4);\n    }\n\n    const height = options.length;\n    const rect = new Rect(0, 0, width, height);\n    super(rect, title);\n    this.options = options;\n    this.callback = callback;\n    this.hoverIndex = -1;\n  }\n\n  drawContents(console: Console, offset: Point): void {\n    for (let i = 0; i < this.options.length; i++) {\n      const str = String.fromCharCode(65 + i) + ' - ' + this.options[i];\n      if (i === this.hoverIndex) {\n        console.drawString(offset.x, offset.y + i, str, Colors.BLACK, Colors.WHITE);\n      } else {\n        console.drawString(offset.x, offset.y + i, str, Colors.WHITE, Colors.BLACK);\n      }\n    }\n  }\n\n  handleInput(terminal: Terminal, offset: Point): boolean {\n    this.hoverIndex = -1;\n    if (terminal.mouse.x >= offset.x &&\n      terminal.mouse.x < offset.x + this.contentsRect.width &&\n      terminal.mouse.y >= offset.y &&\n      terminal.mouse.y < offset.y + this.contentsRect.height) {\n      this.hoverIndex = terminal.mouse.y - offset.y;\n      if (terminal.mouse.buttons[0].upCount === 1) {\n        this.callback(this.hoverIndex);\n        return true;\n      }\n    }\n    for (let i = 0; i < this.options.length; i++) {\n      if (terminal.isKeyPressed(Keys.VK_A + i)) {\n        this.callback(i);\n        return true;\n      }\n    }\n    return terminal.isKeyPressed(Keys.VK_ESCAPE);\n  }\n\n  private isMouseOverOption(terminal: Terminal, offset: Point, index: number): boolean {\n    return terminal.mouse.x >= offset.x &&\n      terminal.mouse.x < offset.x + this.contentsRect.width &&\n      terminal.mouse.y === offset.y + index;\n  }\n}\n","import { Console } from './console';\nimport { Cell } from './cell';\nimport { Point } from './point';\n\nconst dxs = [-1, 0, 1, -1, 1, -1, 0, 1];\nconst dys = [-1, -1, -1, 0, 0, 1, 1, 1];\nconst costs = [1.4, 1, 1.4, 1, 1, 1.4, 1, 1.4];\nlet pathId = 0;\n\n/**\n * Calculates Dijkstra's algorithm.\n *\n * @param {!Object} source Starting point, must have x and y properties.\n * @param {!Object=} opt_dest Optional destination point, must have x and y properties.\n * @param {!number=} opt_maxDist Optional maximum distance to examine.\n * @return {?Array} Array of steps if destination found; null otherwise.\n */\nexport function computePath(map: Console, source: Point, dest: Point, maxDist: number): Cell[] | undefined {\n  pathId++;\n\n  const sourceCell = map.grid[source.y][source.x];\n  sourceCell.pathId = pathId;\n  sourceCell.g = 0.0;\n  sourceCell.h = Math.hypot(source.x - dest.x, source.y - dest.y);\n  sourceCell.prev = null;\n\n  const q = new SortedSet([sourceCell]);\n\n  while (q.size() > 0) {\n    const u = q.pop() as Cell;\n\n    if (u.x === dest.x && u.y === dest.y) {\n      return buildPath(u);\n    }\n\n    for (let i = 0; i < dxs.length; i++) {\n      const x = u.x + dxs[i];\n      const y = u.y + dys[i];\n      if (x >= 0 && x < map.width && y >= 0 && y < map.height) {\n        const v = map.grid[y][x];\n        if (v.blocked && v.explored && (x !== dest.x || y !== dest.y)) {\n          continue;\n        }\n        if (v.pathId !== pathId) {\n          v.pathId = pathId;\n          v.g = Infinity;\n          v.h = Math.hypot(x - dest.x, y - dest.y);\n          v.prev = null;\n        }\n        const alt = u.g + costs[i];\n        if (alt < v.g && alt <= maxDist) {\n          v.g = alt;\n          v.prev = u;\n          q.insert(v);\n        }\n      }\n    }\n  }\n  return undefined;\n}\n\nfunction buildPath(cell: Cell): Cell[] {\n  const result = [];\n  let curr: Cell | null = cell;\n  while (curr) {\n    result.push(curr);\n    curr = curr.prev;\n  }\n  result.reverse();\n  return result;\n}\n\nclass SortedSet {\n  private readonly values: Cell[];\n\n  constructor(initialValues: Cell[]) {\n    this.values = initialValues\n  }\n\n  insert(cell: Cell): void {\n    const array = this.values;\n    let low = 0;\n    let high = array.length;\n    let index = 0;\n\n    while (low < high) {\n      const mid = (low + high) >>> 1;\n      const midCell = array[mid];\n      if (midCell.g + midCell.h > cell.g + cell.h) {\n        low = mid + 1;\n        index = low;\n      } else {\n        high = mid;\n        index = high;\n      }\n    }\n    array.splice(index, 0, cell);\n  }\n\n  pop(): Cell | undefined {\n    return this.values.pop();\n  }\n\n  size(): number {\n    return this.values.length;\n  }\n}","\n/**\n * Random number generator.\n *\n * LCG\n * https://stackoverflow.com/a/424445/2051724\n */\nexport class RNG {\n  private m: number;\n  private a: number;\n  private c: number;\n  private state: number;\n\n  /**\n   * Creates a new random number generator.\n   *\n   * @param seed The integer seed.\n   */\n  constructor(seed?: number) {\n    // LCG using GCC's constants\n    this.m = 0x80000000;  // 2**31;\n    this.a = 1103515245;\n    this.c = 12345;\n    this.state = seed || 1;\n  }\n\n  nextInt(): number {\n    this.state = (this.a * this.state + this.c) % this.m;\n    return this.state;\n  }\n\n  /**\n   * Returns a floating point number between 0.0 and 1.0.\n   */\n  nextFloat(): number {\n    // returns in range [0,1]\n    return this.nextInt() / (this.m - 1);\n  }\n\n  /**\n   * Returns an integer in the range start (inclusive) to end (exclusive).\n   * @param start Lower bound, inclusive.\n   * @param end Upper bound, exclusive.\n   */\n  nextRange(start: number, end: number): number {\n    // returns in range [start, end): including start, excluding end\n    // can't modulu nextInt because of weak randomness in lower bits\n    const rangeSize = end - start;\n    const randomUnder1 = this.nextInt() / this.m;\n    const result = start + ((randomUnder1 * rangeSize) | 0);\n    if (isNaN(result)) {\n      throw new Error('rand nan');\n    }\n    return result;\n  }\n\n  chooseIndex(chances: any[]) {\n    const total = chances.reduce((a, b) => a + b);\n    const roll = this.nextRange(1, total + 1);\n    let runningTotal = 0;\n\n    for (let i = 0; i < chances.length; i++) {\n      runningTotal += chances[i];\n      if (roll <= runningTotal) {\n        return i;\n      }\n    }\n\n    return chances.length - 1;\n  }\n\n  chooseKey(chancesMap: any) {\n    const values = [];\n    const chances = [];\n\n    for (const property in chancesMap) {\n      if (chancesMap.hasOwnProperty(property)) {\n        values.push(property);\n        chances.push(chancesMap[property]);\n      }\n    }\n\n    return values[this.chooseIndex(chances)];\n  }\n}\n","import { Color } from '../../src/color';\nimport { Game } from './game';\n\nexport class Entity {\n  game: Game;\n  x: number;\n  y: number;\n  char: string;\n  name: string;\n  color: Color;\n  blocks: boolean;\n\n  constructor(game: Game, x: number, y: number, char: string, name: string, color: Color, blocks?: boolean) {\n    this.game = game;\n    this.x = x;\n    this.y = y;\n    this.char = char;\n    this.name = name;\n    this.color = color;\n    this.blocks = !!blocks;\n  }\n\n  distanceTo(other: Entity): number {\n    return Math.hypot(other.x - this.x, other.y - this.y);\n  }\n\n  distance(x: number, y: number): number {\n    return Math.hypot(x - this.x, y - this.y);\n  }\n\n  sendToBack(): void {\n    this.remove();\n    this.game.entities.unshift(this);\n  }\n\n  remove(): void {\n    this.game.entities.splice(this.game.entities.indexOf(this), 1);\n  }\n\n  draw(): void {\n    if (this.game.map.isVisible(this.x, this.y)) {\n      this.game.app.term.drawString(this.x, this.y, this.char, this.color);\n    }\n  }\n}\n","import { Color } from '../../src/color';\nimport { Colors } from '../../src/colors';\nimport { AI } from './ai';\nimport { Entity } from './entity';\nimport { Game } from './game';\nimport { Item } from './item';\n\nexport class Actor extends Entity {\n  level: number;\n  inventory: Item[];\n  hp: number;\n  xp: number;\n  baseMaxHp: number;\n  baseDefense: number;\n  basePower: number;\n  ai?: AI;\n\n  constructor(game: Game, x: number, y: number, char: string, name: string, color: Color) {\n    super(game, x, y, char, name, color, true);\n    this.level = 1;\n    this.inventory = [];\n    this.hp = 0;\n    this.xp = 0;\n    this.baseMaxHp = 0;\n    this.baseDefense = 0;\n    this.basePower = 0;\n  }\n\n  move(dx: number, dy: number): void {\n    if (this.game.isBlocked(this.x + dx, this.y + dy)) {\n      return;\n    }\n    this.x += dx;\n    this.y += dy;\n  }\n\n  moveToward(targetX: number, targetY: number): void {\n    const dx = targetX - this.x;\n    const dy = targetY - this.y;\n    const distance = Math.hypot(dx, dy);\n    this.move(Math.round(dx / distance), Math.round(dy / distance));\n  }\n\n  getEquippedInSlot(slot: string): Item | undefined {\n    return this.inventory.find(item => item.slot === slot && item.equipped);\n  }\n\n  getAllEquipped(): Item[] {\n    return this.inventory.filter(item => item.equipped);\n  }\n\n  equip(item: Item): void {\n    const old = this.getEquippedInSlot(item.slot);\n    if (old) {\n      this.dequip(old);\n    }\n\n    item.equipped = true;\n    this.game.addMessage('Equipped ' + item.name + ' on ' + item.slot + '.', Colors.LIGHT_GREEN);\n  }\n\n  dequip(item: Item): void {\n    if (!item.equipped) {\n      return;\n    }\n    item.equipped = false;\n    this.game.addMessage('Dequipped ' + item.name + ' on ' + item.slot + '.', Colors.YELLOW);\n  }\n\n  get maxHp(): number {\n    return this.baseMaxHp + this.getAllEquipped().reduce((acc, item) => acc + item.maxHpBonus, 0);\n  }\n\n  get defense(): number {\n    return this.baseDefense + this.getAllEquipped().reduce((acc, item) => acc + item.defenseBonus, 0);\n  }\n\n  get power(): number {\n    return this.basePower + this.getAllEquipped().reduce((acc, item) => acc + item.powerBonus, 0);\n  }\n\n  attack(target: Actor): void {\n    const damage = this.power - target.defense;\n\n    if (damage > 0) {\n      this.game.addMessage(this.name + ' attacks ' + target.name + ' for ' + damage + ' hit points.');\n      target.takeDamage(damage);\n      if (target.hp === 0) {\n        this.takeXp(target.xp);\n      }\n    } else {\n      this.game.addMessage(this.name + ' attacks ' + target.name + ' but it has no effect!');\n    }\n  }\n\n  takeXp(xp: number): void {\n    this.xp += xp;\n    this.game.checkLevelUp();\n  }\n\n  takeDamage(damage: number): void {\n    this.hp -= damage;\n    if (this.hp <= 0) {\n      this.hp = 0;\n      this.death();\n    }\n  }\n\n  heal(amount: number): void {\n    this.hp = Math.min(this.hp + amount, this.maxHp);\n  }\n\n  death(): void {\n    if (this === this.game.player) {\n      this.game.addMessage('You died!', Colors.DARK_RED);\n    } else {\n      this.game.addMessage(this.name + ' is dead!', Colors.ORANGE);\n    }\n    this.char = '%';\n    this.color = Colors.DARK_RED;\n    this.blocks = false;\n    this.ai = undefined;\n    this.name = 'Remains of ' + this.name;\n    this.sendToBack();\n  }\n\n  pickUp(item: Item): void {\n    if (this.inventory.length >= 26) {\n      this.game.addMessage('Your inventory is full, cannot pick up ' + item.name + '.', Colors.LIGHT_RED);\n    } else {\n      this.inventory.push(item);\n      item.remove();\n      this.game.addMessage('You picked up a ' + item.name + '!', Colors.LIGHT_GREEN);\n    }\n  }\n\n  useItem(item: Item): void {\n    if (item.useFunction) {\n      item.useFunction(item);\n    } else {\n      this.game.addMessage('The ' + item.name + ' cannot be used.');\n    }\n  }\n\n  removeItem(item: Item): void {\n    this.inventory.splice(this.inventory.indexOf(item), 1);\n  }\n\n  setAi(ai: AI): void {\n    this.ai = ai;\n    ai.owner = this;\n  }\n}\n","import { Colors } from '../../src/colors';\r\nimport { Entity } from './entity';\r\n\r\nconst CONFUSE_NUM_TURNS = 10;\r\n\r\nexport interface AI {\r\n  owner?: Entity;\r\n  takeTurn(): void;\r\n}\r\n\r\nexport class BasicMonster implements AI {\r\n  owner?: Entity;\r\n\r\n  constructor() {\r\n    this.owner = undefined;\r\n  }\r\n\r\n  takeTurn(): void {\r\n    const monster = this.owner;\r\n    if (!monster) {\r\n      return;\r\n    }\r\n\r\n    const game = monster.game;\r\n    const player = game.player;\r\n\r\n    // A basic monster takes its turn. if you can see it, it can see you\r\n    if (game.map.isVisible(monster.x, monster.y)) {\r\n\r\n      if (monster.distanceTo(player) >= 2) {\r\n        // Move towards player if far away\r\n        monster.moveToward(player.x, player.y);\r\n\r\n      } else if (player.hp > 0) {\r\n        // Close enough, attack! (if the player is still alive.)\r\n        monster.attack(player);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport class ConfusedMonster implements AI {\r\n  owner?: Entity;\r\n  oldAi: AI;\r\n  numTurns: number;\r\n\r\n  constructor(oldAi: AI) {\r\n    this.owner = undefined;\r\n    this.oldAi = oldAi;\r\n    this.numTurns = CONFUSE_NUM_TURNS;\r\n  }\r\n\r\n  takeTurn(): void {\r\n    if (!this.owner) {\r\n      return;\r\n    }\r\n    const game = this.owner.game;\r\n    if (this.numTurns > 0) {\r\n      // Still confused...\r\n      // Move in a random direction, and decrease the number of turns confused\r\n      const rng = game.rng;\r\n      this.owner.move(rng.nextRange(-1, 1), rng.nextRange(-1, 1));\r\n      this.numTurns--;\r\n    } else {\r\n      this.owner.ai = this.oldAi;\r\n      game.addMessage('The ' + this.owner.name + ' is no longer confused!', Colors.LIGHT_RED);\r\n    }\r\n  }\r\n}\r\n","import { Color } from '../../src/color';\nimport { Entity } from './entity';\nimport { Game } from './game';\n\nexport class Item extends Entity {\n  powerBonus: number;\n  defenseBonus: number;\n  maxHpBonus: number;\n  slot: string;\n  equipped: boolean;\n  useFunction?: (item: Item) => void;\n\n  constructor(game: Game, x: number, y: number, char: string, name: string, color: Color) {\n    super(game, x, y, char, name, color, false);\n    this.powerBonus = 0;\n    this.defenseBonus = 0;\n    this.maxHpBonus = 0;\n    this.slot = '';\n    this.equipped = false;\n  }\n}\n","import { Cell } from '../../src/cell';\nimport { Color, fromRgb } from '../../src/color';\nimport { Colors } from '../../src/colors';\nimport { Console } from '../../src/console';\nimport { MessageDialog } from '../../src/gui/messagedialog';\nimport { SelectDialog } from '../../src/gui/selectdialog';\nimport { Keys } from '../../src/keys';\nimport { computePath } from '../../src/path';\nimport { Rect } from '../../src/rect';\nimport { RNG } from '../../src/rng';\nimport { Actor } from './actor';\nimport { AI, BasicMonster, ConfusedMonster } from './ai';\nimport { App, AppState } from './app';\nimport { Entity } from './entity';\nimport { Item } from './item';\n\n// Actual size of the window\nconst SCREEN_WIDTH = 80;\nconst SCREEN_HEIGHT = 45;\n\n// Size of the map\nconst MAP_WIDTH = 80;\nconst MAP_HEIGHT = 39;\n\n// Sizes and coordinates relevant for the GUI\nconst BAR_WIDTH = 20;\nconst PANEL_HEIGHT = 7;\nconst PANEL_Y = SCREEN_HEIGHT - PANEL_HEIGHT;\nconst MSG_X = BAR_WIDTH + 2;\nconst MSG_HEIGHT = PANEL_HEIGHT - 1;\n\n// Parameters for dungeon generator\nconst ROOM_MAX_SIZE = 10;\nconst ROOM_MIN_SIZE = 6;\nconst MAX_ROOMS = 30;\nconst TORCH_RADIUS = 10;\n\n// Spell values\nconst HEAL_AMOUNT = 4;\nconst LIGHTNING_DAMAGE = 20;\nconst LIGHTNING_RANGE = 5;\nconst CONFUSE_RANGE = 8;\nconst FIREBALL_RANGE = 10;\nconst FIREBALL_RADIUS = 3;\nconst FIREBALL_DAMAGE = 12;\n\n// Experience and level-ups\nconst LEVEL_UP_BASE = 200;\nconst LEVEL_UP_FACTOR = 150;\n\nconst COLOR_DARK_WALL = fromRgb(0, 0, 100);\nconst COLOR_LIGHT_WALL = fromRgb(130, 110, 50);\nconst COLOR_DARK_GROUND = fromRgb(50, 50, 150);\nconst COLOR_LIGHT_GROUND = fromRgb(200, 180, 50);\n\nexport class Game implements AppState {\n  readonly app: App;\n  readonly rng: RNG;\n  readonly player: Actor;\n  readonly messages: { text: string, color: Color }[];\n  stairs?: Entity;\n  entities: Entity[];\n  level: number;\n  map: Console;\n  fovRecompute: boolean;\n  targetCursor: { x: number, y: number };\n  targetFunction: ((x: number, y: number) => void) | undefined;\n  path?: Cell[];\n  pathIndex: number;\n  pathWalking: boolean;\n\n  constructor(app: App) {\n    this.app = app;\n    this.rng = new RNG(Date.now());\n    this.player = new Actor(this, 40, 25, '@', 'Player', Colors.WHITE);\n    this.player.level = 1;\n    this.player.hp = 100;\n    this.player.baseMaxHp = 100;\n    this.player.baseDefense = 1;\n    this.player.basePower = 4;\n    this.entities = [this.player];\n    this.messages = [];\n    this.level = 1;\n    this.map = this.createMap();\n    this.fovRecompute = true;\n    this.targetCursor = { x: 0, y: 0 };\n    this.pathIndex = 0;\n    this.pathWalking = false;\n    this.addMessage('Welcome stranger! Prepare to perish!', Colors.DARK_RED);\n\n    // Initial equipment: a dagger\n    const dagger = new Item(this, 0, 0, '-', 'Dagger', Colors.LIGHT_CYAN);\n    dagger.slot = 'right hand';\n    dagger.powerBonus = 2;\n    this.player.inventory.push(dagger);\n    this.player.equip(dagger);\n  }\n\n  isBlocked(x: number, y: number): boolean {\n    // First test the map tile\n    if (this.map.grid[y][x].blocked) {\n      return true;\n    }\n\n    // Now check for any blocking objects\n    for (let i = 0; i < this.entities.length; i++) {\n      const entity = this.entities[i];\n      if (entity.blocks && entity.x === x && entity.y === y) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  createRoom(map: Console, room: Rect): void {\n    for (let y = room.y + 1; y < room.y2; y++) {\n      for (let x = room.x + 1; x < room.x2; x++) {\n        map.grid[y][x].blocked = false;\n        map.grid[y][x].blockedSight = false;\n      }\n    }\n  }\n\n  createHTunnel(map: Console, x1: number, x2: number, y: number): void {\n    for (let x = Math.min(x1, x2); x <= Math.max(x1, x2); x++) {\n      map.grid[y][x].blocked = false;\n      map.grid[y][x].blockedSight = false;\n    }\n  }\n\n  createVTunnel(map: Console, y1: number, y2: number, x: number): void {\n    for (let y = Math.min(y1, y2); y <= Math.max(y1, y2); y++) {\n      map.grid[y][x].blocked = false;\n      map.grid[y][x].blockedSight = false;\n    }\n  }\n\n  createMap(): Console {\n    const map = new Console(MAP_WIDTH, MAP_HEIGHT);\n    for (let y = 0; y < MAP_HEIGHT; y++) {\n      for (let x = 0; x < MAP_WIDTH; x++) {\n        map.grid[y][x].blocked = true;\n        map.grid[y][x].blockedSight = true;\n      }\n    }\n\n    const rooms = [];\n\n    for (let r = 0; r < MAX_ROOMS; r++) {\n      // Random width and height\n      const w = this.rng.nextRange(ROOM_MIN_SIZE, ROOM_MAX_SIZE);\n      const h = this.rng.nextRange(ROOM_MIN_SIZE, ROOM_MAX_SIZE);\n\n      // Random position without going out of the boundaries of the map\n      const x = this.rng.nextRange(0, MAP_WIDTH - w - 1);\n      const y = this.rng.nextRange(0, MAP_HEIGHT - h - 1);\n\n      // \"Rect\" class makes rectangles easier to work with\n      const newRoom = new Rect(x, y, w, h);\n\n      // Run through the other rooms and see if they intersect with this one\n      let failed = false;\n      for (let j = 0; j < rooms.length; j++) {\n        if (newRoom.intersects(rooms[j])) {\n          failed = true;\n          break;\n        }\n      }\n\n      if (!failed) {\n        // This means there are no intersections, so this room is valid\n\n        // \"paint\" it to the map's tiles\n        this.createRoom(map, newRoom);\n\n        // Center coordinates of new room, will be useful later\n        const center = newRoom.getCenter();\n\n        if (rooms.length === 0) {\n          // This is the first room, where the player starts at\n          this.player.x = center.x;\n          this.player.y = center.y;\n        } else {\n          // All rooms after the first:\n          // Connect it to the previous room with a tunnel\n\n          // Center coordinates of previous room\n          const prev = rooms[rooms.length - 1].getCenter();\n\n          // Draw a coin (random number that is either 0 or 1)\n          if (this.rng.nextRange(0, 1) === 1) {\n            // First move horizontally, then vertically\n            this.createHTunnel(map, prev.x, center.x, prev.y);\n            this.createVTunnel(map, prev.y, center.y, center.x);\n          } else {\n            // First move vertically, then horizontally\n            this.createVTunnel(map, prev.y, center.y, prev.x);\n            this.createHTunnel(map, prev.x, center.x, center.y);\n          }\n        }\n\n        if (r > 0) {\n          // Add some contents to this room, such as monsters\n          this.placeObjects(newRoom);\n        }\n\n        // Finally, append the new room to the list\n        rooms.push(newRoom);\n      }\n    }\n\n    // Create stairs at the center of the last room\n    const stairsLoc = rooms[rooms.length - 1].getCenter();\n    this.stairs = new Entity(this, stairsLoc.x, stairsLoc.y, '<', 'Stairs', Colors.WHITE);\n    this.entities.push(this.stairs);\n    this.stairs.sendToBack();\n    return map;\n  }\n\n  fromDungeonLevel(table: number[][]): number {\n    // Returns a value that depends on level.\n    // The table specifies what value occurs after each level, default is 0.\n    for (let i = 0; i < table.length; i++) {\n      const value = table[i][0];\n      const level = table[i][1];\n      if (this.level >= level) {\n        return value;\n      }\n    }\n    return 0;\n  }\n\n  placeObjects(room: Rect): void {\n    // This is where we decide the chance of each monster or item appearing.\n\n    // Maximum number of monsters per room\n    const maxMonsters = this.fromDungeonLevel([[1, 1], [2, 2], [3, 4], [5, 6]]);\n\n    // Chance of each monster\n    const monsterChances = {\n      'orc': 80, // orc always shows up, even if all other monsters have 0 chance\n      'troll': this.fromDungeonLevel([[15, 3], [30, 5], [60, 7]])\n    };\n\n    // Maximum number of items per room\n    const maxItems = this.fromDungeonLevel([[1, 1], [2, 4]])\n\n    // Chance of each item (by default they have a chance of 0 at level 1, which then goes up)\n    const itemChances = {\n      'heal': 35,  // healing potion always shows up, even if all other items have 0 chance\n      'lightning': this.fromDungeonLevel([[25, 4]]),\n      'fireball': this.fromDungeonLevel([[25, 6]]),\n      'confuse': this.fromDungeonLevel([[10, 2]]),\n      'sword': this.fromDungeonLevel([[5, 4]]),\n      'shield': this.fromDungeonLevel([[15, 8]])\n    };\n\n    // Choose random number of monsters\n    const numMonsters = this.rng.nextRange(0, maxMonsters + 1);\n\n    for (let i = 0; i < numMonsters; i++) {\n      // Choose random spot for this monster\n      const x = this.rng.nextRange(room.x + 1, room.x2 - 1);\n      const y = this.rng.nextRange(room.y + 1, room.y2 - 1);\n      let monster = null;\n\n      const choice = this.rng.chooseKey(monsterChances);\n      if (choice === 'orc') {\n        monster = new Actor(this, x, y, 'o', 'Orc', Colors.LIGHT_GREEN);\n        monster.hp = 20;\n        monster.baseDefense = 0;\n        monster.basePower = 4;\n        monster.xp = 35;\n        monster.setAi(new BasicMonster());\n\n      } else if (choice === 'troll') {\n        monster = new Actor(this, x, y, 'T', 'Troll', Colors.DARK_GREEN);\n        monster.hp = 30;\n        monster.baseDefense = 2;\n        monster.basePower = 8;\n        monster.xp = 100;\n        monster.setAi(new BasicMonster());\n      }\n\n      if (monster) {\n        this.entities.push(monster);\n      }\n    }\n\n    // Choose random number of items\n    const numItems = this.rng.nextRange(0, maxItems + 1);\n\n    for (let i = 0; i < numItems; i++) {\n      // Choose random spot for this item\n      const x = this.rng.nextRange(room.x + 1, room.x2 - 1)\n      const y = this.rng.nextRange(room.y + 1, room.y2 - 1)\n      let item = null;\n\n      const choice = this.rng.chooseKey(itemChances);\n      if (choice === 'heal') {\n        // Create a healing potion\n        item = new Item(this, x, y, '!', 'Healing Potion', Colors.DARK_MAGENTA);\n        item.useFunction = (item) => this.castHeal(item);\n\n      } else if (choice === 'lightning') {\n        // Create a lightning bolt scroll\n        item = new Item(this, x, y, '#', 'Scroll of Lightning Bolt', Colors.YELLOW);\n        item.useFunction = (item) => this.castLightning(item);\n\n      } else if (choice === 'fireball') {\n        // Create a fireball scroll\n        item = new Item(this, x, y, '#', 'Scroll of Fireball', Colors.YELLOW);\n        item.useFunction = (item) => this.castFireball(item);\n\n      } else if (choice === 'confuse') {\n        // Create a confuse scroll\n        item = new Item(this, x, y, '#', 'Scroll of Confusion', Colors.YELLOW);\n        item.useFunction = (item) => this.castConfuse(item);\n\n      } else if (choice === 'sword') {\n        // Create a sword\n        item = new Item(this, x, y, '/', 'Sword', Colors.LIGHT_CYAN);\n        item.useFunction = (item) => this.player.equip(item);\n\n      } else if (choice === 'shield') {\n        // Create a shield\n        item = new Item(this, x, y, '[', 'Shield', Colors.BROWN);\n        item.useFunction = (item) => this.player.equip(item);\n      }\n\n      if (item) {\n        this.entities.push(item);\n        item.sendToBack();  // items appear below other objects\n      }\n    }\n  }\n\n  renderBar(x: number, y: number, totalWidth: number, name: string, value: number, maximum: number, barColor: Color, backColor: Color): void {\n    // Render a bar (HP, experience, etc). first calculate the width of the bar\n    const barWidth = Math.round(value / maximum * totalWidth);\n\n    // Render the background first\n    this.app.term.fillRect(x, y, totalWidth, 1, 0, 0, backColor);\n\n    // Now render the bar on top\n    if (barWidth > 0) {\n      this.app.term.fillRect(x, y, barWidth, 1, 0, 0, barColor);\n    }\n\n    // Finally, some centered text with the values\n    this.app.term.drawCenteredString(x + totalWidth / 2, y, name + ': ' + value + '/' + maximum, Colors.WHITE);\n  }\n\n  getNamesUnderMouse(): string {\n    const x = this.app.term.mouse.x;\n    const y = this.app.term.mouse.y;\n\n    if (!this.map.isVisible(x, y)) {\n      return '';\n    }\n\n    const names = [];\n\n    for (let i = 0; i < this.entities.length; i++) {\n      const entity = this.entities[i];\n      if (entity.x === x && entity.y === y) {\n        names.push(entity.name);\n      }\n    }\n\n    return names.join(', ');\n  }\n\n  addMessage(msg: string, opt_color?: Color): void {\n    while (this.messages.length >= MSG_HEIGHT) {\n      this.messages.shift();\n    }\n    this.messages.push({ text: msg, color: (opt_color || Colors.WHITE) });\n  }\n\n  playerMoveOrAttack(dx: number, dy: number): void {\n    const x = this.player.x + dx;\n    const y = this.player.y + dy;\n\n    let target: Actor | null = null;\n    for (let i = 0; i < this.entities.length; i++) {\n      const entity = this.entities[i];\n      if (entity instanceof Actor && entity != this.player && entity.x === x && entity.y === y) {\n        target = entity;\n        break;\n      }\n    }\n\n    if (target && target.blocks) {\n      this.player.attack(target);\n    } else {\n      this.player.move(dx, dy);\n      this.fovRecompute = true;\n    }\n\n    for (let i = 0; i < this.entities.length; i++) {\n      const entity = this.entities[i];\n      if (entity instanceof Actor && entity.ai) {\n        entity.ai.takeTurn();\n      }\n    }\n  }\n\n  handleKeys(): void {\n    if (this.player.hp <= 0) {\n      return;\n    }\n\n    if (this.app.gui.handleInput()) {\n      return;\n    }\n\n    const term = this.app.term;\n    const movementKey = term.getMovementKey();\n\n    if (this.targetFunction) {\n      if (term.isKeyPressed(Keys.VK_ENTER) || term.mouse.buttons[0].isClicked()) {\n        this.endTargeting(this.targetCursor.x, this.targetCursor.y);\n      }\n      if (term.isKeyPressed(Keys.VK_ESCAPE) || term.mouse.buttons[2].isClicked()) {\n        this.cancelTargeting();\n      }\n      if (movementKey) {\n        this.targetCursor.x += movementKey.x;\n        this.targetCursor.y += movementKey.y;\n      }\n      if (term.mouse.dx !== 0 || term.mouse.dy !== 0) {\n        this.targetCursor.x = term.mouse.x;\n        this.targetCursor.y = term.mouse.y;\n      }\n      return;\n    }\n    if (movementKey) {\n      this.playerMoveOrAttack(movementKey.x, movementKey.y);\n    }\n    if (term.isKeyPressed(Keys.VK_G)) {\n      // Pick up an item\n      for (let i = 0; i < this.entities.length; i++) {\n        const entity = this.entities[i];\n        if (entity instanceof Item && entity.x === this.player.x && entity.y === this.player.y) {\n          this.player.pickUp(entity);\n        }\n      }\n    }\n    if (term.isKeyPressed(Keys.VK_I)) {\n      if (this.player.inventory.length === 0) {\n        this.app.gui.add(new MessageDialog('ALERT', 'Inventory is empty'));\n      } else {\n        const options = this.player.inventory.map(item => {\n          if (item.equipped) {\n            return item.name + ' (on ' + item.slot + ')';\n          } else {\n            return item.name;\n          }\n        });\n        this.app.gui.add(new SelectDialog('INVENTORY', options, (choice) => this.useInventory(choice)));\n      }\n    }\n    if (term.isKeyPressed(Keys.VK_C)) {\n      const levelUpXp = LEVEL_UP_BASE + this.player.level * LEVEL_UP_FACTOR;\n      this.app.gui.add(new MessageDialog('CHARACTER',\n        'Level: ' + this.player.level +\n        '\\nExperience: ' + this.player.xp +\n        '\\nExperience to level up: ' + levelUpXp +\n        '\\n\\nMaximum HP: ' + this.player.maxHp +\n        '\\nAttack: ' + this.player.power +\n        '\\nDefense: ' + this.player.defense));\n    }\n    if (term.isKeyPressed(Keys.VK_COMMA)) {\n      if (this.player.x === this.stairs?.x && this.player.y === this.stairs?.y) {\n        this.nextLevel();\n      }\n    }\n\n    // If the mouse is hovering over the play area,\n    // then draw the path from the player to the cursor\n    if (!this.pathWalking) {\n      if (term.mouse.x >= 0 &&\n        term.mouse.x < MAP_WIDTH &&\n        term.mouse.y >= 0 &&\n        term.mouse.y < MAP_HEIGHT) {\n        this.path = computePath(this.map, this.player, term.mouse, 100);\n      } else {\n        this.path = undefined;\n      }\n    }\n    if (!this.pathWalking && this.path && term.mouse.buttons[0].upCount === 1) {\n      this.pathWalking = true;\n      this.pathIndex = 0;\n    }\n    if (this.pathWalking && this.path && this.pathIndex >= 0) {\n      // Advance to the player's current position\n      while (this.pathIndex < this.path.length &&\n        this.player.x === this.path[this.pathIndex].x &&\n        this.player.y === this.path[this.pathIndex].y) {\n        this.pathIndex++;\n      }\n      // If there are still remaining steps...\n      if (this.pathIndex < this.path.length) {\n        // Try to move to the next step\n        const next = this.path[this.pathIndex];\n        this.playerMoveOrAttack(next.x - this.player.x, next.y - this.player.y);\n        if (this.player.x !== next.x || this.player.y !== next.y) {\n          // If it fails, then cancel autowalking\n          this.pathWalking = false;\n          this.pathIndex = -1;\n          this.path = undefined;\n        }\n      } else {\n        // Otherwise player reached the end of the path\n        this.pathWalking = false;\n        this.pathIndex = -1;\n        this.path = undefined;\n      }\n    }\n  }\n\n  useInventory(choice: number): void {\n    if (choice >= 0) {\n      this.player.useItem(this.player.inventory[choice]);\n    }\n  }\n\n  checkLevelUp(): void {\n    // See if the player's experience is enough to level-up\n    const levelUpXp = LEVEL_UP_BASE + this.player.level * LEVEL_UP_FACTOR;\n    if (this.player.xp >= levelUpXp) {\n      this.player.level++;\n      this.player.xp -= levelUpXp;\n      this.addMessage('Your battle skills grow stronger! You reached level ' + this.player.level + '!', Colors.YELLOW);\n\n      const options = [\n        'Constitution (+20 HP, from ' + this.player.maxHp + ')',\n        'Strength (+1 attack, from ' + this.player.power + ')',\n        'Agility (+1 defense, from ' + this.player.defense + ')'\n      ];\n\n      this.app.gui.add(new SelectDialog('LEVEL UP', options, (choice) => {\n        if (choice === 0) {\n          this.player.baseMaxHp += 20;\n          this.player.hp += 20;\n        } else if (choice === 1) {\n          this.player.basePower += 1;\n        } else if (choice === 2) {\n          this.player.baseDefense += 1;\n        }\n      }));\n    }\n  }\n\n  getClosestMonster(x: number, y: number, range: number): Actor | null {\n    let minDist = range + 1;\n    let result = null;\n    for (let i = 0; i < this.entities.length; i++) {\n      const entity = this.entities[i];\n      if (entity instanceof Actor && entity !== this.player) {\n        const dist = entity.distance(x, y);\n        if (dist < minDist) {\n          minDist = dist;\n          result = entity;\n        }\n      }\n    }\n    return result;\n  }\n\n  getMonsterAt(x: number, y: number): Actor | null {\n    return this.getClosestMonster(x, y, 0);\n  }\n\n  castHeal(item: Item): void {\n    // Heal the player\n    if (this.player.hp === this.player.maxHp) {\n      this.addMessage('You are already at full health.', Colors.DARK_RED);\n      return;\n    }\n\n    this.addMessage('Your wounds start to feel better!', Colors.LIGHT_MAGENTA);\n    this.player.heal(HEAL_AMOUNT);\n    this.player.removeItem(item);\n  }\n\n  castLightning(item: Item): void {\n    // Find closest enemy (inside a maximum range) and damage it\n    const monster = this.getClosestMonster(this.player.x, this.player.y, LIGHTNING_RANGE);\n    if (!monster) {\n      this.addMessage('No enemy is close enough to strike.', Colors.LIGHT_RED);\n      return;\n    }\n\n    // Zap it!\n    this.addMessage('A lightning bolt strikes the ' + monster.name + ' with a loud thunder!', Colors.LIGHT_BLUE);\n    this.addMessage('The damage is ' + LIGHTNING_DAMAGE + ' hit points', Colors.LIGHT_BLUE);\n    monster.takeDamage(LIGHTNING_DAMAGE);\n    this.player.removeItem(item);\n  }\n\n  castFireball(item: Item): void {\n    // Ask the player for a target tile to throw a fireball at\n    this.addMessage('Left-click to cast fireball, or right-click to cancel.', Colors.LIGHT_CYAN);\n    this.startTargeting((x, y) => {\n      if (this.player.distance(x, y) > FIREBALL_RANGE) {\n        this.addMessage('Target out of range.', Colors.LIGHT_GRAY);\n        return;\n      }\n\n      this.addMessage('The fireball explodes, burning everything within ' + FIREBALL_RADIUS + ' tiles!', Colors.ORANGE);\n\n      for (let i = 0; i < this.entities.length; i++) {\n        const entity = this.entities[i];\n        if (entity instanceof Actor && entity.hp > 0 && entity.distance(x, y) <= FIREBALL_RADIUS) {\n          this.addMessage('The ' + entity.name + ' gets burned for ' + FIREBALL_DAMAGE + ' hit points.', Colors.ORANGE);\n          entity.takeDamage(FIREBALL_DAMAGE);\n        }\n      }\n\n      this.player.removeItem(item);\n    });\n  }\n\n  castConfuse(item: Item): void {\n    // Ask the player for a target to confuse\n    this.addMessage('Left-click to cast confuse, or right-click to cancel.', Colors.LIGHT_CYAN);\n    this.startTargeting((x, y) => {\n      if (this.player.distance(x, y) > CONFUSE_RANGE) {\n        this.addMessage('Target out of range.', Colors.LIGHT_GRAY);\n        return;\n      }\n\n      const monster = this.getMonsterAt(x, y);\n      if (!monster) {\n        this.addMessage('No monster there.', Colors.LIGHT_GRAY);\n        return;\n      }\n\n      monster.setAi(new ConfusedMonster(monster.ai as AI));\n      this.addMessage('The eyes of the ' + monster.name + ' look vacant, as he stumbles around!', Colors.LIGHT_GREEN);\n      this.player.removeItem(item);\n    });\n  }\n\n  startTargeting(callback: (x: number, y: number) => void): void {\n    this.targetFunction = callback;\n    this.targetCursor.x = this.player.x;\n    this.targetCursor.y = this.player.y;\n  }\n\n  endTargeting(x: number, y: number): void {\n    if (this.targetFunction) {\n      this.targetFunction(x, y);\n      this.cancelTargeting();\n    }\n  }\n\n  cancelTargeting(): void {\n    this.targetFunction = undefined;\n  }\n\n  renderAll(): void {\n    const term = this.app.term;\n\n    if (this.fovRecompute) {\n      this.map.computeFov(this.player.x, this.player.y, TORCH_RADIUS);\n      this.fovRecompute = false;\n    }\n\n    for (let y = 0; y < MAP_HEIGHT; y++) {\n      for (let x = 0; x < MAP_WIDTH; x++) {\n        const visible = this.map.isVisible(x, y);\n        const wall = this.map.grid[y][x].blockedSight;\n        let color = Colors.BLACK;\n\n        if (visible) {\n          // It's visible\n          color = wall ? COLOR_LIGHT_WALL : COLOR_LIGHT_GROUND;\n          this.map.grid[y][x].explored = true;\n        } else if (this.map.grid[y][x].explored) {\n          // It's remembered\n          color = wall ? COLOR_DARK_WALL : COLOR_DARK_GROUND;\n        }\n\n        term.drawChar(x, y, 0, 0, color);\n      }\n    }\n\n    // If the mouse is hovering over the play area,\n    // then draw the path from the player to the cursor\n    if (!this.pathWalking && this.path) {\n      for (let i = 1; i < this.path.length; i++) {\n        term.drawChar(this.path[i].x, this.path[i].y, 0, 0, Colors.WHITE);\n      }\n    }\n\n    // Draw entities\n    for (let i = 0; i < this.entities.length; i++) {\n      this.entities[i].draw();\n    }\n\n    // Prepare to render the GUI panel\n    term.fillRect(0, PANEL_Y, SCREEN_WIDTH, PANEL_HEIGHT, 0, Colors.WHITE, Colors.BLACK);\n\n    // Print the game this.messages, one line at a time\n    let y = PANEL_Y + 1;\n    for (let i = 0; i < this.messages.length; i++) {\n      const message = this.messages[i];\n      term.drawString(MSG_X, y, message.text, message.color);\n      y++;\n    }\n\n    // Show the player's stats\n    this.renderBar(\n      1, PANEL_Y + 1, BAR_WIDTH,\n      'HP', this.player.hp, this.player.maxHp,\n      Colors.LIGHT_RED, Colors.DARK_RED);\n\n    this.renderBar(\n      1, PANEL_Y + 2, BAR_WIDTH,\n      'XP', this.player.xp, LEVEL_UP_BASE + this.player.level * LEVEL_UP_FACTOR,\n      Colors.LIGHT_MAGENTA, Colors.DARK_MAGENTA);\n\n    term.drawString(1, PANEL_Y + 4, 'Dungeon level ' + this.level, Colors.ORANGE);\n\n    // Display names of objects under the mouse\n    term.drawString(1, PANEL_Y, this.getNamesUnderMouse(), Colors.LIGHT_GRAY);\n\n    if (this.targetFunction) {\n      const targetCell = term.getCell(this.targetCursor.x, this.targetCursor.y);\n      if (targetCell) {\n        targetCell.setBackground(Colors.WHITE);\n      }\n    }\n\n    // Draw dialog boxes\n    this.app.gui.draw();\n  }\n\n  nextLevel(): void {\n    // Advance to the next level\n    this.addMessage('You take a moment to rest, and recover your strength.', Colors.LIGHT_MAGENTA);\n    this.player.heal(this.player.maxHp / 2); // heal the player by 50%\n    this.level++;\n    this.addMessage('After a rare moment of peace, you descend deeper...', Colors.LIGHT_RED);\n    this.entities = [this.player];\n    this.map = this.createMap(); // Create a fresh new level!\n    this.fovRecompute = true;\n  }\n\n  update(): void {\n    this.handleKeys();\n    this.renderAll();\n  }\n}\n","import { Cell } from './cell';\nimport { Chars } from './chars';\nimport { fromRgb } from './color';\nimport { Console } from './console';\n\n/**\n * All available 2x2 patterns for 2x image loading.\n * Note: The strict IBM CGA font only has halves, not quadrants.\n */\nconst PATTERNS = [\n  { charCode: Chars.BLOCK_TOP_HALF, active: [1, 1, 0, 0] },\n  { charCode: Chars.BLOCK_RIGHT_HALF, active: [0, 1, 0, 1] },\n];\n\nexport function loadImage(url: string, callback: (img: Console) => void): void {\n  const img = new Image();\n  img.onload = () => {\n    const w = img.width;\n    const h = img.height;\n    const data = getImageData(img);\n    const result = new Console(w, h);\n    let i = 0;\n\n    for (let y = 0; y < h; y++) {\n      for (let x = 0; x < w; x++) {\n        const cell = result.getCell(x, y) as Cell;\n        cell.setBackground(fromRgb(data[i++], data[i++], data[i++], data[i++]));\n      }\n    }\n\n    callback(result);\n  };\n  img.src = url;\n}\n\nexport function loadImage2x(url: string, callback: (img: Console) => void): void {\n  const img = new Image();\n  img.onload = () => {\n    const w = img.width;\n    const h = img.height;\n    const data = getImageData(img);\n    const result = new Console(w / 2, h / 2);\n\n    for (let y = 0; y < h; y += 2) {\n      for (let x = 0; x < w; x += 2) {\n        draw2x2(result, data, x, y, w);\n      }\n    }\n\n    callback(result);\n  };\n  img.src = url;\n}\n\nfunction getImageData(img: HTMLImageElement) {\n  const canvas = document.createElement('canvas');\n  canvas.width = img.width;\n  canvas.height = img.height;\n\n  const ctx = canvas.getContext('2d') as CanvasRenderingContext2D;\n  ctx.drawImage(img, 0, 0);\n\n  return ctx.getImageData(0, 0, img.width, img.height).data;\n}\n\nfunction draw2x2(\n  con: Console, data: Uint8ClampedArray, x: number, y: number, w: number) {\n  // Top left\n  const i1 = 4 * (y * w + x);\n  const r1 = data[i1];\n  const g1 = data[i1 + 1];\n  const b1 = data[i1 + 2];\n\n  // Top right\n  const i2 = 4 * (y * w + x + 1);\n  const r2 = data[i2];\n  const g2 = data[i2 + 1];\n  const b2 = data[i2 + 2];\n\n  // Bottom left\n  const i3 = 4 * ((y + 1) * w + x);\n  const r3 = data[i3];\n  const g3 = data[i3 + 1];\n  const b3 = data[i3 + 2];\n\n  // Bottom right\n  const i4 = 4 * ((y + 1) * w + x + 1);\n  const r4 = data[i4];\n  const g4 = data[i4 + 1];\n  const b4 = data[i4 + 2];\n\n  const colors = [[r1, g1, b1], [r2, g2, b2], [r3, g3, b3], [r4, g4, b4]];\n\n  // For each possible pattern, calculate the total error\n  // Find the pattern with minum error\n\n  let minError = Number.MAX_VALUE;\n  let bestCharCode = 0;\n  let bestBg = null;\n  let bestFg = null;\n\n  for (let i = 0; i < PATTERNS.length; i++) {\n    const pattern = PATTERNS[i];\n    const patternColors = computeColors(pattern.active, colors);\n    if (patternColors.error < minError) {\n      minError = patternColors.error;\n      bestCharCode = pattern.charCode;\n      bestBg = patternColors.bg;\n      bestFg = patternColors.fg;\n    }\n  }\n\n  con.drawChar(x / 2, y / 2, bestCharCode, arrayToColor(bestFg as number[]), arrayToColor(bestBg as number[]));\n}\n\nfunction computeColors(pattern: number[], colors: number[][]) {\n  const sum = [[0, 0, 0], [0, 0, 0]];\n  const avg = [[0, 0, 0], [0, 0, 0]];\n  const count = [0, 0];\n\n  for (let i = 0; i < 4; i++) {\n    for (let j = 0; j < 3; j++) {\n      sum[pattern[i]][j] += colors[i][j];\n    }\n    count[pattern[i]]++;\n  }\n\n  for (let i = 0; i < 2; i++) {\n    for (let j = 0; j < 3; j++) {\n      avg[i][j] = sum[i][j] / count[i];\n    }\n  }\n\n  let error = 0.0;\n\n  for (let i = 0; i < 4; i++) {\n    let cellError = 0.0;\n    for (let j = 0; j < 3; j++) {\n      const delta = colors[i][j] - avg[pattern[i]][j];\n      cellError += delta * delta;\n    }\n    error += Math.sqrt(cellError);\n  }\n\n  return { bg: avg[0], fg: avg[1], error };\n}\n\nfunction arrayToColor(rgb: number[]) {\n  return fromRgb(rgb[0], rgb[1], rgb[2]);\n}\n","import { Colors } from '../../src/colors';\nimport { Console } from '../../src/console';\nimport { SelectDialog } from '../../src/gui/selectdialog';\nimport { loadImage2x } from '../../src/image';\nimport { App, AppState } from './app';\n\nlet menuBg: Console | null = null;\n\nloadImage2x('menu.png', (result) => { menuBg = result });\n\nexport class MainMenu implements AppState {\n  private readonly app: App;\n\n  constructor(app: App) {\n    this.app = app;\n  }\n\n  update(): void {\n    const term = this.app.term;\n    const gui = this.app.gui;\n\n    if (gui.dialogs.length === 0) {\n      const options = ['Play a new game', 'Continue last game'];\n      gui.add(new SelectDialog('MAIN MENU', options, (choice) => {\n        if (choice === 0) {\n          this.app.newGame();\n        } else if (choice === 1) {\n          this.app.continueGame();\n        }\n        switch (choice) {\n          case 0:\n            this.app.newGame();\n            break;\n          case 1:\n            this.app.continueGame();\n            break;\n        }\n      }));\n    }\n\n    gui.handleInput();\n\n    term.clear();\n\n    if (menuBg) {\n      term.drawConsole(0, 0, menuBg, 0, 0, 80, 50);\n    }\n\n    term.drawCenteredString(40, 10, 'TOMBS OF THE ANCIENT KINGS', Colors.YELLOW);\n    term.drawCenteredString(40, 12, 'By Jotaf', Colors.YELLOW);\n    gui.draw();\n  }\n}\n","import { App } from './app';\n\nnew App();\n","import { GUI } from '../../src/gui';\r\nimport { Terminal } from '../../src/terminal';\r\nimport { Game } from './game';\r\nimport { MainMenu } from './mainmenu';\r\n\r\nconst SCREEN_WIDTH = 80;\r\nconst SCREEN_HEIGHT = 45;\r\n\r\nexport interface AppState {\r\n  update(): void;\r\n}\r\n\r\nexport class App {\r\n  readonly term: Terminal;\r\n  readonly gui: GUI;\r\n  state: AppState;\r\n  mainMenu: MainMenu;\r\n  game?: Game;\r\n\r\n  constructor() {\r\n    this.term = new Terminal(document.querySelector('canvas') as HTMLCanvasElement, SCREEN_WIDTH, SCREEN_HEIGHT);\r\n    this.gui = new GUI(this.term);\r\n    this.mainMenu = new MainMenu(this);\r\n    this.state = this.mainMenu;\r\n\r\n    this.term.update = () => this.state.update();\r\n  }\r\n\r\n  newGame(): void {\r\n    this.game = new Game(this);\r\n    this.state = this.game;\r\n  }\r\n\r\n  continueGame(): void {\r\n    if (this.game) {\r\n      this.state = this.game;\r\n    }\r\n  }\r\n}","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tif(__webpack_module_cache__[moduleId]) {\n\t\treturn __webpack_module_cache__[moduleId].exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// module exports must be returned from runtime so entry inlining is disabled\n// startup\n// Load entry module and return exports\nreturn __webpack_require__(648);\n","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};"],"sourceRoot":""}