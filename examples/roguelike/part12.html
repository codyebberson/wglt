<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>WGLT - Roguelike Tutorial - Part 12 - Monster and item progression</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body>
	<canvas></canvas>
	<p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_12">Part 12: Monster and item progression</a></p>
	<p>Deeper dungeon levels become increasingly more difficult! Here we create tools for dealing with chances and making them vary with level.</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part11.js	2018-11-23 18:01:23.898355900 -0800</div>
<div class="c2">+++ part12.js	2018-11-23 18:01:32.617437200 -0800</div>
<div class="c1">@@ -19,19 +19,17 @@</div>
<div class="c0"> const ROOM_MAX_SIZE = 10;</div>
<div class="c0"> const ROOM_MIN_SIZE = 6;</div>
<div class="c0"> const MAX_ROOMS = 30;</div>
<div class="c3">-const MAX_ROOM_MONSTERS = 3;</div>
<div class="c3">-const MAX_ROOM_ITEMS = 2;</div>
<div class="c0"> const TORCH_RADIUS = 10;</div>
<div class="c0"> </div>
<div class="c0"> // Spell values</div>
<div class="c3">-const HEAL_AMOUNT = 40;</div>
<div class="c3">-const LIGHTNING_DAMAGE = 40;</div>
<div class="c2">+const HEAL_AMOUNT = 4;</div>
<div class="c2">+const LIGHTNING_DAMAGE = 20;</div>
<div class="c0"> const LIGHTNING_RANGE = 5;</div>
<div class="c0"> const CONFUSE_RANGE = 8;</div>
<div class="c0"> const CONFUSE_NUM_TURNS = 10;</div>
<div class="c0"> const FIREBALL_RANGE = 10;</div>
<div class="c0"> const FIREBALL_RADIUS = 3;</div>
<div class="c3">-const FIREBALL_DAMAGE = 25;</div>
<div class="c2">+const FIREBALL_DAMAGE = 12;</div>
<div class="c0"> </div>
<div class="c0"> // Experience and level-ups</div>
<div class="c0"> const LEVEL_UP_BASE = 200;</div>
<div class="c1">@@ -350,9 +348,44 @@</div>
<div class="c0">     return map;</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function fromDungeonLevel(table) {</div>
<div class="c2">+    // Returns a value that depends on level.</div>
<div class="c2">+    // The table specifies what value occurs after each level, default is 0.</div>
<div class="c2">+    for (let i = 0; i &lt; table.length; i++) {</div>
<div class="c2">+        const value = table[i][0];</div>
<div class="c2">+        const level = table[i][1];</div>
<div class="c2">+        if (dungeonLevel &gt;= level) {</div>
<div class="c2">+            return value;</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+    return 0;</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function placeObjects(room) {</div>
<div class="c2">+    // This is where we decide the chance of each monster or item appearing.</div>
<div class="c2">+</div>
<div class="c2">+    // Maximum number of monsters per room</div>
<div class="c2">+    const maxMonsters = fromDungeonLevel([[2, 1], [3, 4], [5, 6]]);</div>
<div class="c2">+</div>
<div class="c2">+    // Chance of each monster</div>
<div class="c2">+    const monsterChances = {</div>
<div class="c2">+        'orc': 80, // orc always shows up, even if all other monsters have 0 chance</div>
<div class="c2">+        'troll': fromDungeonLevel([[15, 3], [30, 5], [60, 7]])</div>
<div class="c2">+    };</div>
<div class="c2">+</div>
<div class="c2">+    // Maximum number of items per room</div>
<div class="c2">+    const maxItems = fromDungeonLevel([[1, 1], [2, 4]])</div>
<div class="c2">+</div>
<div class="c2">+    // Chance of each item (by default they have a chance of 0 at level 1, which then goes up)</div>
<div class="c2">+    const itemChances = {</div>
<div class="c2">+        'heal': 35,  // healing potion always shows up, even if all other items have 0 chance</div>
<div class="c2">+        'lightning': fromDungeonLevel([[25, 4]]),</div>
<div class="c2">+        'fireball': fromDungeonLevel([[25, 6]]),</div>
<div class="c2">+        'confuse': fromDungeonLevel([[10, 2]])</div>
<div class="c2">+    };</div>
<div class="c2">+</div>
<div class="c0">     // Choose random number of monsters</div>
<div class="c3">-    const numMonsters = rng.nextRange(0, MAX_ROOM_MONSTERS);</div>
<div class="c2">+    const numMonsters = rng.nextRange(0, maxMonsters + 1);</div>
<div class="c0"> </div>
<div class="c0">     for (let i = 0; i &lt; numMonsters; i++) {</div>
<div class="c0">         // Choose random spot for this monster</div>
<div class="c1">@@ -360,16 +393,14 @@</div>
<div class="c0">         const y = rng.nextRange(room.y1 + 1, room.y2 - 1);</div>
<div class="c0">         let monster = null;</div>
<div class="c0"> </div>
<div class="c3">-        // Only place it if the tile is not blocked</div>
<div class="c3">-        // 80% chance of getting an orc</div>
<div class="c3">-        if (rng.nextRange(0, 100) &lt; 80) {</div>
<div class="c3">-            // Create an orc</div>
<div class="c3">-            const fighter = new Fighter(10, 0, 3, 35, monsterDeath);</div>
<div class="c2">+        const choice = rng.chooseKey(monsterChances);</div>
<div class="c2">+        if (choice === 'orc') {</div>
<div class="c2">+            const fighter = new Fighter(20, 0, 4, 35, monsterDeath);</div>
<div class="c0">             const ai = new BasicMonster();</div>
<div class="c0">             monster = new Entity(x, y, 'o', 'orc', wglt.Colors.LIGHT_GREEN, true, { fighter: fighter, ai: ai });</div>
<div class="c3">-        } else {</div>
<div class="c3">-            // Create a troll</div>
<div class="c3">-            const fighter = new Fighter(16, 1, 4, 100, monsterDeath);</div>
<div class="c2">+</div>
<div class="c2">+        } else if (choice === 'troll') {</div>
<div class="c2">+            const fighter = new Fighter(30, 2, 8, 100, monsterDeath);</div>
<div class="c0">             const ai = new BasicMonster();</div>
<div class="c0">             monster = new Entity(x, y, 'T', 'troll', wglt.Colors.DARK_GREEN, true, { fighter: fighter, ai: ai });</div>
<div class="c0">         }</div>
<div class="c1">@@ -378,30 +409,29 @@</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c0">     // Choose random number of items</div>
<div class="c3">-    const numItems = rng.nextRange(0, MAX_ROOM_ITEMS);</div>
<div class="c2">+    const numItems = rng.nextRange(0, maxItems + 1);</div>
<div class="c0"> </div>
<div class="c0">     for (let i = 0; i &lt; numItems; i++) {</div>
<div class="c0">         // Choose random spot for this item</div>
<div class="c0">         const x = rng.nextRange(room.x1 + 1, room.x2 - 1)</div>
<div class="c0">         const y = rng.nextRange(room.y1 + 1, room.y2 - 1)</div>
<div class="c3">-</div>
<div class="c3">-        const dice = rng.nextRange(0, 100);</div>
<div class="c0">         let item = null;</div>
<div class="c0"> </div>
<div class="c3">-        if (dice &lt; 50) {</div>
<div class="c3">-            // Create a healing potion (50% chance)</div>
<div class="c2">+        const choice = rng.chooseKey(itemChances);</div>
<div class="c2">+        if (choice === 'heal') {</div>
<div class="c2">+            // Create a healing potion</div>
<div class="c0">             item = new Entity(x, y, '!', 'healing potion', wglt.Colors.DARK_MAGENTA, false, { item: new Item(castHeal) });</div>
<div class="c0"> </div>
<div class="c3">-        } else if (dice &lt; 50 + 20) {</div>
<div class="c3">-            // Create a lightning bolt scroll (20% chance)</div>
<div class="c2">+        } else if (choice === 'lightning') {</div>
<div class="c2">+            // Create a lightning bolt scroll</div>
<div class="c0">             item = new Entity(x, y, '#', 'scroll of lightning bolt', wglt.Colors.YELLOW, false, { item: new Item(castLightning) });</div>
<div class="c0"> </div>
<div class="c3">-        } else if (dice &lt; 50 + 20 + 15) {</div>
<div class="c3">-            // Create a fireball scroll (15% chance)</div>
<div class="c2">+        } else if (choice === 'fireball') {</div>
<div class="c2">+            // Create a fireball scroll</div>
<div class="c0">             item = new Entity(x, y, '#', 'scroll of fireball', wglt.Colors.YELLOW, false, { item: new Item(castFireball) });</div>
<div class="c0"> </div>
<div class="c3">-        } else {</div>
<div class="c3">-            // Create a confuse scroll (15% chance)</div>
<div class="c2">+        } else if (choice === 'confuse') {</div>
<div class="c2">+            // Create a confuse scroll</div>
<div class="c0">             item = new Entity(x, y, '#', 'scroll of confusion', wglt.Colors.YELLOW, false, { item: new Item(castConfuse) });</div>
<div class="c0">         }</div>
<div class="c0"> </div>
<div class="c1">@@ -810,7 +840,7 @@</div>
<div class="c0"> </div>
<div class="c0"> function newGame() {</div>
<div class="c0">     rng = new wglt.RNG(Date.now());</div>
<div class="c3">-    player = new Entity(40, 25, '@', 'player', wglt.Colors.WHITE, true, { fighter: new Fighter(20, 2, 5, 0, playerDeath) });</div>
<div class="c2">+    player = new Entity(40, 25, '@', 'player', wglt.Colors.WHITE, true, { fighter: new Fighter(100, 1, 4, 0, playerDeath) });</div>
<div class="c0">     player.level = 1;</div>
<div class="c0">     entities = [player];</div>
<div class="c0">     messages = [];</div>
<!--ENDDIFF-->
    </div>
    <script src="../../dist/index.umd.js"></script>
	<script src="part12.js"></script>
</body>

</html>