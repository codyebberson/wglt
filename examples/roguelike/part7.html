<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>WGLT - Roguelike Tutorial - Part 7</title>
    <link href="../../styles.css" rel="stylesheet">
</head>

<body class="example">
    <canvas></canvas>
    <p><a href="http://www.roguebasin.com/index.php?title=Complete_Roguelike_Tutorial,_using_python%2Blibtcod,_part_7">Part 7: The GUI</a></p>
    <p>A juicy Graphical User Interface with status bars and a colored message log for maximum eye-candy. Also, the infamous "look" command, with a twist: you can use the mouse.</p>
    <div class="diff">
        <!--STARTDIFF--><div class="c3">--- part6.ts	2020-11-23 12:54:29.720619700 -0800</div>
<div class="c2">+++ part7.ts	2020-11-23 12:54:27.323316900 -0800</div>
<div class="c1">@@ -15,7 +15,15 @@</div>
<div class="c0"> </div>
<div class="c0"> // Size of the map</div>
<div class="c0"> const MAP_WIDTH = 80;</div>
<div class="c3">-const MAP_HEIGHT = 45;</div>
<div class="c2">+const MAP_HEIGHT = 43;</div>
<div class="c2">+</div>
<div class="c2">+// Sizes and coordinates relevant for the GUI</div>
<div class="c2">+const BAR_WIDTH = 20;</div>
<div class="c2">+const PANEL_HEIGHT = 7;</div>
<div class="c2">+const PANEL_Y = SCREEN_HEIGHT - PANEL_HEIGHT;</div>
<div class="c2">+const MSG_X = BAR_WIDTH + 2;</div>
<div class="c2">+const MSG_WIDTH = SCREEN_WIDTH - BAR_WIDTH - 2;</div>
<div class="c2">+const MSG_HEIGHT = PANEL_HEIGHT - 1;</div>
<div class="c0"> </div>
<div class="c0"> // Parameters for dungeon generator</div>
<div class="c0"> const ROOM_MAX_SIZE = 10;</div>
<div class="c1">@@ -119,10 +127,10 @@</div>
<div class="c0">         const damage = this.power - target.fighter.defense;</div>
<div class="c0"> </div>
<div class="c0">         if (damage &gt; 0) {</div>
<div class="c3">-            console.log(this.owner.name + &#x27; attacks &#x27; + target.name + &#x27; for &#x27; + damage + &#x27; hit points.&#x27;);</div>
<div class="c2">+            addMessage(capitalize(this.owner.name) + &#x27; attacks &#x27; + target.name + &#x27; for &#x27; + damage + &#x27; hit points.&#x27;);</div>
<div class="c0">             target.fighter.takeDamage(damage);</div>
<div class="c0">         } else {</div>
<div class="c3">-            console.log(this.owner.name + &#x27; attacks &#x27; + target.name + &#x27; but it has no effect!&#x27;);</div>
<div class="c2">+            addMessage(capitalize(this.owner.name) + &#x27; attacks &#x27; + target.name + &#x27; but it has no effect!&#x27;);</div>
<div class="c0">         }</div>
<div class="c0">     }</div>
<div class="c0"> </div>
<div class="c1">@@ -141,6 +149,10 @@</div>
<div class="c0">             }</div>
<div class="c0">         }</div>
<div class="c0">     }</div>
<div class="c2">+</div>
<div class="c2">+    heal(amount: number) {</div>
<div class="c2">+        this.hp = Math.min(this.hp + amount, this.maxHp);</div>
<div class="c2">+    }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> class BasicMonster {</div>
<div class="c1">@@ -318,6 +330,57 @@</div>
<div class="c0">     }</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c2">+function renderBar(x: number, y: number, totalWidth: number, name: string, value: number, maximum: number, barColor: Color, backColor: Color) {</div>
<div class="c2">+    // Render a bar (HP, experience, etc). first calculate the width of the bar</div>
<div class="c2">+    const barWidth = Math.round(value / maximum * totalWidth);</div>
<div class="c2">+</div>
<div class="c2">+    // Render the background first</div>
<div class="c2">+    term.fillRect(x, y, totalWidth, 1, 0, 0, backColor);</div>
<div class="c2">+</div>
<div class="c2">+    // Now render the bar on top</div>
<div class="c2">+    if (barWidth &gt; 0) {</div>
<div class="c2">+        term.fillRect(x, y, barWidth, 1, 0, 0, barColor);</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    // Finally, some centered text with the values</div>
<div class="c2">+    // term.fillForegroundRect(x, y, totalWidth, 1, Colors.WHITE);</div>
<div class="c2">+    term.drawCenteredString(x + totalWidth / 2, y, name + &#x27;: &#x27; + value + &#x27;/&#x27; + maximum, Colors.WHITE);</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function getNamesUnderMouse() {</div>
<div class="c2">+    const x = term.mouse.x;</div>
<div class="c2">+    const y = term.mouse.y;</div>
<div class="c2">+</div>
<div class="c2">+    if (!map.isVisible(x, y)) {</div>
<div class="c2">+        return &#x27;&#x27;;</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    const names = [];</div>
<div class="c2">+</div>
<div class="c2">+    for (let i = 0; i &lt; entities.length; i++) {</div>
<div class="c2">+        const entity = entities[i];</div>
<div class="c2">+        if (entity.x === x &amp;&amp; entity.y === y) {</div>
<div class="c2">+            names.push(entity.name);</div>
<div class="c2">+        }</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    return capitalize(names.join(&#x27;, &#x27;));</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function addMessage(msg: string, opt_color?: Color) {</div>
<div class="c2">+    while (messages.length &gt;= MSG_HEIGHT) {</div>
<div class="c2">+        messages.shift();</div>
<div class="c2">+    }</div>
<div class="c2">+    messages.push({ text: msg, color: (opt_color || Colors.WHITE) });</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c2">+function capitalize(str: string) {</div>
<div class="c2">+    if (!str) {</div>
<div class="c2">+        return str;</div>
<div class="c2">+    }</div>
<div class="c2">+    return str.charAt(0).toUpperCase() + str.slice(1);</div>
<div class="c2">+}</div>
<div class="c2">+</div>
<div class="c0"> function playerMoveOrAttack(dx: number, dy: number) {</div>
<div class="c0">     const x = player.x + dx;</div>
<div class="c0">     const y = player.y + dy;</div>
<div class="c1">@@ -365,11 +428,11 @@</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function playerDeath(player: Entity) {</div>
<div class="c3">-    console.log(&#x27;You died!&#x27;);</div>
<div class="c2">+    addMessage(&#x27;You died!&#x27;, Colors.LIGHT_RED);</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> function monsterDeath(monster: Entity) {</div>
<div class="c3">-    console.log(monster.name + &#x27; is dead&#x27;);</div>
<div class="c2">+    addMessage(capitalize(monster.name) + &#x27; is dead!&#x27;, Colors.BROWN);</div>
<div class="c0">     monster.char = &#x27;%&#x27;;</div>
<div class="c0">     monster.color = Colors.DARK_RED;</div>
<div class="c0">     monster.blocks = false;</div>
<div class="c1">@@ -407,15 +470,38 @@</div>
<div class="c0">     for (let i = 0; i &lt; entities.length; i++) {</div>
<div class="c0">         entities[i].draw();</div>
<div class="c0">     }</div>
<div class="c2">+</div>
<div class="c2">+    // Prepare to render the GUI panel</div>
<div class="c2">+    term.fillRect(0, PANEL_Y, SCREEN_WIDTH, PANEL_HEIGHT, 0, Colors.WHITE, Colors.BLACK);</div>
<div class="c2">+</div>
<div class="c2">+    // Print the game messages, one line at a time</div>
<div class="c2">+    let y = PANEL_Y + 1;</div>
<div class="c2">+    for (let i = 0; i &lt; messages.length; i++) {</div>
<div class="c2">+        const message = messages[i];</div>
<div class="c2">+        term.drawString(MSG_X, y, message.text, message.color);</div>
<div class="c2">+        y++;</div>
<div class="c2">+    }</div>
<div class="c2">+</div>
<div class="c2">+    // Show the player&#x27;s stats</div>
<div class="c2">+    renderBar(</div>
<div class="c2">+        1, PANEL_Y + 1, BAR_WIDTH,</div>
<div class="c2">+        &#x27;HP&#x27;, (player.fighter as Fighter).hp, (player.fighter as Fighter).maxHp,</div>
<div class="c2">+        Colors.LIGHT_RED, Colors.DARK_RED);</div>
<div class="c2">+</div>
<div class="c2">+    // Display names of objects under the mouse</div>
<div class="c2">+    term.drawString(1, PANEL_Y, getNamesUnderMouse(), Colors.LIGHT_GRAY);</div>
<div class="c0"> }</div>
<div class="c0"> </div>
<div class="c0"> const term = new Terminal(document.querySelector(&#x27;canvas&#x27;) as HTMLCanvasElement, SCREEN_WIDTH, SCREEN_HEIGHT);</div>
<div class="c0"> const rng = new RNG(1);</div>
<div class="c0"> const player = new Entity(40, 25, &#x27;@&#x27;, &#x27;player&#x27;, Colors.WHITE, true, { fighter: new Fighter(20, 2, 5, playerDeath) });</div>
<div class="c0"> const entities = [player];</div>
<div class="c2">+const messages: { text: string; color: number; }[] = [];</div>
<div class="c0"> const map = createMap();</div>
<div class="c0"> let fovRecompute = true;</div>
<div class="c0"> </div>
<div class="c2">+addMessage(&#x27;Welcome stranger! Prepare to perish!&#x27;, Colors.DARK_RED);</div>
<div class="c2">+</div>
<div class="c0"> term.update = function () {</div>
<div class="c0">     handleKeys();</div>
<div class="c0">     renderAll();</div>
<!--ENDDIFF-->
    </div>
	<script src="part7.min.js"></script>
</body>

</html>