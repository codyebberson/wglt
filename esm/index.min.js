var t;!function(t){t[t.None=0]="None",t[t.Blend=1]="Blend",t[t.Add=2]="Add"}(t||(t={}));const e=[[1,0,1,0],[1,0,1,1],[1,0,1,2],[2,0,2,1],[0,0,2,1],[0,0,1,2],[2,0,2,2],[2,0,2,0],[0,0,2,2],[2,0,0,2],[2,0,0,1],[1,0,0,2],[0,0,1,1],[1,1,0,0],[1,1,0,1],[0,1,1,1],[1,1,1,0],[0,1,0,1],[1,1,1,1],[1,2,1,0],[2,1,2,0],[2,2,0,0],[0,2,2,0],[2,2,0,2],[0,2,2,2],[2,2,2,0],[0,2,0,2],[2,2,2,2],[1,2,0,2],[2,1,0,1],[0,2,1,2],[0,1,2,1],[2,1,0,0],[1,2,0,0],[0,2,1,0],[0,1,2,0],[2,1,2,1],[1,2,1,2],[1,0,0,1],[0,1,1,0]];function i(t,e,i){const s=t.getCharCode(e,i);return void 0!==s&&s>=179&&s<=218}function s(t,i,s,r){if(i<0||s<0||i>=t.width||s>=t.height)return 0;const n=t.getCharCode(i,s);return void 0===n||n<179||n>218?0:e[n-179][r]}function r(t,i,s,r){for(let n=0;n<e.length;n++){const h=e[n];if(h[0]===t&&h[1]===i&&h[2]===s&&h[3]===r)return 179+n}return 0}function n(t){for(let e=0;e<t.height;e++)for(let n=0;n<t.width;n++)if(i(t,n,e)){let i=s(t,n,e-1,2),h=s(t,n+1,e,3),o=s(t,n,e+1,0),a=s(t,n-1,e,1);i>0&&0===h&&0===o&&0===a?o=i:0===i&&h>0&&0===o&&0===a?a=h:0===i&&0===h&&o>0&&0===a?i=o:0===i&&0===h&&0===o&&a>0&&(h=a),a>0&&h>0&&(a=h=Math.max(a,h)),i>0&&o>0&&(i=o=Math.max(i,o));const c=r(i,h,o,a);if((i||h||o||a)&&!(c>=179&&c<=218))throw new Error("invalid char code! (up="+i+", right="+h+", down="+o+", left="+a+")");t.drawChar(n,e,c)}}function h(t,e,i,s){var r,n=arguments.length,h=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)h=Reflect.decorate(t,e,i,s);else for(var o=t.length-1;o>=0;o--)(r=t[o])&&(h=(n<3?r(h):n>3?r(e,i,h):r(e,i))||h);return n>3&&h&&Object.defineProperty(e,i,h),h}function o(t,e,i,s){return void 0===s&&(s=255),(t<<24)+(e<<16)+(i<<8)+s}function a(t,e,i,s){const r=6*t|0,n=6*t-r,h=i*(1-e),a=i*(1-n*e),c=i*(1-(1-n)*e);let _,u,d;switch(r%6){case 0:_=i,u=c,d=h;break;case 1:_=a,u=i,d=h;break;case 2:_=h,u=i,d=c;break;case 3:_=h,u=a,d=i;break;case 4:_=c,u=h,d=i;break;case 5:_=i,u=h,d=a;break;default:_=0,u=0,d=0}return void 0===s&&(s=1),o(255*_|0,255*u|0,255*d|0,255*s|0)}const c={BLACK:o(0,0,0),WHITE:o(255,255,255),LIGHT_GRAY:o(170,170,170),DARK_GRAY:o(85,85,85),YELLOW:o(255,255,85),BROWN:o(170,85,0),LIGHT_RED:o(255,85,85),DARK_RED:o(170,0,0),LIGHT_GREEN:o(85,255,85),DARK_GREEN:o(0,170,0),LIGHT_CYAN:o(85,255,255),DARK_CYAN:o(0,170,170),LIGHT_BLUE:o(85,85,255),DARK_BLUE:o(0,0,170),LIGHT_MAGENTA:o(255,85,255),DARK_MAGENTA:o(170,0,170),ORANGE:o(255,136,0)},_=new Map;function u(t){_.set(t.name,t)}function d(t){const e=[],i=new WeakMap,s=r(t);return JSON.stringify({instances:e,root:s});function r(t){return Array.isArray(t)?function(t){const e=[];for(let i=0;i<t.length;i++)e[i]=r(t[i]);return e}(t):t&&"object"==typeof t?function(t){if(t&&t.constructor.name&&"Object"!==t.constructor.name){if(!_.has(t.constructor.name))throw new Error(`Class ${t.constructor.name} is not serializable.`);if(i.has(t))return{$ref:i.get(t)};const s=e.length;return e.push({$type:t.constructor.name}),i.set(t,s),e[s]=Object.assign(Object.assign({},n(t)),{$type:t.constructor.name}),{$ref:s}}return n(t)}(t):t}function n(t){const e={};for(const i of Object.keys(t))e[i]=r(t[i]);return e}}function l(t){const e=JSON.parse(t),i=e.instances;for(let t=0;t<i.length;t++){const e=i[t],s=_.get(e.$type);delete e.$type,i[t]=Object.create(s.prototype,Object.getOwnPropertyDescriptors(e))}for(let t=0;t<i.length;t++)r(i[t]);return s(e.root);function s(t){return Array.isArray(t)?function(t){for(let e=0;e<t.length;e++)t[e]=s(t[e]);return t}(t):t&&"object"==typeof t?function(t){if(e=t,e&&"object"==typeof e&&"$ref"in e)return i[t.$ref];var e;return r(t),t}(t):t}function r(t){for(const[e,i]of Object.entries(t))t[e]=s(i)}}let A=class{constructor(t,e,i,s,r){this.x=t,this.y=e,this.charCode=void 0!==i?function(t){return"string"==typeof t&&t.length>0?t.charCodeAt(0):t}(i):" ".charCodeAt(0),this.fg=void 0!==s?s:c.WHITE,this.bg=void 0!==r?r:c.BLACK,this.dirty=!0,this.blocked=!1,this.blockedSight=!1,this.explored=!1,this.visible=!1,this.pathId=-1,this.g=0,this.h=0,this.prev=null}setCharCode(t){this.charCode!==t&&(this.charCode=t,this.dirty=!0)}setForeground(t){null!=t&&t!==this.fg&&(this.fg=t,this.dirty=!0)}setBackground(t){null!=t&&t!==this.bg&&(this.bg=t,this.dirty=!0)}setValue(e,i,s){return"string"==typeof e&&(e=e.charCodeAt(0)),"number"==typeof e?(this.setCharCode(e),void 0!==i&&this.setForeground(i),void 0!==s&&this.setBackground(s)):this.drawCell(e,t.None),this.dirty}drawCell(e,i){const s=255&e.bg;i===t.None||e.charCode>0?(this.setCharCode(e.charCode),this.setForeground(e.fg)):s>0&&s<255&&this.setForeground(this.blendColors(this.fg,e.bg,i)),i===t.None||255===s?this.setBackground(e.bg):s>0&&this.setBackground(this.blendColors(this.bg,e.bg,i))}blendColors(e,i,s){const r=(255-(255&i))/255,n=1-r,h=e>>24&255,a=e>>16&255,c=e>>8&255,_=i>>24&255,u=i>>16&255,d=i>>8&255;switch(s){case t.Blend:return o(r*h+n*_|0,r*a+n*u|0,r*c+n*d|0);case t.Add:return o(this.clamp(h+n*_|0),this.clamp(a+n*u|0),this.clamp(c+n*d|0));default:return i}}clamp(t){return Math.min(255,t)}};var E;function T(t,e){const i=new RegExp("(\\S(.{0,"+e+"}\\S)?)\\s+","g");return(t+" ").replace(i,"$1\n").trim().split("\n").map((t=>t.trim()))}function g(t){return t?t.charAt(0).toUpperCase()+t.slice(1):t}A=h([u],A),function(t){t[t.SMILEY=1]="SMILEY",t[t.INVERSE_SMILEY=2]="INVERSE_SMILEY",t[t.HEART=3]="HEART",t[t.DIAMOND=4]="DIAMOND",t[t.CLUB=5]="CLUB",t[t.SPADE=6]="SPADE",t[t.BULLET=7]="BULLET",t[t.INVERSE_BULLET=8]="INVERSE_BULLET",t[t.LIGHT_SHADE=176]="LIGHT_SHADE",t[t.MEDIUM_SHADE=177]="MEDIUM_SHADE",t[t.DARK_SHADE=178]="DARK_SHADE",t[t.BOX_SINGLE_VERTICAL=179]="BOX_SINGLE_VERTICAL",t[t.BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT=180]="BOX_SINGLE_VERTICAL_AND_SINGLE_LEFT",t[t.BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT=185]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_LEFT",t[t.BOX_DOUBLE_VERTICAL=186]="BOX_DOUBLE_VERTICAL",t[t.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT=187]="BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT",t[t.BOX_DOUBLE_UP_AND_DOUBLE_LEFT=188]="BOX_DOUBLE_UP_AND_DOUBLE_LEFT",t[t.BOX_SINGLE_DOWN_AND_SINGLE_LEFT=191]="BOX_SINGLE_DOWN_AND_SINGLE_LEFT",t[t.BOX_SINGLE_UP_AND_SINGLE_RIGHT=192]="BOX_SINGLE_UP_AND_SINGLE_RIGHT",t[t.BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP=193]="BOX_SINGLE_HORIZONTAL_AND_SINGLE_UP",t[t.BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN=194]="BOX_SINGLE_HORIZONTAL_AND_SINGLE_DOWN",t[t.BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT=195]="BOX_SINGLE_VERTICAL_AND_SINGLE_RIGHT",t[t.BOX_SINGLE_HORIZONTAL=196]="BOX_SINGLE_HORIZONTAL",t[t.BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL=197]="BOX_SINGLE_VERTICAL_AND_SINGLE_HORIZONTAL",t[t.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT=200]="BOX_DOUBLE_UP_AND_DOUBLE_RIGHT",t[t.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT=201]="BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT",t[t.BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP=202]="BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_UP",t[t.BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN=203]="BOX_DOUBLE_HORIZONTAL_AND_DOUBLE_DOWN",t[t.BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT=204]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_RIGHT",t[t.BOX_DOUBLE_HORIZONTAL=205]="BOX_DOUBLE_HORIZONTAL",t[t.BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL=206]="BOX_DOUBLE_VERTICAL_AND_DOUBLE_HORIZONTAL",t[t.BOX_SINGLE_UP_AND_SINGLE_LEFT=217]="BOX_SINGLE_UP_AND_SINGLE_LEFT",t[t.BOX_SINGLE_DOWN_AND_SINGLE_RIGHT=218]="BOX_SINGLE_DOWN_AND_SINGLE_RIGHT",t[t.BLOCK_FULL=219]="BLOCK_FULL",t[t.BLOCK_BOTTOM_HALF=220]="BLOCK_BOTTOM_HALF",t[t.BLOCK_LEFT_HALF=221]="BLOCK_LEFT_HALF",t[t.BLOCK_RIGHT_HALF=222]="BLOCK_RIGHT_HALF",t[t.BLOCK_TOP_HALF=223]="BLOCK_TOP_HALF"}(E||(E={}));let f=class{constructor(t,e,i){this.width=t,this.height=e,this.grid=[],this.originX=0,this.originY=0,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.radius=0;for(let i=0;i<e;i++){const e=[];for(let s=0;s<t;s++)e.push(new A(s,i));this.grid.push(e)}if(this.clear(),i)for(let s=0;s<e;s++)for(let e=0;e<t;e++)this.grid[s][e].blocked=this.grid[s][e].blockedSight=i(e,s)}clear(){for(let t=0;t<this.height;t++)for(let e=0;e<this.width;e++)this.drawChar(e,t,0)}getCell(t,e){if(!(t<0||e<0||t>=this.width||e>=this.height))return this.grid[e][t]}getCharCode(t,e){if(!(t<0||e<0||t>=this.width||e>=this.height))return this.grid[e][t].charCode}drawChar(t,e,i,s,r){this.clip&&!this.clip.contains({x:t,y:e})||t>=0&&t<this.width&&e>=0&&e<this.height&&this.grid[0|e][0|t].setValue(i,s,r)}drawString(t,e,i,s,r){const n=i.split("\n");for(let i=0;i<n.length;i++)this.drawStringLine(t,e+i,n[i],s,r)}drawStringLine(t,e,i,s,r){for(let n=0;n<i.length;n++)this.drawChar(t+n,e,i.charCodeAt(n),s,r)}drawCenteredString(t,e,i,s,r){this.drawString(t-Math.floor(i.length/2),e,i,s,r)}drawMessage(t,e,i,s){if(i.text){const r=T(i.text,s||this.width-t);for(const s of r)this.drawStringLine(t,e,s,i.fg,i.bg),e++}if(i.children)for(const r of i.children)e=this.drawMessage(t,e,r,s);return e}drawHLine(t,e,i,s,r,n){for(let h=t;h<t+i;h++)this.drawChar(h,e,s,r,n)}drawVLine(t,e,i,s,r,n){for(let h=e;h<e+i;h++)this.drawChar(t,h,s,r,n)}drawRect(t,e,i,s,r,n,h){this.drawHLine(t,e,i,r,n,h),this.drawHLine(t,e+s-1,i,r,n,h),this.drawVLine(t,e,s,r,n,h),this.drawVLine(t+i-1,e,s,r,n,h)}drawBox(t,e,i,s,r,n,h,o,a,c,_,u,d,l){this.drawHLine(t,e,i,r,d,l),this.drawHLine(t,e+s-1,i,h,d,l),this.drawVLine(t,e,s,o,d,l),this.drawVLine(t+i-1,e,s,n,d,l),this.drawChar(t,e,a,d,l),this.drawChar(t+i-1,e,c,d,l),this.drawChar(t,e+s-1,u,d,l),this.drawChar(t+i-1,e+s-1,_,d,l)}drawSingleBox(t,e,i,s,r,n){this.drawBox(t,e,i,s,E.BOX_SINGLE_HORIZONTAL,E.BOX_SINGLE_VERTICAL,E.BOX_SINGLE_HORIZONTAL,E.BOX_SINGLE_VERTICAL,E.BOX_SINGLE_DOWN_AND_SINGLE_RIGHT,E.BOX_SINGLE_DOWN_AND_SINGLE_LEFT,E.BOX_SINGLE_UP_AND_SINGLE_LEFT,E.BOX_SINGLE_UP_AND_SINGLE_RIGHT,r,n)}drawDoubleBox(t,e,i,s,r,n){this.drawBox(t,e,i,s,E.BOX_DOUBLE_HORIZONTAL,E.BOX_DOUBLE_VERTICAL,E.BOX_DOUBLE_HORIZONTAL,E.BOX_DOUBLE_VERTICAL,E.BOX_DOUBLE_DOWN_AND_DOUBLE_RIGHT,E.BOX_DOUBLE_DOWN_AND_DOUBLE_LEFT,E.BOX_DOUBLE_UP_AND_DOUBLE_LEFT,E.BOX_DOUBLE_UP_AND_DOUBLE_RIGHT,r,n)}fillRect(t,e,i,s,r,n,h){for(let o=e;o<e+s;o++)this.drawHLine(t,o,i,r,n,h)}drawConsole(e,i,s,r,n,h,o,a){a=a||t.None;for(let t=0;t<o;t++)for(let o=0;o<h;o++){const h=s.getCell(r+o,n+t);h&&this.drawCell(e+o,i+t,h,a)}}drawCell(t,e,i,s){t>=0&&t<this.width&&e>=0&&e<this.height&&this.grid[e][t].drawCell(i,s)}setBlocked(t,e,i){t>=0&&t<this.width&&e>=0&&e<this.height&&(this.grid[e][t].blocked=i)}setBlockedSight(t,e,i){t>=0&&t<this.width&&e>=0&&e<this.height&&(this.grid[e][t].blockedSight=i)}isVisible(t,e){return!(t<this.minX||t>this.maxX||e<this.minY||e>this.maxY)&&this.grid[e][t].visible}isBlocked(t,e){return t<0||t>this.width||e<0||e>this.height||this.grid[e][t].blocked}isBlockedSight(t,e){return t<0||t>this.width||e<0||e>this.height||this.grid[e][t].blockedSight}computeOctantY(t,e){const i=[],s=[];let r,n,h,o,a,c,_,u,d,l,A=1,E=0,T=0,g=0;for(n=this.originY+e;n>=this.minY&&n<=this.maxY;n+=e,T=E,++A)for(h=.5/A,l=-1,o=Math.floor(g*A+.5),r=this.originX+o*t;o<=A&&r>=this.minX&&r<=this.maxX;r+=t,++o,l=d){if(a=!0,c=!1,_=o/A,u=l,d=_+h,T>0)if(this.grid[n-e][r].visible&&!this.grid[n-e][r].blockedSight||this.grid[n-e][r-t].visible&&!this.grid[n-e][r-t].blockedSight){for(let t=0;t<T&&a;++t)if(u<=s[t]&&d>=i[t])if(this.grid[n][r].blockedSight){if(u>=i[t]&&d<=s[t]){a=!1;break}i[t]=Math.min(i[t],u),s[t]=Math.max(s[t],d),c=!0}else if(_>i[t]&&_<s[t]){a=!1;break}}else a=!1;a&&(this.grid[n][r].visible=!0,this.grid[n][r].blockedSight&&(g>=u?g=d:c||(i[E]=u,s[E++]=d)))}}computeOctantX(t,e){const i=[],s=[];let r,n,h,o,a,c,_,u,d,l,A=1,E=0,T=0,g=0;for(r=this.originX+t;r>=this.minX&&r<=this.maxX;r+=t,T=E,++A)for(h=.5/A,l=-1,o=Math.floor(g*A+.5),n=this.originY+o*e;o<=A&&n>=this.minY&&n<=this.maxY;n+=e,++o,l=d){if(a=!0,c=!1,_=o/A,u=l,d=_+h,T>0)if(this.grid[n][r-t].visible&&!this.grid[n][r-t].blockedSight||this.grid[n-e][r-t].visible&&!this.grid[n-e][r-t].blockedSight){for(let t=0;t<T&&a;++t)if(u<=s[t]&&d>=i[t])if(this.grid[n][r].blockedSight){if(u>=i[t]&&d<=s[t]){a=!1;break}i[t]=Math.min(i[t],u),s[t]=Math.max(s[t],d),c=!0}else if(_>i[t]&&_<s[t]){a=!1;break}}else a=!1;a&&(this.grid[n][r].visible=!0,this.grid[n][r].blockedSight&&(g>=u?g=d:c||(i[E]=u,s[E++]=d)))}}computeFov(t,e,i,s,r){if(this.originX=t,this.originY=e,this.radius=i,s)this.minX=Math.min(this.minX,Math.max(0,t-i)),this.minY=Math.min(this.minY,Math.max(0,e-i)),this.maxX=Math.max(this.maxX,Math.min(this.width-1,t+i)),this.maxY=Math.max(this.maxY,Math.min(this.height-1,e+i));else{this.minX=Math.max(0,t-i),this.minY=Math.max(0,e-i),this.maxX=Math.min(this.width-1,t+i),this.maxY=Math.min(this.height-1,e+i);for(let t=this.minY;t<=this.maxY;t++)for(let e=this.minX;e<=this.maxX;e++)this.grid[t][e].visible=!1}this.grid[e][t].visible=!0,void 0===r?(this.computeOctantY(1,1),this.computeOctantX(1,1),this.computeOctantX(1,-1),this.computeOctantY(1,-1),this.computeOctantY(-1,-1),this.computeOctantX(-1,-1),this.computeOctantX(-1,1),this.computeOctantY(-1,1)):(1&r&&this.computeOctantY(1,1),2&r&&this.computeOctantX(1,1),4&r&&this.computeOctantX(1,-1),8&r&&this.computeOctantY(1,-1),16&r&&this.computeOctantY(-1,-1),32&r&&this.computeOctantX(-1,-1),64&r&&this.computeOctantX(-1,1),128&r&&this.computeOctantY(-1,1))}updateExplored(){for(let t=this.minY;t<=this.maxY;t++)for(let e=this.minX;e<=this.maxX;e++){const i=this.grid[t][e];i.explored=i.explored||i.visible}}};f=h([u],f);class L{constructor(t,e,i,s){this.url=t,this.charWidth=e,this.charHeight=i,this.scale=s||1}}const O=new L("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAQMAAAD58POIAAAABlBMVEUAAAD///+l2Z/dAAAEhklEQVRIx42Sv4oUQRDGC4UzadSwwMUD8QEKlbWD4Q58B/NGpTVocKO1wXHUzMAH0AcwMTYVGg5ag0IzEXaRjdZEZKNzkKbHqtnzHypY09M9+5uvqr7pbYCuC6ftaRhgONXs30eAh0O1rYDm4IS/eH0B8GxRW2vxo396yu/fb0ZFrW1zcOXlPU/XPwK8PGjbWhVwM4KnH61912oK4+zmmHJaQotyt1kvtC2Atdo24iohPDiG/v4eICJsY3Wy8Yvr0DSIBOdxgH6v8wsriWhc8s0AtaK/GzSl1jR0nSjQnwki6FQxNFKjgzO2a7BBqucH7dL4M9z96CIhT1Fs/AgKgcA6dKCxI29DaHNwRJ4EGAU1sU0OG9rmE4SIc3A4FChACqqhJRwpxkqh9wxag4DSmEJ5DtpFwAP4GUf6lmKcFFti1BYuQp4xN8kxM2kNhjdkTOiTUeAKGvhA1rLpMbYACQzCITlTDRMbLYoEa2JWPSMRFZIupcSzMVKcEUkX+sOG+ChNX2vD8ex6k7OFHL0P1655JuPd53WAD+yTv3UrCQiuHmYBbfIxpkImuvpBQBkVb5g4XHv3JkNireG8AO9zDhBZu2z2OMZ11S5/RIlyMefMNaZ4GsCz5xcjyM6hHYEjAYEfO8Ig1rklAe9sRIeYAdwyoIBq6YIzCAKiWoifA3m3o2AzWcdYKOdY47EIf8QABCuYgIUVmdVMEYEDA0Hmo/3D6KKJbh5mxhP3UsWIE97wnEygyizOfOLi2JOJW8CeOblW9IHeKZgv4zxuzDryOmb+4aQH+MXV6e0ywdUcxqCjBWl5GpbzZduOG1QEiGXP86T7EfiJfkMQ4OO4H0yqyNC2zlziWEN7Ywuc2fQ4p5BNkS5QYXP2h5NtRJh0vCKQidtVJmCGAwDSSQpYggSxiRIyzewsgCh4xxiTPDMh5aj//l7btqkr6rQyIOtLji4lVRQwXdzvus40Y53M33fh50GZwF4ExQeMlvuTggLzSi4ElKczUO7zVtpwdyMKdqZKOWb2nDblawPxPmuMwFEWBW+jlZR1eYtS442kiBGMWCi/h1/+GAR6NYOJWiqNJXFygFtrkx5C0O3IeFGs67HhEEhmBu/BUOT+0551pXxYIF+Elpi5AKRkLl5GUbCCZddyMv621ujEBPP4vSy2fotTx3U+d3WBiFOA6VSGSB49v/M7GBX9FPrDaT2c9qr4PCpwZ7qz813R94dVFIe19v33GlMZUghQFb8BrfE7QBmgBMbrn2B3enn/y3B5+DL8UBAdnejdYdBxeV9ejwoYNTgW0Ok/gA7UG2GAzanhL0DG7q4svynwF8UwDPu7u/vD0IudzSltMtVbP+J/gUbR29oJ7Fg9s6Uy+DnpiTCOYc4cXOeXMWfsusSw7FOg9x655nax6BlecwpOQQ68WBwp+H2LMQTuOq2RUigzh2Q/R3CWARJIJG199EwOTyKBlQMznshCRGeQ5gHABAQl6M4gLEdAzVaBWMCiANdsayDCHBA/hagKYfielrJIlipKKQIA9Nf3wBloTHT6BuAx15zRNa1nAAAAAElFTkSuQmCC",8,8);var R,N;function D(t,e){return t>0?e>0?N.QUADRANT_SOUTHEAST:0===e?N.QUADRANT_EAST:N.QUADRANT_NORTHEAST:t<0?e>0?N.QUADRANT_SOUTHWEST:0===e?N.QUADRANT_WEST:N.QUADRANT_NORTHWEST:e>0?N.QUADRANT_SOUTH:N.QUADRANT_NORTH}!function(t){t[t.OCTANT_SOUTH_SOUTHEAST=1]="OCTANT_SOUTH_SOUTHEAST",t[t.OCTANT_EAST_SOUTHEAST=2]="OCTANT_EAST_SOUTHEAST",t[t.OCTANT_EAST_NORTHTHEAST=4]="OCTANT_EAST_NORTHTHEAST",t[t.OCTANT_NORTH_NORTHEAST=8]="OCTANT_NORTH_NORTHEAST",t[t.OCTANT_NORTH_NORTHWEST=16]="OCTANT_NORTH_NORTHWEST",t[t.OCTANT_WEST_NORTHEAST=32]="OCTANT_WEST_NORTHEAST",t[t.OCTANT_WEST_SOUTHWEST=64]="OCTANT_WEST_SOUTHWEST",t[t.OCTANT_SOUTH_SOUTHWEST=128]="OCTANT_SOUTH_SOUTHWEST"}(R||(R={})),function(t){t[t.QUADRANT_SOUTHEAST=3]="QUADRANT_SOUTHEAST",t[t.QUADRANT_EAST=6]="QUADRANT_EAST",t[t.QUADRANT_NORTHEAST=12]="QUADRANT_NORTHEAST",t[t.QUADRANT_NORTH=24]="QUADRANT_NORTH",t[t.QUADRANT_NORTHWEST=48]="QUADRANT_NORTHWEST",t[t.QUADRANT_WEST=96]="QUADRANT_WEST",t[t.QUADRANT_SOUTHWEST=192]="QUADRANT_SOUTHWEST",t[t.QUADRANT_SOUTH=129]="QUADRANT_SOUTH"}(N||(N={}));let m=class{constructor(t,e){this.x=t,this.y=e}};m=h([u],m);let B=class{constructor(t,e,i,s){this.x=this.left=t,this.y=this.top=e,this.width=i,this.height=s,this.x2=t+i,this.y2=e+s}getCenter(){return new m(this.x+this.width/2|0,this.y+this.height/2|0)}intersects(t){return this.x<=t.x2&&this.x2>=t.x&&this.y<=t.y2&&this.y2>=t.y}contains(t){return t.x>=this.x&&t.x<this.x2&&t.y>=this.y&&t.y<this.y2}};B=h([u],B);class p{constructor(t,e,i){this.dialog=t,this.rect=e,this.contentsOffset=i,this.open=!1,this.count=0}}class x{getState(t,e){const i=e.contentsRect.width+4,s=e.contentsRect.height+4,r=(t.width-i)/2|0,n=(t.height-s)/2|0;return new p(e,new B(r,n,i,s),new m(r+2,n+2))}draw(t,e){const i=e.dialog,{x:s,y:r,width:n,height:h}=e.rect;t.fillRect(s,r,n,h,0,c.WHITE,c.BLACK),t.drawSingleBox(s,r,n,h),t.drawCenteredString(s+n/2|0,r," "+i.title+" "),i.drawContents(t,e.contentsOffset)}}class K{constructor(t,e){this.terminal=t,this.renderer=e||new x,this.dialogs=[]}add(t){this.dialogs.push(this.renderer.getState(this.terminal,t))}handleInput(){if(0===this.dialogs.length)return!1;const t=this.dialogs.length-1,e=this.dialogs[this.dialogs.length-1];return e.dialog.handleInput(this.terminal,e.contentsOffset)&&this.dialogs.splice(t,1),!0}draw(){for(let t=0;t<this.dialogs.length;t++)this.renderer.draw(this.terminal,this.dialogs[t])}}class U{constructor(t,e){this.contentsRect=t,this.title=e}}let I=class{constructor(t,e,i,s){this.text=t,this.fg=e,this.bg=i,this.children=s}getWidth(){let t=0;if(this.text)for(const e of this.text.split("\n"))t=Math.max(t,e.length);if(this.children)for(const e of this.children)t=Math.max(t,e.getWidth());return t}getHeight(){let t=0;if(this.text&&(t+=this.text.split("\n").length),this.children)for(const e of this.children)t+=e.getHeight();return t}};I=h([u],I);class y{constructor(){this.down=!1,this.downTime=0,this.repeat=!1,this.repeatTime=0,this.downCount=0,this.upCount=100}setDown(t){this.down!==t&&(this.down=t,this.repeat=!1,this.downTime=this.repeatTime=performance.now())}update(t){this.repeat=!1,this.down?(this.downCount++,this.upCount=0,t-this.downTime>=200&&t-this.repeatTime>=66.66666666666667&&(this.repeat=!0,this.repeatTime=t)):(this.downCount=0,this.upCount++)}isPressed(){return 1===this.downCount||this.repeat}isClicked(){return 1===this.upCount}}class S{constructor(){this.inputs=new Map}clear(){this.inputs.clear()}get(t){let e=this.inputs.get(t);return e||(e=new y,this.inputs.set(t,e)),e}updateAll(t){this.inputs.forEach((e=>e.update(t)))}}class w{constructor(t){this.keys=new S,t.addEventListener("keydown",(t=>this.setKey(t,!0))),t.addEventListener("keyup",(t=>this.setKey(t,!1)))}clear(){this.keys.clear()}getKey(t){return this.keys.get(t)}setKey(t,e){const i=t.code;i!==C.VK_F11&&(t.stopPropagation(),t.preventDefault(),this.keys.get(i).setDown(e))}updateKeys(t){this.keys.updateAll(t)}}var C;!function(t){t.VK_CANCEL="Pause",t.VK_BACKSPACE="Backspace",t.VK_TAB="Tab",t.VK_ENTER="Enter",t.VK_SHIFT_LEFT="ShiftLeft",t.VK_SHIFT_RIGHT="ShiftLeft",t.VK_CONTROL_LEFT="ControlLeft",t.VK_CONTROL_RIGHT="ControlRight",t.VK_ALT_LEFT="AltLeft",t.VK_ALT_RIGHT="AltRight",t.VK_PAUSE="Pause",t.VK_CAPS_LOCK="CapsLock",t.VK_ESCAPE="Escape",t.VK_SPACE="Space",t.VK_PAGE_UP="PageUp",t.VK_PAGE_DOWN="PageDown",t.VK_END="End",t.VK_HOME="Home",t.VK_LEFT="ArrowLeft",t.VK_UP="ArrowUp",t.VK_RIGHT="ArrowRight",t.VK_DOWN="ArrowDown",t.VK_INSERT="Insert",t.VK_DELETE="Delete",t.VK_0="Digit0",t.VK_1="Digit1",t.VK_2="Digit2",t.VK_3="Digit3",t.VK_4="Digit4",t.VK_5="Digit5",t.VK_6="Digit6",t.VK_7="Digit7",t.VK_8="Digit8",t.VK_9="Digit9",t.VK_SEMICOLON="Semicolon",t.VK_EQUALS="Equal",t.VK_A="KeyA",t.VK_B="KeyB",t.VK_C="KeyC",t.VK_D="KeyD",t.VK_E="KeyE",t.VK_F="KeyF",t.VK_G="KeyG",t.VK_H="KeyH",t.VK_I="KeyI",t.VK_J="KeyJ",t.VK_K="KeyK",t.VK_L="KeyL",t.VK_M="KeyM",t.VK_N="KeyN",t.VK_O="KeyO",t.VK_P="KeyP",t.VK_Q="KeyQ",t.VK_R="KeyR",t.VK_S="KeyS",t.VK_T="KeyT",t.VK_U="KeyU",t.VK_V="KeyV",t.VK_W="KeyW",t.VK_X="KeyX",t.VK_Y="KeyY",t.VK_Z="KeyZ",t.VK_CONTEXT_MENU="ContextMenu",t.VK_NUMPAD0="Numpad0",t.VK_NUMPAD1="Numpad1",t.VK_NUMPAD2="Numpad2",t.VK_NUMPAD3="Numpad3",t.VK_NUMPAD4="Numpad4",t.VK_NUMPAD5="Numpad5",t.VK_NUMPAD6="Numpad6",t.VK_NUMPAD7="Numpad7",t.VK_NUMPAD8="Numpad8",t.VK_NUMPAD9="Numpad9",t.VK_NUMPAD_ENTER="NumpadEnter",t.VK_MULTIPLY="NumpadMultiply",t.VK_ADD="NumpadAdd",t.VK_SEPARATOR="NumpadDecimal",t.VK_SUBTRACT="NumpadSubtract",t.VK_DECIMAL="NumpadDecimal",t.VK_DIVIDE="NumpadDivide",t.VK_F1="F1",t.VK_F2="F2",t.VK_F3="F3",t.VK_F4="F4",t.VK_F5="F5",t.VK_F6="F6",t.VK_F7="F7",t.VK_F8="F8",t.VK_F9="F9",t.VK_F10="F10",t.VK_F11="F11",t.VK_F12="F12",t.VK_F13="F13",t.VK_F14="F14",t.VK_F15="F15",t.VK_F16="F16",t.VK_F17="F17",t.VK_F18="F18",t.VK_F19="F19",t.VK_F20="F20",t.VK_F21="F21",t.VK_F22="F22",t.VK_F23="F23",t.VK_F24="F24",t.VK_NUM_LOCK="NumLock",t.VK_SCROLL_LOCK="ScrollLock",t.VK_COMMA="Comma",t.VK_PERIOD="Period",t.VK_SLASH="Slash",t.VK_BACKQUOTE="Backquote",t.VK_OPEN_BRACKET="BracketLeft",t.VK_BACK_SLASH="Backslash",t.VK_CLOSE_BRACKET="BracketRight",t.VK_QUOTE="Quote",t.VK_META="OSLeft"}(C||(C={}));class v extends U{constructor(t,e){let i;i=e instanceof I?new B(0,0,e.getWidth(),e.getHeight()):new B(0,0,e.length,1),super(i,t),this.message=e}drawContents(t,e){this.message instanceof I?t.drawMessage(e.x,e.y,this.message):t.drawString(e.x,e.y,this.message)}handleInput(t){return t.isKeyPressed(C.VK_ESCAPE)}}class b extends U{constructor(t,e,i){super(t,e),this.message=i,this.scrollY=0,this.messagesHeight=i.getHeight(),this.scrollMax=Math.max(1,this.messagesHeight-this.contentsRect.height),this.scrollbarHeight=this.contentsRect.height*this.contentsRect.height/(this.messagesHeight+1)}drawContents(t,e){t.clip=this.contentsRect,t.drawMessage(e.x,e.y-this.scrollY,this.message),t.clip=void 0;const i=this.scrollY/this.scrollMax*(this.contentsRect.height-this.scrollbarHeight);t.drawVLine(this.contentsRect.x+this.contentsRect.width+1,this.contentsRect.y+i,this.scrollbarHeight,E.MEDIUM_SHADE)}handleInput(t){const e=t.getMovementKey();return e&&(this.scrollY+=e.y),t.isKeyPressed(C.VK_PAGE_DOWN)&&(this.scrollY+=this.contentsRect.height),t.isKeyPressed(C.VK_PAGE_UP)&&(this.scrollY-=this.contentsRect.height),0!==t.mouse.wheelDeltaY&&(this.scrollY+=t.mouse.wheelDeltaY<0?-5:5,t.mouse.wheelDeltaY=0),this.scrollY=Math.max(0,Math.min(this.scrollMax,this.scrollY)),t.isKeyPressed(C.VK_ESCAPE)}}class V extends U{constructor(t,e,i){let s=t.length;for(let t=0;t<e.length;t++)s=Math.max(s,e[t].length+4);const r=e.length;super(new B(0,0,s,r),t),this.options=e,this.callback=i,this.hoverIndex=-1}drawContents(t,e){for(let i=0;i<this.options.length;i++){const s=String.fromCharCode(65+i)+" - "+this.options[i];i===this.hoverIndex?t.drawString(e.x,e.y+i,s,c.BLACK,c.WHITE):t.drawString(e.x,e.y+i,s,c.WHITE,c.BLACK)}}handleInput(t,e){const i=t.getMovementKey();if(i&&0!==i.y&&(this.hoverIndex=(this.hoverIndex+this.options.length+i.y)%this.options.length),this.hoverIndex>=0&&(t.isKeyPressed(C.VK_ENTER)||t.isKeyPressed(C.VK_NUMPAD_ENTER)))return this.callback(this.hoverIndex),!0;if(t.mouse.x>=e.x&&t.mouse.x<e.x+this.contentsRect.width&&t.mouse.y>=e.y&&t.mouse.y<e.y+this.contentsRect.height&&(this.hoverIndex=t.mouse.y-e.y,t.mouse.buttons.get(0).isClicked()))return t.mouse.buttons.clear(),this.callback(this.hoverIndex),!0;const s="A".charCodeAt(0);for(let e=0;e<this.options.length;e++)if(t.isKeyPressed("Key"+String.fromCharCode(s+e)))return this.callback(e),!0;return t.isKeyPressed(C.VK_ESCAPE)}isMouseOverOption(t,e,i){return t.mouse.x>=e.x&&t.mouse.x<e.x+this.contentsRect.width&&t.mouse.y===e.y+i}}const F=[{charCode:E.BLOCK_TOP_HALF,active:[1,1,0,0]},{charCode:E.BLOCK_RIGHT_HALF,active:[0,1,0,1]}];function H(t,e){const i=new Image;i.onload=()=>{const t=i.width,s=i.height,r=G(i),n=new f(t,s);let h=0;for(let e=0;e<s;e++)for(let i=0;i<t;i++){n.getCell(i,e).setBackground(o(r[h++],r[h++],r[h++],r[h++]))}e(n)},i.src=t}function P(t,e){const i=new Image;i.onload=()=>{const t=i.width,s=i.height,r=G(i),n=new f(t/2,s/2);for(let e=0;e<s;e+=2)for(let i=0;i<t;i+=2)M(n,r,i,e,t);e(n)},i.src=t}function G(t){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const i=e.getContext("2d");return i.drawImage(t,0,0),i.getImageData(0,0,t.width,t.height).data}function M(t,e,i,s,r){const n=4*(s*r+i),h=4*(s*r+i+1),o=4*((s+1)*r+i),a=4*((s+1)*r+i+1),c=[[e[n],e[n+1],e[n+2]],[e[h],e[h+1],e[h+2]],[e[o],e[o+1],e[o+2]],[e[a],e[a+1],e[a+2]]];let _=Number.MAX_VALUE,u=0,d=null,l=null;for(let t=0;t<F.length;t++){const e=F[t],i=X(e.active,c);i.error<_&&(_=i.error,u=e.charCode,d=i.bg,l=i.fg)}t.drawChar(i/2,s/2,u,Y(l),Y(d))}function X(t,e){const i=[[0,0,0],[0,0,0]],s=[[0,0,0],[0,0,0]],r=[0,0];for(let s=0;s<4;s++){for(let r=0;r<3;r++)i[t[s]][r]+=e[s][r];r[t[s]]++}for(let t=0;t<2;t++)for(let e=0;e<3;e++)s[t][e]=i[t][e]/r[t];let n=0;for(let i=0;i<4;i++){let r=0;for(let n=0;n<3;n++){const h=e[i][n]-s[t[i]][n];r+=h*h}n+=Math.sqrt(r)}return{bg:s[0],fg:s[1],error:n}}function Y(t){return o(t[0],t[1],t[2])}class W{constructor(t){this.buttons=new S,this.el=t.canvas,this.width=t.width,this.height=t.height,this.prevX=0,this.prevY=0,this.x=0,this.y=0,this.dx=0,this.dy=0,this.wheelDeltaX=0,this.wheelDeltaY=0;const e=this.el;e.addEventListener("mousedown",(t=>this.handleEvent(t))),e.addEventListener("mouseup",(t=>this.handleEvent(t))),e.addEventListener("mousemove",(t=>this.handleEvent(t))),e.addEventListener("contextmenu",(t=>this.handleEvent(t))),e.addEventListener("touchstart",(t=>this.handleTouchEvent(t))),e.addEventListener("touchend",(t=>this.handleTouchEvent(t))),e.addEventListener("touchcancel",(t=>this.handleTouchEvent(t))),e.addEventListener("touchmove",(t=>this.handleTouchEvent(t))),e.addEventListener("wheel",(t=>this.handleWheelEvent(t)))}handleTouchEvent(t){if(t.stopPropagation(),t.preventDefault(),t.touches.length>0){const e=t.touches[0];this.updatePosition(e.clientX,e.clientY),this.buttons.get(0).setDown(!0)}else this.buttons.get(0).setDown(!1)}handleEvent(t){t.stopPropagation(),t.preventDefault(),this.updatePosition(t.clientX,t.clientY),"mousedown"===t.type&&(this.buttons.get(t.button).setDown(!0),this.el.focus()),"mouseup"===t.type&&this.buttons.get(t.button).setDown(!1)}handleWheelEvent(t){t.stopPropagation(),t.preventDefault(),this.wheelDeltaX=t.deltaX,this.wheelDeltaY=t.deltaY}updatePosition(t,e){let i=this.el.getBoundingClientRect();const s=this.width/this.height,r=i.width/i.height;if(r-s>.01){const t=s*i.height,e=i.width-t;i=new B(Math.floor(e/2),0,t,i.height)}if(r-s<-.01){const t=i.width/s,e=i.height-t;i=new B(0,Math.floor(e/2),i.width,t)}this.x=this.width*(t-i.left)/i.width|0,this.y=this.height*(e-i.top)/i.height|0}update(t){this.dx=this.x-this.prevX,this.dy=this.y-this.prevY,this.prevX=this.x,this.prevY=this.y,this.buttons.updateAll(t)}}const k={BLACK:o(0,0,0),WHITE:o(255,255,255),RED:o(136,0,0),CYAN:o(170,255,238),VIOLET:o(204,68,204),GREEN:o(0,204,85),BLUE:o(0,0,170),YELLOW:o(238,238,119),ORANGE:o(221,136,85),BROWN:o(102,68,0),LIGHT_RED:o(255,119,119),DARK_GRAY:o(51,51,51),GRAY:o(119,119,119),LIGHT_GREEN:o(170,255,102),LIGHT_BLUE:o(0,136,255),LIGHT_GRAY:o(187,187,187)},Q={BLACK:o(0,0,0),WHITE:o(255,255,255),RED:o(136,0,0),CYAN:o(170,255,238),VIOLET:o(204,68,204),GREEN:o(0,204,85),BLUE:o(0,0,170),YELLOW:o(238,238,119),ORANGE:o(221,136,85),BROWN:o(102,68,0),LIGHT_RED:o(255,119,119),DARK_GRAY:o(51,51,51),GRAY:o(119,119,119),LIGHT_GREEN:o(170,255,102),LIGHT_BLUE:o(0,136,255),LIGHT_GRAY:o(187,187,187)},z={BLACK:o(0,0,0),DARK_BLUE:o(29,43,83),DARK_PURPLE:o(126,37,83),DARK_GREEN:o(0,135,81),BROWN:o(171,82,54),DARK_GRAY:o(95,87,79),LIGHT_GRAY:o(194,195,199),WHITE:o(255,241,232),RED:o(255,0,77),ORANGE:o(255,163,0),YELLOW:o(255,236,39),GREEN:o(0,228,54),BLUE:o(41,173,255),LAVENDER:o(131,118,156),PINK:o(255,119,168),LIGHT_PEACH:o(255,204,170)},Z=[-1,0,1,-1,1,-1,0,1],j=[-1,-1,-1,0,0,1,1,1],J=[1.4,1,1.4,1,1,1.4,1,1.4];let q=0;function $(t,e,i,s){q++;const r=t.grid[e.y][e.x];r.pathId=q,r.g=0,r.h=Math.hypot(e.x-i.x,e.y-i.y),r.prev=null;const n=new et([r]);for(;n.size()>0;){const e=n.pop();if(e.x===i.x&&e.y===i.y)return tt(e);for(let r=0;r<Z.length;r++){const h=e.x+Z[r],o=e.y+j[r];if(h>=0&&h<t.width&&o>=0&&o<t.height){const a=t.grid[o][h];if(a.blocked&&a.explored&&(h!==i.x||o!==i.y))continue;a.pathId!==q&&(a.pathId=q,a.g=1/0,a.h=Math.hypot(h-i.x,o-i.y),a.prev=null);const c=e.g+J[r];c<a.g&&c<=s&&(a.g=c,a.prev=e,n.insert(a))}}}}function tt(t){const e=[];let i=t;for(;i;)e.push(i),i=i.prev;return e.reverse(),e}class et{constructor(t){this.values=t}insert(t){const e=this.values;let i=0,s=e.length,r=0;for(;i<s;){const n=i+s>>>1,h=e[n];h.g+h.h>t.g+t.h?(i=n+1,r=i):(s=n,r=s)}e.splice(r,0,t)}pop(){return this.values.pop()}size(){return this.values.length}}let it=class{constructor(t){this.m=2147483648,this.a=1103515245,this.c=12345,this.state=t||1}nextInt(){return this.state=(this.a*this.state+this.c)%this.m,this.state}nextFloat(){return this.nextInt()/(this.m-1)}nextRange(t,e){const i=e-t,s=t+(this.nextInt()/this.m*i|0);if(isNaN(s))throw new Error("rand nan");return s}chooseIndex(t){const e=t.reduce(((t,e)=>t+e)),i=this.nextRange(1,e+1);let s=0;for(let e=0;e<t.length;e++)if(s+=t[e],i<=s)return e;return t.length-1}chooseKey(t){const e=Object.keys(t),i=e.map((e=>t[e]));return e[this.chooseIndex(i)]}};it=h([u],it);function st(t,e){return t/e*2-1}const rt={font:O};class nt extends f{constructor(t,e,i,s){var r;super(e,i),s=s||rt,this.canvas=t,this.font=s.font||O,this.crt=s.crt,this.maxFps=s.maxFps,this.pixelWidth=e*this.font.charWidth,this.pixelHeight=i*this.font.charHeight,this.pixelScale=(null===(r=s.crt)||void 0===r?void 0:r.scale)||1,t.width=this.pixelWidth*this.pixelScale,t.height=this.pixelHeight*this.pixelScale,t.style.imageRendering="pixelated",t.style.outline="none",t.tabIndex=0,this.handleResize(),window.addEventListener("resize",(()=>this.handleResize())),this.keys=new w(t),this.mouse=new W(this);const n=t.getContext("webgl2",{antialias:!1});if(!n)throw new Error("Unable to initialize WebGL. Your browser may not support it.");const h=n.createProgram();if(!h)throw new Error("Unable to initialize WebGL. Your browser may not support it.");this.gl=n,this.program=h,n.attachShader(h,this.buildShader(n.VERTEX_SHADER,"#version 300 es\nprecision highp float;in vec2 a;in vec2 b;in vec3 c;in vec3 d;out vec2 e;out vec4 f;out vec4 g;void main(void){gl_Position=vec4(a.x,a.y,0,1);e=b/16.0;f=vec4(c.r,c.g,c.b,1);g=vec4(d.r,d.g,d.b,1);}")),n.attachShader(h,this.buildShader(n.FRAGMENT_SHADER,"#version 300 es\nprecision highp float;in vec2 e;in vec4 f;in vec4 g;uniform sampler2D s;out vec4 o;void main(void){o=texture(s,e);if(o.r<0.1) {o=g;} else {o=f;}}")),n.linkProgram(h),n.useProgram(h),this.crtProgram=n.createProgram(),n.attachShader(this.crtProgram,this.buildShader(n.VERTEX_SHADER,"#version 300 es\nprecision highp float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_texCoord;\nvoid main(void) {\n  gl_Position=vec4(a_position.x, a_position.y, 0.0, 1.0);\n  v_texCoord = a_texCoord;\n}")),n.attachShader(this.crtProgram,this.buildShader(n.FRAGMENT_SHADER,"#version 300 es\n#define PI 3.1415926535897932384626433832795\nprecision highp float;\nin vec2 v_texCoord;\nuniform sampler2D u_texture;\nuniform float u_blur;\nuniform float u_curvature;\nuniform float u_chroma;\nuniform float u_scanlineWidth;\nuniform float u_scanlineIntensity;\nuniform float u_vignette;\nout vec4 outputColor;\n\nvec2 curve(vec2 uv) {\n  uv = (uv - 0.5) * 2.0;\n  uv *= 1.1;\n  uv.x *= 1.0 + pow((abs(uv.y) * u_curvature), 2.0);\n  uv.y *= 1.0 + pow((abs(uv.x) * u_curvature), 2.0);\n  uv /= 1.1;\n  uv = (uv / 2.0) + 0.5;\n  return uv;\n}\n\nvoid main() {\n  vec2 iResolution = vec2(640.0, 360.0);\n  vec2 q = v_texCoord;\n  vec2 fragCoord = v_texCoord;\n  vec2 uv = q;\n  uv = curve(uv);\n\n  // Outside of range is black\n  if (uv.x < 0.0 || uv.x > 1.0 || uv.y < 0.0 || uv.y > 1.0) {\n    outputColor = vec4(0.0, 0.0, 0.0, 1.0);\n    return;\n  }\n\n  vec4 col;\n\n  // Chromatic aberration\n  // col = texture(u_texture, uv.xy);\n  col.r = 0.7 * texture(u_texture, vec2(uv.x + 0.001 * u_chroma, uv.y + 0.001 * u_chroma)).r;\n  col.g = 0.7 * texture(u_texture, vec2(uv.x + 0.000 * u_chroma, uv.y - 0.002 * u_chroma)).g;\n  col.b = 0.7 * texture(u_texture, vec2(uv.x - 0.002 * u_chroma, uv.y + 0.000 * u_chroma)).b;\n  \n  // Blur\n  col += 0.05 * texture(u_texture, vec2(uv.x - 2.0 * u_blur / iResolution.x, uv.y));\n  col += 0.10 * texture(u_texture, vec2(uv.x - 1.0 * u_blur / iResolution.x, uv.y));\n  col += 0.10 * texture(u_texture, vec2(uv.x + 1.0 * u_blur / iResolution.x, uv.y));\n  col += 0.05 * texture(u_texture, vec2(uv.x + 2.0 * u_blur / iResolution.x, uv.y));\n\n  // Vignette\n  col *= pow(16.0 * uv.x * uv.y * (1.0 - uv.x) * (1.0 - uv.y), u_vignette);\n\n  // Scanlines\n  col *= clamp(1.0 + u_scanlineWidth * sin(uv.y * iResolution.y * 2.0 * PI), 1.0 - u_scanlineIntensity, 1.0);\n\n  outputColor = vec4(col.rgb, 1.0);\n}")),n.linkProgram(this.crtProgram),n.useProgram(this.crtProgram),this.crtBlurLocation=n.getUniformLocation(this.crtProgram,"u_blur"),this.crtCurvatureLocation=n.getUniformLocation(this.crtProgram,"u_curvature"),this.crtChromaLocation=n.getUniformLocation(this.crtProgram,"u_chroma"),this.crtScanlineWidthLocation=n.getUniformLocation(this.crtProgram,"u_scanlineWidth"),this.crtScanlineIntensityLocation=n.getUniformLocation(this.crtProgram,"u_scanlineIntensity"),this.crtVignetteLocation=n.getUniformLocation(this.crtProgram,"u_vignette"),this.crtPositionLocation=n.getAttribLocation(this.crtProgram,"a_position"),this.crtPositionBuffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.crtPositionBuffer),n.bufferData(n.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),n.STATIC_DRAW),n.enableVertexAttribArray(this.crtPositionLocation),n.vertexAttribPointer(this.crtPositionLocation,2,n.FLOAT,!1,0,0),this.crtTexCoordLocation=n.getAttribLocation(this.crtProgram,"a_texCoord"),this.crtTexCoordBuffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.crtTexCoordBuffer),n.bufferData(n.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),n.STATIC_DRAW),n.enableVertexAttribArray(this.crtTexCoordLocation),n.vertexAttribPointer(this.crtTexCoordLocation,2,n.FLOAT,!1,0,0),this.positionAttribLocation=this.getAttribLocation("a"),this.textureAttribLocation=this.getAttribLocation("b"),this.fgColorAttribLocation=this.getAttribLocation("c"),this.bgColorAttribLocation=this.getAttribLocation("d");const o=e*i;this.positionsArray=new Float32Array(3*o*4),this.indexArray=new Uint16Array(6*o),this.textureArray=new Float32Array(2*o*4),this.foregroundUint8Array=new Uint8Array(4*o*4),this.foregroundDataView=new DataView(this.foregroundUint8Array.buffer),this.backgroundUint8Array=new Uint8Array(4*o*4),this.backgroundDataView=new DataView(this.backgroundUint8Array.buffer),this.frameBufferTexture=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this.frameBufferTexture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.pixelWidth,this.pixelHeight,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),this.frameBuffer=n.createFramebuffer(),n.bindFramebuffer(n.FRAMEBUFFER,this.frameBuffer),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.frameBufferTexture,0);let a=0,c=0,_=0;for(let t=0;t<i;t++)for(let s=0;s<e;s++)this.positionsArray[a++]=st(s,e),this.positionsArray[a++]=-st(t,i),this.positionsArray[a++]=st(s+1,e),this.positionsArray[a++]=-st(t,i),this.positionsArray[a++]=st(s+1,e),this.positionsArray[a++]=-st(t+1,i),this.positionsArray[a++]=st(s,e),this.positionsArray[a++]=-st(t+1,i),this.indexArray[c++]=_+0,this.indexArray[c++]=_+1,this.indexArray[c++]=_+2,this.indexArray[c++]=_+0,this.indexArray[c++]=_+2,this.indexArray[c++]=_+3,_+=4;this.positionBuffer=n.createBuffer(),this.indexBuffer=n.createBuffer(),this.textureBuffer=n.createBuffer(),this.foregroundBuffer=n.createBuffer(),this.backgroundBuffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.positionBuffer),n.bufferData(n.ARRAY_BUFFER,this.positionsArray,n.STATIC_DRAW),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.indexBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,this.indexArray,n.STATIC_DRAW),this.texture=this.loadTexture(this.font.url),this.lastRenderTime=0,this.renderDelta=0,this.fps=0,this.averageFps=0,void 0===this.maxFps?this.requestAnimationFrame():window.setInterval((()=>this.renderLoop(performance.now())),1e3/this.maxFps)}handleResize(){const t=this.canvas.parentElement;if(!t)return;const e=t.offsetWidth/this.pixelWidth,i=t.offsetHeight/this.pixelHeight,s=Math.min(e,i),r=s*this.pixelWidth|0,n=s*this.pixelHeight|0;this.canvas.style.width=r+"px",this.canvas.style.height=n+"px"}getAttribLocation(t){const e=this.gl.getAttribLocation(this.program,t);return this.gl.enableVertexAttribArray(e),e}flush(){let t=0,e=0;for(let i=0;i<this.height;i++)for(let s=0;s<this.width;s++){const r=this.getCell(s,i);if(!r.dirty){t+=8,e+=16;continue}const n=r.charCode%16,h=r.charCode/16|0;this.textureArray[t++]=n,this.textureArray[t++]=h,this.textureArray[t++]=n+1,this.textureArray[t++]=h,this.textureArray[t++]=n+1,this.textureArray[t++]=h+1,this.textureArray[t++]=n,this.textureArray[t++]=h+1;for(let t=0;t<4;t++)this.foregroundDataView.setUint32(e,r.fg,!1),this.backgroundDataView.setUint32(e,r.bg,!1),e+=4;r.dirty=!1}}isKeyDown(t){return this.keys.getKey(t).down}isKeyPressed(t){return this.keys.getKey(t).isPressed()}getKeyDownCount(t){return this.keys.getKey(t).downCount}getMovementKey(){return this.isKeyPressed(C.VK_NUMPAD1)||this.isKeyPressed(C.VK_B)?new m(-1,1):this.isKeyPressed(C.VK_NUMPAD2)||this.isKeyPressed(C.VK_J)||this.isKeyPressed(C.VK_DOWN)?new m(0,1):this.isKeyPressed(C.VK_NUMPAD3)||this.isKeyPressed(C.VK_N)?new m(1,1):this.isKeyPressed(C.VK_NUMPAD4)||this.isKeyPressed(C.VK_H)||this.isKeyPressed(C.VK_LEFT)?new m(-1,0):this.isKeyPressed(C.VK_NUMPAD5)||this.isKeyPressed(C.VK_PERIOD)?new m(0,0):this.isKeyPressed(C.VK_NUMPAD6)||this.isKeyPressed(C.VK_L)||this.isKeyPressed(C.VK_RIGHT)?new m(1,0):this.isKeyPressed(C.VK_NUMPAD7)||this.isKeyPressed(C.VK_Y)?new m(-1,-1):this.isKeyPressed(C.VK_NUMPAD8)||this.isKeyPressed(C.VK_K)||this.isKeyPressed(C.VK_UP)?new m(0,-1):this.isKeyPressed(C.VK_NUMPAD9)||this.isKeyPressed(C.VK_U)?new m(1,-1):void 0}buildShader(t,e){const i=this.gl,s=i.createShader(t);if(!s)throw new Error("An error occurred compiling the shader: ");if(i.shaderSource(s,e),i.compileShader(s),!i.getShaderParameter(s,i.COMPILE_STATUS))throw new Error("An error occurred compiling the shader: "+i.getShaderInfoLog(s));return s}loadTexture(t){const e=this.gl,i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i);const s=e.RGBA,r=e.RGBA,n=e.UNSIGNED_BYTE,h=new Uint8Array([0,0,0,255]);e.texImage2D(e.TEXTURE_2D,0,s,1,1,0,r,n,h);const o=new Image;return o.onload=()=>{e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,s,r,n,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)},o.src=t,i}render(){const t=this.gl;t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),this.crt?t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,this.pixelWidth,this.pixelHeight);{const e=2,i=t.FLOAT,s=!1,r=0,n=0;t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.vertexAttribPointer(this.positionAttribLocation,e,i,s,r,n)}{const e=2,i=t.FLOAT,s=!1,r=0,n=0;t.bindBuffer(t.ARRAY_BUFFER,this.textureBuffer),t.bufferData(t.ARRAY_BUFFER,this.textureArray,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.textureAttribLocation,e,i,s,r,n)}{const e=4,i=t.UNSIGNED_BYTE,s=!0,r=0,n=0;t.bindBuffer(t.ARRAY_BUFFER,this.foregroundBuffer),t.bufferData(t.ARRAY_BUFFER,this.foregroundUint8Array,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.fgColorAttribLocation,e,i,s,r,n)}{const e=4,i=t.UNSIGNED_BYTE,s=!0,r=0,n=0;t.bindBuffer(t.ARRAY_BUFFER,this.backgroundBuffer),t.bufferData(t.ARRAY_BUFFER,this.backgroundUint8Array,t.DYNAMIC_DRAW),t.vertexAttribPointer(this.bgColorAttribLocation,e,i,s,r,n)}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.useProgram(this.program),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture);{const e=this.width*this.height*6,i=t.UNSIGNED_SHORT,s=0;t.drawElements(t.TRIANGLES,e,i,s)}}renderCrt(){const t=this.crt;if(!t)return;const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,this.pixelWidth*this.pixelScale,this.pixelHeight*this.pixelScale),e.useProgram(this.crtProgram),e.uniform1f(this.crtBlurLocation,t.blur),e.uniform1f(this.crtCurvatureLocation,t.curvature),e.uniform1f(this.crtChromaLocation,t.chroma),e.uniform1f(this.crtVignetteLocation,t.vignette),e.uniform1f(this.crtScanlineWidthLocation,t.scanlineWidth),e.uniform1f(this.crtScanlineIntensityLocation,t.scanlineIntensity),e.bindBuffer(e.ARRAY_BUFFER,this.crtPositionBuffer),e.vertexAttribPointer(this.crtPositionLocation,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.crtTexCoordBuffer),e.vertexAttribPointer(this.crtTexCoordLocation,2,e.FLOAT,!1,0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.frameBufferTexture),e.drawArrays(e.TRIANGLES,0,6)}requestAnimationFrame(){window.requestAnimationFrame((t=>this.renderLoop(t)))}renderLoop(t){0===this.lastRenderTime?(this.lastRenderTime=t,this.fps=0):(this.renderDelta=t-this.lastRenderTime,this.lastRenderTime=t,this.fps=1e3/this.renderDelta,this.averageFps=.95*this.averageFps+.05*this.fps),this.keys.updateKeys(t),this.mouse.update(t),this.update&&this.update(),this.flush(),this.render(),this.crt&&this.renderCrt(),void 0===this.maxFps&&this.requestAnimationFrame()}}export{t as BlendMode,A as Cell,E as Chars,Q as ColodorePalette,c as Colors,k as Commodore64Palette,f as Console,O as DEFAULT_FONT,x as DefaultDialogRenderer,U as Dialog,p as DialogState,L as Font,R as FovOctants,N as FovQuadrants,K as GUI,C as Key,w as Keyboard,I as Message,v as MessageDialog,W as Mouse,z as Pico8Palette,m as Point,it as RNG,B as Rect,b as ScrollableMessageDialog,V as SelectDialog,nt as Terminal,g as capitalize,$ as computePath,l as deserialize,n as fixBoxCells,a as fromHsv,o as fromRgb,D as getFovQuadrant,H as loadImage,P as loadImage2x,u as serializable,d as serialize,T as wordWrap};
//# sourceMappingURL=index.min.js.map
